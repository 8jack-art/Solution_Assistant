# 投资项目方案报告生成模块变量检查报告

## 1. 概述

本报告对投资项目方案报告生成模块中的可用变量进行全面的检查和分析，检查范围包括变量定义、变量分组、变量详情描述、数据来源映射、表格资源构建以及图表资源支持等方面。

**检查时间**: 2024年1月6日

---

## 2. 变量系统架构分析

### 2.1 变量存储位置

变量系统的核心代码分布在以下文件中：

| 文件路径 | 作用 |
|---------|------|
| [`client/src/stores/reportStore.ts`](client/src/stores/reportStore.ts:352) | 变量定义和数据来源映射 |
| [`client/src/components/report/VariableMenu.tsx`](client/src/components/report/VariableMenu.tsx:15) | 变量分组配置和详情描述 |
| [`client/src/components/report/VariablePicker.tsx`](client/src/components/report/VariablePicker.tsx:1) | 变量选择器组件 |
| [`client/src/utils/tableResourceBuilder.ts`](client/src/utils/tableResourceBuilder.ts:1) | 表格资源构建器 |
| [`client/src/services/reportApi.ts`](client/src/services/reportApi.ts:1) | API服务层 |
| [`client/src/types/report.ts`](client/src/types/report.ts:1) | 类型定义 |

### 2.2 变量分类结构

系统中的变量分为以下几类：

```
报告变量
├── 基础变量（Basic Variables）
│   ├── 项目信息变量（9个）
│   └── 财务指标变量（3个）
├── 表格资源变量（Table Resources）
│   └── 4个表格变量
└── 图表资源变量（Chart Resources）
    └── 5个图表变量
```

---

## 3. 当前定义的变量清单

### 3.1 基础变量（在reportStore.ts中定义）

#### 3.1.1 项目信息变量

| 变量Key | 变量Label | 数据来源 | 状态 |
|--------|----------|---------|------|
| `{{project_name}}` | 项目名称 | `projectData.project?.name` | ✅ 正确 |
| `{{project_description}}` | 项目描述 | `projectData.project?.description` | ✅ 正确 |
| `{{construction_unit}}` | 建设单位 | `projectData.project?.constructionUnit` | ⚠️ 需验证字段名 |
| `{{total_investment}}` | 总投资额 | `projectData.project?.totalInvestment` | ✅ 正确 |
| `{{construction_years}}` | 建设期 | `projectData.project?.constructionYears` | ✅ 正确 |
| `{{operation_years}}` | 运营期 | `projectData.project?.operationYears` | ✅ 正确 |
| `{{project_type}}` | 项目类型 | `projectData.project?.project_type` | ✅ 正确 |
| `{{location}}` | 项目地点 | `projectData.project?.location` | ✅ 正确 |
| `{{current_date}}` | 当前日期 | `new Date().toLocaleDateString('zh-CN')` | ✅ 正确 |

#### 3.1.2 财务指标变量

| 变量Key | 变量Label | 数据来源 | 状态 |
|--------|----------|---------|------|
| `{{roi}}` | 投资回报率 | `projectData.financialIndicators?.roi` | ⚠️ 需验证数据完整性 |
| `{{irr}}` | 内部收益率 | `projectData.financialIndicators?.irr` | ⚠️ 需验证数据完整性 |
| `{{npv}}` | 净现值 | `projectData.financialIndicators?.npv` | ⚠️ 需验证数据完整性 |

### 3.2 表格资源变量

| 变量Key | 变量Label | 构建函数 | 状态 |
|--------|----------|---------|------|
| `{{TABLE:investment_estimate}}` | 投资估算简表 | `buildInvestmentEstimateTable` | ✅ 正确 |
| `{{TABLE:revenue_cost_detail}}` | 收入成本明细表 | `buildRevenueCostTable` | ✅ 正确 |
| `{{TABLE:financial_indicators}}` | 财务指标汇总表 | `buildFinancialIndicatorsTable` | ✅ 正确 |
| `{{TABLE:loan_repayment}}` | 还款计划表 | `buildLoanRepaymentTable` | ✅ 正确 |

### 3.3 图表资源变量

| 变量Key | 变量Label | 状态 |
|--------|----------|------|
| `{{CHART:investment_composition}}` | 投资构成图 | ❌ **未实现** |
| `{{CHART:revenue_trend}}` | 收入趋势图 | ❌ **未实现** |
| `{{CHART:cost_trend}}` | 成本趋势图 | ❌ **未实现** |
| `{{CHART:cash_flow_trend}}` | 现金流趋势图 | ❌ **未实现** |
| `{{CHART:profit_analysis}}` | 利润分析图 | ❌ **未实现** |

---

## 4. 检查结果汇总

### 4.1 一致性检查

#### ✅ 变量分组配置与定义一致

在 [`VariableMenu.tsx`](client/src/components/report/VariableMenu.tsx:16) 中定义的变量分组与 [`reportStore.ts`](client/src/stores/reportStore.ts:352) 中的变量定义完全匹配：

- **项目信息分组**: `{{project_name}}`, `{{project_description}}`, `{{project_type}}`, `{{location}}`
- **投资数据分组**: `{{total_investment}}`, `{{construction_years}}`, `{{operation_years}}`, `{{construction_unit}}`
- **财务指标分组**: `{{roi}}`, `{{irr}}`, `{{npv}}`
- **表格资源分组**: 4个表格变量全部包含
- **图表资源分组**: 5个图表变量全部包含
- **其他变量**: `{{current_date}}`

#### ✅ 变量详情描述完整

在 [`VariableMenu.tsx`](client/src/components/report/VariableMenu.tsx:56) 中为每个变量提供了详细的描述信息，包括变量名称、描述说明和使用场景。

### 4.2 数据来源验证

#### ⚠️ 字段映射需验证的问题

1. **`construction_unit` 字段**
   - 变量定义中使用的字段名: `projectData.project?.constructionUnit`
   - 在 `projectController.ts` 和数据库模型中需验证实际字段名

2. **财务指标数据完整性**
   - `roi`, `irr`, `npv` 变量依赖 `projectData.financialIndicators`
   - 需要确认API是否返回完整的 `financialIndicators` 数据结构

### 4.3 资源构建器验证

#### ✅ 表格资源构建正确

在 [`tableResourceBuilder.ts`](client/src/utils/tableResourceBuilder.ts:838) 中，`buildAllTableResources` 函数正确构建了4个表格资源：

- 投资估算简表
- 收入成本明细表
- 财务指标汇总表
- 还款计划表

#### ❌ 图表资源未实现（关键问题）

**问题描述**:
虽然定义了5个图表资源变量，但 `buildAllTableResources` 函数**只构建了表格资源**，没有构建任何图表资源。

**问题位置**: [`tableResourceBuilder.ts`](client/src/utils/tableResourceBuilder.ts:838)

```typescript
export function buildAllTableResources(projectData: any): Record<string, TableResource> {
  const tables: Record<string, TableResource> = {}
  // 只构建了表格，没有构建图表
  // ...
  return tables  // charts 为空对象
}
```

**影响**:
- 用户使用 `{{CHART:*}}` 变量时，系统会显示空白图表
- 图表变量在UI中显示，但实际上没有数据支持

---

## 5. 发现的问题清单

### 5.1 严重问题（Critical）

| # | 问题描述 | 影响范围 | 位置 |
|---|---------|---------|------|
| 1 | 图表资源未实现 | 5个图表变量全部无效 | `tableResourceBuilder.ts` |

### 5.2 中等问题（Medium）

| # | 问题描述 | 影响范围 | 位置 |
|---|---------|---------|------|
| 1 | `construction_unit` 字段名可能不匹配 | 建设单位变量可能为空 | `reportStore.ts:355` |
| 2 | 财务指标数据来源不明确 | ROI/IRR/NPV可能为空 | `reportStore.ts:363-365` |
| 3 | API端点 `/report/project/summary/:id` 未找到定义 | 无法验证数据完整性 | 需要进一步调查 |

### 5.3 轻微问题（Low）

| # | 问题描述 | 建议 |
|---|---------|------|
| 1 | 变量值格式化 | 财务指标变量应添加 `%` 或 `万元` 单位后缀 |
| 2 | 空值处理 | 部分变量缺少空值兜底处理 |

---

## 6. 修复建议

### 6.1 图表资源实现方案

#### 方案A：实现图表资源构建器

在 `tableResourceBuilder.ts` 中添加图表资源构建函数：

```typescript
// 添加图表构建函数
export function buildChartResources(projectData: any): Record<string, ChartResource> {
  const charts: Record<string, ChartResource> = {}
  
  // 投资构成图
  charts['investment_composition'] = buildInvestmentCompositionChart(projectData)
  
  // 收入趋势图
  charts['revenue_trend'] = buildRevenueTrendChart(projectData)
  
  // 成本趋势图
  charts['cost_trend'] = buildCostTrendChart(projectData)
  
  // 现金流趋势图
  charts['cash_flow_trend'] = buildCashFlowTrendChart(projectData)
  
  // 利润分析图
  charts['profit_analysis'] = buildProfitAnalysisChart(projectData)
  
  return charts
}

// 在 buildAllResources 中调用
export function buildAllResources(projectData: any): { tables: Record<string, TableResource>, charts: Record<string, ChartResource> } {
  return {
    tables: buildAllTableResources(projectData),
    charts: buildChartResources(projectData)
  }
}
```

### 6.2 字段名验证方案

检查数据库模型和API响应中的实际字段名：

```typescript
// 在 reportStore.ts 中修改为正确的字段名
{ key: '{{construction_unit}}', label: '建设单位', value: projectData.project?.construction_unit || '' },
```

### 6.3 财务指标数据获取方案

确认财务指标数据的来源，可能需要：

1. 在投资估算计算时生成财务指标
2. 或在收入成本计算时生成财务指标
3. 或添加专门的财务指标计算API

---

## 7. 检查结论

### 7.1 总体评价

| 评估项 | 评分 | 说明 |
|-------|------|------|
| 变量定义完整性 | 85% | 基础变量和表格变量完整，图表变量缺失 |
| 分组配置一致性 | 100% | 分组配置与定义完全一致 |
| 详情描述完整性 | 95% | 描述信息详细准确 |
| 数据来源正确性 | 70% | 部分字段名需验证 |
| 资源构建正确性 | 60% | 表格正确，图表缺失 |

### 7.2 建议优先级

1. **高优先级**: 实现图表资源构建器
2. **中优先级**: 验证并修复字段名映射
3. **中优先级**: 确认财务指标数据来源
4. **低优先级**: 优化变量值格式化

---

## 8. 附录

### 8.1 相关文件清单

- `client/src/stores/reportStore.ts` - 变量定义和数据源
- `client/src/components/report/VariableMenu.tsx` - 变量分组和详情
- `client/src/components/report/VariablePicker.tsx` - 变量选择UI
- `client/src/utils/tableResourceBuilder.ts` - 资源构建器
- `client/src/services/reportApi.ts` - API服务
- `client/src/types/report.ts` - 类型定义

### 8.2 变量Key完整列表

```
# 基础变量
{{project_name}}
{{project_description}}
{{construction_unit}}
{{total_investment}}
{{construction_years}}
{{operation_years}}
{{project_type}}
{{location}}
{{current_date}}
{{roi}}
{{irr}}
{{npv}}

# 表格变量
{{TABLE:investment_estimate}}
{{TABLE:revenue_cost_detail}}
{{TABLE:financial_indicators}}
{{TABLE:loan_repayment}}

# 图表变量
{{CHART:investment_composition}}
{{CHART:revenue_trend}}
{{CHART:cost_trend}}
{{CHART:cash_flow_trend}}
{{CHART:profit_analysis}}
```

---

**报告生成时间**: 2024年1月6日
**报告生成人**: Kilo Code (Architect Mode)
