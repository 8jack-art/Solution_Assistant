# 财务评价指标汇总表调试说明

## 年均销售税金及附加计算过程

### 1. 数据来源

年均销售税金及附加的数据来源于 `revenueTableData`（营业收入、营业税金及附加和增值税估算表）中序号为 "3" 的行，即"其他税费及附加"行。

### 2. 计算公式

```
年均销售税金及附加 = 销售税金及附加合计 ÷ 运营期年数
                   = calculateTaxAndSurcharges(合计) ÷ context.operationYears
```

### 3. calculateTaxAndSurcharges 函数逻辑

```typescript
const calculateTaxAndSurcharges = (year?: number): number => {
  if (year !== undefined) {
    // 获取指定年份的税金及附加
    if (revenueTableData && revenueTableData.rows) {
      const row = revenueTableData.rows.find(r => r.序号 === '3');
      if (row && row.运营期 && row.运营期[year - 1] !== undefined) {
        return row.运营期[year - 1];
      }
    }
    return calculateOtherTaxesAndSurchargesLocal(year);
  } else {
    // 获取所有年份的税金及附加合计
    if (revenueTableData && revenueTableData.rows) {
      const row = revenueTableData.rows.find(r => r.序号 === '3');
      if (row && row.合计 !== undefined) {
        return row.合计;
      }
    }
    // 如果没有表格数据，遍历各年累加
    const years = Array.from({ length: context.operationYears }, (_, i) => i + 1);
    let totalSum = 0;
    years.forEach((y) => {
      totalSum += calculateTaxAndSurcharges(y);
    });
    return totalSum;
  }
};
```

### 4. 税金及附加的构成

根据 `revenueCostStore.ts` 中的 `calculateOtherTaxesAndSurcharges` 函数：

```
其他税费及附加 = 增值税 × (城市维护建设税率 + 教育费附加率 + 地方教育附加率)
               = 增值税 × (7% + 5% + 3%)  // 合计15%，或根据实际配置
```

增值税的计算公式：

```
增值税 = 销项税额 - 进项税额 - 进项税额（固定资产待抵扣）
```

其中：
- 销项税额 = Σ(各产品含税收入 - 各产品含税收入/(1+增值税税率))
- 进项税额 = Σ(外购原材料含税金额/(1+原材料税率)×原材料税率) + Σ(外购燃料动力含税金额/(1+燃料动力税率)×燃料动力税率)

### 5. 调试日志输出

当打开"财务评价指标汇总表"时，浏览器控制台将输出以下调试信息：

```
========== 年均销售税金及附加调试信息 ==========
1. calculateTaxAndSurcharges(合计) = [销售税金及附加合计值]
2. calculateVatAndTaxes(合计) = [增值税合计值]
3. context.operationYears = [运营期年数]
4. revenueTableData 状态: {
  rowsExist: true/false,
  rowCount: [行数],
  row3Exist: true/false
}
5. revenueTableData.序号3 = {序号: "3", 项目: "其他税费及附加", 合计: [值], 运营期: [...]}

========== 年均销售税金及附加代数计算过程 ==========
代数表达式: 年均销售税金及附加 = 销售税金及附加合计 ÷ 运营年数
           = calculateTaxAndSurcharges(合计) ÷ context.operationYears
           = [合计值] ÷ [运营期年数]
           = [年均值] (万元)

========== 财务评价指标汇总表完整数据 ==========
项目总投资 = 建设投资 + 建设期利息
= [建设投资值] + [建设期利息值] = [项目总投资值]
资金筹措 = 项目总投资 = [资金筹措值]
项目资本金 = 项目总投资 - 项目债务资金 = [总投资值] - [贷款总额值] = [资本金值]
项目债务资金 = 贷款总额 = [贷款总额值]
年均销售税金及附加 = [年均值]
```

### 6. 可能的问题及排查

#### 问题1: 年均销售税金及附加显示为0

**可能原因：**
1. `revenueTableData` 未加载或为空
2. 序号为 "3" 的行不存在
3. 序号为 "3" 的行中"合计"字段为 undefined 或 0

**排查步骤：**
1. 检查浏览器控制台中的调试信息
2. 确认 `revenueTableData.rowsExist` 是否为 `true`
3. 确认 `revenueTableData.row3Exist` 是否为 `true`
4. 检查 `revenueTableData.序号3.合计` 的值

#### 问题2: 年均销售税金及附加值不正确

**可能原因：**
1. 营业收入、营业税金及附加和增值税估算表中的数据未正确填写
2. 增值税计算逻辑有问题
3. 各税率配置不正确

**排查步骤：**
1. 检查 DynamicRevenueTable 中的数据
2. 确认各产品的增值税税率配置
3. 确认原材料、燃料动力的进项税率配置
4. 确认城市维护建设税、教育费附加、地方教育附加的税率配置

### 7. 相关文件

- `client/src/components/revenue-cost/FinancialIndicatorsTable.tsx` - 财务评价指标汇总表组件
- `client/src/stores/revenueCostStore.ts` - 收入成本状态管理，包含 calculateOtherTaxesAndSurcharges 函数
- `client/src/components/revenue-cost/DynamicRevenueTable.tsx` - 营业收入、营业税金及附加和增值税估算表组件

### 8. 资金筹措与项目总投资的关系

根据财务评价指标汇总表的设计要求：

```
1. 资金筹措 = 项目总投资
2. 项目债务资金 = 贷款总额
3. 项目资本金 = 项目总投资 - 项目债务资金
```

代数表达式：
```
设:
  T = 项目总投资
  CI = 建设投资
  I = 建设期利息
  L = 贷款总额（项目债务资金）
  E = 项目资本金
  F = 资金筹措

则:
  T = CI + I
  F = T
  L = L
  E = T - L
  F = E + L
```

### 9. 调试方法

1. 打开浏览器开发者工具（F12）
2. 切换到 Console（控制台）标签
3. 点击"财务评价指标汇总表"按钮
4. 查看控制台中输出的调试信息
5. 根据调试信息定位问题
