# é¡¹ç›®æ¦‚å†µç”ŸæˆåŠŸèƒ½å®æ–½è®¡åˆ’

## 1. æ¦‚è¿°

åœ¨æŠ¥å‘Šç”Ÿæˆæ¨¡å—çš„"å¯ç”¨å˜é‡"å¡ç‰‡ï¼ˆVariablePickerï¼‰ä¸­ï¼Œå°†"é¡¹ç›®æè¿°"æ›¿æ¢ä¸º"é¡¹ç›®æ¦‚å†µ"å˜é‡ï¼š
- é¡¹ç›®æ¦‚å†µä¸ºç©ºæ—¶æ˜¾ç¤ºä¸ºç°è‰²ï¼ˆä¸å¯ç‚¹å‡»ï¼‰
- é¡¹ç›®æ¦‚å†µæœ‰å†…å®¹æ—¶é¢œè‰²æ­£å¸¸ï¼ˆå¯ç‚¹å‡»å¤åˆ¶ï¼‰
- åœ¨æ ‡é¢˜å³ä¾§æ·»åŠ AIå›¾æ ‡æŒ‰é’®ï¼Œç‚¹å‡»å¼¹å‡ºModalç”Ÿæˆé¡¹ç›®æ¦‚å†µ

## 2. åŠŸèƒ½éœ€æ±‚

### 2.1 å˜é‡è°ƒæ•´

| å˜æ›´å‰ | å˜æ›´å |
|-------|-------|
| `{{project_description}}` - é¡¹ç›®æè¿° | `{{project_overview}}` - é¡¹ç›®æ¦‚å†µ |
| åŸå§‹é¡¹ç›®æè¿°å­—æ®µ | AIç”Ÿæˆçš„é¡¹ç›®æ¦‚å†µHTMLå†…å®¹ |

### 2.2 å˜é‡æ˜¾ç¤ºè§„åˆ™

| çŠ¶æ€ | é¢œè‰² | å¯ç‚¹å‡» |
|-----|------|-------|
| é¡¹ç›®æ¦‚å†µä¸ºç©º | ç°è‰²ï¼ˆgrayï¼‰ | ä¸å¯ç‚¹å‡» |
| é¡¹ç›®æ¦‚å†µæœ‰å†…å®¹ | è“è‰²ï¼ˆblueï¼‰ | å¯ç‚¹å‡»å¤åˆ¶ |

### 2.3 æ•°æ®æ¥æº

| å­—æ®µ | æ•°æ®æ¥æº |
|-----|---------|
| é¡¹ç›®åç§° | é¡¹ç›®åŸºæœ¬ä¿¡æ¯ |
| å»ºè®¾å•ä½ | é¡¹ç›®åŸºæœ¬ä¿¡æ¯ |
| å»ºè®¾åœ°ç‚¹ | é¡¹ç›®åŸºæœ¬ä¿¡æ¯ |
| å»ºè®¾è§„æ¨¡ | æŠ•èµ„ä¼°ç®—ç®€è¡¨ç¬¬ä¸€éƒ¨åˆ† |
| æŠ•èµ„è§„æ¨¡ | æŠ•èµ„ä¼°ç®—ç®€è¡¨ |
| èµ„é‡‘æ¥æº | æŠ•èµ„ä¼°ç®—ç®€è¡¨å»ºè®¾æœŸä¿¡æ¯ |
| å»ºè®¾å‘¨æœŸ | é¡¹ç›®åŸºæœ¬ä¿¡æ¯ |
| æ‰€æ¶‰äº§å“æˆ–æœåŠ¡ | æ”¶å…¥æˆæœ¬ä¼°ç®—è¡¨ |

## 3. æŠ€æœ¯æ¶æ„

```mermaid
flowchart TD
    A[VariablePickeræ ‡é¢˜] --> B[AI IconæŒ‰é’®]
    B --> C[Modalå¼¹å‡º - å®½700xé«˜300]
    C --> D[æ”¶é›†é¡¹ç›®æ•°æ®]
    D --> E[æ„å»ºå¤§æ¨¡å‹Prompt]
    E --> F[è°ƒç”¨å¤§æ¨¡å‹API]
    F --> G[è§£æJSONå“åº”]
    G --> H[è½¬æ¢ä¸ºå¯Œæ–‡æœ¬HTML]
    H --> I[ä¿å­˜åˆ°æ•°æ®åº“å’Œstore]
    I --> J[VariablePickeråˆ·æ–°æ˜¾ç¤º]
    J --> K[é¡¹ç›®æ¦‚å†µå˜é‡å˜è“è‰²å¯ç‚¹å‡»]
```

## 4. å®æ–½æ­¥éª¤

### æ­¥éª¤1ï¼šåˆ›å»ºé¡¹ç›®æ¦‚å†µç”ŸæˆModalç»„ä»¶

**æ–‡ä»¶**: `client/src/components/report/ProjectOverviewModal.tsx`

**åŠŸèƒ½**:
- Modalå°ºå¯¸: width=700, height=300
- åŒ…å«Tiptapå¯Œæ–‡æœ¬ç¼–è¾‘å™¨ï¼ˆåªè¯»ï¼‰
- åŒ…å«"ç”Ÿæˆ"å’Œ"ä¿å­˜"æŒ‰é’®

### æ­¥éª¤2ï¼šä¿®æ”¹VariablePickerç»„ä»¶

**æ–‡ä»¶**: `client/src/components/report/VariablePicker.tsx`

**ä¿®æ”¹å†…å®¹**:
1. å°†"é¡¹ç›®æè¿°"æ›¿æ¢ä¸º"é¡¹ç›®æ¦‚å†µ"
2. æ ¹æ®projectOverviewçŠ¶æ€è®¾ç½®å˜é‡é¢œè‰²
3. æ·»åŠ Modalè§¦å‘æŒ‰é’®ï¼ˆæ ‡é¢˜å³ä¾§AIå›¾æ ‡ï¼‰
4. å¤„ç†ç©ºå€¼/æœ‰å€¼ä¸¤ç§çŠ¶æ€çš„æ˜¾ç¤º

### æ­¥éª¤3ï¼šä¿®æ”¹reportStore

**æ–‡ä»¶**: `client/src/stores/reportStore.ts`

**ä¿®æ”¹å†…å®¹**:
1. æ·»åŠ `projectOverview`çŠ¶æ€
2. æ·»åŠ `saveProjectOverview`æ–¹æ³•
3. æ·»åŠ `loadProjectOverview`æ–¹æ³•
4. åœ¨`availableVariables`ä¸­ä½¿ç”¨`projectOverview`æ›¿ä»£`project_description`

### æ­¥éª¤4ï¼šå®ç°æ•°æ®æ”¶é›†å’Œå¤§æ¨¡å‹è°ƒç”¨

**æ–°å¢æœåŠ¡æ–¹æ³•**: `reportApi.generateProjectOverview` å’Œ `reportApi.saveProjectOverview`

## 5. è¯¦ç»†å®ç°

### 5.1 ProjectOverviewModalç»„ä»¶

```typescript
// client/src/components/report/ProjectOverviewModal.tsx

import { useState, useMemo } from 'react'
import { Modal, Group, Button, Stack, Text, Box } from '@mantine/core'
import { useEditor, EditorContent } from '@tiptap/react'
import StarterKit from '@tiptap/starter-kit'
import { Sparkles, Save } from 'lucide-react'
import { useReportStore } from '../../stores/reportStore'
import { notifications } from '@mantine/notifications'
import { reportApi } from '../../services/reportApi'

interface ProjectOverviewData {
  projectName: string
  constructionUnit: string
  constructionSite: string
  constructionScale: string
  investmentScale: string
  fundingSource: string
  constructionPeriod: string
  productsServices: string[]
}

interface ProjectOverviewModalProps {
  opened: boolean
  onClose: () => void
}

export function ProjectOverviewModal({ opened, onClose }: ProjectOverviewModalProps) {
  const { projectData, projectId, saveProjectOverview } = useReportStore()
  const [generating, setGenerating] = useState(false)
  const [saving, setSaving] = useState(false)

  const editor = useEditor({
    extensions: [StarterKit],
    content: '',
    editable: false,
    editorProps: {
      attributes: {
        class: 'prose prose-sm focus:outline-none min-h-[150px] p-4 border rounded',
      },
    },
  })

  // æ”¶é›†é¡¹ç›®æ•°æ®
  const projectOverviewData = useMemo((): ProjectOverviewData | null => {
    if (!projectData) return null

    const project = projectData.project || {}
    const estimate = projectData.estimate || {}
    const revenueItems = projectData.revenueItems || []

    // ä»æŠ•èµ„ä¼°ç®—ç®€è¡¨æå–å»ºè®¾è§„æ¨¡
    const partAChildren = estimate.partA?.children || []
    const constructionScaleText = partAChildren
      .map((item: any) => `${item.name || ''}: ${item.amount || 0}ä¸‡å…ƒ`)
      .join('ï¼›')

    // æå–æ€»æŠ•èµ„è§„æ¨¡
    const totalInvestment = project.totalInvestment || 0
    const investmentScaleText = `æ€»æŠ•èµ„${totalInvestment}ä¸‡å…ƒ`

    // èµ„é‡‘æ¥æº
    const loanAmount = estimate.loanAmount || 0
    const selfFundedAmount = totalInvestment - loanAmount
    const fundingSourceText = `ç”³è¯·é“¶è¡Œè´·æ¬¾${loanAmount}ä¸‡å…ƒï¼Œå æŠ•èµ„ä¼°ç®—æ€»é¢çš„${((loanAmount / totalInvestment) * 100).toFixed(2)}%ï¼›ä¸šä¸»è‡ªç­¹${selfFundedAmount}ä¸‡å…ƒï¼Œå æŠ•èµ„ä¼°ç®—æ€»é¢çš„${((selfFundedAmount / totalInvestment) * 100).toFixed(2)}%`

    // äº§å“/æœåŠ¡
    const productsServices = revenueItems.map((item: any) => item.name || '').filter(Boolean)

    return {
      projectName: project.name || '',
      constructionUnit: project.constructionUnit || '',
      constructionSite: project.location || '',
      constructionScale: constructionScaleText || 'æš‚æ— æ•°æ®',
      investmentScale: investmentScaleText || 'æš‚æ— æ•°æ®',
      fundingSource: fundingSourceText || 'æš‚æ— æ•°æ®',
      constructionPeriod: `${project.constructionYears || 0}å¹´`,
      productsServices: productsServices.length > 0 ? productsServices : ['æš‚æ— æ•°æ®']
    }
  }, [projectData])

  // æ„å»ºå¤§æ¨¡å‹Prompt
  const buildPrompt = (data: ProjectOverviewData): string => {
    return `
æ ¹æ®ä»¥ä¸‹é¡¹ç›®ä¿¡æ¯ï¼Œç”Ÿæˆé¡¹ç›®æ¦‚å†µï¼š

é¡¹ç›®åç§°ï¼š${data.projectName}
å»ºè®¾å•ä½ï¼š${data.constructionUnit}
å»ºè®¾åœ°ç‚¹ï¼š${data.constructionSite}
å»ºè®¾å‘¨æœŸï¼š${data.constructionPeriod}

å»ºè®¾è§„æ¨¡ä¿¡æ¯ï¼š
${data.constructionScale}

æŠ•èµ„è§„æ¨¡ä¿¡æ¯ï¼š
${data.investmentScale}

èµ„é‡‘æ¥æºä¿¡æ¯ï¼š
${data.fundingSource}

äº§å“/æœåŠ¡ä¿¡æ¯ï¼š
${data.productsServices.join('ã€')}

è¯·æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºé¡¹ç›®æ¦‚å†µï¼ˆä¸è¦æ·»åŠ markdownä»£ç å—æ ‡è®°ï¼Œä¸è¦ç”¨```jsonåŒ…è£¹ï¼‰ï¼š
{
  "projectName": "é¡¹ç›®åç§°",
  "constructionUnit": "å»ºè®¾å•ä½",
  "constructionSite": "å»ºè®¾åœ°ç‚¹",
  "constructionScale": "è¯¦ç»†çš„å»ºè®¾è§„æ¨¡æè¿°",
  "investmentScale": "è¯¦ç»†çš„æŠ•èµ„è§„æ¨¡æè¿°ï¼ŒåŒ…æ‹¬å„åˆ†é¡¹é‡‘é¢",
  "fundingSource": "èµ„é‡‘æ¥æºæè¿°ï¼ŒåŒ…æ‹¬è´·æ¬¾å’Œè‡ªç­¹æ¯”ä¾‹",
  "constructionPeriod": "å»ºè®¾å‘¨æœŸæè¿°",
  "productsServices": ["äº§å“/æœåŠ¡1", "äº§å“/æœåŠ¡2"]
}
    `.trim()
  }

  // JSONè½¬HTML
  const jsonToHtml = (data: ProjectOverviewData): string => {
    return `
      <h3>${data.projectName}</h3>
      <p><strong>å»ºè®¾å•ä½ï¼š</strong>${data.constructionUnit}</p>
      <p><strong>å»ºè®¾åœ°ç‚¹ï¼š</strong>${data.constructionSite}</p>
      <p><strong>å»ºè®¾è§„æ¨¡ï¼š</strong>${data.constructionScale}</p>
      <p><strong>æŠ•èµ„è§„æ¨¡ï¼š</strong>${data.investmentScale}</p>
      <p><strong>èµ„é‡‘æ¥æºï¼š</strong>${data.fundingSource}</p>
      <p><strong>å»ºè®¾å‘¨æœŸï¼š</strong>${data.constructionPeriod}</p>
      <p><strong>æ‰€æ¶‰äº§å“æˆ–æœåŠ¡ï¼š</strong>${data.productsServices.join('ã€')}</p>
    `.trim()
  }

  // ç”Ÿæˆé¡¹ç›®æ¦‚å†µ
  const handleGenerate = async () => {
    if (!projectId) {
      notifications.show({
        title: 'é”™è¯¯',
        message: 'ç¼ºå°‘é¡¹ç›®ID',
        color: 'red',
      })
      return
    }

    if (!projectOverviewData) {
      notifications.show({
        title: 'é”™è¯¯',
        message: 'æ— æ³•è·å–é¡¹ç›®æ•°æ®',
        color: 'red',
      })
      return
    }

    setGenerating(true)

    try {
      const prompt = buildPrompt(projectOverviewData)

      await reportApi.generateProjectOverview(projectId, prompt, {
        onChunk: (content) => {
          try {
            const cleanContent = content
              .replace(/```json/g, '')
              .replace(/```/g, '')
              .trim()
            
            const data = JSON.parse(cleanContent) as ProjectOverviewData
            const html = jsonToHtml(data)
            editor?.commands.setContent(html)
          } catch (e) {
            editor?.commands.setContent(content)
          }
        },
        onComplete: () => {
          setGenerating(false)
          notifications.show({
            title: 'æˆåŠŸ',
            message: 'é¡¹ç›®æ¦‚å†µç”Ÿæˆå®Œæˆ',
            color: 'green',
          })
        },
        onError: (error) => {
          setGenerating(false)
          notifications.show({
            title: 'é”™è¯¯',
            message: error || 'ç”Ÿæˆå¤±è´¥',
            color: 'red',
          })
        }
      })
    } catch (error: any) {
      setGenerating(false)
      notifications.show({
        title: 'é”™è¯¯',
        message: error.message || 'ç”Ÿæˆå¤±è´¥',
        color: 'red',
      })
    }
  }

  // ä¿å­˜é¡¹ç›®æ¦‚å†µ
  const handleSave = async () => {
    const content = editor?.getHTML() || ''
    if (!content) {
      notifications.show({
        title: 'æç¤º',
        message: 'è¯·å…ˆç”Ÿæˆé¡¹ç›®æ¦‚å†µ',
        color: 'orange',
      })
      return
    }

    setSaving(true)
    try {
      await saveProjectOverview(content)
      notifications.show({
        title: 'æˆåŠŸ',
        message: 'é¡¹ç›®æ¦‚å†µå·²ä¿å­˜',
        color: 'green',
      })
      onClose()
    } catch (error: any) {
      notifications.show({
        title: 'é”™è¯¯',
        message: error.message || 'ä¿å­˜å¤±è´¥',
        color: 'red',
      })
    } finally {
      setSaving(false)
    }
  }

  return (
    <Modal
      opened={opened}
      onClose={onClose}
      title={
        <Group gap="xs">
          <Sparkles size={16} color="var(--mantine-color-blue-6)" />
          <Text fw={500}>AIç”Ÿæˆé¡¹ç›®æ¦‚å†µ</Text>
        </Group>
      }
      size="700px"
    >
      <Stack gap="md">
        {/* ç”Ÿæˆå’Œä¿å­˜æŒ‰é’® */}
        <Group justify="flex-end">
          <Button
            variant="light"
            color="blue"
            leftSection={<Sparkles size={14} />}
            onClick={handleGenerate}
            loading={generating}
            disabled={!projectOverviewData}
          >
            ç”Ÿæˆ
          </Button>
          <Button
            variant="filled"
            color="green"
            leftSection={<Save size={14} />}
            onClick={handleSave}
            loading={saving}
          >
            ä¿å­˜
          </Button>
        </Group>

        {/* å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ */}
        <Box style={{ minHeight: '180px' }}>
          <EditorContent editor={editor} />
        </Box>
      </Stack>
    </Modal>
  )
}
```

### 5.2 VariablePickerç»„ä»¶ä¿®æ”¹

```typescript
// client/src/components/report/VariablePicker.tsx ä¿®æ”¹

import { useState } from 'react'
import { Text, Badge, Group, Stack, ActionIcon, Tooltip } from '@mantine/core'
import { Sparkles } from 'lucide-react'
import { useReportStore } from '../../stores/reportStore'
import { ProjectOverviewModal } from './ProjectOverviewModal'

export function VariablePicker() {
  const { projectOverview, setPromptTemplate } = useReportStore()
  const [modalOpened, setModalOpened] = useState(false)

  const handleCopyVariable = (variableKey: string) => {
    navigator.clipboard.writeText(variableKey)
  }

  return (
    <div className="variable-picker">
      <Group justify="space-between" mb="xs">
        <Text size="sm" fw={500}>å¯ç”¨å˜é‡</Text>
        <Tooltip label="AIç”Ÿæˆé¡¹ç›®æ¦‚å†µ">
          <ActionIcon
            variant="subtle"
            color="blue"
            size="sm"
            onClick={() => setModalOpened(true)}
          >
            <Sparkles size={14} />
          </ActionIcon>
        </Tooltip>
      </Group>
      
      <Stack gap="xs">
        {/* åŸºæœ¬ä¿¡æ¯ */}
        <div>
          <Text size="xs" c="dimmed" mb="xs">åŸºæœ¬ä¿¡æ¯</Text>
          <Group gap={4}>
            {/* é¡¹ç›®åç§° */}
            <Badge
              variant="light"
              color="blue"
              style={{ cursor: 'pointer' }}
              onClick={() => handleCopyVariable('{{project_name}}')}
              title="ç‚¹å‡»å¤åˆ¶"
            >
              é¡¹ç›®åç§°
            </Badge>
            
            {/* é¡¹ç›®æ¦‚å†µ - æ ¹æ®çŠ¶æ€æ˜¾ç¤ºä¸åŒé¢œè‰² */}
            <Badge
              variant="light"
              color={projectOverview ? 'blue' : 'gray'}
              style={{ 
                cursor: projectOverview ? 'pointer' : 'not-allowed',
                opacity: projectOverview ? 1 : 0.5
              }}
              onClick={() => {
                if (projectOverview) {
                  handleCopyVariable('{{project_overview}}')
                }
              }}
              title={projectOverview ? 'ç‚¹å‡»å¤åˆ¶' : 'è¯·å…ˆAIç”Ÿæˆé¡¹ç›®æ¦‚å†µ'}
            >
              é¡¹ç›®æ¦‚å†µ
            </Badge>
            
            {/* å…¶ä»–åŸºæœ¬ä¿¡æ¯ */}
            <Badge
              variant="light"
              color="blue"
              style={{ cursor: 'pointer' }}
              onClick={() => handleCopyVariable('{{construction_unit}}')}
              title="ç‚¹å‡»å¤åˆ¶"
            >
              å»ºè®¾å•ä½
            </Badge>
            <Badge
              variant="light"
              color="blue"
              style={{ cursor: 'pointer' }}
              onClick={() => handleCopyVariable('{{total_investment}}')}
              title="ç‚¹å‡»å¤åˆ¶"
            >
              æ€»æŠ•èµ„é¢
            </Badge>
            <Badge
              variant="light"
              color="blue"
              style={{ cursor: 'pointer' }}
              onClick={() => handleCopyVariable('{{construction_years}}')}
              title="ç‚¹å‡»å¤åˆ¶"
            >
              å»ºè®¾æœŸ
            </Badge>
            <Badge
              variant="light"
              color="blue"
              style={{ cursor: 'pointer' }}
              onClick={() => handleCopyVariable('{{operation_years}}')}
              title="ç‚¹å‡»å¤åˆ¶"
            >
              è¿è¥æœŸ
            </Badge>
          </Group>
        </div>
        
        {/* é¡¹ç›®ä¿¡æ¯ */}
        <div>
          <Text size="xs" c="dimmed" mb="xs">é¡¹ç›®ä¿¡æ¯</Text>
          <Group gap={4}>
            <Badge
              variant="light"
              color="cyan"
              style={{ cursor: 'pointer' }}
              onClick={() => handleCopyVariable('{{project_type}}')}
              title="ç‚¹å‡»å¤åˆ¶"
            >
              é¡¹ç›®ç±»å‹
            </Badge>
            <Badge
              variant="light"
              color="cyan"
              style={{ cursor: 'pointer' }}
              onClick={() => handleCopyVariable('{{location}}')}
              title="ç‚¹å‡»å¤åˆ¶"
            >
              é¡¹ç›®åœ°ç‚¹
            </Badge>
          </Group>
        </div>
        
        {/* è´¢åŠ¡æŒ‡æ ‡ */}
        <div>
          <Text size="xs" c="dimmed" mb="xs">è´¢åŠ¡æŒ‡æ ‡</Text>
          <Group gap={4}>
            <Badge
              variant="light"
              color="green"
              style={{ cursor: 'pointer' }}
              onClick={() => handleCopyVariable('{{roi}}')}
              title="ç‚¹å‡»å¤åˆ¶"
            >
              æŠ•èµ„å›æŠ¥ç‡
            </Badge>
            <Badge
              variant="light"
              color="green"
              style={{ cursor: 'pointer' }}
              onClick={() => handleCopyVariable('{{irr}}')}
              title="ç‚¹å‡»å¤åˆ¶"
            >
              å†…éƒ¨æ”¶ç›Šç‡
            </Badge>
            <Badge
              variant="light"
              color="green"
              style={{ cursor: 'pointer' }}
              onClick={() => handleCopyVariable('{{npv}}')}
              title="ç‚¹å‡»å¤åˆ¶"
            >
              å‡€ç°å€¼
            </Badge>
          </Group>
        </div>
        
        {/* è¡¨æ ¼èµ„æº */}
        <div>
          <Text size="xs" c="dimmed" mb="xs">è¡¨æ ¼èµ„æº</Text>
          <Group gap={4}>
            <Badge variant="light" color="teal">æŠ•èµ„ä¼°ç®—ç®€è¡¨</Badge>
            <Badge variant="light" color="teal">æ”¶å…¥æˆæœ¬æ˜ç»†è¡¨</Badge>
            <Badge variant="light" color="teal">è´¢åŠ¡æŒ‡æ ‡æ±‡æ€»è¡¨</Badge>
            <Badge variant="light" color="teal">è¿˜æ¬¾è®¡åˆ’è¡¨</Badge>
          </Group>
        </div>
      </Stack>
      
      <Text size="xs" c="dimmed" mt="xs">
        ğŸ’¡ ç‚¹å‡»å˜é‡æ ‡ç­¾å³å¯å¤åˆ¶ï¼Œç²˜è´´åˆ°æç¤ºè¯ä¸­ä½¿ç”¨
      </Text>
      
      <ProjectOverviewModal
        opened={modalOpened}
        onClose={() => setModalOpened(false)}
      />
    </div>
  )
}
```

### 5.3 reportStoreä¿®æ”¹

```typescript
// client/src/stores/reportStore.ts æ–°å¢å†…å®¹

interface ReportState {
  // ... ç°æœ‰çŠ¶æ€
  projectOverview: string | null  // ä¿å­˜çš„é¡¹ç›®æ¦‚å†µ
  
  // æ–°å¢æ–¹æ³•
  saveProjectOverview: (content: string) => Promise<void>
  loadProjectOverview: () => Promise<void>
}

// åœ¨createå‡½æ•°ä¸­æ·»åŠ 
const store = create<ReportState>((set, get) => ({
  // ... ç°æœ‰çŠ¶æ€
  projectOverview: null,

  saveProjectOverview: async (content: string) => {
    const { projectId } = get()
    if (!projectId) throw new Error('ç¼ºå°‘é¡¹ç›®ID')
    
    set({ isLoading: true, error: null })
    try {
      const response = await reportApi.saveProjectOverview(projectId, content)
      if (response?.success) {
        set({ projectOverview: content, isLoading: false })
      } else {
        throw new Error(response?.error || 'ä¿å­˜å¤±è´¥')
      }
    } catch (error: any) {
      set({ error: error.message, isLoading: false })
      throw error
    }
  },

  loadProjectOverview: async () => {
    const { projectId } = get()
    if (!projectId) return
    
    try {
      const response = await reportApi.getProjectOverview(projectId)
      if (response?.success) {
        set({ projectOverview: response.data?.content || null })
      }
    } catch (error) {
      console.error('åŠ è½½é¡¹ç›®æ¦‚å†µå¤±è´¥:', error)
    }
  },
  
  // åœ¨loadProjectDataä¸­è°ƒç”¨loadProjectOverview
  loadProjectData: async () => {
    // ... ç°æœ‰é€»è¾‘
    await get().loadProjectOverview()
  },
  
  // ä¿®æ”¹loadProjectDataä¸­çš„availableVariablesï¼Œç§»é™¤project_descriptionï¼Œæ·»åŠ project_overview
  loadProjectData: async () => {
    // ...
    const variables: ReportVariable[] = [
      // ...
      // ç§»é™¤project_description
      // { key: '{{project_description}}', label: 'é¡¹ç›®æè¿°', value: projectData.project?.description || '' },
      // æ·»åŠ project_overview
      { key: '{{project_overview}}', label: 'é¡¹ç›®æ¦‚å†µ', value: '', category: 'basic' },
      // ...
    ]
  },
}))
```

## 6. APIéœ€æ±‚

### 6.1 å‰ç«¯API

```typescript
// client/src/services/reportApi.ts

// ç”Ÿæˆé¡¹ç›®æ¦‚å†µ
async generateProjectOverview(
  projectId: string,
  prompt: string,
  handlers: {
    onChunk: (content: string) => void
    onComplete: () => void
    onError: (error: string) => void
  }
) {
  // SSEæµå¼è°ƒç”¨å®ç°
}

// ä¿å­˜é¡¹ç›®æ¦‚å†µ
async saveProjectOverview(projectId: string, content: string) {
  const response = await api.post<any, ApiResponse>('/report/project/overview', {
    projectId,
    content
  })
  return response
}

// è·å–é¡¹ç›®æ¦‚å†µ
async getProjectOverview(projectId: string) {
  const response = await api.get<any, ApiResponse<{ content: string }>>(
    `/report/project/overview/${projectId}`
  )
  return response
}
```

### 6.2 åç«¯APIç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|-----|------|------|
| `/api/report/project/overview` | POST | ä¿å­˜é¡¹ç›®æ¦‚å†µ |
| `/api/report/project/overview/:projectId` | GET | è·å–é¡¹ç›®æ¦‚å†µ |
| `/api/report/generate/overview/:projectId` | POST | ç”Ÿæˆé¡¹ç›®æ¦‚å†µï¼ˆSSEï¼‰ |

## 7. æ•°æ®åº“éœ€æ±‚

æ–°å¢è¡¨ `report_project_overview`ï¼š

```sql
CREATE TABLE report_project_overview (
  id VARCHAR(36) PRIMARY KEY,
  project_id VARCHAR(36) NOT NULL,
  content LONGTEXT NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_project_id (project_id)
);
```

## 8. ä¾èµ–æ–‡ä»¶æ¸…å•

| æ–‡ä»¶è·¯å¾„ | æ“ä½œ | è¯´æ˜ |
|---------|------|------|
| `client/src/components/report/ProjectOverviewModal.tsx` | æ–°å»º | é¡¹ç›®æ¦‚å†µç”ŸæˆModalç»„ä»¶ |
| `client/src/components/report/VariablePicker.tsx` | ä¿®æ”¹ | æ›¿æ¢å˜é‡æ˜¾ç¤ºé€»è¾‘å’Œæ·»åŠ Modal |
| `client/src/services/reportApi.ts` | ä¿®æ”¹ | æ·»åŠ ä¿å­˜å’Œè·å–é¡¹ç›®æ¦‚å†µAPI |
| `client/src/stores/reportStore.ts` | ä¿®æ”¹ | æ·»åŠ projectOverviewçŠ¶æ€å’Œæ–¹æ³• |
| `server/src/routes/report.ts` | ä¿®æ”¹ | æ·»åŠ é¡¹ç›®æ¦‚å†µç›¸å…³APIç«¯ç‚¹ |
| `server/src/db/migrations/xxx.sql` | æ–°å¢ | æ·»åŠ report_project_overviewè¡¨ |

## 9. æµ‹è¯•è¦ç‚¹

1. âœ… AIå›¾æ ‡æŒ‰é’®å¯ç‚¹å‡»å¼¹å‡ºModal
2. âœ… Modalå°ºå¯¸ä¸º700x300
3. âœ… ç”ŸæˆæŒ‰é’®è°ƒç”¨å¤§æ¨¡å‹æ­£å¸¸
4. âœ… ä¿å­˜åé¡¹ç›®æ¦‚å†µå˜é‡å˜è“è‰²å¯ç‚¹å‡»
5. âœ… ç©ºé¡¹ç›®æ¦‚å†µæ˜¾ç¤ºç°è‰²ä¸å¯ç‚¹å‡»
6. âœ… ç‚¹å‡»å˜é‡å¯å¤åˆ¶åˆ°å‰ªè´´æ¿
7. âœ… ç©ºçŠ¶æ€å’Œé”™è¯¯å¤„ç†æ­£å¸¸
