# 报告生成模块样式设置增强计划

## 需求概述

为报告生成模块添加 HTML 转 Word 的独立样式设置功能，需要支持：

1. **标题1样式设置**：字号、行间距、首行缩进
2. **标题2样式设置**：字号、行间距、首行缩进
3. **正文样式设置**：字号、行间距、首行缩进
4. **页面边距设置**：上、下、左、右页边距

## 现有实现分析

### 当前类型定义 (`client/src/types/report.ts`)

现有 `ReportStyleConfig` 结构：
```typescript
interface ReportStyleConfig {
  fonts: { body, heading, number }
  fontSizes: { title, body, tableTitle, tableHeader, tableBody }
  paragraph: { lineSpacing, spaceBefore, spaceAfter, firstLineIndent, headingIndent }
  page: { margin: { top, bottom, left, right }, orientation }
  table: { headerBg, border, zebraStripe, alignment }
}
```

**问题**：标题1、标题2、正文样式未分离，当前只有统一的 title 和 body 字号。

### 当前样式面板 (`client/src/components/report/StyleSettingsPanel.tsx`)

- 有字体、字号、段落、页面边距设置
- 无标题1、标题2独立样式设置

### 服务器端 (`server/src/services/reportService.ts`)

- `generateWordFromHtml()` 使用通用样式
- 无标题1、标题2独立样式应用

## 实施步骤

### 步骤1：扩展类型定义

**文件**：`client/src/types/report.ts`

新增段落样式类型，支持每种段落类型独立配置：

```typescript
// 段落样式配置（支持标题1、标题2、正文独立设置）
interface ParagraphStyle {
  fontSize: number       // 字号（pt）
  lineSpacing: number    // 行间距倍数
  lineSpacingValue?: number  // 固定行间距值（磅）
  spaceBefore: number    // 段前间距
  spaceAfter: number     // 段后间距
  firstLineIndent: number // 首行缩进（字符数）
}

// 扩展 ReportStyleConfig
export interface ReportStyleConfig {
  // 保留向后兼容
  fonts: { ... }
  fontSizes: { ... }
  
  // 新增：标题和正文独立段落样式
  heading1: ParagraphStyle   // 标题1样式
  heading2: ParagraphStyle   // 标题2样式
  body: ParagraphStyle       // 正文样式
  
  // 保留现有配置
  page: { ... }
  table: { ... }
}

// 默认配置
export const defaultStyleConfig: ReportStyleConfig = {
  heading1: {
    fontSize: 22,        // 二号
    lineSpacing: 1.5,
    spaceBefore: 0,
    spaceAfter: 6,
    firstLineIndent: 0
  },
  heading2: {
    fontSize: 16,        // 小三
    lineSpacing: 1.5,
    spaceBefore: 6,
    spaceAfter: 6,
    firstLineIndent: 0
  },
  body: {
    fontSize: 12,        // 小四
    lineSpacing: 1.5,
    spaceBefore: 0,
    spaceAfter: 0,
    firstLineIndent: 2   // 首行缩进2字符
  },
  // ... 其他配置
}
```

### 步骤2：更新样式设置面板 UI

**文件**：`client/src/components/report/StyleSettingsPanel.tsx`

新增标题1、标题2、正文样式设置分组：

```tsx
// 新增段落样式选项
const paragraphStyleOptions = [
  { value: 10.5, label: '五号 10.5pt' },
  { value: 12, label: '小四 12pt' },
  { value: 14, label: '四号 14pt' },
  { value: 15, label: '小三 15pt' },
  { value: 16, label: '三号 16pt' },
  { value: 18, label: '小二 18pt' },
  { value: 22, label: '二号 22pt' },
  { value: 24, label: '小一 24pt' }
]

// 新增 UI 结构
<section className="settings-section">
  <h4>标题1样式</h4>
  <div className="settings-grid">
    <div className="setting-item">
      <label>字号</label>
      <select value={styleConfig?.heading1?.fontSize || 22} onChange={...}>
        {paragraphStyleOptions.map(...)}
      </select>
    </div>
    <div className="setting-item">
      <label>行间距</label>
      <select value={styleConfig?.heading1?.lineSpacing || 1.5} onChange={...}>
        {lineSpacingOptions.map(...)}
      </select>
    </div>
    <div className="setting-item">
      <label>首行缩进</label>
      <select value={styleConfig?.heading1?.firstLineIndent || 0} onChange={...}>
        {firstLineIndentOptions.map(...)}
      </select>
    </div>
  </div>
</section>

// 类似添加标题2样式和正文样式分组
```

### 步骤3：更新服务器端 Word 导出

**文件**：`server/src/services/reportService.ts`

更新 `generateWordFromHtml()` 方法：

```typescript
interface ParagraphStyleConfig {
  fontSize: number
  lineSpacing: number
  lineSpacingValue?: number
  spaceBefore: number
  spaceAfter: number
  firstLineIndent: number
}

static async generateWordFromHtml(
  htmlContent: string,
  title: string,
  styleConfig?: ReportStyleConfig
): Promise<Buffer> {
  const config = styleConfig || this.getDefaultStyleConfig()
  
  // 构建 HTML 样式，应用标题1、标题2、正文独立样式
  const fullHtml = `
    <style>
      h1 {
        font-family: '${config.fonts?.heading || '黑体'}';
        font-size: ${config.heading1?.fontSize || 22}pt;
        font-weight: bold;
        line-height: ${config.heading1?.lineSpacing || 1.5};
        margin: ${(config.heading1?.spaceBefore || 0) * 12}pt 0 
               ${(config.heading1?.spaceAfter || 6) * 12}pt 0;
        text-indent: ${(config.heading1?.firstLineIndent || 0) * 12}pt;
      }
      h2 {
        font-family: '${config.fonts?.heading || '黑体'}';
        font-size: ${config.heading2?.fontSize || 16}pt;
        font-weight: bold;
        line-height: ${config.heading2?.lineSpacing || 1.5};
        margin: ${(config.heading2?.spaceBefore || 6) * 12}pt 0 
               ${(config.heading2?.spaceAfter || 6) * 12}pt 0;
        text-indent: ${(config.heading2?.firstLineIndent || 0) * 12}pt;
      }
      body, p {
        font-family: '${config.fonts?.body || '宋体'}';
        font-size: ${config.body?.fontSize || 12}pt;
        line-height: ${config.body?.lineSpacing || 1.5};
        margin: ${(config.body?.spaceBefore || 0) * 12}pt 0 
               ${(config.body?.spaceAfter || 0) * 12}pt 0;
        text-indent: ${(config.body?.firstLineIndent || 2) * 12}pt;
      }
      // ... 其他样式
    </style>
  `
  
  // html-to-docx 选项也需要更新
  const options = {
    font: config.fonts?.body || '宋体',
    fontSize: config.body?.fontSize || 12,
    lineSpacing: (config.body?.lineSpacing || 1.5) * 240,
    // ... 页面边距
  }
}
```

### 步骤4：更新 ReportPreview 预览组件

**文件**：`client/src/components/report/ReportPreview.tsx`

更新预览组件应用新样式：

```typescript
// 构建 CSS 样式时应用新配置
const configToCss = (config: ReportStyleConfig): string => {
  return `
    body {
      font-family: ${config.fonts?.body || '宋体'}, serif;
      font-size: ${config.body?.fontSize || 12}pt;
      line-height: ${config.body?.lineSpacing || 1.5};
    }
    h1 {
      font-family: ${config.fonts?.heading || '黑体'}, sans-serif;
      font-size: ${config.heading1?.fontSize || 22}pt;
      font-weight: bold;
      line-height: ${config.heading1?.lineSpacing || 1.5};
      margin: ${(config.heading1?.spaceBefore || 0) * 12}pt 0 
             ${(config.heading1?.spaceAfter || 6) * 12}pt 0;
    }
    h2 {
      font-family: ${config.fonts?.heading || '黑体'}, sans-serif;
      font-size: ${config.heading2?.fontSize || 16}pt;
      font-weight: bold;
      line-height: ${config.heading2?.lineSpacing || 1.5};
      margin: ${(config.heading2?.spaceBefore || 6) * 12}pt 0 
             ${(config.heading2?.spaceAfter || 6) * 12}pt 0;
    }
  `
}
```

## 数据结构变更

### 变更前后对比

| 配置项 | 变更前 | 变更后 |
|--------|--------|--------|
| 标题字号 | `fontSizes.title` (统一) | `heading1.fontSize`, `heading2.fontSize` |
| 正文字号 | `fontSizes.body` (统一) | `body.fontSize` |
| 行间距 | `paragraph.lineSpacing` (统一) | `heading1/heading2/body.lineSpacing` |
| 首行缩进 | `paragraph.firstLineIndent` (统一) | `heading1/heading2/body.firstLineIndent` |

### 向后兼容性

在类型定义中保留旧的 `fontSizes` 和 `paragraph` 配置，使用默认值映射：

```typescript
// 兼容旧配置，映射到新结构
const getEffectiveConfig = (config: ReportStyleConfig): ReportStyleConfig => ({
  ...config,
  heading1: config.heading1 || {
    fontSize: config.fontSizes?.title || 22,
    lineSpacing: config.paragraph?.lineSpacing || 1.5,
    spaceBefore: 0,
    spaceAfter: config.paragraph?.spaceAfter || 6,
    firstLineIndent: config.paragraph?.firstLineIndent || 0
  },
  heading2: config.heading2 || {
    fontSize: (config.fontSizes?.title || 22) - 6,
    lineSpacing: config.paragraph?.lineSpacing || 1.5,
    spaceBefore: config.paragraph?.spaceBefore || 6,
    spaceAfter: config.paragraph?.spaceAfter || 6,
    firstLineIndent: config.paragraph?.firstLineIndent || 0
  },
  body: config.body || {
    fontSize: config.fontSizes?.body || 12,
    lineSpacing: config.paragraph?.lineSpacing || 1.5,
    spaceBefore: config.paragraph?.spaceBefore || 0,
    spaceAfter: config.paragraph?.spaceAfter || 0,
    firstLineIndent: config.paragraph?.firstLineIndent || 2
  }
})
```

## 测试要点

1. **预览一致性测试**：验证预览组件显示的样式与导出 Word 一致
2. **样式应用测试**：
   - 标题1独立设置字号、行间距、首行缩进
   - 标题2独立设置字号、行间距、首行缩进
   - 正文独立设置字号、行间距、首行缩进
3. **页边距测试**：验证上下左右页边距正确应用
4. **向后兼容性测试**：旧配置能正确映射到新结构
