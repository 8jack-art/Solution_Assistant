import React, { useState, useEffect } from 'react'
import { useNavigate, useParams } from 'react-router-dom'
import { projectApi, investmentApi } from '@/lib/api'
import {
  Container,
  Paper,
  Title,
  Text,
  Button,
  Card,
  Group,
  Stack,
  Table,
  NumberInput,
  Grid,
  Badge,
  Divider,
} from '@mantine/core'
import { notifications } from '@mantine/notifications'
import { useMediaQuery } from '@mantine/hooks'
import LoadingOverlay from '@/components/LoadingOverlay'

// æŠ•èµ„ä¼°ç®—æ•°æ®ç»“æ„
interface InvestmentItem {
  id: string
  åºå·: string
  å·¥ç¨‹æˆ–è´¹ç”¨åç§°: string
  å»ºè®¾å·¥ç¨‹è´¹?: number
  è®¾å¤‡è´­ç½®è´¹?: number
  å®‰è£…å·¥ç¨‹è´¹?: number
  å…¶å®ƒè´¹ç”¨?: number
  åˆè®¡: number
  å æ€»æŠ•èµ„æ¯”ä¾‹?: number
  å¤‡æ³¨?: string
  children?: InvestmentItem[]
}

interface InvestmentEstimate {
  projectId: string
  projectName: string
  targetInvestment: number
  constructionYears: number
  operationYears: number
  loanRatio: number
  loanInterestRate: number
  landCost: number
  
  // A-Géƒ¨åˆ†
  partA: InvestmentItem
  partB: InvestmentItem
  partC: InvestmentItem
  partD: InvestmentItem
  partE: InvestmentItem
  partF: {
    è´·æ¬¾æ€»é¢: number
    å¹´åˆ©ç‡: number
    å»ºè®¾æœŸå¹´é™: number
    åˆ†å¹´åˆ©æ¯: Array<{
      å¹´ä»½: number
      æœŸåˆæœ¬é‡‘ç´¯è®¡: number
      å½“æœŸå€Ÿæ¬¾é‡‘é¢: number
      å½“æœŸåˆ©æ¯: number
    }>
    åˆè®¡: number
    å æ€»æŠ•èµ„æ¯”ä¾‹: number
  }
  partG: InvestmentItem
  
  // è¿­ä»£ä¿¡æ¯
  iterationCount: number
  gapRate: number
}

const InvestmentSummary: React.FC = () => {
  const { id } = useParams()
  const navigate = useNavigate()
  const isMobile = useMediaQuery('(max-width: 768px)')
  
  const [loading, setLoading] = useState(false)
  const [generating, setGenerating] = useState(false)
  const [project, setProject] = useState<any>(null)
  const [estimate, setEstimate] = useState<InvestmentEstimate | null>(null)
  const [errorLog, setErrorLog] = useState<string>('')
  const [showDebug, setShowDebug] = useState(false)

  useEffect(() => {
    if (id) {
      loadProjectAndEstimate()
    }
  }, [id])

  const loadProjectAndEstimate = async () => {
    setLoading(true)
    try {
      // åŠ è½½é¡¹ç›®ä¿¡æ¯
      const projectResponse = await projectApi.getById(id!)
      if (projectResponse.success && projectResponse.data?.project) {
        setProject(projectResponse.data.project)
        
        // æ£€æŸ¥æ˜¯å¦å·²æœ‰æŠ•èµ„ä¼°ç®—
        const estimateResponse = await investmentApi.getByProjectId(id!)
        if (estimateResponse.success && estimateResponse.data?.estimate) {
          // ä½¿ç”¨estimate_dataå­—æ®µä½œä¸ºè¯¦ç»†æ•°æ®
          setEstimate(estimateResponse.data.estimate.estimate_data)
        } else {
          // æ²¡æœ‰ä¼°ç®—ï¼Œè‡ªåŠ¨ç”Ÿæˆ
          await generateEstimate()
        }
      } else {
        notifications.show({
          title: 'âŒ åŠ è½½å¤±è´¥',
          message: projectResponse.error || 'åŠ è½½é¡¹ç›®å¤±è´¥',
          color: 'red',
        })
      }
    } catch (error: any) {
      notifications.show({
        title: 'âŒ åŠ è½½å¤±è´¥',
        message: error.response?.data?.error || 'åŠ è½½é¡¹ç›®å¤±è´¥',
        color: 'red',
      })
    } finally {
      setLoading(false)
    }
  }

  const generateEstimate = async () => {
    setGenerating(true)
    setErrorLog('')
    try {
      const response = await investmentApi.generateSummary(id!)
      console.log('APIå“åº”:', response)
      setErrorLog(`APIå“åº”: ${JSON.stringify(response, null, 2)}`)
      
      if (response.success && response.data) {
        // ä½¿ç”¨summaryä½œä¸ºè¯¦ç»†æ•°æ®
        setEstimate(response.data.summary)
        notifications.show({
          title: 'âœ¨ ç”ŸæˆæˆåŠŸ',
          message: `æŠ•èµ„ä¼°ç®—å·²ç”Ÿæˆï¼Œè¿­ä»£${response.data.summary.iterationCount}æ¬¡ï¼Œå·®è·ç‡${response.data.summary.gapRate?.toFixed(2) || 'N/A'}%`,
          color: 'green',
        })
      } else {
        const errorMsg = response.error || 'ç”ŸæˆæŠ•èµ„ä¼°ç®—å¤±è´¥'
        setErrorLog(`é”™è¯¯: ${errorMsg}\nå®Œæ•´å“åº”: ${JSON.stringify(response, null, 2)}`)
        notifications.show({
          title: 'âŒ ç”Ÿæˆå¤±è´¥',
          message: errorMsg,
          color: 'red',
        })
      }
    } catch (error: any) {
      const errorMsg = error.response?.data?.error || error.message || 'ç”ŸæˆæŠ•èµ„ä¼°ç®—å¤±è´¥'
      const fullError = `é”™è¯¯: ${errorMsg}

Stack: ${error.stack}

Response: ${JSON.stringify(error.response?.data, null, 2)}`
      setErrorLog(fullError)
      console.error('ç”ŸæˆæŠ•èµ„ä¼°ç®—å¤±è´¥:', error)
      
      notifications.show({
        title: 'âŒ ç”Ÿæˆå¤±è´¥',
        message: errorMsg,
        color: 'red',
      })
    } finally {
      setGenerating(false)
    }
  }

  if (loading) {
    return (
      <div style={{ minHeight: '100vh', backgroundColor: '#F5F7FA', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
        <Text>åŠ è½½ä¸­...</Text>
      </div>
    )
  }

  if (!project) {
    return (
      <div style={{ minHeight: '100vh', backgroundColor: '#F5F7FA', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
        <Text>é¡¹ç›®ä¸å­˜åœ¨</Text>
      </div>
    )
  }

  return (
    <div style={{ minHeight: '100vh', backgroundColor: '#F5F7FA' }}>
      <LoadingOverlay visible={generating} message="æ™ºèƒ½ç”ŸæˆæŠ•èµ„ä¼°ç®—" />
      
      {/* Header */}
      <Paper shadow="none" p="0" style={{ height: '50px', borderBottom: '1px solid #E5E6EB', backgroundColor: '#FFFFFF' }}>
        <Container size="xl" px={isMobile ? 'sm' : 'lg'} style={{ height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
          <Title order={isMobile ? 6 : 3} c="#1D2129" style={{ fontSize: isMobile ? '16px' : '20px', fontWeight: 600 }}>
            æŠ•èµ„ä¼°ç®—ç®€è¡¨
          </Title>
          <Button 
            variant="subtle" 
            size={isMobile ? 'xs' : 'sm'}
            onClick={() => navigate('/dashboard')}
            style={{ height: isMobile ? '28px' : '32px', padding: '4px 8px', color: '#1D2129', backgroundColor: 'transparent' }}
          >
            è¿”å›
          </Button>
        </Container>
      </Paper>

      {/* Main Content */}
      <Container size="xl" py={isMobile ? 'md' : 'lg'} px={isMobile ? 'sm' : 'lg'} style={{ maxWidth: '1400px', margin: '0 auto' }}>
        <Stack gap="lg">
          {/* é¡¹ç›®ä¿¡æ¯å¡ç‰‡ */}
          <Card shadow="sm" padding="lg" radius="md" withBorder style={{ borderColor: '#E5E6EB' }}>
            <Stack gap="md">
              <Group justify="space-between">
                <div>
                  <Title order={4} c="#1D2129" style={{ fontSize: '18px', fontWeight: 600, marginBottom: '8px' }}>
                    {project.project_name}
                  </Title>
                  <Group gap="lg">
                    <Text size="sm" c="#86909C">ç›®æ ‡æ€»æŠ•èµ„ï¼š<Text span fw={600} c="#1D2129">{project.total_investment}ä¸‡å…ƒ</Text></Text>
                    <Text size="sm" c="#86909C">å»ºè®¾æœŸï¼š<Text span fw={600} c="#1D2129">{project.construction_years}å¹´</Text></Text>
                    <Text size="sm" c="#86909C">è¿è¥æœŸï¼š<Text span fw={600} c="#1D2129">{project.operation_years}å¹´</Text></Text>
                    <Text size="sm" c="#86909C">è´·æ¬¾æ¯”ä¾‹ï¼š<Text span fw={600} c="#1D2129">{(project.loan_ratio * 100).toFixed(1)}%</Text></Text>
                    <Text size="sm" c="#86909C">å¹´åˆ©ç‡ï¼š<Text span fw={600} c="#1D2129">{(project.loan_interest_rate * 100).toFixed(2)}%</Text></Text>
                  </Group>
                </div>
                <Button 
                  onClick={generateEstimate}
                  disabled={generating}
                  style={{ 
                    height: '40px', 
                    backgroundColor: '#00C48C', 
                    color: '#FFFFFF',
                    borderRadius: '6px',
                    padding: '0 24px',
                    fontSize: '14px',
                    fontWeight: 500,
                    marginRight: '8px'
                  }}
                >
                  {generating ? 'ç”Ÿæˆä¸­...' : 'âœ¨ é‡æ–°ç”ŸæˆæŠ•èµ„ä¼°ç®—'}
                </Button>
                <Button 
                  onClick={() => setShowDebug(!showDebug)}
                  style={{ 
                    height: '40px', 
                    backgroundColor: showDebug ? '#FF4D4F' : '#165DFF', 
                    color: '#FFFFFF',
                    borderRadius: '6px',
                    padding: '0 24px',
                    fontSize: '14px',
                    fontWeight: 500
                  }}
                >
                  {showDebug ? 'éšè—è°ƒè¯•' : 'ğŸ” è°ƒè¯•ä¿¡æ¯'}
                </Button>
              </Group>
            </Stack>
          </Card>

          {/* è°ƒè¯•ä¿¡æ¯é¢æ¿ */}
          {showDebug && (
            <Card shadow="sm" padding="lg" radius="md" withBorder style={{ borderColor: '#E5E6EB', backgroundColor: '#F7F8FA' }}>
              <Stack gap="md">
                <Group justify="space-between">
                  <Text size="sm" c="#1D2129" fw={600}>ğŸ” è°ƒè¯•æ—¥å¿—</Text>
                  <Button 
                    size="xs" 
                    onClick={() => {
                      navigator.clipboard.writeText(errorLog)
                      notifications.show({
                        title: 'âœ… å·²å¤åˆ¶',
                        message: 'é”™è¯¯æ—¥å¿—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿',
                        color: 'green',
                      })
                    }}
                    style={{ backgroundColor: '#165DFF', color: '#FFFFFF' }}
                  >
                    ğŸ“‹ å¤åˆ¶æ—¥å¿—
                  </Button>
                </Group>
                <textarea
                  value={errorLog || 'æš‚æ— é”™è¯¯æ—¥å¿—'}
                  readOnly
                  style={{
                    width: '100%',
                    minHeight: '300px',
                    fontFamily: 'monospace',
                    fontSize: '12px',
                    padding: '12px',
                    border: '1px solid #E5E6EB',
                    borderRadius: '4px',
                    backgroundColor: '#FFFFFF',
                    color: '#1D2129',
                    resize: 'vertical'
                  }}
                />
              </Stack>
            </Card>
          )}

          {/* æŠ•èµ„ä¼°ç®—è¡¨æ ¼ */}
          {!estimate ? (
            <Card shadow="sm" padding="xl" radius="md" withBorder style={{ borderColor: '#E5E6EB' }}>
              <Stack align="center" gap="xl" py="xl">
                <div style={{ fontSize: '64px', opacity: 0.3 }}>ğŸ“Š</div>
                <div style={{ textAlign: 'center' }}>
                  <Text c="#1D2129" size="lg" fw={500} mb="xs">è¿˜æ²¡æœ‰æŠ•èµ„ä¼°ç®—</Text>
                  <Text c="#86909C" size="sm">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹ç”ŸæˆæŠ•èµ„ä¼°ç®—ç®€è¡¨</Text>
                </div>
              </Stack>
            </Card>
          ) : (
            <Stack gap="md">
              {/* è¿­ä»£ä¿¡æ¯ */}
              <Card shadow="sm" padding="md" radius="md" withBorder style={{ borderColor: '#E5E6EB' }}>
                <Group gap="xl">
                  <div>
                    <Text size="xs" c="#86909C" mb={4}>è¿­ä»£æ¬¡æ•°</Text>
                    <Text size="lg" fw={600} c="#165DFF">{estimate.iterationCount} æ¬¡</Text>
                  </div>
                  <div>
                    <Text size="xs" c="#86909C" mb={4}>å·®è·ç‡</Text>
                    <Text size="lg" fw={600} c={Math.abs(estimate.gapRate) < 5 ? '#00C48C' : '#FF4D4F'}>
                      {estimate.gapRate?.toFixed(2) || 'N/A'}%
                    </Text>
                  </div>
                  <div>
                    <Text size="xs" c="#86909C" mb={4}>é¡¹ç›®æ€»èµ„é‡‘</Text>
                    <Text size="lg" fw={600} c="#1D2129">{estimate.partG.åˆè®¡?.toFixed(2) || 0} ä¸‡å…ƒ</Text>
                  </div>
                  <div>
                    <Text size="xs" c="#86909C" mb={4}>å»ºè®¾æŠ•èµ„</Text>
                    <Text size="lg" fw={600} c="#1D2129">{estimate.partE.åˆè®¡?.toFixed(2) || 0} ä¸‡å…ƒ</Text>
                  </div>
                  <div>
                    <Text size="xs" c="#86909C" mb={4}>å»ºè®¾æœŸåˆ©æ¯</Text>
                    <Text size="lg" fw={600} c="#1D2129">{estimate.partF.åˆè®¡?.toFixed(2) || 0} ä¸‡å…ƒ</Text>
                  </div>
                </Group>
              </Card>

              {/* Aéƒ¨åˆ†ï¼šå·¥ç¨‹è´¹ç”¨ */}
              <Card shadow="sm" padding="lg" radius="md" withBorder style={{ borderColor: '#E5E6EB' }}>
                <Text size="sm" c="#1D2129" fw={600} mb="md">A. ç¬¬ä¸€éƒ¨åˆ† å·¥ç¨‹è´¹ç”¨</Text>
                <Table highlightOnHover withTableBorder withColumnBorders>
                  <Table.Thead>
                    <Table.Tr style={{ backgroundColor: '#F7F8FA' }}>
                      <Table.Th style={{ width: '80px' }}>åºå·</Table.Th>
                      <Table.Th>å·¥ç¨‹æˆ–è´¹ç”¨åç§°</Table.Th>
                      <Table.Th style={{ width: '120px', textAlign: 'right' }}>å»ºè®¾å·¥ç¨‹è´¹</Table.Th>
                      <Table.Th style={{ width: '120px', textAlign: 'right' }}>è®¾å¤‡è´­ç½®è´¹</Table.Th>
                      <Table.Th style={{ width: '120px', textAlign: 'right' }}>å®‰è£…å·¥ç¨‹è´¹</Table.Th>
                      <Table.Th style={{ width: '120px', textAlign: 'right' }}>å…¶å®ƒè´¹ç”¨</Table.Th>
                      <Table.Th style={{ width: '120px', textAlign: 'right' }}>åˆè®¡</Table.Th>
                    </Table.Tr>
                  </Table.Thead>
                  <Table.Tbody>
                    {estimate.partA.children?.map((item, index) => (
                      <Table.Tr key={index}>
                        <Table.Td>{item.åºå·}</Table.Td>
                        <Table.Td>{item.å·¥ç¨‹æˆ–è´¹ç”¨åç§°}</Table.Td>
                        <Table.Td style={{ textAlign: 'right' }}>{item.å»ºè®¾å·¥ç¨‹è´¹?.toFixed(2) || '-'}</Table.Td>
                        <Table.Td style={{ textAlign: 'right' }}>{item.è®¾å¤‡è´­ç½®è´¹?.toFixed(2) || '-'}</Table.Td>
                        <Table.Td style={{ textAlign: 'right' }}>{item.å®‰è£…å·¥ç¨‹è´¹?.toFixed(2) || '-'}</Table.Td>
                        <Table.Td style={{ textAlign: 'right' }}>{item.å…¶å®ƒè´¹ç”¨?.toFixed(2) || '-'}</Table.Td>
                        <Table.Td style={{ textAlign: 'right', fontWeight: 600 }}>{item.åˆè®¡?.toFixed(2) || '0.00'}</Table.Td>
                      </Table.Tr>
                    ))}
                    <Table.Tr style={{ backgroundColor: '#F7F8FA' }}>
                      <Table.Td colSpan={6} style={{ fontWeight: 600 }}>åˆè®¡</Table.Td>
                      <Table.Td style={{ textAlign: 'right', fontWeight: 600, color: '#165DFF' }}>
                        {estimate.partA.åˆè®¡?.toFixed(2) || '0.00'}
                      </Table.Td>
                    </Table.Tr>
                  </Table.Tbody>
                </Table>
              </Card>

              {/* Béƒ¨åˆ†ï¼šå·¥ç¨‹å…¶å®ƒè´¹ç”¨ */}
              <Card shadow="sm" padding="lg" radius="md" withBorder style={{ borderColor: '#E5E6EB' }}>
                <Text size="sm" c="#1D2129" fw={600} mb="md">B. ç¬¬äºŒéƒ¨åˆ† å·¥ç¨‹å…¶å®ƒè´¹ç”¨</Text>
                <Table highlightOnHover withTableBorder withColumnBorders>
                  <Table.Thead>
                    <Table.Tr style={{ backgroundColor: '#F7F8FA' }}>
                      <Table.Th style={{ width: '80px' }}>åºå·</Table.Th>
                      <Table.Th>å·¥ç¨‹æˆ–è´¹ç”¨åç§°</Table.Th>
                      <Table.Th style={{ width: '150px', textAlign: 'right' }}>åˆè®¡ï¼ˆä¸‡å…ƒï¼‰</Table.Th>
                      <Table.Th style={{ width: '200px' }}>å¤‡æ³¨</Table.Th>
                    </Table.Tr>
                  </Table.Thead>
                  <Table.Tbody>
                    {estimate.partB.children?.map((item, index) => (
                      <Table.Tr key={index}>
                        <Table.Td>{item.åºå·}</Table.Td>
                        <Table.Td>{item.å·¥ç¨‹æˆ–è´¹ç”¨åç§°}</Table.Td>
                        <Table.Td style={{ textAlign: 'right', fontWeight: item.åºå· === '11' ? 600 : 400 }}>
                          {typeof item.åˆè®¡ === 'number' ? item.åˆè®¡.toFixed(2) : '0.00'}
                        </Table.Td>
                        <Table.Td style={{ fontSize: '12px', color: '#86909C' }}>{item.å¤‡æ³¨}</Table.Td>
                      </Table.Tr>
                    ))}
                    <Table.Tr style={{ backgroundColor: '#F7F8FA' }}>
                      <Table.Td colSpan={2} style={{ fontWeight: 600 }}>åˆè®¡</Table.Td>
                      <Table.Td style={{ textAlign: 'right', fontWeight: 600, color: '#165DFF' }}>
                        {typeof estimate.partB.åˆè®¡ === 'number' ? estimate.partB.åˆè®¡.toFixed(2) : '0.00'}
                      </Table.Td>
                      <Table.Td></Table.Td>
                    </Table.Tr>
                  </Table.Tbody>
                </Table>
              </Card>

              {/* C-Géƒ¨åˆ†æ±‡æ€» */}
              <Card shadow="sm" padding="lg" radius="md" withBorder style={{ borderColor: '#E5E6EB' }}>
                <Text size="sm" c="#1D2129" fw={600} mb="md">æŠ•èµ„æ±‡æ€»</Text>
                <Table highlightOnHover withTableBorder withColumnBorders>
                  <Table.Thead>
                    <Table.Tr style={{ backgroundColor: '#F7F8FA' }}>
                      <Table.Th style={{ width: '80px' }}>åºå·</Table.Th>
                      <Table.Th>å·¥ç¨‹æˆ–è´¹ç”¨åç§°</Table.Th>
                      <Table.Th style={{ width: '150px', textAlign: 'right' }}>åˆè®¡ï¼ˆä¸‡å…ƒï¼‰</Table.Th>
                      <Table.Th style={{ width: '120px', textAlign: 'right' }}>å æ€»æŠ•èµ„æ¯”ä¾‹</Table.Th>
                      <Table.Th style={{ width: '180px' }}>å¤‡æ³¨</Table.Th>
                    </Table.Tr>
                  </Table.Thead>
                  <Table.Tbody>
                    {[estimate.partC, estimate.partD, estimate.partE].map((part, index) => (
                      <Table.Tr key={index}>
                        <Table.Td>{part.åºå·}</Table.Td>
                        <Table.Td>{part.å·¥ç¨‹æˆ–è´¹ç”¨åç§°}</Table.Td>
                        <Table.Td style={{ textAlign: 'right', fontWeight: 600 }}>
                          {typeof part.åˆè®¡ === 'number' ? part.åˆè®¡.toFixed(2) : '0.00'}
                        </Table.Td>
                        <Table.Td style={{ textAlign: 'right' }}>
                          {part.å æ€»æŠ•èµ„æ¯”ä¾‹ ? `${part.å æ€»æŠ•èµ„æ¯”ä¾‹.toFixed(2)}%` : '-'}
                        </Table.Td>
                        <Table.Td style={{ fontSize: '12px', color: '#86909C' }}>{part.å¤‡æ³¨}</Table.Td>
                      </Table.Tr>
                    ))}
                    <Table.Tr>
                      <Table.Td>F</Table.Td>
                      <Table.Td>å»ºè®¾æœŸåˆ©æ¯</Table.Td>
                      <Table.Td style={{ textAlign: 'right', fontWeight: 600 }}>
                        {estimate.partF.åˆè®¡?.toFixed(2) || '0.00'}
                      </Table.Td>
                      <Table.Td style={{ textAlign: 'right' }}>
                        {estimate.partF.å æ€»æŠ•èµ„æ¯”ä¾‹ ? `${estimate.partF.å æ€»æŠ•èµ„æ¯”ä¾‹.toFixed(2)}%` : '-'}
                      </Table.Td>
                      <Table.Td style={{ fontSize: '12px', color: '#86909C' }}>
                        è´·æ¬¾æ€»é¢: {estimate.partF.è´·æ¬¾æ€»é¢?.toFixed(2) || '0.00'}ä¸‡å…ƒ
                      </Table.Td>
                    </Table.Tr>
                    <Table.Tr style={{ backgroundColor: '#FFF7E6', borderTop: '2px solid #165DFF' }}>
                      <Table.Td style={{ fontWeight: 700 }}>{estimate.partG.åºå·}</Table.Td>
                      <Table.Td style={{ fontWeight: 700 }}>{estimate.partG.å·¥ç¨‹æˆ–è´¹ç”¨åç§°}</Table.Td>
                      <Table.Td style={{ textAlign: 'right', fontWeight: 700, color: '#165DFF', fontSize: '16px' }}>
                        {typeof estimate.partG.åˆè®¡ === 'number' ? estimate.partG.åˆè®¡.toFixed(2) : '0.00'}
                      </Table.Td>
                      <Table.Td style={{ textAlign: 'right', fontWeight: 700 }}>100%</Table.Td>
                      <Table.Td style={{ fontSize: '12px', color: '#86909C' }}>{estimate.partG.å¤‡æ³¨}</Table.Td>
                    </Table.Tr>
                  </Table.Tbody>
                </Table>
              </Card>
            </Stack>
          )}
        </Stack>
      </Container>
    </div>
  )
}

export default InvestmentSummary
