# è¥æ”¶æˆæœ¬å»ºæ¨¡æŠ€æœ¯æ–‡æ¡£

> æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0  
> åˆ›å»ºæ—¥æœŸï¼š2025-12-17  
> æŠ€æœ¯æ ˆï¼šReact 18 + TypeScript + Node.js + Express + SQLite

---

## ç›®å½•

1. [æŠ€æœ¯æ¶æ„](#ä¸€æŠ€æœ¯æ¶æ„)
2. [æ ¸å¿ƒæ¨¡å—](#äºŒæ ¸å¿ƒæ¨¡å—)
3. [æ•°æ®ç»“æ„](#ä¸‰æ•°æ®ç»“æ„)
4. [APIæ¥å£](#å››apiæ¥å£)
5. [LLMé›†æˆ](#äº”llmé›†æˆ)
6. [çŠ¶æ€ç®¡ç†](#å…­çŠ¶æ€ç®¡ç†)
7. [ç®—æ³•å®ç°](#ä¸ƒç®—æ³•å®ç°)
8. [æ€§èƒ½ä¼˜åŒ–](#å…«æ€§èƒ½ä¼˜åŒ–)
9. [é”™è¯¯å¤„ç†](#ä¹é”™è¯¯å¤„ç†)
10. [æµ‹è¯•æŒ‡å—](#åæµ‹è¯•æŒ‡å—)

---

## ä¸€ã€æŠ€æœ¯æ¶æ„

### 1.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å‰ç«¯å±‚ (Client)                        â”‚
â”‚  React 18 + TypeScript + Mantine UI + Zustand                â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ é¡µé¢ç»„ä»¶å±‚    â”‚  â”‚  ä¸šåŠ¡é€»è¾‘å±‚   â”‚  â”‚  çŠ¶æ€ç®¡ç†å±‚   â”‚       â”‚
â”‚  â”‚ RevenueCost  â”‚  â”‚  Hooks       â”‚  â”‚  Zustand     â”‚       â”‚
â”‚  â”‚ Modeling     â”‚  â”‚  Utils       â”‚  â”‚  Store       â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†• HTTP/REST API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åç«¯å±‚ (Server)                         â”‚
â”‚         Node.js + Express + TypeScript + SQLite              â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚   è·¯ç”±å±‚      â”‚  â”‚  æ§åˆ¶å™¨å±‚     â”‚  â”‚   æ¨¡å‹å±‚      â”‚       â”‚
â”‚  â”‚   Routes     â”‚  â”‚ Controllers  â”‚  â”‚   Models     â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚  æœåŠ¡å±‚       â”‚  â”‚  æ•°æ®åº“å±‚     â”‚                         â”‚
â”‚  â”‚  LLM Service â”‚  â”‚  SQLite      â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†• LLM API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å¤–éƒ¨æœåŠ¡å±‚ (External)                      â”‚
â”‚          OpenAI / DeepSeek / é˜¿é‡Œé€šä¹‰ / å…¶ä»–LLM               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æŠ€æœ¯é€‰å‹

#### å‰ç«¯æŠ€æœ¯æ ˆ
| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| React | 18.x | UIæ¡†æ¶ |
| TypeScript | 5.x | ç±»å‹å®‰å…¨ |
| Mantine | 7.x | UIç»„ä»¶åº“ |
| Zustand | 4.x | çŠ¶æ€ç®¡ç† |
| Axios | 1.x | HTTPå®¢æˆ·ç«¯ |
| Vite | 5.x | æ„å»ºå·¥å…· |

#### åç«¯æŠ€æœ¯æ ˆ
| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Node.js | 18.x | è¿è¡Œæ—¶ |
| Express | 4.x | Webæ¡†æ¶ |
| TypeScript | 5.x | ç±»å‹å®‰å…¨ |
| SQLite | 3.x | æ•°æ®åº“ |
| Zod | 3.x | æ•°æ®éªŒè¯ |

---

## äºŒã€æ ¸å¿ƒæ¨¡å—

### 2.1 å‰ç«¯æ¨¡å—ç»“æ„

```
client/src/
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ RevenueCostModeling.tsx      # ä¸»é¡µé¢ç»„ä»¶ï¼ˆ3000+è¡Œï¼‰
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ revenue-cost/
â”‚   â”‚   â”œâ”€â”€ RevenueCategoryModal.tsx # è¥æ”¶ç±»åˆ«ç¼–è¾‘å¼¹çª—
â”‚   â”‚   â””â”€â”€ RevenueTypeModal.tsx     # æ”¶å…¥ç±»å‹ç¼–è¾‘å¼¹çª—
â”‚   â””â”€â”€ RevenueItemModal.tsx         # æ”¶å…¥é¡¹ç¼–è¾‘å¼¹çª—
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ api.ts                       # APIæ¥å£å®šä¹‰
â”‚   â””â”€â”€ utils.ts                     # å·¥å…·å‡½æ•°
â”œâ”€â”€ stores/
â”‚   â””â”€â”€ revenueCostStore.ts          # ZustandçŠ¶æ€ç®¡ç†
â””â”€â”€ types/
    â””â”€â”€ index.ts                      # TypeScriptç±»å‹å®šä¹‰
```

### 2.2 åç«¯æ¨¡å—ç»“æ„

```
server/src/
â”œâ”€â”€ routes/
â”‚   â””â”€â”€ revenueCost.ts               # è·¯ç”±å®šä¹‰
â”œâ”€â”€ controllers/
â”‚   â””â”€â”€ revenueCostController.ts     # ä¸šåŠ¡æ§åˆ¶å™¨
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ InvestmentProject.ts         # é¡¹ç›®æ¨¡å‹
â”‚   â””â”€â”€ InvestmentEstimate.ts        # æŠ•èµ„ä¼°ç®—æ¨¡å‹
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ llm.ts                       # LLMæ ¸å¿ƒæœåŠ¡
â”‚   â”œâ”€â”€ llmProviders.ts              # LLMæä¾›å•†é›†æˆ
â”‚   â””â”€â”€ algorithms/                  # ç®—æ³•åº“
â”‚       â”œâ”€â”€ loanCalculator.ts        # è´·æ¬¾è®¡ç®—
â”‚       â””â”€â”€ depreciationCalculator.ts # æŠ˜æ—§æ‘Šé”€è®¡ç®—
â””â”€â”€ types/
    â””â”€â”€ index.ts                      # TypeScriptç±»å‹å®šä¹‰
```

---

## ä¸‰ã€æ•°æ®ç»“æ„

### 3.1 è¥æ”¶ç»“æ„è¡¨æ•°æ®ç»“æ„

```typescript
interface AIAnalysisResult {
  selected_categories: RevenueCategory[]
  total_categories: number
  analysis_summary: string
}

interface RevenueCategory {
  category_code: string           // ç±»åˆ«ä»£ç  A-N
  category_name: string           // ç±»åˆ«åç§°
  category_icon: string           // å›¾æ ‡emoji
  relevance_score: number         // ç›¸å…³åº¦ 0-1
  reasoning: string               // æ¨èç†ç”±
  recommended_revenue_types: RevenueType[]
}

interface RevenueType {
  type_name: string               // æ”¶å…¥ç±»å‹åç§°
  priority: 'high' | 'medium' | 'low'  // ä¼˜å…ˆçº§
  suggested_vat_rate: number      // å»ºè®®ç¨ç‡ï¼ˆå°æ•°ï¼‰
  typical_pricing_model: string   // è®¡è´¹æ¨¡å¼
  estimated_proportion: string    // é¢„è®¡å æ¯”ï¼ˆç™¾åˆ†æ¯”ï¼‰
}
```

### 3.2 æ”¶å…¥é¡¹ç›®æ•°æ®ç»“æ„

```typescript
interface RevenueItem {
  id: string                      // å”¯ä¸€æ ‡è¯†
  name: string                    // æ”¶å…¥é¡¹åç§°
  category: RevenueCategory       // ç±»åˆ«
  unit: string                    // è®¡é‡å•ä½
  quantity: number                // å¹´äº§é‡/è§„æ¨¡
  unitPrice: number               // å•ä»·ï¼ˆå…ƒï¼‰
  annualRevenue: number           // å¹´æ”¶å…¥ï¼ˆä¸‡å…ƒï¼Œå«ç¨ï¼‰
  vatRate: number                 // å¢å€¼ç¨ç‡ï¼ˆ%ï¼‰
  nonTaxRevenue: number           // ä¸å«ç¨æ”¶å…¥ï¼ˆä¸‡å…ƒï¼‰
  vatAmount: number               // å¢å€¼ç¨é¢ï¼ˆä¸‡å…ƒï¼‰
  // å¯é€‰å­—æ®µ
  variety?: string                // å“ç§
  acreage?: number                // äº©æ•°
  yieldPerAcre?: number           // å¹´äº§é‡ï¼ˆå¨/äº©ï¼‰
  pricingModel?: string           // æ”¶è´¹æ¨¡å¼
  serviceScale?: string           // æœåŠ¡è§„æ¨¡
}

type RevenueCategory = 
  | 'agriculture-crop'            // å†œä¸šç§æ¤
  | 'agriculture-aquaculture'     // æ°´äº§å…»æ®–
  | 'digital-platform'            // æ•°å­—å¹³å°
  | 'transaction-hub'             // äº¤æ˜“å¹³å°
  | 'other'                       // å…¶ä»–
```

### 3.3 è¿˜æœ¬ä»˜æ¯æ•°æ®ç»“æ„

```typescript
interface RepaymentRow {
  åºå·: string                    // è¡Œå·
  é¡¹ç›®: string                    // é¡¹ç›®åç§°
  åˆè®¡: number | null             // åˆè®¡å€¼
  åˆ†å¹´æ•°æ®: number[]              // å„å¹´æ•°æ®
  isMainRow?: boolean             // æ˜¯å¦ä¸ºä¸»è¡Œ
}

interface RepaymentPlan {
  loanAmount: number              // è´·æ¬¾æ€»é¢
  loanYears: number               // è´·æ¬¾å¹´é™
  interestRate: number            // å¹´åˆ©ç‡ï¼ˆå°æ•°ï¼‰
  monthlyPrincipal: number        // æ¯æœˆè¿˜æœ¬é‡‘é¢
  totalInterest: number           // æ€»åˆ©æ¯
  rows: RepaymentRow[]            // è¡¨æ ¼æ•°æ®
}
```

---

## å››ã€APIæ¥å£

### 4.1 è¥æ”¶ç»“æ„AIæ¨è

**æ¥å£åœ°å€**ï¼š`POST /api/revenue-cost/ai-recommend/:projectId`

**è¯·æ±‚å‚æ•°**ï¼š
```typescript
{
  projectInfo?: string             // é¡¹ç›®æè¿°
  engineeringItems?: Array<{
    name: string                   // å·¥ç¨‹åç§°
    amount: number                 // é‡‘é¢
  }>
}
```

**å“åº”æ•°æ®**ï¼š
```typescript
{
  success: boolean
  data: {
    analysis: AIAnalysisResult
    config_name: string            // ä½¿ç”¨çš„LLMé…ç½®åç§°
  }
  error?: string
}
```

**å®ç°ä½ç½®**ï¼š`server/src/controllers/revenueCostController.ts`

```typescript
static async aiRecommend(req: AuthRequest, res: Response) {
  const { projectId } = req.params
  const userId = req.userId!
  
  // 1. è·å–é¡¹ç›®æ•°æ®
  const project = await InvestmentProjectModel.findById(projectId, userId)
  
  // 2. è·å–LLMé…ç½®
  const llmConfig = await LLMConfigModel.findDefaultByUserId(userId)
  
  // 3. æ„å»ºPrompt
  const messages = analyzeRevenueStructurePrompt(
    project.project_name,
    params.projectInfo || project.project_info || '',
    project.total_investment,
    engineeringItems
  )
  
  // 4. è°ƒç”¨LLM
  const llmResponse = await LLMService.generateContent(
    llmConfig, 
    messages, 
    { maxTokens: 2000, temperature: 0.7 }
  )
  
  // 5. è§£æå¹¶è¿”å›ç»“æœ
  const analysis = JSON.parse(llmResponse.content)
  return res.json({ success: true, data: { analysis, config_name } })
}
```

### 4.2 æ”¶å…¥é¡¹ç›®ç”Ÿæˆï¼ˆå¾…å®ç°ï¼‰

**æ¥å£åœ°å€**ï¼š`POST /api/revenue-cost/generate-items/:projectId`

**è¯·æ±‚å‚æ•°**ï¼š
```typescript
{
  revenueStructure: AIAnalysisResult  // è¥æ”¶ç»“æ„è¡¨
  investmentData: {
    total_investment: number
    construction_years: number
    operation_years: number
    construction_cost: number
    equipment_cost: number
  }
}
```

**å“åº”æ•°æ®**ï¼š
```typescript
{
  success: boolean
  data: {
    revenue_items: Array<{
      name: string
      category: string
      unit: string
      quantity: number
      unitPrice: number
      vatRate: number
    }>
  }
}
```

### 4.3 AIåˆ†æç¨ç‡å’Œè®¡è´¹æ¨¡å¼ï¼ˆå¾…å®ç°ï¼‰

**æ¥å£åœ°å€**ï¼š`POST /api/revenue-cost/analyze-pricing`

**è¯·æ±‚å‚æ•°**ï¼š
```typescript
{
  type_name: string                // è¥ä¸šæ”¶å…¥ç±»å‹åç§°
}
```

**å“åº”æ•°æ®**ï¼š
```typescript
{
  success: boolean
  data: {
    vat_rate: number               // ç¨ç‡ï¼ˆ%ï¼‰
    pricing_model: string          // è®¡è´¹æ¨¡å¼
  }
}
```

---

## äº”ã€LLMé›†æˆ

### 5.1 LLMæœåŠ¡æ¶æ„

```typescript
// server/src/lib/llm.ts

class LLMService {
  // ç”Ÿæˆå†…å®¹çš„æ ¸å¿ƒæ–¹æ³•
  static async generateContent(
    config: LLMConfig,
    messages: LLMMessage[],
    options: LLMOptions
  ): Promise<LLMResponse> {
    const provider = this.getProvider(config.provider)
    return await provider.generateContent(config, messages, options)
  }
  
  // è·å–æä¾›å•†å®ä¾‹
  private static getProvider(providerName: string): LLMProvider {
    switch (providerName) {
      case 'openai': return new OpenAIProvider()
      case 'deepseek': return new DeepSeekProvider()
      case 'tongyi': return new TongyiProvider()
      default: throw new Error('Unsupported provider')
    }
  }
}
```

### 5.2 Promptå·¥ç¨‹

#### 5.2.1 è¥æ”¶ç»“æ„åˆ†æPrompt

```typescript
export function analyzeRevenueStructurePrompt(
  projectName: string,
  projectDescription: string,
  totalInvestment: number,
  engineeringItems?: Array<{ name: string; amount: number }>
): LLMMessage[] {
  
  const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„äº§ä¸šæ”¶å…¥ç»“æ„åˆ†æä¸“å®¶ã€‚
æ ¹æ®é¡¹ç›®ä¿¡æ¯ï¼Œä»ä»¥ä¸‹14ä¸ªç±»åˆ«ä¸­é€‰å‡º2-6ä¸ªæœ€åˆé€‚çš„è¥ä¸šæ”¶å…¥ç±»åˆ«ï¼Œ
å¹¶ä¸ºæ¯ä¸ªç±»åˆ«æ¨è3-8ä¸ªå…·ä½“çš„è¥ä¸šæ”¶å…¥ç±»å‹ã€‚

## è¥ä¸šæ”¶å…¥ç±»å‹è¡¨ï¼ˆ14ä¸ªç±»åˆ«ï¼‰ï¼š

| åºå· | ç±»åˆ« | å¯èƒ½çš„è¥ä¸šæ”¶å…¥ç±»å‹ |
|------|------|-------------------|
| ğŸ”¹ A | ğŸ–¥ï¸ æ•°å­—å¹³å°ç±» | SaaSå¹³å°ä¼šå‘˜è´¹ã€AIå†³ç­–æ”¯æŒå¢å€¼æœåŠ¡è´¹... |
| ğŸŒ± B | ğŸŒ¾ å†œä¸šç§æ¤ç±» | ä¸­è¯æé”€å”®æ”¶å…¥ã€ç§è‹—é”€å”®æ”¶å…¥... |
| ... (å®Œæ•´14ä¸ªç±»åˆ«)

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š
{
  "selected_categories": [
    {
      "category_code": "ç±»åˆ«ä»£ç (A-N)",
      "category_name": "ç±»åˆ«åç§°",
      "category_icon": "ç±»åˆ«å›¾æ ‡",
      "relevance_score": 0.0-1.0çš„ç›¸å…³åº¦è¯„åˆ†,
      "reasoning": "ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸ªç±»åˆ«çš„ç®€çŸ­ç†ç”±ï¼ˆ50å­—ä»¥å†…ï¼‰",
      "recommended_revenue_types": [
        {
          "type_name": "å…·ä½“è¥ä¸šæ”¶å…¥ç±»å‹åç§°",
          "priority": "high|medium|low",
          "suggested_vat_rate": å¢å€¼ç¨ç‡(å¦‚0.13è¡¨ç¤º13%),
          "typical_pricing_model": "è®¡è´¹æ¨¡å¼è¯´æ˜",
          "estimated_proportion": "é¢„è®¡å æ€»æ”¶å…¥çš„ç™¾åˆ†æ¯”(0-100)"
        }
      ]
    }
  ],
  "total_categories": é€‰ä¸­çš„ç±»åˆ«æ•°é‡,
  "analysis_summary": "æ•´ä½“åˆ†ææ€»ç»“ï¼ˆ100å­—ä»¥å†…ï¼‰"
}`

  const userPrompt = `
# é¡¹ç›®åˆ†æä»»åŠ¡

## é¡¹ç›®åŸºæœ¬ä¿¡æ¯
- é¡¹ç›®åç§°ï¼š${projectName}
- é¡¹ç›®æè¿°ï¼š${projectDescription}
- æ€»æŠ•èµ„ï¼š${totalInvestment} ä¸‡å…ƒ

## å·¥ç¨‹é¡¹ç›®åˆ—è¡¨
${engineeringItems?.map(item => 
  `- ${item.name}ï¼š${item.amount} ä¸‡å…ƒ`
).join('\n') || 'æ— '}

è¯·åŸºäºä»¥ä¸Šä¿¡æ¯è¿›è¡Œåˆ†æã€‚`

  return [
    { role: 'system', content: systemPrompt },
    { role: 'user', content: userPrompt }
  ]
}
```

#### 5.2.2 ç¨ç‡è®¡è´¹æ¨¡å¼åˆ†æPrompt

```typescript
export function analyzePricingPrompt(
  typeName: string
): LLMMessage[] {
  
  const systemPrompt = `ä½œä¸ºä¸€ä¸ªä¸“ä¸šçš„è´¢åŠ¡é¡¾é—®ï¼Œ
æ ¹æ®è¥ä¸šæ”¶å…¥ç±»å‹çš„åç§°ï¼Œæ¨ç†å…¶åˆé€‚çš„å¢å€¼ç¨ç¨ç‡å’Œè®¡è´¹æ¨¡å¼ã€‚

å‚è€ƒè§„åˆ™ï¼š
- å†œäº§å“é”€å”®ï¼š9%
- æœåŠ¡ä¸šï¼š6%
- å·¥ä¸šäº§å“é”€å”®ï¼š13%
- ç§ŸèµæœåŠ¡ï¼š9%

è®¡è´¹æ¨¡å¼ç¤ºä¾‹ï¼š
- é”€å”®ç±»ï¼šæŒ‰é‡é‡é”€å”®ã€æŒ‰æ•°é‡é”€å”®
- æœåŠ¡ç±»ï¼šæŒ‰æœåŠ¡æ¬¡æ•°ã€æŒ‰é¢ç§¯ã€æŒ‰å°æ—¶
- ç§Ÿèµç±»ï¼šæŒ‰æœˆç§Ÿèµã€æŒ‰å¹´ç§Ÿèµ
- è®¢é˜…ç±»ï¼šæŒ‰æœˆè®¢é˜…ã€æŒ‰å¹´è®¢é˜…

è¯·ä»¥JSONæ ¼å¼è¿”å›ï¼š
{
  "vat_rate": å¢å€¼ç¨ç‡ï¼ˆå•ä½ï¼š%ï¼Œå¦‚ï¼š9ã€13ï¼‰,
  "pricing_model": "è®¡è´¹æ¨¡å¼ï¼ˆä¸è¶…è¿‡15å­—ï¼‰"
}`

  const userPrompt = `è¥ä¸šæ”¶å…¥ç±»å‹ï¼š${typeName}`

  return [
    { role: 'system', content: systemPrompt },
    { role: 'user', content: userPrompt }
  ]
}
```

#### 5.2.3 æ”¶å…¥é¡¹ç›®ç”ŸæˆPrompt

```typescript
export function generateRevenueItemsPrompt(
  projectInfo: {
    name: string
    description: string
    totalInvestment: number
    constructionYears: number
    operationYears: number
  },
  revenueSummary: string
): LLMMessage[] {
  
  const systemPrompt = `ä½œä¸ºä¸€ä¸ªä¸“ä¸šçš„è´¢åŠ¡åˆ†æå¸ˆï¼Œ
æ ¹æ®é¡¹ç›®ä¿¡æ¯ã€æŠ•èµ„æ•°æ®å’Œè¥æ”¶ç»“æ„è¡¨ï¼Œç”Ÿæˆè¯¦ç»†çš„è¥ä¸šæ”¶å…¥é¡¹ç›®è¡¨ã€‚

è¯·ä»¥JSONæ ¼å¼è¿”å›ï¼š
{
  "revenue_items": [
    {
      "name": "æ”¶å…¥é¡¹åç§°",
      "category": "agriculture-crop | agriculture-aquaculture | digital-platform | transaction-hub | other",
      "unit": "è®¡é‡å•ä½",
      "quantity": å¹´äº§é‡æ•°å€¼,
      "unitPrice": å•ä»·æ•°å€¼(å…ƒ),
      "vatRate": å¢å€¼ç¨ç‡æ•°å€¼(%)
    }
  ]
}

è¦æ±‚ï¼š
1. ç”Ÿæˆ 3-8 ä¸ªæ”¶å…¥é¡¹
2. æ•°æ®ç¬¦åˆè¡Œä¸šå¸¸è¯†å’Œé¡¹ç›®è§„æ¨¡
3. category å¿…é¡»æ˜¯æšä¸¾å€¼ä¹‹ä¸€
4. å¢å€¼ç¨ç‡å‚è€ƒï¼šå†œäº§å“ 9%ã€æœåŠ¡ä¸š 6%ã€å·¥ä¸šäº§å“ 13%`

  const userPrompt = `
## é¡¹ç›®ä¿¡æ¯
- åç§°ï¼š${projectInfo.name}
- æè¿°ï¼š${projectInfo.description}
- æ€»æŠ•èµ„ï¼š${projectInfo.totalInvestment}ä¸‡å…ƒ
- å»ºè®¾æœŸï¼š${projectInfo.constructionYears}å¹´
- è¿è¥æœŸï¼š${projectInfo.operationYears}å¹´

## è¥æ”¶ç»“æ„è¡¨
${revenueSummary}
`

  return [
    { role: 'system', content: systemPrompt },
    { role: 'user', content: userPrompt }
  ]
}
```

### 5.3 LLMé…ç½®ç®¡ç†

```typescript
interface LLMConfig {
  id: number
  user_id: number
  config_name: string
  provider: 'openai' | 'deepseek' | 'tongyi' | 'custom'
  api_key: string
  base_url?: string
  model_name: string
  max_tokens: number
  temperature: number
  is_default: boolean
  created_at: string
  updated_at: string
}

// è·å–é»˜è®¤é…ç½®
const llmConfig = await LLMConfigModel.findDefaultByUserId(userId)

// è°ƒç”¨LLM
const response = await LLMService.generateContent(
  llmConfig,
  messages,
  { maxTokens: 2000, temperature: 0.7 }
)
```

---

## å…­ã€çŠ¶æ€ç®¡ç†

### 6.1 Zustand Store

```typescript
// client/src/stores/revenueCostStore.ts

interface RevenueCostState {
  // ä¸Šä¸‹æ–‡æ•°æ®
  context: {
    projectId: string
    projectName: string
    constructionYears: number
    operationYears: number
    totalInvestment: number
  }
  
  // å½“å‰æ­¥éª¤
  currentStep: 'basic-data' | 'depreciation' | 'ai-recommend' | 
               'revenue-modeling' | 'cost-modeling' | 'profit-tax'
  
  // Actions
  setContext: (context: Partial<Context>) => void
  setCurrentStep: (step: Step) => void
}

export const useRevenueCostStore = create<RevenueCostState>((set) => ({
  context: {
    projectId: '',
    projectName: '',
    constructionYears: 0,
    operationYears: 0,
    totalInvestment: 0,
  },
  currentStep: 'basic-data',
  
  setContext: (context) => set((state) => ({
    context: { ...state.context, ...context }
  })),
  
  setCurrentStep: (step) => set({ currentStep: step }),
}))
```

### 6.2 ç»„ä»¶å†…çŠ¶æ€

```typescript
// é¡µé¢çº§çŠ¶æ€
const [loading, setLoading] = useState(true)
const [project, setProject] = useState<any>(null)
const [investmentEstimate, setInvestmentEstimate] = useState<InvestmentEstimate | null>(null)

// åŸºç¡€æ•°æ®çŠ¶æ€
const [repaymentPeriod, setRepaymentPeriod] = useState(0)
const [constructionDepreciationYears, setConstructionDepreciationYears] = useState(50)
const [constructionResidualRate, setConstructionResidualRate] = useState(5)
// ...å…¶ä»–åŸºç¡€å‚æ•°

// AIæ¨èç›¸å…³çŠ¶æ€
const [aiAnalysisResult, setAiAnalysisResult] = useState<any>(null)
const [generatingSuggestions, setGeneratingSuggestions] = useState(false)
const [revenueStructureLocked, setRevenueStructureLocked] = useState(false)
const [categoryModified, setCategoryModified] = useState(false)
const [editingCategory, setEditingCategory] = useState<any>(null)
const [originalEditingCategory, setOriginalEditingCategory] = useState<any>(null)

// æ”¶å…¥é¡¹ç›®çŠ¶æ€
const [revenueItems, setRevenueItems] = useState<RevenueItem[]>([])
const [generatingRevenueItems, setGeneratingRevenueItems] = useState(false)
const [editingRevenue, setEditingRevenue] = useState<RevenueItem | null>(null)

// ModalçŠ¶æ€
const [editCategoryModalOpened, setEditCategoryModalOpened] = useState(false)
const [editRevenueTypeModalOpened, setEditRevenueTypeModalOpened] = useState(false)
const [revenueModalOpened, setRevenueModalOpened] = useState(false)
```

---

## ä¸ƒã€ç®—æ³•å®ç°

### 7.1 è¿˜æœ¬ä»˜æ¯è®¡ç®—

```typescript
/**
 * ç­‰é¢æœ¬é‡‘è¿˜æ¬¾è®¡ç®—
 * @param loanAmount è´·æ¬¾æ€»é¢ï¼ˆä¸‡å…ƒï¼‰
 * @param loanYears è´·æ¬¾å¹´é™
 * @param interestRate å¹´åˆ©ç‡ï¼ˆå°æ•°ï¼Œå¦‚0.049è¡¨ç¤º4.9%ï¼‰
 * @param operationYears è¿è¥æœŸå¹´æ•°
 */
function calculateRepaymentPlan(
  loanAmount: number,
  loanYears: number,
  interestRate: number,
  operationYears: number
): RepaymentRow[] {
  
  const totalMonths = loanYears * 12
  const monthlyPrincipal = loanAmount / totalMonths  // æ¯æœˆå›ºå®šæœ¬é‡‘
  
  const data: RepaymentRow[] = []
  
  // é¢„å…ˆè®¡ç®—æ€»åˆ©æ¯
  let totalInterest = 0
  for (let y = 0; y < loanYears; y++) {
    const yearOpeningBalance = loanAmount - (monthlyPrincipal * y * 12)
    if (yearOpeningBalance <= 0) break
    
    const monthsInYear = Math.min(12, totalMonths - y * 12)
    const yearPrincipal = monthlyPrincipal * monthsInYear
    
    // å…³é”®å…¬å¼ï¼šå½“å¹´åˆ©æ¯ = (æœŸåˆä½™é¢ - å½“æœŸè¿˜æœ¬/2) Ã— å¹´åˆ©ç‡
    const yearInterest = Math.max(0, 
      (yearOpeningBalance - yearPrincipal / 2) * interestRate
    )
    totalInterest += yearInterest
  }
  
  // ç”Ÿæˆå„è¡Œæ•°æ®
  // 1. æœŸåˆå€Ÿæ¬¾ä½™é¢
  const openingBalanceRow = {
    åºå·: '1',
    é¡¹ç›®: 'æœŸåˆå€Ÿæ¬¾ä½™é¢',
    åˆè®¡: null,
    åˆ†å¹´æ•°æ®: Array.from({ length: operationYears }, (_, i) => {
      if (i === 0) return loanAmount
      if (i >= loanYears) return 0
      const monthsPassed = i * 12
      return Math.max(0, loanAmount - monthlyPrincipal * monthsPassed)
    })
  }
  
  // 2. å½“æœŸè¿˜æœ¬ä»˜æ¯ï¼ˆä¸»è¡Œï¼‰
  const currentRepaymentRow = {
    åºå·: '2',
    é¡¹ç›®: 'å½“æœŸè¿˜æœ¬ä»˜æ¯',
    åˆè®¡: loanAmount + totalInterest,
    isMainRow: true,
    åˆ†å¹´æ•°æ®: Array.from({ length: operationYears }, (_, i) => {
      if (i >= loanYears) return 0
      
      const yearOpeningBalance = loanAmount - (monthlyPrincipal * i * 12)
      if (yearOpeningBalance <= 0) return 0
      
      const monthsRemaining = Math.min(12, totalMonths - i * 12)
      const yearPrincipal = monthlyPrincipal * monthsRemaining
      const yearInterest = Math.max(0, 
        (yearOpeningBalance - yearPrincipal / 2) * interestRate
      )
      
      return yearPrincipal + yearInterest
    })
  }
  
  // 3. è¿˜æœ¬ï¼ˆå­è¡Œï¼‰
  const principalRow = {
    åºå·: '2.1',
    é¡¹ç›®: 'è¿˜æœ¬',
    åˆè®¡: loanAmount,
    åˆ†å¹´æ•°æ®: Array.from({ length: operationYears }, (_, i) => {
      if (i >= loanYears) return 0
      const monthsRemaining = Math.min(12, totalMonths - i * 12)
      return monthlyPrincipal * monthsRemaining
    })
  }
  
  // 4. ä»˜æ¯ï¼ˆå­è¡Œï¼‰
  const interestRow = {
    åºå·: '2.2',
    é¡¹ç›®: 'ä»˜æ¯',
    åˆè®¡: totalInterest,
    åˆ†å¹´æ•°æ®: Array.from({ length: operationYears }, (_, i) => {
      if (i >= loanYears) return 0
      
      const yearOpeningBalance = loanAmount - (monthlyPrincipal * i * 12)
      if (yearOpeningBalance <= 0) return 0
      
      const monthsRemaining = Math.min(12, totalMonths - i * 12)
      const yearPrincipal = monthlyPrincipal * monthsRemaining
      
      return Math.max(0, 
        (yearOpeningBalance - yearPrincipal / 2) * interestRate
      )
    })
  }
  
  // 5. æœŸæœ«å€Ÿæ¬¾ä½™é¢
  const closingBalanceRow = {
    åºå·: '3',
    é¡¹ç›®: 'æœŸæœ«å€Ÿæ¬¾ä½™é¢',
    åˆè®¡: null,
    åˆ†å¹´æ•°æ®: Array.from({ length: operationYears }, (_, i) => {
      if (i >= loanYears) return 0
      const monthsPassed = (i + 1) * 12
      if (monthsPassed >= totalMonths) return 0
      return Math.max(0, loanAmount - monthlyPrincipal * monthsPassed)
    })
  }
  
  return [
    openingBalanceRow,
    currentRepaymentRow,
    principalRow,
    interestRow,
    closingBalanceRow
  ]
}
```

### 7.2 æŠ˜æ—§æ‘Šé”€è®¡ç®—

```typescript
/**
 * ç›´çº¿æ³•æŠ˜æ—§è®¡ç®—
 * @param originalValue èµ„äº§åŸå€¼
 * @param years æŠ˜æ—§å¹´é™
 * @param residualRate æ®‹å€¼ç‡ï¼ˆ%ï¼‰
 * @param operationYears è¿è¥æœŸå¹´æ•°
 */
function calculateDepreciation(
  originalValue: number,
  years: number,
  residualRate: number,
  operationYears: number
): number[] {
  
  const residualValue = originalValue * (residualRate / 100)
  const depreciableValue = originalValue - residualValue
  const annualDepreciation = depreciableValue / years
  
  return Array.from({ length: operationYears }, (_, i) => {
    if (i < years) return annualDepreciation
    return 0
  })
}
```

### 7.3 ç¨é¢è®¡ç®—

```typescript
/**
 * å¢å€¼ç¨è®¡ç®—
 * @param annualRevenue å¹´æ”¶å…¥ï¼ˆå«ç¨ï¼Œä¸‡å…ƒï¼‰
 * @param vatRate å¢å€¼ç¨ç‡ï¼ˆ%ï¼‰
 */
function calculateVAT(
  annualRevenue: number,
  vatRate: number
): { vatAmount: number; nonTaxRevenue: number } {
  
  const vatRateDecimal = vatRate / 100
  const vatAmount = annualRevenue * vatRateDecimal / (1 + vatRateDecimal)
  const nonTaxRevenue = annualRevenue - vatAmount
  
  return { vatAmount, nonTaxRevenue }
}

// ç¤ºä¾‹
const revenue = 500  // 500ä¸‡å…ƒå«ç¨æ”¶å…¥
const result = calculateVAT(revenue, 9)
// result = { vatAmount: 41.28, nonTaxRevenue: 458.72 }
```

---

## å…«ã€æ€§èƒ½ä¼˜åŒ–

### 8.1 å‰ç«¯ä¼˜åŒ–

#### 8.1.1 ç»„ä»¶æ‡’åŠ è½½
```typescript
// ä½¿ç”¨React.lazyæ‡’åŠ è½½å¤§å‹ç»„ä»¶
const RevenueItemModal = lazy(() => import('@/components/RevenueItemModal'))

<Suspense fallback={<LoadingOverlay visible />}>
  <RevenueItemModal {...props} />
</Suspense>
```

#### 8.1.2 çŠ¶æ€æ›´æ–°ä¼˜åŒ–
```typescript
// ä½¿ç”¨å‡½æ•°å¼æ›´æ–°é¿å…é—­åŒ…é—®é¢˜
setRevenueItems(items => [...items, newItem])

// ä½¿ç”¨useMemoç¼“å­˜è®¡ç®—ç»“æœ
const totalRevenue = useMemo(() => {
  return revenueItems.reduce((sum, item) => sum + item.annualRevenue, 0)
}, [revenueItems])

// ä½¿ç”¨useCallbackç¼“å­˜å›è°ƒå‡½æ•°
const handleDelete = useCallback((id: string) => {
  setRevenueItems(items => items.filter(item => item.id !== id))
}, [])
```

#### 8.1.3 è™šæ‹Ÿæ»šåŠ¨
```typescript
// å¯¹äºå¤§é‡æ•°æ®ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨ï¼ˆå¾…å®ç°ï¼‰
import { VirtualTable } from '@mantine/core'

<VirtualTable
  data={revenueItems}
  rowHeight={60}
  height={600}
/>
```

### 8.2 åç«¯ä¼˜åŒ–

#### 8.2.1 æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
```typescript
// ä½¿ç”¨ç´¢å¼•
CREATE INDEX idx_project_user ON investment_projects(user_id)
CREATE INDEX idx_estimate_project ON investment_estimates(project_id)

// é¿å…N+1æŸ¥è¯¢
const projects = await db.all(`
  SELECT p.*, e.* 
  FROM investment_projects p
  LEFT JOIN investment_estimates e ON e.project_id = p.id
  WHERE p.user_id = ?
`, [userId])
```

#### 8.2.2 LLMè¯·æ±‚ä¼˜åŒ–
```typescript
// è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
const timeout = 120000  // 2åˆ†é’Ÿ

// å®ç°è¯·æ±‚é‡è¯•
async function retryLLMRequest(
  fn: () => Promise<any>,
  maxRetries = 3
): Promise<any> {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fn()
    } catch (error) {
      if (i === maxRetries - 1) throw error
      await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)))
    }
  }
}
```

#### 8.2.3 ç¼“å­˜ç­–ç•¥
```typescript
// ç¼“å­˜LLMé…ç½®ï¼ˆå¾…å®ç°ï¼‰
const configCache = new Map<number, LLMConfig>()

async function getCachedLLMConfig(userId: number): Promise<LLMConfig> {
  if (configCache.has(userId)) {
    return configCache.get(userId)!
  }
  
  const config = await LLMConfigModel.findDefaultByUserId(userId)
  configCache.set(userId, config)
  return config
}
```

---

## ä¹ã€é”™è¯¯å¤„ç†

### 9.1 å‰ç«¯é”™è¯¯å¤„ç†

#### 9.1.1 APIè°ƒç”¨é”™è¯¯
```typescript
try {
  const response = await revenueCostApi.aiRecommend(projectId, params)
  
  if (!response.success) {
    notifications.show({
      title: 'AIåˆ†æå¤±è´¥',
      message: response.error || 'æœªçŸ¥é”™è¯¯',
      color: 'red'
    })
    return
  }
  
  // å¤„ç†æˆåŠŸå“åº”
  setAiAnalysisResult(response.data.analysis)
  
} catch (error: any) {
  console.error('AIåˆ†æé”™è¯¯:', error)
  
  if (error.code === 'ECONNABORTED') {
    notifications.show({
      title: 'è¯·æ±‚è¶…æ—¶',
      message: 'AIåˆ†æè¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•',
      color: 'orange'
    })
  } else {
    notifications.show({
      title: 'ç½‘ç»œé”™è¯¯',
      message: error.message || 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥',
      color: 'red'
    })
  }
}
```

#### 9.1.2 æ•°æ®éªŒè¯é”™è¯¯
```typescript
// ä½¿ç”¨Zodè¿›è¡ŒéªŒè¯
import { z } from 'zod'

const revenueItemSchema = z.object({
  name: z.string().min(1, 'è¯·è¾“å…¥æ”¶å…¥é¡¹åç§°'),
  quantity: z.number().min(0, 'äº§é‡ä¸èƒ½ä¸ºè´Ÿæ•°'),
  unitPrice: z.number().min(0, 'å•ä»·ä¸èƒ½ä¸ºè´Ÿæ•°'),
  vatRate: z.number().min(0).max(100, 'ç¨ç‡èŒƒå›´0-100%')
})

try {
  revenueItemSchema.parse(formData)
} catch (error) {
  if (error instanceof z.ZodError) {
    notifications.show({
      title: 'éªŒè¯å¤±è´¥',
      message: error.errors[0].message,
      color: 'red'
    })
  }
}
```

### 9.2 åç«¯é”™è¯¯å¤„ç†

#### 9.2.1 ç»Ÿä¸€é”™è¯¯å“åº”
```typescript
class ApiError extends Error {
  constructor(
    public statusCode: number,
    public message: string
  ) {
    super(message)
  }
}

// é”™è¯¯å¤„ç†ä¸­é—´ä»¶
app.use((err: any, req: Request, res: Response, next: NextFunction) => {
  console.error('Error:', err)
  
  if (err instanceof ApiError) {
    return res.status(err.statusCode).json({
      success: false,
      error: err.message
    })
  }
  
  res.status(500).json({
    success: false,
    error: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
  })
})
```

#### 9.2.2 LLMè°ƒç”¨é”™è¯¯å¤„ç†
```typescript
try {
  const llmResponse = await LLMService.generateContent(config, messages, options)
  const analysis = JSON.parse(llmResponse.content)
  
  return res.json({ success: true, data: { analysis } })
  
} catch (parseError: any) {
  console.error('âŒ è§£æLLMå“åº”å¤±è´¥:', parseError.message)
  console.error('åŸå§‹å“åº”:', llmResponse.content.substring(0, 500))
  
  return res.status(500).json({
    success: false,
    error: `AIè¿”å›æ ¼å¼é”™è¯¯: ${parseError.message}`
  })
}
```

---

## åã€æµ‹è¯•æŒ‡å—

### 10.1 å•å…ƒæµ‹è¯•

#### 10.1.1 ç®—æ³•æµ‹è¯•
```typescript
// __tests__/loanCalculator.test.ts

describe('è¿˜æœ¬ä»˜æ¯è®¡ç®—', () => {
  test('ç­‰é¢æœ¬é‡‘è¿˜æ¬¾è®¡ç®—æ­£ç¡®', () => {
    const result = calculateRepaymentPlan(1000, 10, 0.049, 20)
    
    expect(result).toHaveLength(5)
    expect(result[0].é¡¹ç›®).toBe('æœŸåˆå€Ÿæ¬¾ä½™é¢')
    expect(result[1].é¡¹ç›®).toBe('å½“æœŸè¿˜æœ¬ä»˜æ¯')
    expect(result[2].é¡¹ç›®).toBe('è¿˜æœ¬')
    expect(result[3].é¡¹ç›®).toBe('ä»˜æ¯')
    expect(result[4].é¡¹ç›®).toBe('æœŸæœ«å€Ÿæ¬¾ä½™é¢')
    
    // éªŒè¯è¿˜æœ¬åˆè®¡
    expect(result[2].åˆè®¡).toBe(1000)
    
    // éªŒè¯ç¬¬ä¸€å¹´æ•°æ®
    expect(result[0].åˆ†å¹´æ•°æ®[0]).toBe(1000)  // æœŸåˆä½™é¢
    expect(result[4].åˆ†å¹´æ•°æ®[0]).toBeLessThan(1000)  // æœŸæœ«ä½™é¢å‡å°‘
  })
  
  test('åˆ©æ¯è®¡ç®—å…¬å¼æ­£ç¡®', () => {
    const loanAmount = 1000
    const yearlyPrincipal = 100
    const interestRate = 0.049
    
    // å½“å¹´åˆ©æ¯ = (æœŸåˆä½™é¢ - å½“æœŸè¿˜æœ¬/2) Ã— å¹´åˆ©ç‡
    const expectedInterest = (loanAmount - yearlyPrincipal / 2) * interestRate
    
    const result = calculateRepaymentPlan(loanAmount, 10, interestRate, 20)
    expect(result[3].åˆ†å¹´æ•°æ®[0]).toBeCloseTo(expectedInterest, 2)
  })
})
```

#### 10.1.2 ç»„ä»¶æµ‹è¯•
```typescript
// __tests__/RevenueItemModal.test.tsx

import { render, screen, fireEvent } from '@testing-library/react'
import RevenueItemModal from '@/components/RevenueItemModal'

describe('æ”¶å…¥é¡¹ç¼–è¾‘å¼¹çª—', () => {
  test('æ¸²æŸ“æ­£å¸¸', () => {
    render(
      <RevenueItemModal
        opened={true}
        onClose={jest.fn()}
        onSave={jest.fn()}
      />
    )
    
    expect(screen.getByText('æ·»åŠ æ”¶å…¥é¡¹')).toBeInTheDocument()
    expect(screen.getByLabelText('æ”¶å…¥é¡¹åç§°')).toBeInTheDocument()
  })
  
  test('è¡¨å•éªŒè¯å·¥ä½œæ­£å¸¸', async () => {
    const onSave = jest.fn()
    render(
      <RevenueItemModal
        opened={true}
        onClose={jest.fn()}
        onSave={onSave}
      />
    )
    
    // ä¸å¡«å†™æ•°æ®ç›´æ¥ä¿å­˜
    fireEvent.click(screen.getByText('ä¿å­˜'))
    
    // åº”è¯¥æ˜¾ç¤ºéªŒè¯é”™è¯¯
    expect(await screen.findByText('è¯·è¾“å…¥æ”¶å…¥é¡¹åç§°')).toBeInTheDocument()
    
    // onSaveä¸åº”è¯¥è¢«è°ƒç”¨
    expect(onSave).not.toHaveBeenCalled()
  })
})
```

### 10.2 é›†æˆæµ‹è¯•

```typescript
// __tests__/integration/revenueCost.test.ts

describe('è¥æ”¶æˆæœ¬å»ºæ¨¡é›†æˆæµ‹è¯•', () => {
  let server: any
  let authToken: string
  
  beforeAll(async () => {
    server = await startTestServer()
    authToken = await getTestAuthToken()
  })
  
  afterAll(async () => {
    await server.close()
  })
  
  test('AIæ¨èè¥æ”¶ç»“æ„å®Œæ•´æµç¨‹', async () => {
    // 1. åˆ›å»ºé¡¹ç›®
    const project = await createTestProject({
      project_name: 'æµ‹è¯•é¡¹ç›®',
      total_investment: 1000
    })
    
    // 2. è°ƒç”¨AIæ¨è
    const response = await request(server)
      .post(`/api/revenue-cost/ai-recommend/${project.id}`)
      .set('Authorization', `Bearer ${authToken}`)
      .send({
        projectInfo: 'ä¸­è¯æç§æ¤åŸºåœ°'
      })
    
    expect(response.status).toBe(200)
    expect(response.body.success).toBe(true)
    expect(response.body.data.analysis.selected_categories).toBeDefined()
    
    // 3. éªŒè¯è¿”å›çš„ç±»åˆ«æ•°é‡åœ¨2-6ä¹‹é—´
    const categories = response.body.data.analysis.selected_categories
    expect(categories.length).toBeGreaterThanOrEqual(2)
    expect(categories.length).toBeLessThanOrEqual(6)
    
    // 4. éªŒè¯æ¯ä¸ªç±»åˆ«åŒ…å«æ¨èçš„æ”¶å…¥ç±»å‹
    categories.forEach((cat: any) => {
      expect(cat.category_code).toMatch(/^[A-N]$/)
      expect(cat.recommended_revenue_types).toBeDefined()
      expect(cat.recommended_revenue_types.length).toBeGreaterThanOrEqual(3)
      expect(cat.recommended_revenue_types.length).toBeLessThanOrEqual(8)
    })
  })
})
```

### 10.3 E2Eæµ‹è¯•

```typescript
// e2e/revenueCost.spec.ts (ä½¿ç”¨Playwright)

import { test, expect } from '@playwright/test'

test.describe('è¥æ”¶æˆæœ¬å»ºæ¨¡E2Eæµ‹è¯•', () => {
  test('å®Œæ•´å·¥ä½œæµç¨‹', async ({ page }) => {
    // 1. ç™»å½•
    await page.goto('http://localhost:5173/login')
    await page.fill('[name="username"]', 'testuser')
    await page.fill('[name="password"]', 'password')
    await page.click('button[type="submit"]')
    
    // 2. è¿›å…¥é¡¹ç›®
    await page.goto('http://localhost:5173/revenue-cost/1')
    
    // 3. è¿›å…¥AIæ¨èæ­¥éª¤
    await page.click('text=ä¸‹ä¸€æ­¥')  // è·³è¿‡åŸºç¡€æ•°æ®
    await page.click('text=ä¸‹ä¸€æ­¥')  // è·³è¿‡æŠ˜æ—§æ‘Šé”€
    
    // 4. ç‚¹å‡»AIåˆ†æ
    await page.click('text=å¼€å§‹AIåˆ†æ')
    
    // 5. ç­‰å¾…åˆ†æå®Œæˆ
    await page.waitForSelector('text=AIåˆ†æå®Œæˆ', { timeout: 120000 })
    
    // 6. éªŒè¯æœ‰æ¨èç»“æœ
    const categories = await page.locator('table tbody tr').count()
    expect(categories).toBeGreaterThan(0)
    
    // 7. é”å®šè¥æ”¶ç»“æ„
    await page.click('role=switch')
    await expect(page.locator('text=å·²é”å®š')).toBeVisible()
    
    // 8. è¿›å…¥æ”¶å…¥å»ºæ¨¡
    await page.click('text=ä¸‹ä¸€æ­¥')
    
    // 9. ç­‰å¾…è‡ªåŠ¨ç”Ÿæˆæ”¶å…¥é¡¹ç›®
    await page.waitForSelector('text=AIç”ŸæˆæˆåŠŸ', { timeout: 30000 })
    
    // 10. éªŒè¯æœ‰æ”¶å…¥é¡¹ç›®
    const items = await page.locator('table tbody tr').count()
    expect(items).toBeGreaterThan(0)
  })
})
```

---

## é™„å½•Aï¼šæ•°æ®åº“Schema

```sql
-- æŠ•èµ„é¡¹ç›®è¡¨
CREATE TABLE investment_projects (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  project_name TEXT NOT NULL,
  project_info TEXT,
  total_investment REAL NOT NULL,
  construction_years INTEGER NOT NULL,
  operation_years INTEGER NOT NULL,
  loan_interest_rate REAL DEFAULT 0.049,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  FOREIGN KEY (user_id) REFERENCES users(id)
);

-- æŠ•èµ„ä¼°ç®—è¡¨
CREATE TABLE investment_estimates (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  project_id INTEGER NOT NULL,
  construction_cost REAL,
  equipment_cost REAL,
  installation_cost REAL,
  other_cost REAL,
  basic_reserve REAL,
  price_reserve REAL,
  construction_interest REAL,
  loan_amount REAL,
  estimate_data TEXT,  -- JSONæ ¼å¼
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  FOREIGN KEY (project_id) REFERENCES investment_projects(id)
);

-- LLMé…ç½®è¡¨
CREATE TABLE llm_configs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  config_name TEXT NOT NULL,
  provider TEXT NOT NULL,
  api_key TEXT NOT NULL,
  base_url TEXT,
  model_name TEXT NOT NULL,
  max_tokens INTEGER DEFAULT 2000,
  temperature REAL DEFAULT 0.7,
  is_default INTEGER DEFAULT 0,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  FOREIGN KEY (user_id) REFERENCES users(id)
);
```

---

## é™„å½•Bï¼šç¯å¢ƒå˜é‡é…ç½®

```bash
# .env

# æœåŠ¡å™¨é…ç½®
PORT=3001
NODE_ENV=development

# æ•°æ®åº“é…ç½®
DB_PATH=./data/database.sqlite

# JWTé…ç½®
JWT_SECRET=your-secret-key-here
JWT_EXPIRES_IN=7d

# LLMé…ç½®ï¼ˆå¯é€‰ï¼Œç”¨äºé»˜è®¤é…ç½®ï¼‰
DEFAULT_LLM_PROVIDER=openai
DEFAULT_LLM_API_KEY=sk-xxx
DEFAULT_LLM_MODEL=gpt-4
DEFAULT_LLM_BASE_URL=https://api.openai.com/v1
```

---

## é™„å½•Cï¼šå¸¸ç”¨å‘½ä»¤

```bash
# å‰ç«¯å¼€å‘
cd client
npm install
npm run dev          # å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run build        # æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run preview      # é¢„è§ˆç”Ÿäº§ç‰ˆæœ¬

# åç«¯å¼€å‘
cd server
npm install
npm run dev          # å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼ˆnodemonï¼‰
npm run build        # ç¼–è¯‘TypeScript
npm start            # å¯åŠ¨ç”Ÿäº§æœåŠ¡å™¨

# æ•°æ®åº“æ“ä½œ
npm run db:migrate   # è¿è¡Œæ•°æ®åº“è¿ç§»
npm run db:seed      # å¡«å……æµ‹è¯•æ•°æ®

# æµ‹è¯•
npm test             # è¿è¡Œå•å…ƒæµ‹è¯•
npm run test:e2e     # è¿è¡ŒE2Eæµ‹è¯•
npm run test:coverage # ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
```

---

**æ–‡æ¡£ç»“æŸ**

å¦‚éœ€æ›´å¤šæŠ€æœ¯ç»†èŠ‚æˆ–æœ‰ç–‘é—®ï¼Œè¯·æŸ¥çœ‹æºä»£ç æˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚
