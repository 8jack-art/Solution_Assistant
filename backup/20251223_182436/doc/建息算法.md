# 建设期利息计算规则

## 一、核心计算公式

### 1. 标准单利计息公式
```
当期建设期利息 = (期初贷款本金累计 + 当期借款金额 ÷ 2) × 年利率
```

**说明：**
- 采用单利计息方式（不计复利）
- 当期借款金额除以2，表示该年度借款平均使用半年
- 期初本金累计是指前几年已借款的累计金额

### 2. 建设期利息合计
```
建设期利息合计 = Σ(各年度建设期利息)
```

---

## 二、贷款金额分配规则

### 1. 贷款总额取整规则
根据贷款金额大小采用不同的取整单位：

| 贷款金额范围 | 取整单位 | 取整方式 |
|------------|---------|---------|
| ≥ 1亿元 | 1000万元 | 向下取整 |
| < 1亿元 | 100万元 | 向下取整 |

**代码实现：**
```typescript
export function roundLoanAmount(amount: number): number {
  const amountInYuan = amount * 10000; // 转换为元
  
  if (amountInYuan >= 100000000) {
    // ≥1亿元，向下取整到千万
    return Math.floor(amountInYuan / 10000000) * 1000; // 返回万元
  } else {
    // <1亿元，向下取整到百万
    return Math.floor(amountInYuan / 1000000) * 100; // 返回万元
  }
}
```

### 2. "头大尾小"分年借款分配算法

**原理：**
- 前 n-1 年：每年借款金额相同，为取整后的平均值
- 第 n 年：使用减法得出的尾数（贷款总额 - 前n-1年累计）

**步骤：**
1. 计算基础额度：`基础额度 = 贷款总额 ÷ 建设期年限`
2. 对基础额度进行取整：`第1年金额 = roundLoanAmount(基础额度)`
3. 前 n-1 年都使用相同的取整后金额
4. 最后一年：`最后一年金额 = 贷款总额 - 前n-1年累计`

**代码实现：**
```typescript
export function distributeLoanByYear(
  loanTotal: number,
  years: number
): number[] {
  if (years <= 0) return [];
  if (years === 1) return [loanTotal];
  
  // 第1年基础额度
  const baseAmount = loanTotal / years;
  const firstYearAmount = roundLoanAmount(baseAmount);
  
  const distribution: number[] = [];
  let accumulated = 0;
  
  // 前n-1年使用相同的取整后金额
  for (let i = 0; i < years - 1; i++) {
    distribution.push(firstYearAmount);
    accumulated += firstYearAmount;
  }
  
  // 最后一年使用减法得出的尾数
  const lastYearAmount = loanTotal - accumulated;
  distribution.push(Math.max(0, lastYearAmount));
  
  return distribution;
}
```

---

## 三、迭代计算机制

### 1. 迭代原因
建设期利息会影响项目总资金，而项目总资金又会影响贷款金额（按比例计算时），贷款金额又会影响建设期利息，形成循环依赖。因此需要迭代计算直到收敛。

### 2. 迭代算法
```
初始值：项目总资金 = 建设投资
循环：
  1. 计算贷款金额 = 项目总资金 × 贷款比例
  2. 对贷款金额进行取整
  3. 分配分年借款金额
  4. 计算分年利息
  5. 计算建设期利息合计
  6. 计算新的项目总资金 = 建设投资 + 建设期利息合计
  7. 如果 |新项目总资金 - 旧项目总资金| < 0.01万元，则收敛，退出循环
  8. 否则继续迭代
最大迭代次数：10次（熔断保护）
```

### 3. 收敛条件
```
|新项目总资金 - 旧项目总资金| < 0.01万元
```

### 4. 贷款比例约束
当按比例计算贷款金额时，实际贷款比例应在以下区间内：
```
[目标比例 - 3%, 目标比例]
```

**示例：**
- 目标比例：80%
- 实际比例应在：77% - 80% 之间

如果取整后的贷款金额导致实际比例低于最小值，则向上调整贷款金额。

---

## 四、计算示例

### 示例1：3年期贷款
**输入参数：**
- 建设投资：10,000 万元
- 贷款比例：70%
- 年利率：4.9%
- 建设期：3年

**计算过程：**

**第1次迭代：**
1. 项目总资金 = 10,000 万元
2. 粗略贷款额 = 10,000 × 70% = 7,000 万元
3. 贷款总额（取整）= 7,000 万元（< 1亿，按100万取整）
4. 分年借款分配：
   - 基础额度 = 7,000 ÷ 3 = 2,333.33 万元
   - 取整后 = 2,300 万元
   - 第1年：2,300 万元
   - 第2年：2,300 万元
   - 第3年：7,000 - 2,300 - 2,300 = 2,400 万元

5. 分年利息计算：
   - 第1年利息 = (0 + 2,300 ÷ 2) × 4.9% = 56.35 万元
   - 第2年利息 = (2,300 + 2,300 ÷ 2) × 4.9% = 168.77 万元
   - 第3年利息 = (4,600 + 2,400 ÷ 2) × 4.9% = 284.20 万元
   - 建设期利息合计 = 509.32 万元

6. 新项目总资金 = 10,000 + 509.32 = 10,509.32 万元
7. 差值 = |10,509.32 - 10,000| = 509.32 > 0.01，继续迭代

**第2次迭代：**
1. 项目总资金 = 10,509.32 万元
2. 粗略贷款额 = 10,509.32 × 70% = 7,356.52 万元
3. 贷款总额（取整）= 7,300 万元
4. 分年借款分配：
   - 第1年：2,400 万元
   - 第2年：2,400 万元
   - 第3年：2,500 万元

5. 分年利息计算：
   - 第1年利息 = (0 + 2,400 ÷ 2) × 4.9% = 58.80 万元
   - 第2年利息 = (2,400 + 2,400 ÷ 2) × 4.9% = 176.40 万元
   - 第3年利息 = (4,800 + 2,500 ÷ 2) × 4.9% = 296.45 万元
   - 建设期利息合计 = 531.65 万元

6. 新项目总资金 = 10,000 + 531.65 = 10,531.65 万元
7. 差值 = |10,531.65 - 10,509.32| = 22.33 > 0.01，继续迭代

**...**（继续迭代直到收敛）

---

## 五、特殊情况处理

### 1. 自定义贷款金额
当用户手动指定贷款金额时：
- 不再按比例计算贷款金额
- 直接使用用户指定的金额
- 仍需迭代计算利息（因为利息会影响项目总资金）
- 不受贷款比例约束限制

### 2. 利率格式处理
系统自动检测利率格式：
- 如果利率 < 1，说明是小数形式（如 0.049），自动转换为百分比形式（4.9%）
- 如果利率 ≥ 1，说明已经是百分比形式，直接使用

**代码示例：**
```typescript
let annualRate = project.loan_interest_rate || 4.9;

// 修复利率格式
if (annualRate < 1) {
  annualRate = annualRate * 100;
  console.log(`⚠️ 检测到小数形式的利率，已转换为 ${annualRate}%`);
}
```

### 3. 建设期为1年
当建设期只有1年时：
- 分年借款：全部贷款金额在第1年借入
- 建设期利息 = 贷款金额 ÷ 2 × 年利率

---



## 六、关键要点总结

1. **单利计息**：采用单利方式，不计复利
2. **平均使用**：当期借款按平均使用半年计算利息
3. **分级取整**：根据金额大小采用不同取整单位（1000万或100万）
4. **头大尾小**：前几年借款金额相同，最后一年用减法得出
5. **迭代收敛**：通过迭代计算直到项目总资金稳定
6. **比例约束**：实际贷款比例应在目标比例的±3%范围内
7. **熔断保护**：最多迭代10次，防止无限循环

---

