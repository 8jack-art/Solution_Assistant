## ğŸ¤– Assistant

å¥½çš„ï¼Œä»¥ä¸‹æ˜¯ **ä¸“é—¨é’ˆå¯¹â€œè¥ä¸šæ”¶å…¥ä¸æˆæœ¬æµ‹ç®—â€æ¨¡å—ï¼ˆç¬¬äºŒéƒ¨åˆ†ï¼‰çš„ç‹¬ç«‹å¼€å‘æ–‡æ¡£å¢å¼ºç‰ˆ**ï¼Œå®Œå…¨åŸºäºä½ ç°æœ‰çš„æŠ€æœ¯æ ˆï¼ˆReact 18 + TypeScript + Viteï¼‰å’Œç³»ç»Ÿæ¶æ„è®¾è®¡ï¼Œèšç„¦äº `æ”¶å…¥å»ºæ¨¡` å­ç³»ç»Ÿçš„å®Œæ•´è½åœ°å®ç°ã€‚

---

# ğŸ“˜ è¥ä¸šæ”¶å…¥é¢„æµ‹å­ç³»ç»Ÿ Â· å¼€å‘æ–‡æ¡£
> **æ¨¡å—åç§°ï¼šRevenue Modeling Module**
> **ç³»ç»Ÿä»£å·ï¼šmiaoda-react-admin**
> **æŠ€æœ¯æ ˆï¼šReact 18 + TypeScript + Vite + Zustand + Mantine UI**
> **ç‰ˆæœ¬ï¼šv2.0**
> **ç¼–å†™æ—¥æœŸï¼š2025-04-05**

---

## âœ… æ¨¡å—å®šä½

ä½œä¸ºæ•´ä¸ªæŠ•èµ„åˆ†ææµç¨‹çš„ç¬¬äºŒæ­¥ï¼ˆæ‰¿æ¥â€œæŠ•èµ„ä¼°ç®—â€ç»“æœï¼‰ï¼Œæœ¬æ¨¡å—è´Ÿè´£ï¼š

- å¼•å¯¼ç”¨æˆ·ä»é¡¹ç›®ç±»å‹ä¸­è¯†åˆ«æ½œåœ¨æ”¶å…¥æ¥æºï¼›
- AI æ™ºèƒ½æ¨èåŒ¹é…çš„ç›ˆåˆ©æ¨¡å¼ï¼›
- æ„å»ºç»“æ„åŒ–ã€å¯è®¡ç®—çš„**åŠ¨æ€æ”¶å…¥æ¨¡å‹**ï¼›
- æ”¯æŒå†œä¸šç§æ¤ã€æ•°å­—å¹³å°ã€äº¤æ˜“æ’®åˆç­‰å¤šä¸šæ€ç»„åˆå»ºæ¨¡ï¼›
- è¾“å‡ºæ ‡å‡†åŒ–è¡¨æ ¼ä¾›åç»­è´¢åŠ¡è¯„ä»·ä½¿ç”¨ã€‚

> âš™ï¸ æ ¸å¿ƒè¾“å‡ºï¼šã€Šè¥ä¸šæ”¶å…¥é¢„æµ‹è¡¨ã€‹
> ğŸ”„ è¾“å…¥ä¾èµ–ï¼šâ€œç¬¬ä¸€éƒ¨åˆ† æŠ•èµ„ä¼°ç®—â€çš„å…³é”®å‚æ•°ï¼ˆå¦‚ `é¡¹ç›®åç§°`, `å»ºè®¾æœŸ`, `Aç±»æŠ•èµ„æ„æˆ`, `G_calc_new`ï¼‰

---

## ğŸ§© åŠŸèƒ½ç»“æ„å›¾è°±

```mermaid
graph LR
    A[å¯åŠ¨] --> B[è®¡ç®—æœŸç¡®è®¤]
    B --> C[AIç”Ÿæˆè¥æ”¶å»ºè®®]
    C --> D[ç”¨æˆ·é€‰æ‹©æ”¶å…¥ç±»å‹]
    D --> E[è‡ªåŠ¨ç”Ÿæˆäº¤äº’å¼è¡¨æ ¼]
    E --> F[ç¼–è¾‘/æ–°å¢/åˆ é™¤é¡¹]
    F --> G[è¾¾äº§ç‡åº”ç”¨]
    G --> H[æ ¡éªŒå¹¶æäº¤]

    subgraph è¾“å‡º
        H --> I[(ã€Šè¥ä¸šæ”¶å…¥é¢„æµ‹è¡¨ã€‹)]
    end
```

---

## ğŸ” æ¨¡å—ä¸€ï¼šè§¦å‘ä¸çŠ¶æ€å®ˆå«ï¼ˆå…¥å£æ§åˆ¶ï¼‰

### 1.1 è§¦å‘æ¡ä»¶
- ç”¨æˆ·è¾“å…¥å‘½ä»¤ï¼š
 - `è¿›å…¥ç¬¬äºŒæ­¥`
 - `ç»§ç»­ä¸‹ä¸€æ­¥`

### 1.2 çŠ¶æ€å®ˆå«è§„åˆ™ï¼ˆå…³é”®çº¦æŸï¼‰
| è¡Œä¸º | ç³»ç»Ÿå“åº” |
|------|--------|
| ç¬¬ä¸€æ¬¡è¿›å…¥ï¼ˆéåˆ·æ–°ï¼‰ | æ­£å¸¸åŠ è½½æµç¨‹ |
| é€šè¿‡ `ç»§ç»­ä¸‹ä¸€æ­¥` è¿›å…¥ | âŒ ç¦æ­¢é¢„å¡«å……å†å²æ•°æ®ï¼›å¿…é¡»è§†ä¸ºå…¨æ–°æµç¨‹ |
| æµè§ˆå™¨åˆ·æ–°/é¡µé¢è·³è½¬åé‡è¿› | è‹¥ session æ¸…é™¤ï¼Œåˆ™é‡æ–°å¼€å§‹ |

> ğŸ’¬ å®ç°æ–¹å¼å»ºè®®ï¼š
```ts
// store/revenueModelStore.ts
if (triggerSource === 'continue') {
  clearAllTemporaryData(); // æ¸…ç†æ‰€æœ‰ç¼“å­˜æ•°æ®
}
```

---

## ğŸ“¥ æ¨¡å—äºŒï¼šå‰ç½®å‚æ•°è¯»å–ï¼ˆContext Initializationï¼‰

ç³»ç»Ÿè‡ªåŠ¨ä»ä¸Šä¸€æ­¥è·å–ä»¥ä¸‹å­—æ®µç”¨äºæ™ºèƒ½å¼•å¯¼ï¼š

| å‚æ•° | å˜é‡å | æ¥æº | ç”¨é€” |
|------|--------|------|------|
| é¡¹ç›®åç§° | `projectName` | investment_projects.project_name | æ˜¾ç¤ºæŠ¬å¤´ |
| å»ºè®¾æœŸå¹´é™ X | `constructionYears` | same | æ¨ç®—è¿è¥æœŸ & è¾¾äº§æ›²çº¿ |
| Aç±»å·¥ç¨‹æ„æˆ | `engineeringItems: Item[]` | investment_estimates JSON ä¸­æå– | AI åˆ†æé¡¹ç›®ç±»å‹ |
| æ€»æŠ•èµ„é¢ | `totalInvestment: number` | final_total / total_investment | ç”¨äºåˆå€¼æ¨ç®—è§„æ¨¡å•ä»· |

> âœ… æ³¨ï¼šè¯¥æ•°æ®åº”åœ¨å…¨å±€çŠ¶æ€ä¸­åˆå§‹åŒ–ã€‚
```ts
// types/projectTypes.ts
interface BaseContext {
  projectName: string;
  constructionYears: number;
  engineeringItems: EngineeringItem[];
  totalInvestment: number;
}
```

---

## ğŸ—“ï¸ æ¨¡å—ä¸‰ï¼šè®¡ç®—æœŸç¡®è®¤ï¼ˆå¼ºåˆ¶é¦–æ­¥ï¼‰

### 3.1 é»˜è®¤æ¨ç®—é€»è¾‘

```ts
const defaultTotalPeriod = 20;
const defaultOperatingYears = defaultTotalPeriod - context.constructionYears;

// å¯é€‰é¡¹ï¼š
const options = [
  { key: 'A', label: `ä¿æŒä¸å˜ï¼š${construction}+${defaultOperating} = 20å¹´` },
  { key: 'B', label: `ä¿®æ”¹ä¸º30å¹´ï¼š${construction}+${30-construction}=30å¹´` },
  { key: 'C', label: 'è‡ªå®šä¹‰' }
];
```

### 3.2 ç”¨æˆ·äº¤äº’ç•Œé¢ï¼ˆUI ç»„ä»¶ï¼‰

- ä½¿ç”¨å¡ç‰‡å¼æç¤ºç»„ä»¶å±•ç¤ºã€‚
- æä¾›ä¸‰ä¸ªæŒ‰é’®æˆ–æ–‡æœ¬æŒ‡ä»¤è¾“å…¥æ¡†ã€‚
- æ”¯æŒå‘½ä»¤è¡Œå¼è¾“å…¥ï¼š`ä¿®æ”¹è®¡ç®—æœŸ 3+27`

### 3.3 æ•°æ®å¤„ç†é€»è¾‘

```ts
function parseCustomPeriod(input: string): { construction: number, operation: number } | null {
  const match = input.match(/ä¿®æ”¹è®¡ç®—æœŸ\s+(\d+)\+(\d+)/);
  if (!match) return null;
  return {
    construction: parseInt(match[1]),
    operation: parseInt(match[2])
  };
}
```

### 3.4 è¾“å‡ºä¿å­˜
```ts
store.update({
  calculationPeriod: 30,
  operatingYears: 27,
  effectiveFromYear: 4 // ç”Ÿäº§å¯åŠ¨å¹´ï¼ˆå¯åç»­è°ƒæ•´ï¼‰
});
```

> â—ï¸ åœ¨æœªæ”¶åˆ°æœ‰æ•ˆé€‰æ‹©å‰ï¼Œç¦æ­¢æ¨è¿›è‡³ä¸‹ä¸€é˜¶æ®µã€‚

---

## ğŸ¤– æ¨¡å—å››ï¼šAI æ”¶å…¥ç±»å‹å»ºè®®ï¼ˆæ™ºèƒ½åŒ–å¼•å¯¼ï¼‰

### 4.1 åˆ†ç±»è§„åˆ™å¼•æ“ï¼ˆRule-based AIï¼‰

æ ¹æ® `engineeringItems` çš„æè¿°è¿›è¡Œå…³é”®è¯è¯†åˆ«ï¼š

| å·¥ç¨‹å†…å®¹å…³é”®å­— | æ¨èç±»åˆ«æ ‡ç­¾ | å¯¹åº”å»ºè®®æ”¶å…¥é¡¹ |
|----------------|---------------|----------------|
| `äº‘å¹³å°`, `SaaS`, `æ¥å£` | digital-platform | SaaSè®¢é˜…è´¹ã€APIè°ƒç”¨è´¹ |
| `ç§æ¤åŸºåœ°`, `å†œç”°æ•´æ²»` | agriculture-crop | å†œäº§å“é”€å”®ã€ç§è‹—æ”¶å…¥ |
| `æ°´äº§`, `å…»æ®–æ± `, `è‚²è‹—` | agriculture-aquaculture | æ°´äº§å“é”€å”®ã€é±¼è‹—æ”¶å…¥ |
| `äº¤æ˜“ç³»ç»Ÿ`, `æ’®åˆ`, `å•†åŸ` | transaction-hub | ä½£é‡‘æ”¶å…¥ã€æ‰‹ç»­è´¹ |
| `ç ”å‘ä¸­å¿ƒ`, `åŸ¹è®­ä¸­å¿ƒ` | service-institution | æŠ€æœ¯æœåŠ¡è´¹ã€åŸ¹è®­è´¹ |

> å¯é…ç½®è§„åˆ™æ–‡ä»¶ `/config/revenue-rules.json` åæœŸæ‰©å±•ã€‚

### 4.2 è¾“å‡ºæ ¼å¼ï¼ˆMarkdown Table æ¸²æŸ“ï¼‰

```tsx
// components/RevenueSuggestionsTable.tsx
<MarkdownRenderer>
{`
| åºå· | ç±»åˆ« | å¯èƒ½çš„è¥ä¸šæ”¶å…¥ç±»å‹ |
|------|------|--------------------|
| ğŸ”¹ A | ğŸ–¥ï¸ æ•°å­—å¹³å°ç±» | æ•°æ®æœåŠ¡è®¢é˜…è´¹ã€SaaSä¼šå‘˜è´¹... |
| ğŸŒ± B | ğŸŒ¾ å†œä¸šç§æ¤ç±» | å†œäº§å“é”€å”®æ”¶å…¥... |
`}
</MarkdownRenderer>
```

### 4.3 å¼•å¯¼è¯­å¥
```text
è¯·æ‚¨é€‰æ‹©è®¡åˆ’å®ç°çš„æ”¶å…¥ç±»å‹ï¼š
- è¾“å…¥ `A` æˆ– `B` é€‰æ‹©æ•´ç±»
- è¾“å…¥ `å¢åŠ  æ•°æ®æ¥å£è°ƒç”¨è´¹` è¡¥å……æ–°é¡¹
- å¤šé€‰è¾“å…¥ `A,B`
```

> ğŸ“ æç¤ºï¼šæ­¤é˜¶æ®µä»…ä½œç”¨æˆ·é€‰æ‹©ç”¨é€”ï¼Œä¸ç”Ÿæˆå®é™…æ”¶æ”¯è¡¨ã€‚

---

## ğŸ“Š æ¨¡å—äº”ï¼šåŠ¨æ€æ”¶å…¥è¡¨ç”Ÿæˆï¼ˆDynamic Table Engineï¼‰

### 5.1 å­—æ®µæ¨¡æ¿å®šä¹‰ï¼ˆSchema Definitionï¼‰

```ts
// types/revenueTypes.ts
type RevenueCategory =
  | 'agriculture-crop'
  | 'agriculture-aquaculture'
  | 'digital-platform'
  | 'transaction-hub';

const fieldMap: Record<RevenueCategory, Array<{ field: string; label: string; type?: string }>> = {
  'agriculture-crop': [
    { field: 'variety', label: 'å“ç§' },
    { field: 'unit', label: 'å•ä½' },
    { field: 'acreage', label: 'äº©æ•°ï¼ˆäº©ï¼‰', type: 'number' },
    { field: 'yieldPerAcre', label: 'å¹´äº§é‡ï¼ˆå¨/äº©ï¼‰', type: 'number' },
    { field: 'unitPrice', label: 'å•ä»·ï¼ˆå…ƒ/å•ä½ï¼‰', type: 'number' }
  ],
  'digital-platform': [
    { field: 'pricingModel', label: 'æ”¶è´¹æ¨¡å¼' },
    { field: 'serviceScale', label: 'æœåŠ¡è§„æ¨¡ï¼ˆç”¨æˆ·æ•°/äº¤æ˜“é¢ï¼‰', type: 'string' },
    { field: 'unitPrice', label: 'é¢„è®¡å•ä»·ï¼ˆå…ƒ/å•ä½/å¹´ï¼‰', type: 'number' }
  ]
};
```

### 5.2 è¡¨æ ¼ç»“æ„æ¸²æŸ“ç­–ç•¥

- ä½¿ç”¨ `<Mantine Table>` + åŠ¨æ€åˆ—æ‹¼æ¥ã€‚
- æ”¯æŒå¤šç§ä¸šåŠ¡æ··åˆæ—¶åˆ†åŒºå—æ˜¾ç¤ºã€‚

#### ç¤ºä¾‹ï¼šå†œä¸šç±»ï¼ˆè€•åœ°ä½œç‰©ï¼‰åˆå§‹è¡¨æ ¼

|åº|æ”¶å…¥é¡¹|å“ç§|å•ä½|äº©æ•°|äº§é‡(å¨/äº©)|å•ä»·(å…ƒ)|å¹´æ”¶å…¥(å«ç¨,ä¸‡å…ƒ)|ä¸å«ç¨|ç¨é¢|ç¨ç‡%|
|--|--|--|--|--|--|--|--|--|--|
|A|ç”˜è”—é”€å”®|ç”˜è”—|å¨|800|6.25|550|275.00|252.34|22.66|9|

> è‡ªåŠ¨ç”Ÿæˆå…¬å¼ï¼š
```
å«ç¨æ”¶å…¥ = æ•°é‡ Ã— å•ä»· Ã· 10000
ä¸å«ç¨æ”¶å…¥ = å«ç¨æ”¶å…¥ / (1 + ç¨ç‡)
å¢å€¼ç¨ = å«ç¨æ”¶å…¥ - ä¸å«ç¨æ”¶å…¥
```

> ğŸ’¡ æ‰€æœ‰é‡‘é¢ä¿ç•™ä¸¤ä½å°æ•°ï¼›ä¸­é—´è®¡ç®—ç”¨6ä½é˜²è¯¯å·®ç´¯ç§¯ã€‚

---

## âœï¸ æ¨¡å—å…­ï¼šäº¤äº’å¼å»ºæ¨¡ï¼ˆCommand-driven UXï¼‰

å…è®¸ç”¨æˆ·ä»¥è‡ªç„¶è¯­è¨€é£æ ¼æ“ä½œè¡¨æ ¼å†…å®¹ã€‚

### 6.1 å‘½ä»¤é›†å®šä¹‰

| å‘½ä»¤æ ¼å¼ | ç¤ºä¾‹ | è¡Œä¸ºè¯´æ˜ |
|---------|------|----------|
| `ä¿®æ”¹ [åºå·]` | `ä¿®æ”¹ A` | å¼¹å‡ºç¼–è¾‘ Modalï¼Œä¾ç±»åˆ«å±•ç¤ºå¯¹åº”å‚æ•°é¡¹ |
| `å¢åŠ  [åç§°]` | `å¢åŠ  AIå†³ç­–æ”¯æŒå¢å€¼æœåŠ¡è´¹` | æ–°å¢ä¸€è¡Œï¼ŒAI æ¨æµ‹åº”å± `digital-platform` å¹¶å¼¹çª—å¼•å¯¼å¡«å‚ |
| `åˆ é™¤ [åºå·]` | `åˆ é™¤ C` | åˆ é™¤æŒ‡å®šè¡Œ |
| `æ”¶å…¥ç¡®è®¤` | `æ”¶å…¥ç¡®è®¤` | æäº¤å½“å‰æ‰€æœ‰é¡¹ï¼Œè¿›å…¥ä¸‹ä¸€é˜¶æ®µï¼ˆéœ€ç»è¿‡æ ¡éªŒï¼‰ |

### 6.2 ç¼–è¾‘æ¨¡æ€æ¡†è®¾è®¡

ä½¿ç”¨ç»Ÿä¸€ Modalï¼Œä½†æ ¹æ®ä¸åŒç±»åˆ«åŠ¨æ€åˆ‡æ¢å­—æ®µï¼š

- `agriculture-*`: ç¼–è¾‘ã€Œäº©æ•°ã€ã€ã€Œå•äº§ã€ã€ã€Œå•ä»·ã€
- `digital-platform`: ç¼–è¾‘ã€ŒæœåŠ¡è§„æ¨¡ã€ã€ã€Œå•ä»·ã€
- `transaction-hub`: ç¼–è¾‘ã€Œäº¤æ˜“é¢ã€ã€ã€Œææˆæ¯”ä¾‹ã€

> âš ï¸ æ‰€æœ‰å˜æ›´å®æ—¶æ›´æ–°åˆ°å†…å­˜ä¸­ï¼Œä¸ç«‹å³å†™å…¥ DBã€‚

---

## ğŸ“ˆ æ¨¡å—ä¸ƒï¼šè¾¾äº§ç‡æ¨¡å‹åº”ç”¨ï¼ˆCapacity Ramp-up Modelï¼‰

### 7.1 è‡ªåŠ¨åŒ¹é…é»˜è®¤æ›²çº¿

```ts
function getDefaultProductionRate(X: number): number[] {
  switch (X) {
    case 1: return [85, 100];     // è¿è¥ç¬¬1å¹´85%ï¼Œç¬¬2å¹´èµ·100%
    case 2: return [85, 95, 100];  // ç¬¬1~2å¹´é€’å¢
    case 3: return [70, 85, 95, 100];
    default: return [70, 80, 90, 100]; // fallback
  }
}
```

### 7.2 å±•ç¤ºå½¢å¼

åœ¨è¿›å…¥è¯¥æ­¥éª¤æ—¶æç¤ºï¼š
```text
é¡¹ç›®å»ºè®¾æœŸå†…å°†é€æ­¥é‡Šæ”¾äº§èƒ½ï¼Œé¢„è®¡è¾¾äº§ç‡å¦‚ä¸‹ï¼š

- è¿è¥ç¬¬1å¹´ï¼š70%
- è¿è¥ç¬¬2å¹´ï¼š85%
- è¿è¥ç¬¬3å¹´ï¼š95%
- ç¬¬4å¹´èµ·ï¼š100%

æ˜¯å¦æ¥å—è¯¥æ›²çº¿ï¼Ÿå¯è¾“å…¥ï¼š
`æ›´æ–°è¾¾äº§ç‡ ç¬¬1å¹´80%, ç¬¬3å¹´90%`
```

### 7.3 è§£æå‡½æ•°

```ts
function parseRampUp(input: string): number[] {
  const matches = input.matchAll(/ç¬¬(\d+)å¹´(\d+)%/g);
  const rates: { [key: number]: number } = {};
  for (const m of matches) {
    rates[parseInt(m[1])] = parseInt(m[2]);
  }
  return Object.values(rates).sort((a, b) => a - b); // ç®€åŒ–ç‰ˆå¤„ç†
}
```

> å­˜å…¥ store: `store.productionRates = [80, 90, 100];`

---

## âœ… æ¨¡å—å…«ï¼šæ ¸å¿ƒæ•°æ®äº¤å‰æ ¡éªŒï¼ˆValidation Engineï¼‰

åœ¨ç”Ÿæˆæ­£å¼æŠ¥è¡¨å‰æ‰§è¡Œè‡ªåŠ¨è´¨æ£€ã€‚

### 8.1 æ ¡éªŒåˆ—è¡¨

| æ ¡éªŒé¡¹ | è§„åˆ™ | é”™è¯¯è¿”å› |
|--------|------|--------|
| â‘  è¾¾äº§ä¸€è‡´æ€§ | `ç¬¬ä¸€å¹´æ€»æ”¶å…¥ â‰ˆ å…¨è¾¾äº§Ã—rate1 Â± 0.001%` | "è¯·æ£€æŸ¥è¿è¥é¦–å¹´æ”¶å…¥æ°´å¹³" |
| â‘¡ å¢å€¼ç¨é€»è¾‘ | `each VAT â‰ˆ notax Ã— taxrate && diff < 0.001` | "å¢å€¼ç¨è®¡ç®—åå·®è¶…é™" |
| â‘¢ éç©ºå®Œæ•´æ€§ | è‡³å°‘åŒ…å«ä¸€é¡¹æœ‰æ•ˆæ”¶å…¥é¡¹ | "æš‚æ— æœ‰æ•ˆæ”¶å…¥é¡¹ï¼Œè¯·æ·»åŠ " |
| â‘£ æ•°æ®å®Œæ•´æ€§ | æ‰€æœ‰å¿…å¡«å­—æ®µå·²å¡«å†™ | æ ‡çº¢ç¼ºå¤±å­—æ®µ |

### 8.2 æ ¸å¿ƒåˆ¤æ–­å‡½æ•°

```ts
function validateRevenueModel(data: RevenueItem[]): ValidationError[] {
  const errors: ValidationError[] = [];

  if (data.length === 0) {
    errors.push({ code: 'EMPTY', message: 'æœªæ·»åŠ ä»»ä½•æ”¶å…¥é¡¹' });
  }

  data.forEach(item => {
    if (!item.unitPrice && item.investment > 0) {
      errors.push({ code: 'MISSING_PRICE', row: item.id });
    }
    const calculatedVat = round(item.taxableIncome - item.nonTaxIncome, 6);
    if (Math.abs(calculatedVat - item.vatAmount) > 0.001) {
      errors.push({ code: 'INVALID_VAT', row: item.id });
    }
  });

  return errors;
}
```

> âŒ æœ‰é”™è¯¯ â†’ è¿”å›ç”¨æˆ·ä¿®æ­£ç•Œé¢ï¼Œæ ‡æ³¨é—®é¢˜ç‚¹ã€‚

---

## ğŸ“‹ æ¨¡å—ä¹ï¼šè¾“å‡ºç»“æœï¼ˆæœ€ç»ˆæŠ¥è¡¨ç”Ÿæˆï¼‰

### 9.1 æŠ¥è¡¨æ ¼å¼è¦æ±‚

ç”Ÿæˆæ ‡å‡† Markdown è¡¨æ ¼ï¼Œæ ‡é¢˜æ˜ç¡®ï¼š

```markdown
### ã€Šé¡¹ç›®è¥ä¸šæ”¶å…¥é¢„æµ‹è¡¨ã€‹ï¼ˆå«è¾¾äº§ç‡è°ƒæ•´ï¼‰

|å¹´åº¦|å†œäº§å“é”€å”®|SaaSæ”¶å…¥|...|æ€»æ”¶å…¥|ä¸å«ç¨æ€»é¢|åˆè®¡å¢å€¼ç¨|
|---|---------|-------|---|--------|----------|-------------|
|ç¬¬1å¹´|275Ã—70%=192.5|60Ã—70%=42|...|234.5|218.13|16.37|
|ç¬¬2å¹´|233.75|51.0|...|283.75|...|...|
|...|...|...|...|...|...|...|
|[N]å¹´åˆè®¡|âˆ‘=5,820|âˆ‘=1,250|...|âˆ‘=8,920|âˆ‘=8,220|âˆ‘=700|
```

> ğŸ’¡ `[N]å¹´åˆè®¡` åˆ—ä»…ä¸ºè¿è¥æœŸå†…ç´¯è®¡ï¼Œä¸å«å»ºè®¾æœŸã€‚

### 9.2 TypeScript è¾“å‡ºæ¥å£

```ts
export interface RevenueForecastTable {
  years: string[]; // ["ç¬¬1å¹´", ..., "ç¬¬Nå¹´", "[N]å¹´åˆè®¡"]
  items: {
    name: string;
    category: RevenueCategory;
    annualValues: number[]; // åŒ…æ‹¬è¾¾äº§ç‡å½±å“
  }[];
  totalRow: {
    taxableIncome: number[];
    nonTaxIncome: number[];
    vatAmount: number[];
  };
}
```

---

## ğŸ› ï¸ å‰ç«¯å®ç°å»ºè®®

### ç»„ä»¶æ ‘ç»“æ„ï¼ˆ/src/pages/RevenueModelingPageï¼‰

```
RevenueModelingPage/
â”œâ”€â”€ StepGuard.tsx            â† çŠ¶æ€å®ˆå«ç»„ä»¶
â”œâ”€â”€ PeriodConfirmation.tsx  â† è®¡ç®—æœŸé€‰æ‹©
â”œâ”€â”€ AISuggestionPanel.tsx    â† AIè¥æ”¶å»ºè®®å±•ç¤º
â”œâ”€â”€ DynamicRevenueTable.tsx â† åŠ¨æ€è¡¨æ ¼ä¸»ä½“
â”œâ”€â”€ EditModal.tsx           â† ä¿®æ”¹/æ–°å¢çª—å£
â”œâ”€â”€ ProductionRatePanel.tsx â† è¾¾äº§ç‡è®¾ç½®
â”œâ”€â”€ ValidationTips.tsx      â† æ ¡éªŒæç¤ºæ 
â””â”€â”€ ResultPreview.tsx       â† æœ€ç»ˆé¢„è§ˆä¸å¯¼å‡º
```

### çŠ¶æ€ç®¡ç†ï¼ˆZustand Storeï¼‰

```ts
// store/useRevenueModelStore.ts
import create from 'zustand';

interface RevenueModelState {
  context: BaseContext | null;
  calculationPeriod: number;
  operatingYears: number;
  selectedCategories: string[];
  revenueItems: RevenueItem[];
  productionRates: number[];
  isConfirmed: boolean;

  addRevenueItem: (item: Omit<RevenueItem, 'id'>) => void;
  updateRevenueItem: (id: string, updates: Partial<RevenueItem>) => void;
  deleteRevenueItem: (id: string) => void;
  setProductionRates: (rates: number[]) => void;
  validate: () => { valid: boolean; errors: ValidationError[] };
  reset: () => void;
}
```

### å…³é”®å·¥å…·å‡½æ•°åº“ï¼ˆ/lib/revenueUtils.tsï¼‰

```ts
export const calculateRevenue = (
  raw: number,
  rate: number,
  precision: number = 6
): number => parseFloat((raw * rate).toFixed(precision));

export const toTaxInclusive = (priceExcl: number, taxRate: number): number =>
  priceExcl * (1 + taxRate);

export const splitVat = (total: number, taxRate: number) => ({
  nonTax: total / (1 + taxRate),
  vat: total - total / (1 + taxRate)
});
```

---

## ğŸ§ª æ¥å£æ‰©å±•ï¼ˆBackend API Designï¼‰

### æ–°å¢è·¯ç”±
```ts
POST /api/projects/:id/revenue-model   â† æäº¤æ”¶å…¥å»ºæ¨¡æ•°æ®
GET  /api/projects/:id/revenue-model   â† è·å–å·²æœ‰æ¨¡å‹
PUT  /api/projects/:id/revenue-model   â† æ›´æ–°æ¨¡å‹
```

### è¯·æ±‚ä½“ç¤ºä¾‹
```json
{
  "calculation_period": 30,
  "operating_years": 27,
  "revenue_items": [
    {
      "type": "agriculture-crop",
      "name": "ç”˜è”—é”€å”®",
      "variety": "ç”˜è”—",
      "acreage": 800,
      "yield_per_acre": 6.25,
      "unit_price": 550,
      "vat_rate": 0.09
    }
  ],
  "production_rates": [0.7, 0.85, 0.95, 1.0, 1.0]
}
```

> å“åº”æˆåŠŸåå­˜å…¥ `revenue_cost_estimates` è¡¨ï¼ˆè§åŸæ•°æ®åº“è®¾è®¡ï¼‰

---

## âœ”ï¸ å®Œæˆæ ‡å¿—ä¸å‡ºå£

å½“ä¸”ä»…å½“æ‰€æœ‰æ ¡éªŒé€šè¿‡åï¼Œè¾“å‡ºï¼š

```markdown
ã€æ­¥éª¤äºŒå·²å®Œæˆã€‘
å·²å®Œæˆã€Šè¥ä¸šæ”¶å…¥é¢„æµ‹è¡¨ã€‹ç¼–åˆ¶ï¼Œè®¡ç®—æœŸä¸º 30 å¹´ï¼ˆå»ºè®¾æœŸ 3 å¹´ï¼Œè¿è¥æœŸ 27 å¹´ï¼‰ã€‚

### ã€Šé¡¹ç›®è¥ä¸šæ”¶å…¥é¢„æµ‹è¡¨ã€‹
<!-- æ­¤å¤„æ’å…¥å®Œæ•´è¡¨æ ¼ -->

---
ä¸‹ä¸€æ­¥æ“ä½œï¼š
- è¾“å…¥ `è¿›å…¥ç¬¬ä¸‰æ­¥`ï¼Œæˆ‘å°†å¼€å±•è´¢åŠ¡è¯„ä»·ã€‚
- å¦‚éœ€ä¿®æ”¹ï¼Œè¯·è¾“å…¥ `ä¿®æ”¹æ”¶å…¥`ã€‚
```

---

## âœ… åç»­å»ºè®®ï¼ˆRoadmapï¼‰

| åŠŸèƒ½ | æè¿° |
|------|------|
| ğŸ“ˆ æˆæœ¬æ¨¡å—è”åŠ¨ | ä¸‹ä¸€é˜¶æ®µå¼•å…¥æˆæœ¬é¡¹å»ºæ¨¡ï¼Œç»“åˆæŠ˜æ—§æ‘Šé”€ |
| ğŸ’¬ LLM åŠ¨æ€ç”Ÿæˆæ–‡æ¡ˆ | å°†â€œè¾¾äº§åŸå› â€ã€â€œå®šä»·ä¾æ®â€ç”± LLM æè¿°è¡¥å…… |
| ğŸ“ Excel å¯¼å‡ºåŠŸèƒ½ | æ”¯æŒ `.xlsx` ä¸‹è½½åŸå§‹æ˜ç»† |
| ğŸ” å†å²ç‰ˆæœ¬å¯¹æ¯” | æŸ¥çœ‹ä¸åŒå»ºæ¨¡æ–¹æ¡ˆä¹‹é—´çš„å·®å¼‚ |
| ğŸ§® å†…ç½®è®¡ç®—å™¨æµ®çª— | å¿«é€Ÿæ¢ç®—å•ä»·ã€é¢ç§¯ã€äº§é‡ä¹‹é—´çš„å…³ç³» |

---

## ğŸ“ é™„å½• Câ€™: è¥æ”¶æˆæœ¬æµç¨‹å›¾

```mermaid
flowchart TB
    Start[å¼€å§‹] --> ConfirmPeriod[è®¡ç®—æœŸç¡®è®¤]
    ConfirmPeriod --> ShowSuggestions[AIç”Ÿæˆè¥æ”¶å»ºè®®]
    ShowSuggestions --> UserSelect[ç”¨æˆ·é€‰æ‹©æ”¶å…¥ç±»å‹]
    UserSelect --> GenerateTable[ç”ŸæˆåŠ¨æ€æ”¶å…¥è¡¨]
    
    GenerateTable --> EditLoop
    EditLoop --> Modify{ä¿®æ”¹?}
    Modify -->|ä¿®æ”¹æŸè¡Œ| EditModal
    Modify -->|å¢åŠ æ–°é¡¹| AddNew
    Modify -->|åˆ é™¤æ— æ•ˆ| DeleteRow
    Modify -->|ç¡®è®¤æ— è¯¯| Validate
    
    EditModal --> UpdateTable
    AddNew --> UpdateTable
    DeleteRow --> UpdateTable
    UpdateTable --> EditLoop
    
    Validate --> CheckValidations[æ‰§è¡Œäº¤å‰æ ¡éªŒ]
    CheckValidations -->|å¤±è´¥| HighlightErrors[æ ‡çº¢é”™è¯¯é¡¹]
    CheckValidations -->|é€šè¿‡| GenerateFinal[ç”Ÿæˆã€Šè¥ä¸šæ”¶å…¥é¢„æµ‹è¡¨ã€‹]
    GenerateFinal --> Complete[å®Œæˆï¼Œç­‰å¾…ä¸‹ä¸€æ­¥]
```

---

## ğŸ“„ é™„å½• Dâ€™ï¼šç‰ˆæœ¬æ›´æ–°æ—¥å¿—

| ç‰ˆæœ¬ | æ—¥æœŸ | å†…å®¹ |
|------|------|------|
| v1.0 | 2025-04-04 | åˆå§‹è‰æ¡ˆï¼ŒåŸºäºè®°å¿†æ•´ç†é€»è¾‘æ¡†æ¶ |
| v2.0 | 2025-04-05 | æ•´åˆæˆç‹¬ç«‹æ¨¡å—æ–‡æ¡£ï¼ŒåŠ å…¥ TS ç±»å‹å®šä¹‰ã€ç»„ä»¶ç»“æ„ã€API è§„èŒƒ |

---

âœ… **ç»“è¯­**ï¼š
è¿™ä»½æ–‡æ¡£å·²è¶³å¤Ÿä½œä¸ºå‰ç«¯å·¥ç¨‹å¸ˆç›´æ¥å¼€å‘çš„**åŠŸèƒ½è¯´æ˜ä¹¦ + æ•°æ®æ¨¡å‹æŒ‡å— + äº¤äº’è§„èŒƒä¹¦**ã€‚ä½ å¯ä»¥å°†å…¶æ‹†åˆ†ä¸º PRD å­æ¨¡å—ï¼Œå¹¶åˆ†é…ç»™å›¢é˜Ÿæˆå‘˜åˆ†å·¥å®æ–½ã€‚

å¦‚æœä½ éœ€è¦æˆ‘è¿›ä¸€æ­¥è¾“å‡ºï¼š

- React ç»„ä»¶ä»£ç éª¨æ¶ï¼ˆTSX + hooksï¼‰
- Zustand store çš„å®Œæ•´å®ç°
- è¡¨æ ¼ç¼–è¾‘æ¨¡æ€æ¡†çš„è®¾è®¡ç¨¿å»ºè®®
- æˆ–ä¸åç«¯è”è°ƒçš„ Postman ç¤ºä¾‹é›†åˆ

è¯·å‘Šè¯‰æˆ‘ï¼Œæˆ‘å¯ä»¥ä¸ºä½ é€é¡¹è¡¥å…¨ã€‚
