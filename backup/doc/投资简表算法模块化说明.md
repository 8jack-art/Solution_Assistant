# 投资简表算法模块化重构说明

## 概述
将投资估算简表中的各种计算算法从主文件 `investmentCalculator.ts` 中分离到独立的算法模块文件中，提高代码的可维护性和可读性。

## 模块结构

### 1. 贷款计算算法模块
**文件路径**: `/opt/Solution_Assistant/server/src/lib/algorithms/loanCalculation.ts`

**功能**:
- 贷款分级取整（金融规范）
- "头大尾小"分年借款分配算法
- 建设期利息计算（单利计息）

**主要函数**:
- `roundLoanAmount(amount: number): number` - 贷款取整
- `distributeLoanByYear(loanTotal: number, years: number): number[]` - 分年借款分配
- `calculateConstructionInterest(...)` - 计算建设期利息

**导出接口**:
- `YearlyInterest` - 年度利息数据结构
- `LoanCalculationResult` - 贷款计算结果

---

### 2. 投资估算各部分计算模块
**文件路径**: `/opt/Solution_Assistant/server/src/lib/algorithms/partCalculation.ts`

**功能**:
- 生成A部分工程费用（支持AI生成或默认数据）
- 计算B部分工程其它费用

**主要函数**:
- `generatePartAItems(...)` - 生成A部分初始子项
- `calculatePartB(partATotal: number, landCost: number)` - 计算B部分

**导出接口**:
- `InvestmentItem` - 投资项目数据结构

---

### 3. 迭代调整算法模块
**文件路径**: `/opt/Solution_Assistant/server/src/lib/algorithms/iterationAdjustment.ts`

**功能**:
- 全局调整算法（使总投资收敛到目标值）
- 最小占比强制规则
- 子项数值缩放

**主要函数**:
- `applyGlobalAdjustment(...)` - 全局调整
- `enforceMinimumShare(items)` - 强制最小占比
- `scaleItemValues(item, ratio)` - 缩放子项数值

**导出常量**:
- `MAX_ITERATIONS = 50` - 最大迭代次数
- `GAP_THRESHOLD = 0.015` - 差距率阈值（1.5%）
- `ADJUSTMENT_STEP_RATE = 0.0075` - 调整步长（0.75%）
- `MAX_ITEM_ADJUSTMENT = 0.2` - 最大调整幅度（20%）
- `MIN_ITEM_SHARE = 0.01` - 最小占比（1%）

---

### 4. 主文件（统一调度）
**文件路径**: `/opt/Solution_Assistant/server/src/lib/investmentCalculator.ts`

**功能**:
- 统一循环迭代算法的主流程控制
- 协调各算法模块完成投资估算

**主要函数**:
- `calculateInvestmentEstimate(params)` - 主计算函数
- `finalizeResult(...)` - 最终化结果，计算占比

**迭代流程**:
1. **第一阶段**: 建设期利息迭代收敛（最大10次）
   - 收敛条件: |新项目总资金 - 旧项目总资金| < 0.01万元
2. **第二阶段**: 目标投资差距调整迭代（最大50次）
   - 收敛条件: 差距率 ≤ 1.5%

---

## 重构优势

### 1. **代码组织更清晰**
- 每个算法模块职责单一，易于理解
- 文件大小从662行减少到约245行

### 2. **可维护性提升**
- 算法逻辑独立，修改互不影响
- 单元测试更容易编写

### 3. **可复用性增强**
- 各算法模块可独立导出使用
- 贷款计算、迭代调整等算法可在其他场景复用

### 4. **符合单一职责原则**
- 贷款计算专注于利息计算
- 迭代调整专注于收敛算法
- 主文件专注于流程编排

---

## 调用关系图

```
investmentCalculator.ts (主文件)
├── algorithms/loanCalculation.ts
│   ├── roundLoanAmount()
│   ├── distributeLoanByYear()
│   └── calculateConstructionInterest()
│
├── algorithms/partCalculation.ts
│   ├── generatePartAItems()
│   └── calculatePartB()
│
└── algorithms/iterationAdjustment.ts
    ├── enforceMinimumShare()
    ├── applyGlobalAdjustment()
    └── scaleItemValues()
```

---

## 使用示例

在 `investmentController.ts` 中调用：

```typescript
import { calculateInvestmentEstimate } from '../lib/investmentCalculator.js'

// 使用统一的主函数
const result = calculateInvestmentEstimate({
  projectName: project.project_name,
  targetInvestment: project.total_investment,
  constructionYears: project.construction_years,
  operationYears: project.operation_years,
  loanRatio: customLoanRatio,
  loanInterestRate: project.loan_interest_rate,
  landCost: landCost,
  aiGeneratedItems: ai_items,
  customLoanAmount: finalCustomLoanAmount
})
```

无需修改调用方式，API保持不变。

---

## 注意事项

1. **保持向后兼容**: 主函数 `calculateInvestmentEstimate` 的接口未变，现有代码无需修改
2. **模块依赖**: 所有算法模块使用 ES6 模块导入/导出
3. **类型安全**: 所有模块都定义了 TypeScript 类型接口
4. **算法完整性**: 所有算法逻辑保持不变，仅进行了结构重组

---

## 后续优化建议

1. **单元测试**: 为每个算法模块编写独立的单元测试
2. **性能优化**: 可考虑在迭代调整中引入更智能的步长调整策略
3. **日志增强**: 在关键算法节点添加详细日志，便于调试
4. **配置化**: 将常量（如迭代次数、阈值等）提取为可配置项

---

## 文件清单

### 新增文件
- `/opt/Solution_Assistant/server/src/lib/algorithms/loanCalculation.ts`
- `/opt/Solution_Assistant/server/src/lib/algorithms/partCalculation.ts`
- `/opt/Solution_Assistant/server/src/lib/algorithms/iterationAdjustment.ts`

### 修改文件
- `/opt/Solution_Assistant/server/src/lib/investmentCalculator.ts` (大幅简化)

### 文档
- `/opt/Solution_Assistant/doc/投资简表算法模块化说明.md` (本文档)
