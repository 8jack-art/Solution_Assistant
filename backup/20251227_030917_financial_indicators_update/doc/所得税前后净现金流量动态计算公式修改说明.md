# 所得税前后净现金流量动态计算公式修改说明

## 修改背景

根据项目需求，需要对项目投资现金流量表中的"所得税前净现金流量（动态）"和"所得税后净现金流量（动态）"的计算公式进行修改，以符合财务分析的标准要求。

## 修改内容

### 1. 所得税前净现金流量（动态）计算公式

**原公式：**
```
所得税前净现金流量（动态）= 所得税前净现金流量
```

**新公式：**
```
所得税前净现金流量（动态）= 所得税前净现金流量/(1+A)^B
```

其中：
- A：基准收益率（所得税前），使用小数值（如0.06）
- B：计算期中的第n年，从建设期第1年开始计算，对应当前数据所在的列

### 2. 所得税后净现金流量（动态）计算公式

**原公式：**
```
所得税后净现金流量（动态）= 所得税后净现金流量
```

**新公式：**
```
所得税后净现金流量（动态）= C-D/(1+E)^B
```

其中：
- C：所得税前净现金流量（动态）
- D：调整所得税（本列对应的调整所得税，不是动态计算后的调整所得税）
- E：基准收益率（所得税后），使用小数值（如0.06）
- B：计算期中的第n年，从建设期第1年开始计算，对应当前数据所在的列

注意：根据数学运算优先级，公式实际为：所得税后净现金流量（动态）= C - D/(1+E)^B

## 实现细节

### 1. 代码修改位置

修改了 `client/src/components/revenue-cost/FinancialIndicatorsTable.tsx` 文件中的以下部分：

1. **表格渲染部分**（第2578-2908行）：
   - 所得税前净现金流量（动态）计算逻辑
   - 累计所得税前净现金流量（动态）计算逻辑
   - 所得税后净现金流量（动态）计算逻辑
   - 累计所得税后净现金流量（动态）计算逻辑

2. **Excel导出功能**（第1232-1348行）：
   - 在导出的Excel文件中添加了4行动态计算数据

### 2. 关键代码实现

#### 所得税前净现金流量（动态）计算

```typescript
// 应用动态计算公式：所得税前净现金流量/(1+A)^B
// B从建设期第1年开始计算，所以直接使用year
const preTaxRateDecimal = preTaxRate / 100; // 转换为小数
const discountFactor = Math.pow(1 + preTaxRateDecimal, year);
const dynamicValue = yearPreTaxCashFlow / discountFactor;
```

#### 所得税后净现金流量（动态）计算

```typescript
// 应用动态计算公式：C-D/(1+E)^B
// C为所得税前净现金流量（动态），D为调整所得税
// B从建设期第1年开始计算，所以直接使用year

// 先计算所得税前净现金流量（动态）
const preTaxRateDecimal = preTaxRate / 100; // 转换为小数
const preTaxDiscountFactor = Math.pow(1 + preTaxRateDecimal, year);
const dynamicPreTaxCashFlow = yearPreTaxCashFlow / preTaxDiscountFactor;

// 再计算所得税后净现金流量（动态）= C-D/(1+E)^B
const postTaxRateDecimal = postTaxRate / 100; // 转换为小数
const discountFactor = Math.pow(1 + postTaxRateDecimal, year);
const dynamicValue = dynamicPreTaxCashFlow - yearAdjustedTax / discountFactor;
```

### 3. 参数说明

1. **基准收益率设置**：
   - 通过财务指标设置弹窗可以设置所得税前和所得税后的基准收益率
   - 设置保存在localStorage中，确保页面刷新后仍然有效
   - 默认值均为6%

2. **年份计算**：
   - B从建设期第1年开始计算，对应当前数据所在的列
   - 建设期和运营期统一使用从1开始的连续年份编号

3. **调整所得税处理**：
   - D为本列对应的调整所得税，不是动态计算后的调整所得税
   - 建设期没有调整所得税，值为0
   - 运营期根据利润与利润分配表中的息税前利润计算

## 功能影响

1. **表格显示**：
   - 项目投资现金流量表底部新增4行动态计算数据
   - 数据实时根据基准收益率设置更新

2. **Excel导出**：
   - 导出的Excel文件包含完整的动态计算数据
   - 与表格显示保持一致

3. **财务分析**：
   - 提供更准确的动态现金流分析
   - 支持不同基准收益率下的财务指标计算

## 注意事项

1. **基准收益率使用小数值**：
   - 确保A和E使用小数值（如0.06）而不是百分比（如6%）
   - 代码中已实现百分比到小数的转换

2. **年份计算基准**：
   - B从建设期第1年开始计算，不是运营期第1年
   - 确保与表格列的对应关系正确

3. **调整所得税的处理**：
   - 使用本列对应的调整所得税，不是动态计算后的调整所得税
   - 建设期调整所得税为0
   
4. **建设期所得税前后净现金流量（动态）的一致性**：
   - 在建设期，调整所得税为0，所以所得税后净现金流量（动态）= 所得税前净现金流量（动态）/(1+E)^B
   - 确保在建设期，所得税前净现金流量（动态）与所得税后净现金流量（动态）的折现计算逻辑一致

## 测试验证

1. **计算逻辑验证**：
   - 验证动态计算公式的正确性
   - 确认建设期和运营期的不同处理方式

2. **界面显示验证**：
   - 确认表格中动态计算数据的正确显示
   - 验证基准收益率设置变更后的数据更新

3. **Excel导出验证**：
   - 确认导出文件中包含动态计算数据
   - 验证导出数据与表格显示的一致性

## 后续优化建议

1. **性能优化**：
   - 考虑缓存计算结果，避免重复计算
   - 对于大型项目，可以优化计算性能

2. **用户体验**：
   - 可以添加动态计算公式的说明提示
   - 考虑提供计算过程的详细展示

3. **扩展功能**：
   - 可以添加更多财务指标的计算
   - 支持自定义动态计算公式