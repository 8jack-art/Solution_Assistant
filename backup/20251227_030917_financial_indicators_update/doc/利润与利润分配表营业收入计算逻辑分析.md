# 利润与利润分配表营业收入计算逻辑分析

## 问题描述

用户要求：
1. 利润与利润分配表中营业收入的运营期列的值来源于：revenueTableData中"营业收入"减"销项税额"
2. 项目投资现金流量表的营业收入直接使用revenueTableData中"营业收入"的值

## 修改结果

已按照用户要求修改了 `FinancialIndicatorsTable.tsx` 文件中的相关函数，现在营业收入的计算逻辑如下：

### 1. 修改后的利润与利润分配表营业收入计算逻辑

在 `FinancialIndicatorsTable.tsx` 文件中，`calculateOperatingRevenue` 函数（第245-286行）现在负责计算利润与利润分配表中的营业收入：

```typescript
// 计算营业收入的函数（营业收入 = 营业收入（含税） - 销项税额）
const calculateOperatingRevenue = (year?: number): number => {
  if (year !== undefined) {
    // 从 revenueTableData 中获取"营业收入"（序号1）和"销项税额"（序号2.1）的运营期列数据
    if (revenueTableData && revenueTableData.rows) {
      const revenueRow = revenueTableData.rows.find(r => r.序号 === '1');
      const outputTaxRow = revenueTableData.rows.find(r => r.序号 === '2.1');
      
      if (revenueRow && revenueRow.运营期 && revenueRow.运营期[year - 1] !== undefined &&
          outputTaxRow && outputTaxRow.运营期 && outputTaxRow.运营期[year - 1] !== undefined) {
        // 营业收入 = 营业收入（含税） - 销项税额
        return revenueRow.运营期[year - 1] - outputTaxRow.运营期[year - 1];
      }
    }
    // 如果没有表格数据，使用原有计算逻辑作为后备
    // 计算指定年份的营业收入（不含税）
    // 利润与利润分配表的营业收入 = 营业收入估算表的营业收入 - 销项税额
    const productionRate = productionRates?.find(p => p.yearIndex === year)?.rate || 1;
    return revenueItems.reduce((sum, item) => {
      // 计算含税收入
      const taxableRevenue = calculateYearlyRevenue(item, year, productionRate);
      // 计算销项税额 = 含税收入 - 不含税收入 = 含税收入 - 含税收入/(1+税率)
      const outputTax = taxableRevenue - taxableRevenue / (1 + item.vatRate);
      // 不含税收入 = 含税收入 - 销项税额
      const nonTaxRevenue = taxableRevenue - outputTax;
      return sum + nonTaxRevenue;
    }, 0);
  } else {
    // 从 revenueTableData 中获取"营业收入"（序号1）和"销项税额"（序号2.1）的合计数据
    if (revenueTableData && revenueTableData.rows) {
      const revenueRow = revenueTableData.rows.find(r => r.序号 === '1');
      const outputTaxRow = revenueTableData.rows.find(r => r.序号 === '2.1');
      
      if (revenueRow && revenueRow.合计 !== undefined &&
          outputTaxRow && outputTaxRow.合计 !== undefined) {
        // 营业收入 = 营业收入（含税） - 销项税额
        return revenueRow.合计 - outputTaxRow.合计;
      }
    }
    // 如果没有表格数据，使用原有计算逻辑作为后备
    // 计算所有年份的营业收入合计
    if (!context) return 0;
    const years = Array.from({ length: context.operationYears }, (_, i) => i + 1);
    let totalSum = 0;
    years.forEach((year) => {
      totalSum += calculateOperatingRevenue(year);
    });
    return totalSum;
  }
};
```

### 2. 修改后的项目投资现金流量表营业收入计算逻辑

在 `FinancialIndicatorsTable.tsx` 文件中，项目投资现金流量表的营业收入部分（第1948-1969行）现在直接使用revenueTableData中"营业收入"的值：

```typescript
// 1.1 营业收入
<Table.Tr>
  <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>1.1</Table.Td>
  <Table.Td style={{ border: '1px solid #dee2e6' }}>营业收入</Table.Td>
  <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
    {(() => {
      // 直接从 revenueTableData 中获取"营业收入"（序号1）的合计数据
      if (revenueTableData && revenueTableData.rows) {
        const row = revenueTableData.rows.find(r => r.序号 === '1');
        if (row && row.合计 !== undefined) {
          return formatNumberNoRounding(row.合计);
        }
      }
      return formatNumberNoRounding(0);
    })()}
  </Table.Td>
  {years.map((year) => {
    let yearTotal = 0;
    
    if (year > constructionYears) {
      // 运营期
      const operationYear = year - constructionYears;
      // 直接从 revenueTableData 中获取"营业收入"（序号1）的运营期列数据
      if (revenueTableData && revenueTableData.rows) {
        const row = revenueTableData.rows.find(r => r.序号 === '1');
        if (row && row.运营期 && row.运营期[operationYear - 1] !== undefined) {
          yearTotal = row.运营期[operationYear - 1];
        }
      }
    }
    
    return (
      <Table.Td key={year} style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
        {formatNumberWithZeroBlank(yearTotal)}
      </Table.Td>
    );
  })}
</Table.Tr>
```

### 3. 修改后的计算方式

现在有两个不同的营业收入计算方式：

1. **利润与利润分配表中的营业收入**：
   - 从 `revenueTableData` 中获取"营业收入"（序号1）和"销项税额"（序号2.1）的运营期列数据，然后相减
   - 营业收入 = 营业收入（含税） - 销项税额

2. **项目投资现金流量表中的营业收入**：
   - 直接从 `revenueTableData` 中获取"营业收入"（序号1）的运营期列数据
   - 不进行任何减法计算

### 4. revenueTableData 的生成

在 `DynamicRevenueTable.tsx` 文件中，`generateRevenueTableData` 函数（第694-816行）负责生成营业收入表数据：

```typescript
// 1. 营业收入
const row1 = { 序号: '1', 收入项目: '营业收入', 合计: 0, 运营期: [] as number[] };
years.forEach((year) => {
  const yearTotal = revenueItems.reduce((sum, item) => {
    const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
    return sum + calculateYearlyRevenue(item, year, productionRate)
  }, 0);
  row1.运营期.push(yearTotal);
  row1.合计 += yearTotal;
});
rows.push(row1);
```

这里的营业收入是**含税收入**。

### 5. 销项税额的计算

销项税额在 `DynamicRevenueTable.tsx` 文件中通过计算每个收入项的含税收入减去不含税收入得出：

```typescript
// 销项税额 = 含税收入 - 不含税收入 = 含税收入 - 含税收入/(1+税率)
const outputTax = taxableRevenue - taxableRevenue / (1 + item.vatRate);
```

## 结论

1. 已按照用户要求修改了两个表格中的营业收入计算逻辑：
   - 利润与利润分配表：营业收入 = 营业收入（含税） - 销项税额
   - 项目投资现金流量表：营业收入 = 营业收入（含税）

2. 修改位置：`FinancialIndicatorsTable.tsx` 文件中的 `calculateOperatingRevenue` 函数和项目投资现金流量表的营业收入部分。

3. 如果没有表格数据，则使用原有的后备计算逻辑。