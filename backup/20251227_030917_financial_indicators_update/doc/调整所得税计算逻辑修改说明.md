# 调整所得税计算逻辑修改说明

## 修改背景

根据需求，需要修改项目投资现金流量表中"5 调整所得税"运营期列数据来源，使其来自"利润与利润分配表"中"19 息税前利润（利润总额+利息支出）"运营期各列的数据乘以"所得税率"。

## 修改内容

### 1. 新增数据结构

在 `client/src/stores/revenueCostStore.ts` 中新增了利润与利润分配表的数据结构：

```typescript
// 利润与利润分配表数据结构
export interface ProfitDistributionTableRow {
  序号: string;           // "1", "1.1", "2", "3" 等
  项目: string;           // "营业收入", "税金附加等", "总成本费用" 等
  合计: number;           // 合计列数值
  运营期: number[];       // 各年数据数组
}

export interface ProfitDistributionTableData {
  rows: ProfitDistributionTableRow[];   // 所有行数据
  updatedAt: string;      // 最后更新时间
}
```

### 2. 更新状态管理

在 `RevenueCostState` 接口中添加了利润与利润分配表的状态：

```typescript
// ========== 表格数据 ==========
revenueTableData: RevenueTableData | null
costTableData: CostTableData | null
profitDistributionTableData: ProfitDistributionTableData | null  // 新增

// ========== 操作方法 ==========
setRevenueTableData: (data: RevenueTableData | null) => void
setCostTableData: (data: CostTableData | null) => void
setProfitDistributionTableData: (data: ProfitDistributionTableData | null) => void  // 新增
```

### 3. 修改调整所得税计算逻辑

在 `client/src/components/revenue-cost/FinancialIndicatorsTable.tsx` 中修改了 `calculateAdjustedIncomeTax` 函数：

```typescript
// 计算调整所得税的函数
const calculateAdjustedIncomeTax = (year?: number): number => {
  if (year !== undefined) {
    // 优先从利润与利润分配表中获取"19 息税前利润（利润总额+利息支出）"运营期列数据
    if (profitDistributionTableData && profitDistributionTableData.rows) {
      const row = profitDistributionTableData.rows.find(r => r.序号 === '19');
      if (row && row.运营期 && row.运营期[year - 1] !== undefined) {
        // 使用设置的所得税率计算调整所得税
        return row.运营期[year - 1] * (incomeTaxRate / 100);
      }
    }
    // 如果没有利润与利润分配表数据，使用原有计算逻辑作为后备
    return 0;
  } else {
    // 优先从利润与利润分配表中获取"19 息税前利润（利润总额+利息支出）"合计数据
    if (profitDistributionTableData && profitDistributionTableData.rows) {
      const row = profitDistributionTableData.rows.find(r => r.序号 === '19');
      if (row && row.合计 !== undefined) {
        // 使用设置的所得税率计算调整所得税合计
        return row.合计 * (incomeTaxRate / 100);
      }
    }
    // 如果没有利润与利润分配表数据，使用原有计算逻辑作为后备
    // 计算所有年份的调整所得税合计
    if (!context) return 0;
    const years = Array.from({ length: context.operationYears }, (_, i) => i + 1);
    let totalSum = 0;
    years.forEach((year) => {
      totalSum += calculateAdjustedIncomeTax(year);
    });
    return totalSum;
  }
};
```

### 4. 新增数据保存函数

新增了 `saveProfitDistributionTableData` 函数，用于将利润与利润分配表的数据保存到状态中：

```typescript
// 保存利润与利润分配表数据
const saveProfitDistributionTableData = () => {
  if (!context) return;
  
  const operationYears = context.operationYears;
  const years = Array.from({ length: operationYears }, (_, i) => i + 1);
  
  // 定义表格行数据
  const tableRows = [
    { id: '1', name: '营业收入', calc: (y?: number) => calculateOperatingRevenue(y) },
    // ... 其他行数据
    { id: '19', name: '息税前利润（利润总额+利息支出）', calc: (y?: number) => calculateEBIT(y) },
    // ... 更多行数据
  ];
  
  // 构建数据行
  const rows: any[] = [];
  tableRows.forEach((row) => {
    const dataRow: any = {
      序号: row.id,
      项目: row.name,
      合计: row.id === '10' ? 0 : row.calc(undefined),
      运营期: []
    };
    
    // 计算各年数据
    years.forEach((year) => {
      const yearValue = row.calc(year);
      dataRow.运营期.push(yearValue);
    });
    
    rows.push(dataRow);
  });
  
  // 保存到store
  const { setProfitDistributionTableData } = useRevenueCostStore.getState();
  setProfitDistributionTableData({
    rows,
    updatedAt: new Date().toISOString()
  });
};
```

### 5. 更新数据保存和加载逻辑

在 `revenueCostStore.ts` 中更新了数据保存和加载逻辑，确保 `profitDistributionTableData` 能够正确保存到后端和从后端加载。

## 修改效果

1. **数据来源变更**：调整所得税现在从利润与利润分配表中的"19 息税前利润"行获取数据，而不是从其他来源获取。

2. **计算逻辑**：调整所得税 = 息税前利润 × 所得税率（默认25%）

3. **数据一致性**：确保了项目投资现金流量表和利润与利润分配表之间的数据一致性，调整所得税直接使用利润与利润分配表中计算的息税前利润。

4. **用户体验**：在打开利润与利润分配表或导出Excel时，会自动保存数据到状态中，确保调整所得税能够获取到正确的数据。

## 验证方法

1. 打开利润与利润分配表，确认"19 息税前利润"行有正确的数据
2. 打开项目投资现金流量表，查看"5 调整所得税"行的数据是否正确计算
3. 导出Excel文件，验证数据的一致性

## 注意事项

1. 如果利润与利润分配表数据不存在，调整所得税会返回0作为后备值
2. 所得税率可以在利润与利润分配表设置中调整，默认为25%
3. 数据保存是自动的，在打开或导出利润与利润分配表时会触发