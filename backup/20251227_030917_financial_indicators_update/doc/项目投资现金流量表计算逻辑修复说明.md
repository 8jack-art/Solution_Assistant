# 项目投资现金流量表计算逻辑修复说明

## 问题描述

用户反馈"3 所得税前净现金流量（1-2）"的计算结果不正确。该行应该计算"1 现金流入"运营期列数据减去"2 现金流出"运营期列数据，但实际计算结果与预期不符。

## 问题分析

经过分析，发现问题在于"3 所得税前净现金流量（1-2）"的计算逻辑没有正确使用"1 现金流入"和"2 现金流出"的计算结果进行差值计算。

## 修复方案

修改了两处代码，确保"3 所得税前净现金流量（1-2）"直接使用"1 现金流入"和"2 现金流出"的计算结果进行差值计算：

### 1. Excel导出功能中的计算逻辑（第1245-1275行）

修改前：
```typescript
// 尝试从row1和row2对象中获取数据，但这些对象在Excel导出函数中尚未完全构建
```

修改后：
```typescript
if (year <= constructionYears) {
  // 建设期：直接计算现金流入和流出的差值
  const yearInflow = 0; // 建设期没有现金流入
  const yearOutflow = calculateConstructionInvestment(year) + calculateWorkingCapital(year);
  yearTotal = yearInflow - yearOutflow;
} else {
  // 运营期：直接计算现金流入和流出的差值
  const operationYear = year - constructionYears;
  const yearInflow = calculateOperatingRevenue(operationYear) +
                    calculateSubsidyIncome(operationYear) +
                    calculateFixedAssetResidual(operationYear) +
                    calculateWorkingCapitalRecovery(operationYear);
  const yearOutflow = calculateConstructionInvestment(year) +
                    calculateWorkingCapital(year) +
                    calculateOperatingCost(operationYear) +
                    calculateVatAndTaxes(operationYear) +
                    calculateMaintenanceInvestment(operationYear);
  yearTotal = yearInflow - yearOutflow;
}
```

### 2. 表格显示中的计算逻辑（第2696-2720行）

修改前：
```typescript
// 建设期：直接使用"1 现金流入"和"2 现金流出"的计算结果
// 从表格中获取对应年份的数据
```

修改后：
```typescript
if (year <= constructionYears) {
  // 建设期：直接计算现金流入和流出的差值
  yearInflow = 0; // 建设期没有现金流入
  yearOutflow = calculateConstructionInvestment(year) + calculateWorkingCapital(year);
} else {
  // 运营期：直接计算现金流入和流出的差值
  const operationYear = year - constructionYears;
  yearInflow = calculateOperatingRevenue(operationYear) +
              calculateSubsidyIncome(operationYear) +
              calculateFixedAssetResidual(operationYear) +
              calculateWorkingCapitalRecovery(operationYear);
  yearOutflow = calculateConstructionInvestment(year) +
              calculateWorkingCapital(year) +
              calculateOperatingCost(operationYear) +
              calculateVatAndTaxes(operationYear) +
              calculateMaintenanceInvestment(operationYear);
}
```

## 修复效果

修复后，"3 所得税前净现金流量（1-2）"的计算结果将正确反映"1 现金流入"和"2 现金流出"的差值，符合用户的预期。

## 测试验证

创建了测试文件 `test-cash-flow-calculation.html` 来验证计算逻辑的正确性。测试结果显示，修改后的计算逻辑能够正确计算各年度的所得税前净现金流量。

## 相关文件

- `client/src/components/revenue-cost/FinancialIndicatorsTable.tsx` - 主要修改文件
- `test-cash-flow-calculation.html` - 测试验证文件
- `doc/项目投资现金流量表计算逻辑修复说明.md` - 本说明文档

## 注意事项

1. 修改确保了Excel导出和表格显示的计算逻辑一致性
2. 修改后的代码更加直接和清晰，避免了从表格中获取可能不正确的数据
3. 所有相关的计算函数（如calculateOperatingRevenue、calculateConstructionInvestment等）保持不变，只是确保它们的计算结果被正确使用