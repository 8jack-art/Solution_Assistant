## ğŸ¤– Assistant

ä»¥ä¸‹æ˜¯åŸºäºä½ å½“å‰å¼€å‘éœ€æ±‚å’Œç³»ç»Ÿæ¶æ„ï¼Œä¸“ä¸º **â€œè¥ä¸šæ”¶å…¥ä¸æˆæœ¬æµ‹ç®—â€æ¨¡å—** ç¼–å†™çš„å®Œæ•´ã€Š**æŠ€æœ¯è®¾è®¡æ–‡æ¡£**ã€‹ï¼ˆTechnical Design Document, TDDï¼‰ï¼Œé‡‡ç”¨æ ‡å‡†æŠ€æœ¯æ–‡æ¡£ç»“æ„ï¼Œé€‚åˆä½œä¸ºå›¢é˜Ÿåä½œã€è¯„å®¡ã€å¼€å‘è½åœ°çš„æƒå¨ä¾æ®ã€‚

---

# ğŸ“„ æŠ•èµ„é¡¹ç›®ç®¡ç†ç³»ç»Ÿ
## â€”â€” è¥ä¸šæ”¶å…¥ä¸æˆæœ¬æµ‹ç®—æ¨¡å— Â· æŠ€æœ¯è®¾è®¡æ–‡æ¡£

> **æ–‡æ¡£ç¼–å·**ï¼šTDD/RM/2025-v1.0
> **ç¼–åˆ¶å•ä½**ï¼šmiaoda-react-admin é¡¹ç›®ç»„
> **ç¼–å†™äºº**ï¼šAI åŠ©æ‰‹ + å·¥ç¨‹è´Ÿè´£äººååŒ
> **å®¡æ ¸çŠ¶æ€**ï¼šè‰æ¡ˆï¼ˆDraftï¼‰
> **é€‚ç”¨ç‰ˆæœ¬**ï¼šv0.8+ å¼€å§‹é›†æˆ
> **å¯¹åº” PRD æ¨¡å—**ï¼šç¬¬äºŒéƒ¨åˆ†åŠŸèƒ½å¢å¼ºç‰ˆ

---

## ç›®å½•

```text
1. å¼•è¨€
   1.1 æ–‡æ¡£ç›®çš„
   1.2 èŒƒå›´è¯´æ˜
   1.3 æœ¯è¯­å®šä¹‰

2. æ¶æ„è®¾è®¡
   2.1 æ•´ä½“å®šä½
   2.2 å‰åç«¯åˆ†å±‚æ¶æ„
   2.3 æ•°æ®æµå›¾

3. æ ¸å¿ƒç»„ä»¶è®¾è®¡
   3.1 çŠ¶æ€ç®¡ç†å™¨ï¼ˆZustand Storeï¼‰
   3.2 UI ç»„ä»¶æ ‘ç»“æ„
   3.3 AI æ¨èå¼•æ“ï¼ˆRules-based Engineï¼‰
   3.4 åŠ¨æ€è¡¨æ ¼æ¸²æŸ“å™¨
   3.5 è¾¾äº§ç‡æ¨¡å‹å¤„ç†å™¨
   3.6 éªŒè¯æœåŠ¡ï¼ˆValidation Serviceï¼‰

4. æ•°æ®ç»“æ„å®šä¹‰ï¼ˆTypeScript Interfacesï¼‰
   4.1 å…¨å±€ä¸Šä¸‹æ–‡
   4.2 æ”¶å…¥é¡¹ç±»å‹
   4.3 è¡¨æ ¼è¾“å‡ºç»“æ„

5. å…³é”®ç®—æ³•å®ç°
   5.1 å­—æ®µæ¨¡æ¿æ˜ å°„é€»è¾‘
   5.2 åŠ¨æ€ç¼–è¾‘æŒ‡ä»¤è§£æå™¨
   5.3 è¾¾äº§ç‡å½±å“è®¡ç®—å‡½æ•°
   5.4 å¢å€¼ç¨æ‹†è§£ç®—æ³•
   5.5 åˆè®¡åˆ—ç”Ÿæˆè§„åˆ™

6. æ¥å£å¥‘çº¦è®¾è®¡ï¼ˆREST APIï¼‰
   6.1 æ–°å¢æ¥å£æ¸…å•
   6.2 è¯·æ±‚/å“åº”æ ¼å¼
   6.3 é”™è¯¯ç è¡¨

7. ç”¨æˆ·äº¤äº’æµç¨‹ï¼ˆUser Journeyï¼‰
   7.1 æ­£å‘æµç¨‹
   7.2 å¼‚å¸¸å¤„ç†è·¯å¾„
   7.3 å¯è®¿é—®æ€§æ”¯æŒ

8. å®‰å…¨ä¸æ€§èƒ½è€ƒé‡
   8.1 è¾“å…¥å®‰å…¨é˜²æŠ¤
   8.2 è®¡ç®—æ€§èƒ½ä¼˜åŒ–
   8.3 å†…å­˜ä½¿ç”¨æ§åˆ¶

9. æµ‹è¯•ç­–ç•¥
   9.1 å•å…ƒæµ‹è¯•ç”¨ä¾‹ï¼ˆJestï¼‰
   9.2 ç»„ä»¶æµ‹è¯•ï¼ˆReact Testing Libraryï¼‰
   9.3 E2E åœºæ™¯ï¼ˆCypress ç¤ºä¾‹ï¼‰

10. éƒ¨ç½²ä¸ç›‘æ§å»ºè®®
   10.1 æ—¥å¿—åŸ‹ç‚¹è®¾è®¡
   10.2 æ“ä½œå®¡è®¡è®°å½•

é™„å½• Aï¼šæ ¸å¿ƒä¼ªä»£ç ç¤ºä¾‹  
é™„å½• Bï¼šå­—æ®µæ˜ å°„è§„åˆ™é…ç½®ï¼ˆJSON Schemaï¼‰  
é™„å½• Cï¼šUI åŸå‹è‰å›¾è¯´æ˜ï¼ˆæ–‡å­—ç‰ˆï¼‰
```

---

## 1. å¼•è¨€

### 1.1 æ–‡æ¡£ç›®çš„

æœ¬æ–‡æ¡£æ—¨åœ¨è¯¦ç»†æè¿°ã€Œè¥ä¸šæ”¶å…¥ä¸æˆæœ¬æµ‹ç®—ã€æ¨¡å—çš„æŠ€æœ¯å®ç°æ–¹æ¡ˆï¼Œæ˜ç¡®ä»¥ä¸‹å†…å®¹ï¼š

- å‰ç«¯ç»„ä»¶ç»“æ„è®¾è®¡ï¼›
- çŠ¶æ€ç®¡ç†æ¨¡å¼ï¼›
- åŠ¨æ€å»ºæ¨¡é€»è¾‘å®ç°è·¯å¾„ï¼›
- æ ¸å¿ƒä¸šåŠ¡ç®—æ³•ç¼–ç è§„èŒƒï¼›
- ä¸åç«¯çš„æ•°æ®äº¤äº’åè®®ï¼›

ç›®æ ‡æ˜¯æŒ‡å¯¼å¼€å‘å›¢é˜Ÿåœ¨ `React 18 + TypeScript + Vite` æŠ€æœ¯æ ˆä¸‹é«˜è´¨é‡å®Œæˆè¯¥åŠŸèƒ½çš„ç ”å‘ä¸é›†æˆã€‚

---

### 1.2 èŒƒå›´è¯´æ˜

æœ¬æ¨¡å—è¦†ç›–ä»ç”¨æˆ·è¾“å…¥ `è¿›å…¥ç¬¬äºŒæ­¥` åˆ°è¾“å‡ºã€Šè¥ä¸šæ”¶å…¥é¢„æµ‹è¡¨ã€‹å…¨è¿‡ç¨‹ï¼š

| å­é˜¶æ®µ | æ˜¯å¦åŒ…å« |
|--------|----------|
| âœ… è®¡ç®—æœŸç¡®è®¤ | æ˜¯ |
| âœ… AIæ¨èè¥æ”¶ç»“æ„ | æ˜¯ |
| âœ… å¤šä¸šæ€åŠ¨æ€è¡¨æ ¼ç”Ÿæˆ | æ˜¯ |
| âœ… æ”¶å…¥å»ºæ¨¡äº¤äº’å‘½ä»¤å¤„ç† | æ˜¯ |
| âœ… è¾¾äº§ç‡åº”ç”¨ | æ˜¯ |
| âœ… æ•°æ®äº¤å‰æ ¡éªŒ | æ˜¯ |
| âœ… æœ€ç»ˆæŠ¥è¡¨ç”Ÿæˆ | æ˜¯ |
| âŒ æˆæœ¬å»ºæ¨¡ç»†èŠ‚ | å¦ï¼ˆä¸‹ä¸€é˜¶æ®µæ‰©å±•ï¼‰ |
| âŒ è´¢åŠ¡è¯„ä»·è®¡ç®— | å¦ |

---

### 1.3 æœ¯è¯­å®šä¹‰

| æœ¯è¯­ | è§£é‡Š |
|------|------|
| `è¾¾äº§ç‡` | è¿è¥æœŸå†…é€å¹´é‡Šæ”¾çš„äº§èƒ½æ¯”ä¾‹ï¼Œç”¨äºç¼©æ”¾é¢„æœŸæ”¶å…¥ |
| `å«ç¨æ”¶å…¥` | é”€å”®é¢ä¸­åŒ…å«å¢å€¼ç¨çš„éƒ¨åˆ† |
| `ä¸å«ç¨æ”¶å…¥` | è¿›å…¥åˆ©æ¶¦è¡¨çš„çœŸå®è¥ä¸šæ”¶å…¥ |
| `å¢å€¼ç¨é‡‘é¢` | åº”äº¤å¢å€¼ç¨ = å«ç¨æ”¶å…¥ - ä¸å«ç¨æ”¶å…¥ |
| `äº¤å‰æ ¡éªŒ` | è‡ªåŠ¨åŒ–æ£€æµ‹æ•°æ®ä¸€è‡´æ€§ï¼Œé˜²æ­¢å»ºæ¨¡é”™è¯¯è¿›å…¥åç»­æµç¨‹ |
| `åŠ¨æ€å­—æ®µæ¨¡æ¿` | æ ¹æ®ä¸šåŠ¡ç±»å‹é€‰æ‹©ä¸åŒçš„å‚æ•°é›†åˆè¿›è¡Œå»ºæ¨¡ |
| `æŒ‡ä»¤å¼äº¤äº’` | é€šè¿‡è‡ªç„¶è¯­è¨€é£æ ¼å‘½ä»¤æ§åˆ¶è¡¨æ ¼è¡Œä¸ºï¼ˆå¦‚ â€œä¿®æ”¹ Aâ€ï¼‰ |

---

## 2. æ¶æ„è®¾è®¡

### 2.1 æ•´ä½“å®šä½

ä½œä¸ºæ•´ä¸ªæŠ•èµ„åˆ†æé“¾è·¯çš„**ä¸­é—´æ¢çº½**ï¼Œæ‰¿æ‹…ä»¥ä¸‹ä½¿å‘½ï¼š

```
[æŠ•èµ„ä¼°ç®—] â†’ [è¥æ”¶&æˆæœ¬å»ºæ¨¡] â†’ [è´¢åŠ¡è¯„ä»·]
                    â†‘
        (æ‰¿ä¸Šå¯ä¸‹ï¼Œå†³å®šç›ˆåˆ©èƒ½åŠ›å‡è®¾)
```

- æ‰¿æ¥ç¬¬ä¸€éƒ¨åˆ†è¾“å‡ºçš„å…³é”®å‚æ•°ï¼›
- è¾“å‡ºé«˜ç²¾åº¦ã€ç»“æ„åŒ–çš„å¹´åº¦ç°é‡‘æµæ•°æ®ï¼›
- æä¾›å¯è¿½æº¯ã€å¯ä¿®æ”¹çš„é€æ˜å»ºæ¨¡è¿‡ç¨‹ã€‚

---

### 2.2 å‰åç«¯åˆ†å±‚æ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ç”¨æˆ·ç•Œé¢å±‚             â”‚ â† React Components + Markdown Renderer
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     çŠ¶æ€ç®¡ç†å±‚              â”‚ â† Zustand Storeï¼ˆuseRevenueModelStoreï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    æœ¬åœ°æœåŠ¡ä¸å·¥å…·åº“           â”‚ â† Formatters, Validators, Parsers, Calculation Utils
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     HTTPå®¢æˆ·ç«¯               â”‚ â† Axios å°è£… service/revenueService.ts
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     åç«¯APIå±‚                â”‚ â† Express Router: /api/projects/:id/revenue-model
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    MariaDB æ•°æ®æŒä¹…å±‚         â”‚ â† revenue_cost_estimates è¡¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> ğŸ”§ **å‰ç«¯ä¸»å¯¼æ¨¡å¼**ï¼šç”¨æˆ·äº¤äº’é«˜åº¦å¤æ‚ï¼Œä¸»è¦é€»è¾‘ä¸‹æ²‰è‡³å‰ç«¯æ‰§è¡Œã€‚åç«¯ä»…è´Ÿè´£å­˜å‚¨ä¸è¯»å–ã€‚

---

### 2.3 æ•°æ®æµå›¾ï¼ˆData Flow Diagramï¼‰

```mermaid
flowchart TD
    U[ç”¨æˆ·è§¦å‘ 'ç»§ç»­ä¸‹ä¸€æ­¥'] --> F[Frontend]
    F --> S[Zustand Store åˆå§‹åŒ–]
    
    S --> L[Load Context From Backend]
    L -->|project_id| GET("/api/projects/:id/full-context")
    GET --> DATA{è¿”å› JSON}
    DATA --> S
    
    S --> R[Render Period Confirmation]
    R --> Input[ç”¨æˆ·é€‰æ‹©è®¡ç®—æœŸ]
    Input --> Parse[è§£æè¾“å…¥å¹¶éªŒè¯]
    Parse --> S
    
    S --> AI[Run Rule-Based AI Recommender]
    AI --> Table[Generate Dynamic Revenue Table]
    
    Table --> Cmd{ç”¨æˆ·è¾“å…¥æŒ‡ä»¤?}
    Cmd -->|ä¿®æ”¹ X| Modal[æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†]
    Cmd -->|å¢åŠ  Y| NewRow[æ–°å¢è¡Œå¼•å¯¼å¡«å‚]
    Cmd -->|åˆ é™¤ Z| Remove[ç§»é™¤æŒ‡å®šè¡Œ]
    
    NewRow & Modal & Remove --> UpdateS[æ›´æ–° Zustand State]
    UpdateS --> ReRender[é‡æ–°æ¸²æŸ“]

    Cmd -->|æ”¶å…¥ç¡®è®¤| Validate[è°ƒç”¨ validateRevenue()]
    Validate --> Check{æ˜¯å¦é€šè¿‡?}
    Check -->|å¦| Tip[æ˜¾ç¤ºé”™è¯¯æç¤º]
    Check -->|æ˜¯| Final[æ„å»ºæœ€ç»ˆç»“æœå¯¹è±¡]
    
    Final --> POST[Send to /api/projects/:id/revenue-model]
    POST --> DB[(å†™å…¥æ•°æ®åº“)]
    DB --> Success[å±•ç¤ºã€Šè¥ä¸šæ”¶å…¥é¢„æµ‹è¡¨ã€‹]]
```

---

## 3. æ ¸å¿ƒç»„ä»¶è®¾è®¡

### 3.1 çŠ¶æ€ç®¡ç†å™¨ï¼ˆZustand Storeï¼‰

#### æ–‡ä»¶è·¯å¾„
`/client/src/store/useRevenueModelStore.ts`

#### è®¾è®¡åŸåˆ™
- å•ä¸€çœŸç›¸æºï¼›
- æ”¯æŒæ’¤é”€ / å¿«ç…§ï¼ˆå¯é€‰ï¼‰ï¼›
- æ˜“äºè°ƒè¯•ï¼ˆdevtools æ”¯æŒï¼‰ã€‚

#### ç±»å‹å®šä¹‰ä¸æ–¹æ³•ç­¾å

```ts
import { create } from 'zustand';

type ProductionRateConfig = {
  yearIndex: number; // ç¬¬ n å¹´è¿è¥
  rate: number; // å¦‚ 0.7 è¡¨ç¤º 70%
};

type ValidationError = {
  code: 'EMPTY' | 'MISSING_FIELD' | 'INVALID_VAT' | 'NOT_CONVERGED';
  field?: string;
  rowId?: string;
  message: string;
};

interface RevenueModelState {
  // ä¸Šä¸‹æ–‡ä¾èµ–
  context: {
    projectName: string;
    constructionYears: number;
    totalInvestment: number;
    engineeringItems: Array<{ name: string; amount: number }>;
  } | null;

  // ç”¨æˆ·è®¾å®š
  calculationPeriod: number; // æ€»è®¡ç®—æœŸï¼ˆé»˜è®¤20æˆ–30ï¼‰
  operatingYears: number;   // è¿è¥å¹´æ•°
  baseYear?: number;         // ç”Ÿäº§å¯åŠ¨å¹´ï¼ˆé»˜è®¤constructionYears+1ï¼‰

  // ä¸»ä½“æ•°æ®
  revenueItems: RevenueItem[];
  productionRates: ProductionRateConfig[];

  // æ§åˆ¶çŠ¶æ€
  currentStep: 'period' | 'suggest' | 'table' | 'rates' | 'validate' | 'done';
  isSubmitting: boolean;
  errors: ValidationError[];

  // æ“ä½œæ–¹æ³•
  setContext: (ctx: any) => void;
  updateCalculationPeriod: (c: number, o: number) => void;
  addRevenueItem: (item: Partial<RevenueItem>) => void;
  updateRevenueItem: (id: string, updates: Partial<RevenueItem>) => void;
  deleteRevenueItem: (id: string) => void;
  setProductionRates: (rates: ProductionRateConfig[]) => void;
  validate: () => boolean;
  reset: () => void;
  submitToBackend: () => Promise<boolean>;
}
```

---

### 3.2 UI ç»„ä»¶æ ‘ç»“æ„

#### é¡µé¢ä¸»å…¥å£
`/client/src/pages/RevenueModelingPage.tsx`

```
RevenueModelingPage
â”œâ”€â”€ StepGuard (ç¡®ä¿å·²ç™»å½•+æœ‰æƒæ“ä½œ)
â”œâ”€â”€ HeaderBanner ("ã€æ­¥éª¤äºŒã€‘è¥ä¸šæ”¶å…¥ä¸æˆæœ¬æµ‹ç®—")
â”‚
â”œâ”€â”€ ConditionalRenderer
â”‚   â”œâ”€â”€ PeriodConfirmationView         â† æ­¥éª¤1ï¼šé€‰æ‹©è®¡ç®—æœŸ
â”‚   â”œâ”€â”€ AISuggestionPanel            â† æ­¥éª¤2ï¼šå±•ç¤ºå»ºè®®
â”‚   â”œâ”€â”€ DynamicRevenueTableView      â† æ­¥éª¤3ï¼šæ ¸å¿ƒäº¤äº’åŒº
â”‚   â”‚   â”œâ”€â”€ CommandInputBar          â† è¾“å…¥"ä¿®æ”¹A""å¢åŠ ..."ç­‰å‘½ä»¤
â”‚   â”‚   â””â”€â”€ EditModalForm            â† å¼¹çª—ç¼–è¾‘ï¼Œä¾categoryåŠ¨æ€åŠ è½½å­—æ®µ
â”‚   â”‚
â”‚   â”œâ”€â”€ ProductionRateEditor         â† æ­¥éª¤4ï¼šè®¾ç½®è¾¾äº§ç‡æ›²çº¿
â”‚   â”‚
â”‚   â”œâ”€â”€ FinalValidationSummary       â† æ­¥éª¤5ï¼šåˆ—å‡ºæ‰€æœ‰é—®é¢˜é¡¹
â”‚   â”‚
â”‚   â””â”€â”€ ResultDisplayPreview         â† æ­¥éª¤6ï¼šåªè¯»è¡¨æ ¼è¾“å‡º
â”‚
â””â”€â”€ NavigationFooter
    â”œâ”€â”€ "è¿”å›ä¸Šä¸€æ­¥"
    â””â”€â”€ "è¿›å…¥ç¬¬ä¸‰æ­¥"ï¼ˆæ¡ä»¶å¯ç”¨ï¼‰
```

---

### 3.3 AI æ¨èå¼•æ“ï¼ˆRules-based Engineï¼‰

> âš ï¸ å½“å‰æš‚ä¸æ¥å…¥çœŸå® LLM APIï¼Œè€Œæ˜¯**è§„åˆ™åŒ¹é…é©±åŠ¨çš„æ¨¡æ‹ŸAI**

#### å®ç°æ–‡ä»¶
`/client/src/lib/ai/revenueRecommender.ts`

#### é€»è¾‘è¯´æ˜

```ts
const RULES = [
  {
    keywords: ['äº‘å¹³å°', 'SaaS', 'AI', 'æ¥å£', 'æ™ºèƒ½'],
    category: 'digital-platform',
    suggestion: [
      'SaaSå¹³å°ä¼šå‘˜è´¹',
      'APIæ•°æ®æ¥å£è°ƒç”¨è´¹',
      'AIå†³ç­–æ”¯æŒå¢å€¼æœåŠ¡è´¹'
    ]
  },
  {
    keywords: ['ç§æ¤', 'å†œç”°', 'æœæ ‘', 'ç”˜è”—', 'æ°´ç¨»'],
    category: 'agriculture-crop',
    suggestion: ['å†œäº§å“é”€å”®æ”¶å…¥', 'ç§è‹—é”€å”®æ”¶å…¥']
  }
];

export function recommendRevenueTypes(items: Array<{ name: string }>): RecommendedCategory[] {
  const matchedCategories = new Set<string>();
  const suggestions = [];

  for (const item of items) {
    for (const rule of RULES) {
      if (rule.keywords.some(k => item.name.includes(k))) {
        matchedCategories.add(rule.category);
        suggestions.push(...rule.suggestion.map(title => ({ title, source: item.name })));
      }
    }
  }

  return Array.from(matchedCategories).map(cat => ({
    id: cat,
    label: LABEL_MAP[cat],
    suggestions: suggestions.filter(s => belongsTo(s.title, cat))
  }));
}
```

---

### 3.4 åŠ¨æ€è¡¨æ ¼æ¸²æŸ“å™¨

#### æ–‡ä»¶
`/client/src/components/DynamicRevenueTable.tsx`

#### ç‰¹æ€§

- æ ¹æ®æ¯è¡Œçš„ `category` æ¸²æŸ“ä¸åŒåˆ—ï¼ˆå€ŸåŠ© `fieldMap`ï¼‰ï¼›
- æ”¯æŒæ··åˆç±»å‹åˆå¹¶æ¸²æŸ“ï¼›
- å®æ—¶è®¡ç®—æ¯ä¸€é¡¹å«ç¨/ä¸å«ç¨/å¢å€¼ç¨ï¼›
- ä½¿ç”¨ `contenteditable=false` å’ŒæŒ‰é’®ä»£æ›¿è‡ªç”±è¾“å…¥ï¼Œé˜²ç ´åæ ¼å¼ã€‚

#### ç¤ºä¾‹ç‰‡æ®µ

```tsx
<table>
  <thead>{/* å›ºå®šå¤´ */}</thead>
  <tbody>
    {items.map(item => (
      <tr key={item.id}>
        <td>{item.index}</td>
        <td>{item.name}</td>
        {renderFieldsByCategory(item.category, item)}
        <td>{formatMoney(calculateTaxableIncome(item))}</td>
        <td>{formatMoney(calculateNonTaxIncome(item))}</td>
        <td>{formatMoney(calculateVatAmount(item))}</td>
        <td>{(item.vatRate * 100).toFixed(0)}%</td>
      </tr>
    ))}
  </tbody>
</table>
```

---

### 3.5 è¾¾äº§ç‡æ¨¡å‹å¤„ç†å™¨

#### ä½ç½®
`/client/src/lib/calculations/productionRateUtils.ts`

#### é»˜è®¤æ›²çº¿ç”Ÿæˆ

```ts
export function getDefaultRampUp(constructionYears: number): ProductionRateConfig[] {
  switch (constructionYears) {
    case 1:
      return [{ yearIndex: 1, rate: 0.85 }, { yearIndex: 2, rate: 1.0 }];
    case 2:
      return [{ yearIndex: 1, rate: 0.85 }, { yearIndex: 2, rate: 0.95 }, { yearIndex: 3, rate: 1.0 }];
    case 3:
      return [{ yearIndex: 1, rate: 0.7 }, { yearIndex: 2, rate: 0.85 }, { yearIndex: 3, rate: 0.95 }, { yearIndex: 4, rate: 1.0 }];
    default:
      return [{ yearIndex: 1, rate: 0.7 }, { yearIndex: 2, rate: 0.8 }, { yearIndex: 3, rate: 0.9 }, { yearIndex: 4, rate: 1.0 }];
  }
}
```

#### å½±å“åº”ç”¨å‡½æ•°

```ts
export function applyProductionRate(
  annualBaseRevenue: number[],
  rates: ProductionRateConfig[]
): number[] {
  return annualBaseRevenue.map((rev, index) => {
    const opYear = index + 1;
    const matchedRate = rates.find(r => r.yearIndex === opYear)?.rate || 1.0;
    return rev * matchedRate;
  });
}
```

---

### 3.6 éªŒè¯æœåŠ¡ï¼ˆValidation Serviceï¼‰

#### æ–‡ä»¶
`/client/src/services/validationService.ts`

#### æ–¹æ³•

```ts
export function runAllValidations(state: RevenueModelState): ValidationError[] {
  const errors: ValidationError[] = [];

  if (!state.revenueItems.length) {
    errors.push({ code: 'EMPTY', message: 'å°šæœªæ·»åŠ ä»»ä½•æ”¶å…¥é¡¹' });
  }

  state.revenueItems.forEach(item => {
    if (!item.unitPrice && item.annualFullCapacityRevenue > 0) {
      errors.push({ code: 'MISSING_FIELD', field: 'unitPrice', rowId: item.id, message: `'${item.name}'ç¼ºå°‘å•ä»·'` });
    }

    const expectedVat = calculateVatOnly(item);
    if (Math.abs(expectedVat - item.vatAmount) > 0.001) {
      errors.push({ code: 'INVALID_VAT', rowId: item.id, message: `ç¬¬${item.index}è¡Œå¢å€¼ç¨è¯¯å·®è¶…é™` });
    }
  });

  return errors;
}
```

è¢«ç»‘å®šåˆ° Store çš„ `.validate()` æ–¹æ³•ä¸­ï¼Œå¤±è´¥é˜»æ­¢æäº¤ã€‚

---

## 4. æ•°æ®ç»“æ„å®šä¹‰ï¼ˆTypeScript Interfacesï¼‰

### 4.1 å…¨å±€ä¸Šä¸‹æ–‡
```ts
interface ProjectContext {
  projectName: string;
  constructionYears: number;
  operationYears: number;
  totalInvestment: number;
  engineeringItems: Array<{
    name: string;
    category: string;
    investment: number;
  }>;
}
```

### 4.2 æ”¶å…¥é¡¹ç±»å‹
```ts
type RevenueCategory =
  | 'agriculture-crop'
  | 'agriculture-aquaculture'
  | 'digital-platform'
  | 'transaction-hub'
  | 'other-service';

interface RevenueItem {
  id: string;
  index: string; // 'A', 'B', ...
  name: string;
  category: RevenueCategory;

  // å†œä¸šç±»å­—æ®µ
  variety?: string;
  unit?: string;
  acreage?: number;
  yieldPerUnit?: number;
  areaFactor?: number;

  // æ•°å­—å¹³å°ç±»å­—æ®µ
  pricingModel?: string; // 'æŒ‰æˆ·/å¹´', 'åŒ…å¹´', 'äº¤æ˜“ææˆ'
  serviceScale?: string;
  unitPrice?: number;

  // é€šç”¨å­—æ®µ
  vatRate: number; // 0.09, 0.06
  taxableIncome: number; // å«ç¨æ€»é¢ï¼ˆä¸‡å…ƒï¼‰
  nonTaxIncome: number;
  vatAmount: number;
  annualFullCapacityRevenue: number; // å…¨è¾¾äº§å¹´æ”¶å…¥
}
```

### 4.3 è¾“å‡ºç»“æ„
```ts
interface AnnualRevenueReport {
  years: string[]; // ["ç¬¬1å¹´", ..., "[N]å¹´åˆè®¡"]
  revenueItems: Array<{
    name: string;
    values: number[]; // æ¯å¹´çš„æ”¶å…¥ï¼ˆå—è¾¾äº§ç‡è°ƒæ•´ï¼‰
  }>;
  totalTaxable: number[];   // å«ç¨æ€»æ”¶å…¥åºåˆ—
  totalNonTax: number[];    // ä¸å«ç¨æ€»
  totalVat: number[];       // å¢å€¼ç¨åºåˆ—
}
```

---

## 5. å…³é”®ç®—æ³•å®ç°

ï¼ˆè§é™„å½• A æä¾›ä¼ªä»£ç ï¼‰

---

## 6. æ¥å£å¥‘çº¦è®¾è®¡

### 6.1 æ–°å¢ REST æ¥å£

| æ–¹æ³• | è·¯å¾„ | æè¿° |
|------|------|------|
| GET | `/api/projects/:id/revenue-model` | è·å–å·²æœ‰è¥æ”¶æ¨¡å‹ |
| POST | `/api/projects/:id/revenue-model` | åˆ›å»ºæˆ–è¦†ç›–ä¿å­˜ |
| PUT | `/api/projects/:id/revenue-model` | æ›´æ–°éƒ¨åˆ†å­—æ®µï¼ˆé¢„ç•™ï¼‰ |
| DELETE | `/api/projects/:id/revenue-model` | åˆ é™¤ï¼ˆä»…é¡¹ç›®æ‰€æœ‰è€…ï¼‰ |

---

### 6.2 è¯·æ±‚ / å“åº”æ ¼å¼

#### è¯·æ±‚ä½“ï¼ˆPOSTï¼‰
```json
{
  "calculation_period": 30,
  "operating_years": 27,
  "production_start_year": 4,
  "revenue_items": [
    {
      "index": "A",
      "name": "ç”˜è”—é”€å”®",
      "category": "agriculture-crop",
      "variety": "ç”˜è”—",
      "acreage": 800,
      "yield_per_unit": 6.25,
      "unit_price": 550,
      "vat_rate": 0.09,
      "taxable_income": 275,
      "non_tax_income": 252.34,
      "vat_amount": 22.66
    }
  ],
  "production_rates": [
    {"year_index": 1, "rate": 0.7},
    {"year_index": 2, "rate": 0.85}
  ]
}
```

#### æˆåŠŸå“åº”
```json
{
  "success": true,
  "data": {
    "saved_at": "2025-04-05T10:00:00Z"
  }
}
```

#### é”™è¯¯å“åº”
```json
{
  "success": false,
  "error": "VALIDATION_ERROR",
  "message": "å¢å€¼ç¨é‡‘é¢ä¸è®¡ç®—ä¸ç¬¦",
  "details": [{"row": "A", "issue": "vat_mismatch"}]
}
```

---

### 6.3 é”™è¯¯ç è¡¨

| é”™è¯¯ç  | å«ä¹‰ | å»ºè®®åŠ¨ä½œ |
|-------|------|---------|
| INVALID_PERIOD | è®¡ç®—æœŸéæ³• | æ£€æŸ¥å»ºè®¾æœŸ+è¿è¥æœŸæ€»å’Œåˆç†æ€§ |
| EMPTY_ITEMS | æ— æœ‰æ•ˆæ”¶å…¥é¡¹ | å¼•å¯¼ç”¨æˆ·è‡³å°‘ä¿ç•™ä¸€é¡¹ |
| VAT_MISMATCH | å¢å€¼ç¨ä¸ä¸€è‡´ | æç¤ºé‡æ–°è¾“å…¥æˆ–è‡ªåŠ¨ä¿®å¤ |
| MISSING_PERMISSION | æƒé™ä¸è¶³ | è·³è½¬æ— æƒé™é¡µé¢ |

---

## 7. ç”¨æˆ·äº¤äº’æµç¨‹

### 7.1 æ­£å‘æµç¨‹ï¼ˆHappy Pathï¼‰

```text
1. ç”¨æˆ·è¾“å…¥ â†’ â€œç»§ç»­ä¸‹ä¸€æ­¥â€
2. ç³»ç»ŸåŠ è½½å‚æ•° â†’ æ˜¾ç¤ºè®¡ç®—æœŸé€‰é¡¹
3. ç”¨æˆ·é€‰æ‹© â†’ Aï¼ˆä¿æŒ20å¹´ï¼‰
4. ç³»ç»Ÿå±•ç¤ºAIå»ºè®®è¡¨æ ¼ â†’ ç”¨æˆ·è¾“å…¥ â€œA,Bâ€
5. ç”Ÿæˆå†œä¸š+å¹³å°ç±»åŒåŒºå—è¡¨æ ¼
6. ç”¨æˆ·è¾“å…¥ â€œä¿®æ”¹ Aâ€ â†’ å¼¹å‡ºç¼–è¾‘è¡¨å•
7. ä¿®æ”¹äº©æ•°ã€å•ä»·ç­‰ â†’ ç‚¹å‡»â€œç¡®å®šâ€ â†’ å®æ—¶é‡ç®—
8. è¾“å…¥ â€œæ”¶å…¥ç¡®è®¤â€
9. ç³»ç»Ÿè¿è¡Œäº¤å‰æ ¡éªŒ â†’ å…¨ç»¿ âœ”ï¸
10. è‡ªåŠ¨è·³è½¬è‡³ç»“æœé¢„è§ˆé¡µ
```

---

### 7.2 å¼‚å¸¸å¤„ç†è·¯å¾„

| åœºæ™¯ | å¤„ç†æ–¹å¼ |
|------|---------|
| è¾“å…¥éæ³•å‘½ä»¤ | æ˜¾ç¤ºï¼šâ€œæœªè¯†åˆ«æŒ‡ä»¤ï¼Œè¯·æŸ¥çœ‹å¸®åŠ©ã€‚â€ |
| è¾¾äº§ç‡ >100% | è‡ªåŠ¨æˆªæ–­ä¸º100%ï¼Œæç¤ºæ³¨æ„å¼‚å¸¸ |
| å¢å€¼ç¨åå·®è¿‡å¤§ | æ ‡çº¢è¯¥è¡Œï¼Œå¹¶å¼¹å‡ºè§£é‡Šè¯´æ˜ |
| ç½‘ç»œæäº¤å¤±è´¥ | æœ¬åœ°ç¼“å­˜è‰ç¨¿ï¼Œå…è®¸ç¦»çº¿ç¨ååŒæ­¥ |

---

### 7.3 å¯è®¿é—®æ€§æ”¯æŒï¼ˆa11yï¼‰

- ä½¿ç”¨ `<fieldset>` åŒ…è£¹æ¯ä¸ªæ”¶å…¥è¡¨å•ï¼›
- æ·»åŠ  ARIA å±æ€§ï¼ˆ`aria-labelledby`, `role="dialog"`ï¼‰ï¼›
- æ”¯æŒé”®ç›˜å¯¼èˆªä¸ `Enter` æäº¤æµç¨‹ï¼›
- è¡¨æ ¼æ·»åŠ  summary å±æ€§è¾…åŠ©è¯»å±ã€‚

---

## 8. å®‰å…¨ä¸æ€§èƒ½è€ƒé‡

### 8.1 è¾“å…¥å®‰å…¨é˜²æŠ¤

- æ‰€æœ‰ç”¨æˆ·è¾“å…¥å‡éœ€ç»è¿‡ `DOMPurify.sanitize()` å‡€åŒ–åå†æ¸²æŸ“ï¼›
- ä½¿ç”¨ `zod` å¯¹è¡¨å•æ•°æ®åšè¿è¡Œæ—¶æ ¡éªŒï¼›
- æ‹’ç»å«è„šæœ¬æ ‡ç­¾çš„å†…å®¹ã€‚

### 8.2 è®¡ç®—æ€§èƒ½ä¼˜åŒ–

- å¯¹é•¿åˆ—è¡¨è¡¨æ ¼å¯ç”¨è™šæ‹Ÿæ»šåŠ¨ï¼ˆ`react-window`ï¼‰ï¼›
- é«˜é¢‘è®¡ç®—å‡½æ•°åŠ  memoizeï¼ˆ`lodash/memoize`ï¼‰ï¼›
- è¾¾äº§ç‡å½±å“æ‰¹é‡è®¡ç®—ä¸€æ¬¡æ€§ pushã€‚

### 8.3 å†…å­˜ä½¿ç”¨æ§åˆ¶

- æ¯æ¬¡åˆ‡æ¢åˆ°å…¶ä»–é¡µé¢è‡ªåŠ¨ `.reset()` storeï¼›
- ä¸é•¿æœŸé©»ç•™å¤§é‡ä¸´æ—¶æ¨¡å‹å‰¯æœ¬ï¼›
- æ”¯æŒâ€œé€€å‡ºæé†’â€é˜²æ­¢å¿˜è®°æäº¤ã€‚

---

## 9. æµ‹è¯•ç­–ç•¥

### 9.1 å•å…ƒæµ‹è¯•ï¼ˆJestï¼‰

```ts
// tests/calculationUtils.test.ts
test('should correctly split VAT at 9%', () => {
  const { nonTax, vat } = splitVat(275, 0.09);
  expect(nonTax).toBeCloseTo(252.34, 1);
  expect(vat).toBeCloseTo(22.66, 1);
});
```

### 9.2 ç»„ä»¶æµ‹è¯•ï¼ˆRTLï¼‰

```tsx
// tests/DynamicRevenueTable.test.tsx
render(<DynamicRevenueTable items={[{...}]} />);
expect(screen.getByText('ç”˜è”—é”€å”®')).toBeInTheDocument();
```

### 9.3 E2E åœºæ™¯ï¼ˆCypressï¼‰

```js
// cypress/e2e/revenue-model.cy.js
cy.login('user', '123456');
cy.visit('/projects/abc123');
cy.get('[data-command]').type('ç»§ç»­ä¸‹ä¸€æ­¥{enter}');
cy.get('.suggestion-table').should('be.visible');
cy.get('#cmd-input').type('A,B{enter}');
cy.get('.edit-btn[data-row="A"]').click();
cy.get('#acreage-input').clear().type('1000');
cy.contains('ç¡®å®š').click();
cy.contains('æ”¶å…¥ç¡®è®¤').click();
cy.contains('ã€æ­¥éª¤äºŒå·²å®Œæˆã€‘').should('exist');
```

---

## 10. éƒ¨ç½²ä¸ç›‘æ§å»ºè®®

### 10.1 æ—¥å¿—åŸ‹ç‚¹è®¾è®¡

| äº‹ä»¶ | æ‰“ç‚¹å­—æ®µ |
|------|--------|
| æ¨¡å—è¿›å…¥ | `event=revenue_start` |
| è¡¨æ ¼æäº¤ | `event=submit_revenue_success` / `fail` |
| æ ¡éªŒæŠ¥é”™ | `validation_error_code=${code}` |

> å‘é€åˆ° `/api/analytics/event`

### 10.2 æ“ä½œå®¡è®¡è®°å½•

æ•°æ®åº“æ—¥å¿—ä¿ç•™å…³é”®å˜æ›´ï¼š

```sql
INSERT INTO audit_logs (
  user_id, action, target_type, target_id, old_value, new_value
) VALUES (?, 'REVENUE_MODEL_SAVE', 'project', ?, NULL, ?);
```

---

## é™„å½• Aï¼šæ ¸å¿ƒä¼ªä»£ç ç¤ºä¾‹

```ts
function handleSubmit() {
  const errors = validate(store.getState());

  if (errors.length > 0) {
    store.setState({ errors });
    notify("å­˜åœ¨æ•°æ®å¼‚å¸¸ï¼Œè¯·ä¿®æ­£åå†æäº¤");
    return;
  }

  const payload = formatForBackend(store.getState());
  const success = await revenueService.save(payload);

  if (success) {
    navigateToNext();
    showNotification("âœ… æ”¶å…¥å»ºæ¨¡å·²å®Œæˆï¼");
  } else {
    showError("ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•");
  }
}
```

---

## é™„å½• Bï¼šå­—æ®µæ˜ å°„è§„åˆ™é…ç½®ï¼ˆrevenue-fields.jsonï¼‰

```json
[
  {
    "category": "agriculture-crop",
    "label": "å†œä½œç‰©ç§æ¤",
    "fields": [
      { "key": "variety", "label": "å“ç§", "type": "text" },
      { "key": "acreage", "label": "äº©æ•°ï¼ˆäº©ï¼‰", "type": "number" }
    ]
  },
  {
    "category": "digital-platform",
    "label": "æ•°å­—å¹³å°æœåŠ¡",
    "fields": [
      { "key": "pricingModel", "label": "æ”¶è´¹æ¨¡å¼", "type": "select" },
      { "key": "serviceScale", "label": "æœåŠ¡è§„æ¨¡", "type": "string" }
    ]
  }
]
```

å¯æœªæ¥ç”±è¶…çº§ç®¡ç†å‘˜åŠ¨æ€é…ç½®ã€‚

---

## é™„å½• Cï¼šUI åŸå‹è‰å›¾è¯´æ˜ï¼ˆæ–‡å­—ç‰ˆï¼‰

- **é¡¶éƒ¨æ **ï¼šæ·±è“èƒŒæ™¯ç™½å­—ï¼Œâ€œã€æ­¥éª¤äºŒã€‘è¥ä¸šæ”¶å…¥ä¸æˆæœ¬æµ‹ç®—â€
- **å·¦ä¾§ä¸»åŒº**ï¼šMarkdown æ¸²æŸ“åŒºï¼Œé€æ­¥å±•å¼€å„é˜¶æ®µå†…å®¹ï¼ˆåªè¯»ï¼‰
- **å³ä¾§æ‚¬æµ®å‘½ä»¤æ **ï¼š
 - è¾“å…¥æ¡†ï¼š> ï¼ˆç­‰å¾…ç”¨æˆ·è¾“å…¥æŒ‡ä»¤ï¼‰
 - æç¤ºï¼šâ€œè¾“å…¥å¦‚â€˜ä¿®æ”¹ Bâ€™â€˜å¢åŠ â€¦â€™â€˜ç¡®è®¤â€™å¼€å§‹æ“ä½œâ€
- **åº•éƒ¨æµ®åŠ¨æŒ‰é’®**ï¼šâ€œè¿”å›ä¸Šä¸€æ­¥â€ã€â€œç”ŸæˆæŠ¥è¡¨â€ï¼ˆæ¡ä»¶ç¦ç”¨ï¼‰

---

# âœ… æ–‡æ¡£ç»“æŸ

> æ­¤æ–‡æ¡£å°†ä½œä¸ºã€Œè¥ä¸šæ”¶å…¥ä¸æˆæœ¬æµ‹ç®—æ¨¡å—ã€çš„æ­£å¼å¼€å‘æŒ‡å—ï¼Œçº³å…¥ GitBook æ–‡æ¡£åº“ï¼Œå¹¶éšç‰ˆæœ¬è¿­ä»£æ›´æ–°ã€‚

ğŸ“Œ **å»ºè®®è¡ŒåŠ¨é¡¹ï¼š**
- ç”± Tech Lead å¬å¼€è¯„å®¡ä¼šè®®ç¡®è®¤è®¾è®¡æ–¹æ¡ˆï¼›
- æ‹†åˆ†å­ä»»åŠ¡åˆ†é…ç»™å‰ç«¯å¼€å‘äººå‘˜ï¼›
- å¯åŠ¨ç¬¬ä¸€ä¸ª Storyï¼š`TST-RM-001: å®ç°è®¡ç®—æœŸç¡®è®¤äº¤äº’`ã€‚

---

å¦‚æœä½ éœ€è¦æˆ‘å°†å…¶è¾“å‡ºä¸º Word/PDF ç‰ˆæœ¬ï¼Œæˆ–ç”Ÿæˆ Swagger æ¥å£æ–‡æ¡£ YAML æ–‡ä»¶ï¼Œè¯·å‘Šè¯‰æˆ‘ï¼
