# 财务计算指标表数据列完善说明

## 概述

本文档详细说明了财务计算指标表中各项财务指标的计算实现，包括内部收益率、净现值、投资回收期等关键财务指标的计算方法和数据来源。

## 实现的财务指标

### 1. 项目投资财务内部收益率（IRR）

#### 1.1 所得税前内部收益率
- **计算函数**: `calculateIRR(preTaxCashFlows)`
- **数据来源**: `getPreTaxCashFlows()` 函数获取所得税前净现金流量数组
- **计算方法**: 使用牛顿-拉夫逊迭代法计算使净现值为0的折现率
- **显示格式**: 百分比形式，保留2位小数

#### 1.2 所得税后内部收益率
- **计算函数**: `calculateIRR(postTaxCashFlows)`
- **数据来源**: `getPostTaxCashFlows()` 函数获取所得税后净现金流量数组
- **计算方法**: 使用牛顿-拉夫逊迭代法计算使净现值为0的折现率
- **显示格式**: 百分比形式，保留2位小数

### 2. 项目投资财务净现值（NPV）

#### 2.1 所得税前净现值
- **计算函数**: `calculateNPV(preTaxCashFlows, preTaxRate)`
- **数据来源**: 
  - 现金流数据: `getPreTaxCashFlows()` 函数
  - 折现率: 用户设置的所得税前基准收益率（默认6%）
- **计算方法**: 将未来现金流按指定折现率折算到现值的总和
- **显示格式**: 数值形式，保留2位小数

#### 2.2 所得税后净现值
- **计算函数**: `calculateNPV(postTaxCashFlows, postTaxRate)`
- **数据来源**: 
  - 现金流数据: `getPostTaxCashFlows()` 函数
  - 折现率: 用户设置的所得税后基准收益率（默认6%）
- **计算方法**: 将未来现金流按指定折现率折算到现值的总和
- **显示格式**: 数值形式，保留2位小数

### 3. 项目静态投资回收期

#### 3.1 所得税前静态投资回收期
- **计算函数**: `calculateStaticPaybackPeriod(cumulativePreTaxCashFlows)`
- **数据来源**: `getCumulativePreTaxCashFlows()` 函数获取累计所得税前净现金流量数组
- **计算方法**: 累计净现金流量由负变正所需的时间，使用线性插值法计算精确值
- **显示格式**: 年数形式，保留2位小数

#### 3.2 所得税后静态投资回收期
- **计算函数**: `calculateStaticPaybackPeriod(cumulativePostTaxCashFlows)`
- **数据来源**: `getCumulativePostTaxCashFlows()` 函数获取累计所得税后净现金流量数组
- **计算方法**: 累计净现金流量由负变正所需的时间，使用线性插值法计算精确值
- **显示格式**: 年数形式，保留2位小数

### 4. 项目动态投资回收期

#### 4.1 所得税前动态投资回收期
- **计算函数**: `calculateDynamicPaybackPeriod(cumulativeDynamicPreTaxCashFlows)`
- **数据来源**: `getCumulativeDynamicPreTaxCashFlows()` 函数获取累计所得税前净现金流量(动态)数组
- **计算方法**: 考虑时间价值的投资回收期，使用线性插值法计算精确值
- **显示格式**: 年数形式，保留2位小数

#### 4.2 所得税后动态投资回收期
- **计算函数**: `calculateDynamicPaybackPeriod(cumulativeDynamicPostTaxCashFlows)`
- **数据来源**: `getCumulativeDynamicPostTaxCashFlows()` 函数获取累计所得税后净现金流量(动态)数组
- **计算方法**: 考虑时间价值的投资回收期，使用线性插值法计算精确值
- **显示格式**: 年数形式，保留2位小数

## 现金流数据获取函数

### 1. 所得税前净现金流量数组
- **函数**: `getPreTaxCashFlows()`
- **计算逻辑**:
  - 建设期: 净现金流量 = -建设投资 - 流动资金
  - 运营期: 净现金流量 = 营业收入 + 补贴收入 + 回收固定资产余值 + 回收流动资金 - 建设投资 - 流动资金 - 经营成本 - 增值税等 - 维持运营投资

### 2. 所得税后净现金流量数组
- **函数**: `getPostTaxCashFlows()`
- **计算逻辑**:
  - 建设期: 净现金流量 = -建设投资 - 流动资金
  - 运营期: 净现金流量 = 所得税前净现金流量 - 调整所得税

### 3. 累计所得税前净现金流量数组
- **函数**: `getCumulativePreTaxCashFlows()`
- **计算逻辑**: 对所得税前净现金流量进行累加

### 4. 累计所得税后净现金流量数组
- **函数**: `getCumulativePostTaxCashFlows()`
- **计算逻辑**: 对所得税后净现金流量进行累加

### 5. 累计所得税前净现金流量(动态)数组
- **函数**: `getCumulativeDynamicPreTaxCashFlows()`
- **计算逻辑**: 
  - 计算每年的动态净现金流量: 所得税前净现金流量/(1+折现率)^年份
  - 对动态净现金流量进行累加

### 6. 累计所得税后净现金流量(动态)数组
- **函数**: `getCumulativeDynamicPostTaxCashFlows()`
- **计算逻辑**: 
  - 计算每年的动态净现金流量: 所得税前净现金流量/(1+所得税前折现率)^年份 - 调整所得税/(1+所得税后折现率)^年份
  - 对动态净现金流量进行累加

## 核心计算算法

### 1. 内部收益率(IRR)计算
```typescript
const calculateIRR = (cashFlows: number[], initialGuess: number = 0.1): number => {
  if (cashFlows.length === 0) return 0;
  
  let irr = initialGuess;
  const maxIterations = 100;
  const tolerance = 1e-6;
  
  for (let i = 0; i < maxIterations; i++) {
    let npv = 0;
    let dnpv = 0;
    
    for (let j = 0; j < cashFlows.length; j++) {
      npv += cashFlows[j] / Math.pow(1 + irr, j);
      dnpv -= j * cashFlows[j] / Math.pow(1 + irr, j + 1);
    }
    
    const newIrr = irr - npv / dnpv;
    
    if (Math.abs(newIrr - irr) < tolerance) {
      return newIrr * 100; // 转换为百分比
    }
    
    irr = newIrr;
    
    // 防止发散
    if (irr < -0.99) irr = -0.99;
    if (irr > 10) irr = 10;
  }
  
  return irr * 100; // 转换为百分比
};
```

### 2. 净现值(NPV)计算
```typescript
const calculateNPV = (cashFlows: number[], discountRate: number): number => {
  if (cashFlows.length === 0) return 0;
  
  let npv = 0;
  const rate = discountRate / 100; // 转换为小数
  
  for (let i = 0; i < cashFlows.length; i++) {
    npv += cashFlows[i] / Math.pow(1 + rate, i);
  }
  
  return npv;
};
```

### 3. 静态投资回收期计算
```typescript
const calculateStaticPaybackPeriod = (cumulativeCashFlows: number[]): number => {
  if (cumulativeCashFlows.length === 0) return 0;
  
  for (let i = 0; i < cumulativeCashFlows.length; i++) {
    if (cumulativeCashFlows[i] >= 0) {
      if (i === 0) return 1;
      
      const prevCumulative = cumulativeCashFlows[i - 1];
      const currentCumulative = cumulativeCashFlows[i];
      const currentCashFlow = currentCumulative - prevCumulative;
      
      // 线性插值计算精确的回收期
      if (currentCashFlow > 0) {
        return i + Math.abs(prevCumulative) / currentCashFlow;
      } else {
        return i + 1;
      }
    }
  }
  
  // 如果整个项目周期内都没有回收，返回项目周期+1
  return cumulativeCashFlows.length + 1;
};
```

### 4. 动态投资回收期计算
```typescript
const calculateDynamicPaybackPeriod = (dynamicCumulativeCashFlows: number[]): number => {
  if (dynamicCumulativeCashFlows.length === 0) return 0;
  
  for (let i = 0; i < dynamicCumulativeCashFlows.length; i++) {
    if (dynamicCumulativeCashFlows[i] >= 0) {
      if (i === 0) return 1;
      
      const prevCumulative = dynamicCumulativeCashFlows[i - 1];
      const currentCumulative = dynamicCumulativeCashFlows[i];
      const currentCashFlow = currentCumulative - prevCumulative;
      
      // 线性插值计算精确的回收期
      if (currentCashFlow > 0) {
        return i + Math.abs(prevCumulative) / currentCashFlow;
      } else {
        return i + 1;
      }
    }
  }
  
  // 如果整个项目周期内都没有回收，返回项目周期+1
  return dynamicCumulativeCashFlows.length + 1;
};
```

## 缓存机制

为了提高计算性能，系统实现了缓存机制：

```typescript
const useCachedFinancialIndicators = () => {
  // 创建一个唯一的计算键，基于所有可能影响财务指标的数据
  const calculationKey = JSON.stringify({
    preTaxRate,
    postTaxRate,
    constructionYears: context?.constructionYears,
    operationYears: context?.operationYears,
    // 可以根据需要添加更多依赖项
  })
  
  // 如果计算键没有变化，返回缓存的结果
  if (lastCalculationKey === calculationKey && cachedFinancialIndicators) {
    return cachedFinancialIndicators;
  }
  
  // 计算所有财务指标
  const indicators = {
    preTaxIRR: safeCalculateIRR(preTaxCashFlows),
    postTaxIRR: safeCalculateIRR(postTaxCashFlows),
    preTaxNPV: safeCalculateNPV(preTaxCashFlows, preTaxRate),
    postTaxNPV: safeCalculateNPV(postTaxCashFlows, postTaxRate),
    preTaxStaticPaybackPeriod: safeCalculatePaybackPeriod(cumulativePreTaxCashFlows),
    postTaxStaticPaybackPeriod: safeCalculatePaybackPeriod(cumulativePostTaxCashFlows),
    preTaxDynamicPaybackPeriod: safeCalculateDynamicPaybackPeriod(cumulativeDynamicPreTaxCashFlows),
    postTaxDynamicPaybackPeriod: safeCalculateDynamicPaybackPeriod(cumulativeDynamicPostTaxCashFlows),
  };
  
  // 缓存结果
  setCachedFinancialIndicators(indicators);
  setLastCalculationKey(calculationKey);
  
  return indicators;
};
```

## 安全包装函数

为了处理可能的错误情况，系统实现了安全包装函数：

```typescript
const safeCalculateIRR = (cashFlows: number[], initialGuess: number = 0.1): number => {
  try {
    if (!cashFlows || cashFlows.length === 0) {
      return 0;
    }
    return calculateIRR(cashFlows, initialGuess);
  } catch (error) {
    console.error('计算IRR时出错:', error);
    return 0;
  }
}

const safeCalculateNPV = (cashFlows: number[], discountRate: number): number => {
  try {
    if (!cashFlows || cashFlows.length === 0) {
      return 0;
    }
    return calculateNPV(cashFlows, discountRate);
  } catch (error) {
    console.error('计算NPV时出错:', error);
    return 0;
  }
}

const safeCalculatePaybackPeriod = (cumulativeCashFlows: number[]): number => {
  try {
    if (!cumulativeCashFlows || cumulativeCashFlows.length === 0) {
      return 0;
    }
    return calculateStaticPaybackPeriod(cumulativeCashFlows);
  } catch (error) {
    console.error('计算投资回收期时出错:', error);
    return 0;
  }
}

const safeCalculateDynamicPaybackPeriod = (cumulativeCashFlows: number[]): number => {
  try {
    if (!cumulativeCashFlows || cumulativeCashFlows.length === 0) {
      return 0;
    }
    return calculateDynamicPaybackPeriod(cumulativeCashFlows);
  } catch (error) {
    console.error('计算动态投资回收期时出错:', error);
    return 0;
  }
}
```

## 用户界面

财务计算指标表通过模态窗口展示，包含以下功能：

1. **指标展示**: 以表格形式展示8个关键财务指标
2. **设置功能**: 用户可以设置所得税前和所得税后的基准收益率
3. **数据缓存**: 避免重复计算，提高性能
4. **错误处理**: 安全包装函数确保计算的稳定性

## 数据来源

财务计算指标表的数据来源于项目投资现金流量表，具体包括：

1. **现金流入**: 营业收入、补贴收入、回收固定资产余值、回收流动资金
2. **现金流出**: 建设投资、流动资金、经营成本、增值税等、维持运营投资
3. **调整所得税**: 从利润与利润分配表中获取

## 总结

财务计算指标表已经实现了完整的财务指标计算功能，包括内部收益率、净现值、投资回收期等关键指标。系统采用了标准的财务计算方法，实现了缓存机制提高性能，并提供了安全包装函数处理错误情况。用户可以通过界面设置基准收益率，系统会自动计算并展示各项财务指标。