# 分年度投资估算表实现说明

## 功能概述

分年度投资估算表展示了建设期各年度的投资分配情况，包括工程费用、工程其他费用、无形资产费用、预备费等各项费用的年度分配。

## 组件结构

### 文件位置
- 组件文件: `client/src/components/revenue-cost/AnnualInvestmentTable.tsx`
- 集成位置: `client/src/components/revenue-cost/FinancialIndicatorsTable.tsx`
- 主页面: `client/src/pages/RevenueCostModeling.tsx`

### Props 接口
```typescript
interface AnnualInvestmentTableProps {
  investmentEstimate?: InvestmentEstimate | null  // 投资估算数据
  constructionYears?: number                      // 建设期年数
}
```

## 表格结构

### 序号及项目内容

| 序号 | 项目 | 说明 |
|------|------|------|
| 一 | 工程费用 | 主分类 |
| 1.1 | 建筑安装工程费 | 子项（建安费 + 安装工程费） |
| 1.2 | 设备购置费 | 子项 |
| 二 | 工程其他费用 | 主分类 |
| 三 | 无形资产费用 | 主分类（土地费用） |
| 四 | 预备费 | 主分类（基本预备费 + 涨价预备费） |
| 五 | 建设投资合计 | 总计 |

### 数据来源

| 费用项 | 数据来源 |
|--------|----------|
| 建安费 | `investmentEstimate.construction_cost` |
| 安装工程费 | `investmentEstimate.installation_cost` |
| 设备购置费 | `investmentEstimate.equipment_cost` |
| 其他费用 | `investmentEstimate.other_cost` |
| 土地费用 | `investmentEstimate.land_cost` |
| 基本预备费 | `investmentEstimate.basic_reserve` |
| 涨价预备费 | `investmentEstimate.price_reserve` |

## 年度分配算法

### 分配策略

投资采用逐年递增模式进行分配，符合工程实际建设规律：

- **1年建设期**: 100% 在第1年
- **2年建设期**: 40% 第1年, 60% 第2年
- **3年建设期**: 25% 第1年, 50% 第2年, 25% 第3年
- **4年建设期**: 20% 第1年, 30% 第2年, 30% 第3年, 20% 第4年
- **5年建设期**: 15% 第1年, 25% 第2年, 30% 第3年, 20% 第4年, 10% 第5年
- **其他年数**: 平均分配

### 计算公式

```typescript
const distributeByIncreasing = (total: number, yearCount: number): number[] => {
  if (yearCount === 1) return [total]
  if (yearCount === 2) return [total * 0.4, total * 0.6]
  if (yearCount === 3) return [total * 0.25, total * 0.5, total * 0.25]
  if (yearCount === 4) return [total * 0.2, total * 0.3, total * 0.3, total * 0.2]
  if (yearCount === 5) return [total * 0.15, total * 0.25, total * 0.3, total * 0.2, total * 0.1]
  // 默认平均分配
  return years.map(() => total / yearCount)
}
```

## 功能特性

### 1. 数据展示
- 表格展示建设期各年度的投资分配
- 支持横向滚动查看多年数据
- 合计列显示各费用项总额

### 2. 样式设计
- 主分类行（一、二、三、四、五）使用加粗字体
- 子项行（1.1、1.2）左缩进显示
- 建设投资合计行使用蓝色高亮背景

### 3. Excel 导出
- 支持导出为 Excel 文件
- 包含完整的表头和数据行
- 文件名: `分年度投资估算表.xlsx`

### 4. 空状态处理
- 无投资估算数据时显示提示信息
- 按钮在无数据时禁用

## 集成说明

### FinancialIndicatorsTable 修改

1. **添加导入**
```typescript
import AnnualInvestmentTable from './AnnualInvestmentTable'
```

2. **扩展 Props 接口**
```typescript
interface FinancialIndicatorsTableProps {
  // ... 原有 props
  investmentEstimate?: any  // 新增
}
```

3. **接收参数**
```typescript
const FinancialIndicatorsTable: React.FC<FinancialIndicatorsTableProps> = ({
  repaymentTableData = [],
  depreciationData = [],
  investmentEstimate  // 新增
}) => {
```

4. **替换弹窗内容**
```typescript
<Modal opened={showAnnualInvestmentModal}>
  <AnnualInvestmentTable 
    investmentEstimate={investmentEstimate}
    constructionYears={context?.constructionYears}
  />
</Modal>
```

### RevenueCostModeling 修改

传递 `investmentEstimate` 给 `FinancialIndicatorsTable`:
```typescript
<FinancialIndicatorsTable
  repaymentTableData={repaymentTableData}
  depreciationData={depreciationData}
  investmentEstimate={investmentEstimate}  // 新增
/>
```

## 数字格式化

### 格式化函数

```typescript
// 不四舍五入保留2位小数
const formatNumberNoRounding = (value: number): string => {
  const isNegative = value < 0;
  const absValue = Math.abs(value);
  const truncated = Math.trunc(absValue * 100) / 100;
  let result = truncated.toString();
  if (!result.includes('.')) {
    result += '.00';
  } else {
    const decimalPart = result.split('.')[1];
    if (decimalPart.length === 1) {
      result += '0';
    } else if (decimalPart.length > 2) {
      result = result.split('.')[0] + '.' + decimalPart.substring(0, 2);
    }
  }
  if (isNegative) {
    result = '-' + result;
  }
  return result;
}

// 0值显示为空白
const formatNumberWithZeroBlank = (value: number): string => {
  if (value === 0) {
    return '';
  }
  return formatNumberNoRounding(value);
}
```

## 使用示例

### 查看表格

1. 进入"收入及成本预测"页面
2. 进入步骤4"项目投资现金流量"
3. 点击"分年度投资估算表"按钮
4. 在弹窗中查看详细的年度分配数据

### 导出 Excel

1. 打开分年度投资估算表
2. 点击导出按钮（下载图标）
3. Excel 文件自动下载

## 注意事项

1. **数据依赖**: 需要先完成投资估算才能显示数据
2. **建设期**: 表格列数根据项目的建设期年数动态生成
3. **精度**: 所有金额保留2位小数，不四舍五入
4. **分配模式**: 当前使用递增模式，未来可根据项目特点支持自定义分配比例
