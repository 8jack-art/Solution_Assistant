# 投资估算简表结构详细说明

## 一、概述

投资估算简表是工程投资方案编制工具的核心输出，采用标准的工程经济学格式，通过**统一循环迭代算法**自动生成符合规范的项目投资估算。

## 二、表格结构（7个部分：A-G）

### A部分：第一部分 工程费用
**定义**：实体建设类支出合计

**结构**：
- **序号**：A
- **包含子项**：一级子项（一、二、三...）
  - 每个子项包含：
    - 序号（中文数字：一、二、三...）
    - 工程或费用名称
    - 建设工程费
    - 设备购置费
    - 安装工程费
    - 其它费用
    - 合计
    - 占总投资比例
    - 备注
    - 可选字段：单位、数量、单位价值（精算模式）

**特点**：
- 支持AI自动生成子项（基于项目名称和项目信息）
- 支持手动编辑和调整
- 支持三级结构（一级、二级、三级子项）
- 子项数量不规则（根据项目实际情况生成）

**计算公式**：
```
A.合计 = Σ(子项.合计)
A.设备购置费 = Σ(子项.设备购置费)
A.安装工程费 = Σ(子项.安装工程费)
A.其它费用 = Σ(子项.其它费用)
```

---

### B部分：第二部分 工程其它费用
**定义**：管理性、咨询性和专项费用合计

**结构**：
- **序号**：B
- **包含子项**：固定子项（1-12项）
  1. 建设单位管理费
  2. 勘察设计费
  3. 研究试验费
  4. 建设工程监理费
  5. 工程保险费
  6. 引进技术和进口设备其它费
  7. 工程招标代理服务费
  8. 场地准备及临时设施费
  9. 市政公用设施费
  10. 专项评价费
  11. 土地费用（根据土地费用配置计算）
  12. 其它

**特点**：
- 子项固定，不可增删
- 根据A部分和土地费用自动计算
- 第11项"土地费用"根据用户选择的土地模式计算

**计算公式**：
```
B.合计 = Σ(子项.合计)
各子项按照工程经济学标准比例计算
```

**土地费用模式**：
- **A模式**：一次性征地（征地亩数 × 每亩征地单价）
- **B模式**：长期租赁用地（租赁亩数 × 年租金单价 × 建设期年限）
- **C模式**：无土地需求（土地费用 = 0）
- **D模式**：混合用地模式（征地 + 租赁）
- **E模式**：AI自主决策（根据项目信息智能选择）

---

### C部分：第一、二部分合计
**定义**：A部分和B部分的合计

**结构**：
- **序号**：C
- **无子项**

**计算公式**：
```
C.建设工程费 = A.建设工程费 + B.建设工程费
C.设备购置费 = A.设备购置费 + B.设备购置费
C.安装工程费 = A.安装工程费 + B.安装工程费
C.其它费用 = A.其它费用 + B.其它费用
C.合计 = A.合计 + B.合计
```

---

### D部分：基本预备费
**定义**：按照工程经济学标准，预留的基本预备费用

**结构**：
- **序号**：D
- **无子项**

**计算公式**：
```
D.合计 = (A.合计 + B.合计) × 8%
D.合计 = C.合计 × 8%
```

**说明**：
- 预备费率固定为8%
- 用于应对项目实施过程中的不确定性

---

### E部分：建设投资
**定义**：项目的建设投资总额（不含利息）

**结构**：
- **序号**：E
- **无子项**

**计算公式**：
```
E.合计 = C.合计 + D.合计
E.合计 = (A.合计 + B.合计) × 1.08
```

**说明**：
- 建设投资是计算贷款金额的基础
- 不包含建设期利息

---

### F部分：建设期利息
**定义**：建设期内贷款产生的利息

**结构**：
- **序号**：F
- **包含详细信息**：
  - 贷款总额（万元）
  - 年利率（%）
  - 建设期年限（年）
  - 分年利息明细（每年的利息计算）

**计算公式**：

#### 1. 贷款金额计算（标准单利计息）
```
粗略贷款额 Z_raw = E.合计 × 贷款比例
```

#### 2. 贷款分级取整（金融规范）
```
如果 Z_raw < 100万元：
  Z_final = round(Z_raw, 整数)
  
如果 100万元 ≤ Z_raw < 1000万元：
  Z_final = round(Z_raw / 10) × 10
  
如果 Z_raw ≥ 1000万元：
  Z_final = round(Z_raw / 100) × 100
```

#### 3. 分年借款分配
```
每年借款金额 = Z_final / 建设期年限
```

#### 4. 分年利息计算（单利）
```
第n年利息 = (期初本金累计 + 当期借款金额 / 2) × 年利率

其中：
- 期初本金累计 = Σ(前n-1年的借款金额)
- 当期借款金额 = Z_final / 建设期年限
```

**示例**（建设期3年，贷款总额1000万元，年利率4.9%）：
```
第1年：
  期初本金累计 = 0
  当期借款金额 = 333.33万元
  当期利息 = (0 + 333.33 / 2) × 4.9% = 8.17万元

第2年：
  期初本金累计 = 333.33万元
  当期借款金额 = 333.33万元
  当期利息 = (333.33 + 333.33 / 2) × 4.9% = 24.50万元

第3年：
  期初本金累计 = 666.66万元
  当期借款金额 = 333.34万元
  当期利息 = (666.66 + 333.34 / 2) × 4.9% = 40.83万元

F.合计 = 8.17 + 24.50 + 40.83 = 73.50万元
```

**特殊功能**：
- 支持用户自定义贷款金额（手动修改贷款额度）
- 自定义后，跳过迭代调整，直接计算利息

---

### G部分：项目总资金
**定义**：项目的总投资（含利息）

**结构**：
- **序号**：G
- **无子项**

**计算公式**：
```
G.合计 = E.合计 + F.合计
G.占总投资比例 = 100%
```

**说明**：
- G部分是最终的项目总投资
- 迭代算法的目标是使G.合计无限逼近用户设定的目标总投资

---

 以下是表结构，供调整参考：

| 序号 | 工程或费用名称 | 合计（万元） | 占总投资比例 | 备注 |
| --- | --- | --- | --- | --- |
| **A** | **第一部分 工程费用** | **[A_total.xx]** | **[A_ratio.xx]%** | **实体建设类支出合计** |
| 一 | [二级子项名称1] | [A1_total.xx] | [A1_ratio.xx]% | — |
| 二 | [二级子项名称2] | [A2_total.xx] | [A2_ratio.xx]% | — |
| **B** | **第二部分 工程其它费用** | **[B_total.xx]** | **[B_ratio.xx]%** | **管理性、咨询性和专项费用合计** |
| 1 | 建设管理费 | [B1.xx] | [B1_ratio.xx]% | 按第一部分工程费的1.5%计取（可调范围±0.05%） |
| 2 | 项目土地费用 | [B2.xx] | [B2_ratio.xx]% | — |
| ... | (其他关键费用项) | [...] | [...]% | — |
| **C** | **第一、二部分合计** | **[C_calc.xx]** | **[C_ratio.xx]%** | **C = A + B** |
| **D** | **基本预备费** | **[D_value.xx]** | **[D_ratio.xx]%** | **按C×8%计算** |
| **E** | **建设投资** | **[E_calc.xx]** | **[E_ratio.xx]%** | **E = C + D** |
| **F** | **建设期利息** | **[F_value.xx]** | **[F_ratio.xx]%** | **贷款计息** |
| **G** | **项目总资金** | **[G_calc.xx]** | **100.00%** | **G = E + F** |



## 三、统一循环迭代算法

### 算法目标
使 `G_calc`（计算出的总投资）无限逼近 `G_target`（用户设定的目标总投资）

### 差距率定义
```
差距率 = (G_calc - G_target) / G_target × 100%
```

### 迭代条件
- **差距率阈值**：-5% ~ 5%
- **最大迭代次数**：10次（熔断保护）

### 迭代流程
```
1. 初始化A部分子项（AI生成或使用历史数据）
2. 计算B、C、D、E部分
3. 计算贷款金额和建设期利息（F部分）
4. 计算项目总资金（G部分）
5. 计算差距率
6. 如果 |差距率| > 5% 且 迭代次数 < 10：
   - 调整A部分子项金额
   - 返回步骤2
7. 否则：
   - 输出最终结果
```

### 调整策略
- **差距率 > 5%**（计算值偏大）：按比例缩小A部分子项
- **差距率 < -5%**（计算值偏小）：按比例放大A部分子项

---

## 四、资金来源分析

### 贷款资金
```
贷款金额 = F.贷款总额
贷款比例 = 贷款金额 / G.合计 × 100%
```

### 自筹资金
```
自筹金额 = G.合计 - 贷款金额
自筹比例 = 自筹金额 / G.合计 × 100%
```

### 验证
```
贷款比例 + 自筹比例 = 100%
```

---


## 六、UI展示特点

### 1. 简表模式（默认）
- 显示A-G所有部分
- A部分显示所有一级子项
- B部分显示前3项关键子项 + 其他项合计
- 不显示工程量和单价列

### 2. 精算模式（可选）
- 显示所有子项（包括二级、三级）
- 显示工程量、单位、单价列
- 适用于详细审核和调整

### 3. 颜色标识
- **A、B部分**：浅蓝色背景（`bg-primary/5`）
- **C、E部分**：浅灰色背景（`bg-accent/20`）
- **D、F部分**：浅黄色背景（`bg-secondary/30`）
- **G部分**：浅绿色背景（`bg-primary/10`）+ 加粗 + 大字号

### 4. 差距率提示
- **|差距率| ≤ 5%**：绿色文字（`text-green-600`）
- **|差距率| > 5%**：橙色文字（`text-orange-600`）

---

## 七、核心功能

### 1. 自动生成
- 输入：项目名称、目标总投资、建设期年限、贷款比例、贷款利率
- 输出：完整的投资估算简表
- 特点：10次迭代内自动收敛到目标值

### 2. 手动调整
- 修改A部分子项金额
- 修改土地费用配置
- 修改贷款金额
- 修改后自动重新计算

### 3. 参数变更检测
- 检测总投资、建设期、贷款利率、土地费用的变更
- 提示用户是否重新计算
- 保留历史数据，支持恢复

### 4. 锁定机制
- 锁定后不可修改
- 解锁后可继续编辑
- 锁定时保存完整的估算数据

### 5. AI辅助
- 自动生成A部分子项
- 智能建议项目类型
- 自动补全工程量和单价

---

## 八、数据校验

### 1. 费用联动校验
```
A.合计 = Σ(A.children.合计)
B.合计 = Σ(B.children.合计)
C.合计 = A.合计 + B.合计
D.合计 = C.合计 × 8%
E.合计 = C.合计 + D.合计
G.合计 = E.合计 + F.合计
```

### 2. 比例校验
```
Σ(所有部分.占总投资比例) = 100%
```

### 3. 贷款校验
```
贷款比例 + 自筹比例 = 100%
贷款金额 = F.贷款总额
```

### 4. 利息校验
```
F.合计 = Σ(F.分年利息.当期利息)
```

---
