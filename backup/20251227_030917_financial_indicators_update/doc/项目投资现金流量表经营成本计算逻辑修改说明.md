# 项目投资现金流量表经营成本计算逻辑修改说明

## 修改背景

根据需求，项目投资现金流量表中"经营成本"运营期列需要加上 revenueTableData 中进项税额的数据。

## 修改内容

### 修改文件
- `client/src/components/revenue-cost/FinancialIndicatorsTable.tsx`
- 修改函数：`calculateOperatingCost`（第520-647行）

### 修改逻辑

1. **从 costTableData 获取经营成本时添加进项税额**
   - 当从 costTableData 中获取"经营成本"（序号1）的运营期列数据时
   - 同时从 revenueTableData 中获取"进项税额"（序号2.2）的运营期列数据
   - 将两者相加作为最终的经营成本

2. **使用后备计算逻辑时添加进项税额**
   - 当没有 costTableData 数据，使用后备计算逻辑时
   - 计算基础经营成本（外购原材料费、外购燃料及动力费、工资及福利费、修理费、其他费用）
   - 从 revenueTableData 中获取"进项税额"（序号2.2）的运营期列数据
   - 将基础经营成本与进项税额相加作为最终的经营成本

3. **合计数据计算同样添加进项税额**
   - 在计算合计数据时，也应用了相同的逻辑
   - 将经营成本合计与进项税额合计相加

## 修改代码

```typescript
// 优先从 costTableData 中获取"经营成本"（序号1）的运营期列数据
if (costTableData && costTableData.rows) {
  const row = costTableData.rows.find(r => r.序号 === '1');
  if (row && row.运营期 && row.运营期[year - 1] !== undefined) {
    // 如果有 costTableData 数据，需要添加 revenueTableData 中的进项税额
    let operatingCost = row.运营期[year - 1];
    
    // 从 revenueTableData 中获取进项税额（序号2.2）的运营期列数据
    if (revenueTableData && revenueTableData.rows) {
      const inputTaxRow = revenueTableData.rows.find(r => r.序号 === '2.2');
      if (inputTaxRow && inputTaxRow.运营期 && inputTaxRow.运营期[year - 1] !== undefined) {
        // 经营成本 = 原经营成本 + 进项税额
        operatingCost += inputTaxRow.运营期[year - 1];
      }
    }
    
    return operatingCost;
  }
}

// 后备计算逻辑中也添加进项税额
let operatingCost = rawMaterialsCost + fuelPowerCost + wagesCost + repairCost + otherExpensesCost;

// 从 revenueTableData 中获取进项税额（序号2.2）的运营期列数据
if (revenueTableData && revenueTableData.rows) {
  const inputTaxRow = revenueTableData.rows.find(r => r.序号 === '2.2');
  if (inputTaxRow && inputTaxRow.运营期 && inputTaxRow.运营期[year - 1] !== undefined) {
    // 经营成本 = 基础经营成本 + 进项税额
    operatingCost += inputTaxRow.运营期[year - 1];
  }
}

return operatingCost;
```

## 修改原因

根据财务计算原则，项目投资现金流量表中的"经营成本"应该包含进项税额。进项税额是企业购买原材料、燃料等时支付的增值税，虽然可以在计算应交增值税时抵扣，但在现金流量表中，这部分税额实际是企业支付的现金，应该包含在经营成本中。

## 影响范围

此修改将影响以下表格和计算：
1. 项目投资现金流量表中的"经营成本"（序号2.3）
2. 项目投资现金流量表中的"现金流出"（序号2）
3. 项目投资现金流量表中的"所得税前净现金流量"（序号3）
4. 项目投资现金流量表中的"累计所得税前净现金流量"（序号4）
5. 项目投资现金流量表中的"所得税后净现金流量"（序号6）
6. 项目投资现金流量表中的"累计所得税后净现金流量"（序号7）

## 测试建议

1. 确认在有 revenueTableData 和 costTableData 数据时，经营成本计算正确
2. 确认在只有后备计算逻辑时，经营成本计算正确
3. 确认经营成本合计计算正确
4. 验证项目投资现金流量表中的相关数据计算正确
5. 验证导出的Excel文件中数据正确