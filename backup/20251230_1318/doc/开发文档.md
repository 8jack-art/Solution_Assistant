# miaoda-react-admin 开发文档

## 1. 项目概述

miaoda-react-admin 是一个基于 React 18 + TypeScript 构建的投资项目管理系统，提供投资估算、项目管理、LLM 配置等功能。系统采用现代化的前端技术栈，结合 Supabase 数据库，实现了一套完整的投资项目全生命周期管理解决方案。

### 1.1 项目特点

- **现代化技术栈**：React 18 + TypeScript + Vite，提供良好的开发体验和性能
- **组件化架构**：基于 Radix UI 和 Tailwind CSS，实现高质量的用户界面
- **灵活的投资估算**：支持自定义贷款金额和 AI 辅助生成工程费用项
- **LLM 集成**：支持多供应商 LLM API 配置，提供 AI 辅助功能
- **安全的用户认证**：多重验证机制，支持本地测试账号
- **完善的数据管理**：基于 Supabase 的完整数据模型和 API

## 2. 技术架构

### 2.1 技术栈

| 分类 | 技术/框架 | 版本 | 用途 |
|------|-----------|------|------|
| 前端框架 | React | 18 | 用户界面构建 |
| 类型系统 | TypeScript | 5 | 类型安全 |
| 构建工具 | Vite | ^5 | 项目构建和开发服务器 |
| UI 组件库 | Radix UI | - | 可访问的 UI 组件 |
| 样式 | Tailwind CSS | ^3 | 实用优先的 CSS 框架 |
| 路由 | React Router | 6 | 页面路由管理 |
| 数据库 | Supabase | - | 后端即服务 (BaaS) |
| 代码质量 | Biome | - | 代码检查和格式化 |

### 2.2 系统架构

```
┌───────────────────────────────────────────────────────────────────┐
│                        前端应用 (React)                           │
│  ┌─────────────────┐  ┌─────────────────┐  ┌───────────────────┐ │
│  │   路由层        │  │   组件层        │  │   工具函数层      │ │
│  │ (React Router)  │  │ (Radix UI)      │  │ (LLM, 投资估算等) │ │
│  └────────┬────────┘  └────────┬────────┘  └────────┬───────────┘ │
│           │                    │                    │             │
│  ┌────────▼────────────────────▼────────────────────▼────────┐    │
│  │                    API 接口层                              │    │
│  │ (src/db/api.ts)                                           │    │
│  └───────────────────────────┬───────────────────────────────┘    │
└───────────────────────────────┼───────────────────────────────────┘
                                ▼
                        Supabase 数据库
```

## 3. 项目结构

```
src/
├── components/          # 通用组件
│   ├── auth/           # 认证相关组件
│   │   └── ProtectedRoute.tsx
│   └── ui/             # UI 组件
├── db/                 # 数据库相关
│   ├── api.ts          # API 接口封装
│   └── supabase.ts     # Supabase 客户端配置
├── lib/                # 工具函数和业务逻辑
│   ├── investmentEstimator.ts  # 投资估算核心算法
│   └── llm.ts          # LLM 调用工具
├── pages/              # 页面组件
│   ├── LLMConfigsManagement.tsx
│   ├── Login.tsx
│   └── InvestmentCalculator.tsx
├── routes/             # 路由配置
│   └── routes.tsx
├── types/              # TypeScript 类型定义
│   ├── index.ts
│   ├── investment.ts
│   └── types.ts
├── App.tsx             # 应用主组件
└── main.tsx            # 应用入口
```

## 4. 核心功能模块

### 4.1 用户认证

用户认证模块提供了多重验证机制，确保系统安全：

- **登录验证**：支持 REST API、RPC 函数和本地验证三种方式
- **权限控制**：基于 `ProtectedRoute` 组件的路由级权限控制
- **测试账号**：内置管理员和普通用户测试账号

```typescript
// 登录验证流程
export const userApi = {
  async login(username: string, password: string) {
    // 1. 尝试 REST API 直接查询
    // 2. 尝试 RPC 函数
    // 3. 本地验证（最终后备方案）
  }
};
```

### 4.2 投资项目管理

投资项目管理模块提供了完整的项目生命周期管理：

- **项目创建**：支持设置项目名称、总投资、建设年限、运营年限等
- **项目编辑**：可更新项目基本信息和参数
- **项目删除**：支持删除不再需要的项目
- **状态管理**：支持草稿和完成状态切换
- **投资锁定**：可锁定项目总投资，防止误操作

```typescript
export const projectApi = {
  async create(userId: string, projectName: string, totalInvestment: number, ...) {
    // 创建新项目
  },
  async update(projectId: string, updates: { ... }) {
    // 更新项目信息
  },
  async lock(projectId: string) {
    // 锁定项目总投资
  }
};
```

### 4.3 投资估算

投资估算模块使用统一循环迭代算法，实现精确的投资估算：

- **统一循环迭代算法**：自动计算建设期利息和贷款金额
- **自定义贷款金额**：支持用户自定义贷款金额
- **AI 辅助生成**：可利用 LLM 生成工程费用项
- **投资组成**：支持建设投资、建设期利息等详细计算

```typescript
export const estimateInvestment = async (params: EstimateParams) => {
  // 1. 构建基础数据
  // 2. 计算建设期利息
  // 3. 迭代计算贷款金额
  // 4. 生成最终投资估算
};
```

### 4.4 LLM 配置管理

LLM 配置管理模块支持多供应商 API 适配和配置管理：

- **多供应商支持**：支持不同 LLM 服务提供商
- **API 配置**：可配置 API 密钥、模型、基础 URL 等
- **默认配置**：支持设置默认 LLM 配置
- **连接测试**：可测试 LLM 配置的有效性

```typescript
export const llmConfigApi = {
  async create(userId: string, config: Partial<LLMConfig>) {
    // 创建 LLM 配置
  },
  async setDefault(configId: string, userId: string) {
    // 设置默认配置
  },
  async testConnection(config: LLMConfig) {
    // 测试连接
  }
};
```

## 5. 数据模型

### 5.1 投资项目 (InvestmentProject)

```typescript
export interface InvestmentProject {
  id: string;                  // 项目 ID
  user_id: string;             // 用户 ID
  project_name: string;        // 项目名称
  total_investment: number;    // 总投资
  project_info?: string;       // 项目信息
  status: 'draft' | 'completed'; // 项目状态
  construction_years: number;  // 建设年限
  operation_years: number;     // 运营年限
  loan_ratio: number;          // 贷款比例
  loan_interest_rate: number;  // 贷款利率
  is_locked: boolean;          // 是否锁定
  locked_at?: string;          // 锁定时间
  created_at: string;          // 创建时间
  updated_at: string;          // 更新时间
}
```

### 5.2 投资估算 (InvestmentEstimate)

```typescript
export interface InvestmentEstimate {
  id: string;                  // 估算 ID
  project_id: string;          // 项目 ID
  estimate_data?: any;         // 完整估算数据
  total_investment?: number;   // 总投资
  building_investment?: number;// 建设投资
  construction_interest?: number; // 建设期利息
  gap_rate?: number;           // 差距率
  construction_cost: number;   // 建筑工程费
  equipment_cost: number;      // 设备购置费
  installation_cost: number;   // 安装工程费
  other_cost: number;          // 其他费用
  land_cost: number;           // 土地费用
  basic_reserve: number;       // 基本预备费
  price_reserve: number;       // 涨价预备费
  construction_period: number; // 建设周期
  iteration_count: number;     // 迭代次数
  final_total: number;         // 最终总投资
  loan_amount: number;         // 贷款金额
  loan_rate: number;           // 贷款利率
  custom_loan_amount?: number; // 自定义贷款金额
  created_at: string;          // 创建时间
  updated_at: string;          // 更新时间
}
```

### 5.3 营收成本估算 (RevenueCostEstimate)

```typescript
export interface RevenueCostEstimate {
  id: string;                  // 估算 ID
  project_id: string;          // 项目 ID
  calculation_period: number;  // 计算期
  operation_period: number;    // 运营期
  production_start_year: number; // 投产年份
  full_production_year: number;  // 达产年份
  annual_revenue: number;      // 年营收
  annual_cost: number;         // 年成本
  depreciation_years: number;  // 折旧年限
  residual_rate: number;       // 残值率
  amortization_years: number;  // 摊销年限
  vat_rate: number;            // 增值税率
  additional_tax_rate: number; // 附加税率
  created_at: string;          // 创建时间
  updated_at: string;          // 更新时间
}
```

### 5.4 LLM 配置 (LLMConfig)

```typescript
export interface LLMConfig {
  id: string;                  // 配置 ID
  name: string;                // 配置名称
  provider: string;            // 服务提供商
  apiKey: string;              // API 密钥
  baseUrl: string;             // 基础 URL
  model: string;               // 模型名称
  isDefault: boolean;          // 是否默认配置
  createdAt: string;           // 创建时间
  updatedAt: string;           // 更新时间
}
```

### 5.5 用户 (User)

```typescript
export interface User {
  id: string;                  // 用户 ID
  username: string;            // 用户名
  password_hash: string;       // 密码哈希
  is_admin: boolean;           // 是否管理员
  is_expired: boolean;         // 是否过期
  expired_at?: string;         // 过期时间
  created_at: string;          // 创建时间
  updated_at: string;          // 更新时间
}
```

## 6. API 接口

### 6.1 项目管理 API

| 方法 | 功能 | 参数 | 返回值 |
|------|------|------|--------|
| `projectApi.create()` | 创建项目 | userId, projectName, totalInvestment, ... | InvestmentProject |
| `projectApi.getByUserId()` | 获取用户项目列表 | userId, isAdmin | InvestmentProject[] |
| `projectApi.getById()` | 获取项目详情 | projectId | ProjectWithEstimates |
| `projectApi.updateStatus()` | 更新项目状态 | projectId, status | InvestmentProject |
| `projectApi.update()` | 更新项目信息 | projectId, updates | InvestmentProject |
| `projectApi.lock()` | 锁定项目 | projectId | InvestmentProject |
| `projectApi.unlock()` | 解锁项目 | projectId | InvestmentProject |
| `projectApi.delete()` | 删除项目 | projectId | void |

### 6.2 投资估算 API

| 方法 | 功能 | 参数 | 返回值 |
|------|------|------|--------|
| `investmentEstimateApi.save()` | 保存投资估算 | projectId, estimate | InvestmentEstimate |
| `investmentEstimateApi.getByProjectId()` | 获取投资估算 | projectId | InvestmentEstimate |

### 6.3 LLM 配置 API

| 方法 | 功能 | 参数 | 返回值 |
|------|------|------|--------|
| `llmConfigApi.create()` | 创建 LLM 配置 | userId, config | LLMConfig |
| `llmConfigApi.getByUserId()` | 获取用户 LLM 配置列表 | userId | LLMConfig[] |
| `llmConfigApi.getDefault()` | 获取默认 LLM 配置 | userId | LLMConfig |
| `llmConfigApi.update()` | 更新 LLM 配置 | configId, config | LLMConfig |
| `llmConfigApi.setDefault()` | 设置默认配置 | configId, userId | void |
| `llmConfigApi.delete()` | 删除 LLM 配置 | configId | void |

### 6.4 用户管理 API

| 方法 | 功能 | 参数 | 返回值 |
|------|------|------|--------|
| `userApi.login()` | 用户登录 | username, password | User |
| `userApi.getById()` | 获取用户信息 | userId | User |
| `userApi.create()` | 创建用户 | username, password, isAdmin | User |
| `userApi.update()` | 更新用户信息 | userId, updates | User |
| `userApi.delete()` | 删除用户 | userId | void |

## 7. 开发环境搭建

### 7.1 环境要求

- Node.js >= 18
- npm >= 9
- Git

### 7.2 安装步骤

1. 克隆项目代码
```bash
git clone <项目地址>
cd miaoda-react-admin
```

2. 安装依赖
```bash
npm install
```

3. 配置环境变量

创建 `.env` 文件，配置以下环境变量：
```env
VITE_SUPABASE_URL=your_supabase_url
VITE_SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key
```

4. 运行开发服务器
```bash
npm run dev
```

### 7.3 代码质量检查

```bash
# 运行类型检查
npm run type-check

# 运行代码检查
npm run lint
```

## 8. 代码质量规范

### 8.1 代码风格

- 使用 TypeScript 编写所有代码
- 采用 Biome 进行代码格式化和检查
- 遵循 React 最佳实践

### 8.2 命名规范

- **变量名**：使用 camelCase
- **函数名**：使用 camelCase
- **组件名**：使用 PascalCase
- **类型名**：使用 PascalCase

### 8.3 提交规范

- 提交信息应清晰描述修改内容
- 遵循 Conventional Commits 规范

## 9. 部署说明

### 9.1 构建生产版本

```bash
npm run build
```

### 9.2 部署方式

- 静态文件部署：可部署到 Vercel、Netlify 等静态托管平台
- 容器化部署：可使用 Docker 容器化后部署

### 9.3 环境配置

部署时需确保配置以下环境变量：
- `VITE_SUPABASE_URL`：Supabase 项目 URL
- `VITE_SUPABASE_SERVICE_ROLE_KEY`：Supabase Service Role 密钥

## 10. 安全注意事项

1. **API 密钥保护**：不要将 API 密钥硬编码到代码中，应使用环境变量
2. **权限控制**：确保用户只能访问其有权限的资源
3. **数据验证**：对所有用户输入进行严格验证
4. **日志记录**：记录关键操作日志，便于审计和问题排查

## 11. 故障排查

### 11.1 常见问题

1. **开发服务器启动失败**
   - 检查环境变量配置是否正确
   - 检查依赖是否安装完整

2. **数据库连接失败**
   - 检查 Supabase URL 和密钥是否正确
   - 检查网络连接是否正常

3. **LLM 调用失败**
   - 检查 LLM 配置是否正确
   - 检查 API 密钥是否有效

### 11.2 调试技巧

- 使用浏览器开发者工具进行前端调试
- 查看控制台日志获取详细错误信息
- 使用 Supabase 控制台查看数据库操作日志

## 12. 未来规划

1. **功能增强**：
   - 添加更多投资分析指标
   - 支持多项目比较功能
   - 提供报表导出功能

2. **性能优化**：
   - 优化投资估算算法性能
   - 添加数据缓存机制

3. **用户体验改进**：
   - 添加更多操作引导
   - 优化移动端体验

4. **安全增强**：
   - 实现更细粒度的权限控制
   - 添加多因素认证

---

**文档版本**：1.0
**最后更新**：2025-04-05
**编写者**：AI 助手