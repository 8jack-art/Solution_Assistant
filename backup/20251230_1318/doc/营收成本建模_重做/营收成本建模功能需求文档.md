# 营收成本建模功能需求文档

> 文档版本：v1.0  
> 创建日期：2025-12-17  
> 涵盖范围：还本付息表优化 → AI推荐营收结构 → 收入建模自动生成

---

## 一、还本付息计划表优化

### 1.1 功能概述
优化还本付息计划表的计算逻辑，采用等额本金还款方式，并修正利息计算公式。

### 1.2 详细需求

#### 1.2.1 还款方式
- **还款模式**：等额本金还款
- **还款规则**：每月偿还固定本金，利息随剩余本金递减

#### 1.2.2 利息计算公式
**新公式**：当年利息 = (期初借款余额 - 当期还本/2) × 年利率

**计算逻辑**：
1. 期初借款余额 = 贷款总额 - 已偿还本金
2. 当期还本 = 每月固定本金 × 12个月
3. 利息基数 = 期初余额 - (当期还本 ÷ 2)
4. 当年利息 = 利息基数 × 年利率

#### 1.2.3 数据展示
还本付息表包含以下行：
1. **期初借款余额**：每年初的贷款余额
2. **当期还本付息**（主行）：还本 + 付息的合计
3. **还本**（子行2.1）：当年偿还的本金
4. **付息**（子行2.2）：当年支付的利息
5. **期末借款余额**：每年末的贷款余额

---

## 二、AI推荐营收结构功能

### 2.1 功能概述
使用LLM大模型分析项目特征，从14个预定义营业收入类型类别中智能推荐2-6个最合适的类别，并为每个类别推荐3-8个具体的营业收入类型。

### 2.2 营业收入类型表（14个类别）

| 序号 | 类别代码 | 类别名称 | 图标 | 示例收入类型 |
|------|---------|---------|------|-------------|
| A | 🖥️ 数字平台类 | SaaS平台会员费、AI决策支持增值服务费 |
| B | 🌾 农业种植类 | 中药材销售收入、种苗销售收入 |
| C | 🐄 畜牧养殖类 | 肉牛销售收入、乳制品销售收入 |
| D | 🌲 林业类 | 木材销售收入、林下经济产品收入 |
| E | 🐟 渔业类 | 水产品销售收入、观赏鱼销售收入 |
| F | 🏗️ 建筑营造类 | 建筑工程收入、装修服务费 |
| G | 🏢 资产运营类 | 房屋租赁收入、设备租赁收入 |
| H | 🏭 产业园区开发类 | 园区管理费、配套服务费 |
| I | 🤝 交易撮合类 | 平台交易佣金、信息服务费 |
| J | ⚙️ 加工服务类 | 农产品加工收入、来料加工费 |
| K | 🌱 综合农服类 | 农技服务费、农机租赁收入 |
| L | ⚡ 新能源融合类 | 光伏发电收入、生物质能源销售 |
| M | 🎡 农旅融合类 | 门票收入、民宿收入 |
| N | 💰 政策与金融服务类 | 补贴收入、担保服务费 |

### 2.3 AI分析流程

#### 2.3.1 输入数据
- 项目名称
- 项目描述/基本信息
- 总投资金额
- 工程项目列表（从投资估算表提取）

#### 2.3.2 输出格式
```json
{
  "selected_categories": [
    {
      "category_code": "B",
      "category_name": "🌾 农业种植类",
      "category_icon": "🌾",
      "relevance_score": 0.85,
      "reasoning": "项目涉及中药材种植基地建设",
      "recommended_revenue_types": [
        {
          "type_name": "中药材销售收入",
          "priority": "high",
          "suggested_vat_rate": 0.09,
          "typical_pricing_model": "按重量销售",
          "estimated_proportion": "60"
        }
      ]
    }
  ],
  "total_categories": 3,
  "analysis_summary": "基于项目投资和工程内容分析..."
}
```

#### 2.3.3 超时配置
- AI推荐接口超时时间：**120秒**（2分钟）

### 2.4 用户交互设计

#### 2.4.1 汇总表格
**表头**：
- 序号
- 营收大类（显示：emoji + 类别名，如 🌾 农业种植类）
- 营业收入类型（显示所有推荐类型，带优先级Badge）
- 相关度（百分比）
- 操作（编辑、删除）

**优先级显示**：
- 高：红色Badge "高"
- 中：橙色Badge "中"
- 低：灰色Badge "低"

#### 2.4.2 编辑营收类别弹窗
**功能**：
1. 显示推荐理由和相关度
2. 营业收入类型表格（序号、优先级、名称、计费模式、税率、占比、操作）
3. 支持编辑、删除、新增营业收入类型
4. 编辑/新增支持AI分析功能

**按钮布局**：
- 底部左侧："AI分析"按钮
- 底部右侧："应用"、"取消"按钮（从左到右）

**应用逻辑**：
- 所有编辑、删除、新增操作仅修改临时状态
- 只有点击"应用"后才同步到主表格
- 未修改时"应用"按钮不可用
- 点击"取消"恢复原始数据

#### 2.4.3 AI分析功能（编辑收入类型）
**输入验证**：
- 检查营业收入类型名称是否包含收入相关关键词
- 支持的关键词：收入、销售、服务、租赁、费、佣金、营业、产品、咨询、代理、会员、订阅等（共25个）
- 允许测试性收入：匹配 `测试[0-9A-Za-z中文]*` 模式

**AI分析输出**：
- 增值税税率（%）
- 计费模式（不超过15字）

**税率参考规则**：
- 农产品销售：9%
- 服务业：6%
- 工业产品销售：13%
- 租赁服务：9%

**示例**：
- 输入："中药材销售收入"
- 输出：税率 9%，计费模式 "按重量销售"

### 2.5 锁定机制

#### 2.5.1 锁定开关
**位置**：AI分析营收结构按钮左侧

**状态**：
- 未锁定（默认）：灰色，显示"未锁定"
- 已锁定：绿色，显示"已锁定"

#### 2.5.2 锁定条件
- **允许锁定**：营收结构表有数据（`aiAnalysisResult.selected_categories.length > 0`）
- **禁止锁定**：营收结构表无数据（开关禁用）

#### 2.5.3 锁定后的限制
1. AI分析按钮禁用
2. 所有类别的"编辑"按钮禁用
3. 所有类别的"删除"按钮禁用
4. "下一步"按钮解锁

#### 2.5.4 下一步验证
- 未锁定时点击"下一步"：提示"请先锁定营收结构表才能进行下一步"
- 已锁定时点击"下一步"：允许进入收入建模步骤

### 2.6 AI分析确认机制

#### 2.6.1 覆盖数据确认
**触发条件**：营收结构表已有数据时点击"AI分析营收结构"

**确认对话框**：
- 标题："确认重新分析"
- 内容：显示当前已有的类别数量
- 警告：点击「继续」将会覆盖当前数据
- 按钮：
  - "继续"（红色，表示危险操作）
  - "取消"（默认）

**流程**：
1. 有数据 → 弹出确认对话框 → 点击"继续" → 执行AI分析
2. 无数据 → 直接执行AI分析

### 2.7 AI分析时的状态管理

#### 2.7.1 按钮禁用
AI分析过程中（`generatingSuggestions = true`）：
- "上一步"按钮禁用
- "下一步"按钮禁用
- "完成并保存"按钮禁用
- "返回投资估算"按钮禁用
- "AI分析营收结构"按钮显示加载状态

---

## 三、收入建模自动生成功能

### 3.1 功能概述
当用户进入"收入建模"步骤时，系统自动读取营收结构表数据，使用LLM分析项目信息和投资数据，自动生成营业收入项目表。

### 3.2 触发条件
进入第3步（收入建模）时，同时满足：
1. `activeStep === 3`
2. `revenueItems.length === 0`（还没有收入项目）
3. `aiAnalysisResult` 存在（已完成AI推荐）
4. `!generatingRevenueItems`（未在生成中）

### 3.3 AI分析输入

#### 3.3.1 项目基本信息
- 项目名称
- 项目描述

#### 3.3.2 投资简表数据
- 总投资（万元）
- 建设期（年）
- 运营期（年）
- 建筑工程费（万元）
- 设备购置费（万元）

#### 3.3.3 营收结构表摘要
格式：
```
🌾 农业种植类：中药材销售收入、种苗销售收入
🖥️ 数字平台类：技术咨询服务费
```

### 3.4 AI分析输出

#### 3.4.1 输出格式
```json
{
  "revenue_items": [
    {
      "name": "中药材销售收入",
      "category": "agriculture-crop",
      "unit": "吨",
      "quantity": 100,
      "unitPrice": 50000,
      "vatRate": 9
    }
  ]
}
```

#### 3.4.2 字段说明
- **name**：收入项名称
- **category**：类别枚举值
  - `agriculture-crop`：农业种植
  - `agriculture-aquaculture`：水产养殖
  - `digital-platform`：数字平台
  - `transaction-hub`：交易平台
  - `other`：其他
- **unit**：计量单位（如：吨、平方米、次、人等）
- **quantity**：年产量/规模
- **unitPrice**：单价（元）
- **vatRate**：增值税率（%）

#### 3.4.3 生成规则
1. 生成 **3-8** 个收入项目
2. 覆盖主要营收类型
3. 数据符合行业常识和项目规模
4. 税率参考：农产品9%、服务业6%、工业产品13%

### 3.5 数据自动计算

系统自动计算以下字段：
- **annualRevenue**（年收入）= (quantity × unitPrice) ÷ 10000（万元）
- **vatAmount**（增值税额）= annualRevenue × (vatRate / 100) ÷ (1 + vatRate / 100)
- **nonTaxRevenue**（不含税收入）= annualRevenue - vatAmount

### 3.6 UI交互

#### 3.6.1 加载状态
**位置**：营业收入项目表标题右侧

**显示内容**：
- Badge："AI生成中..."
- 图标：旋转的IconSparkles

#### 3.6.2 通知消息
1. **开始生成**：
   - 标题："AI分析中"
   - 内容："正在生成营业收入项目表..."
   - 颜色：蓝色

2. **生成成功**：
   - 标题："AI生成成功"
   - 内容："已生成 X 个收入项目"
   - 颜色：绿色

3. **生成失败**：
   - 标题："AI生成失败"
   - 内容：错误信息
   - 颜色：红色

---

## 四、技术实现要点

### 4.1 LLM集成
- 所有AI功能需先检查LLM配置（`llmConfigApi.getDefault()`）
- 未配置时提示："请先配置LLM服务"

### 4.2 状态管理
**关键状态变量**：
- `aiAnalysisResult`：AI推荐结果
- `generatingSuggestions`：AI分析中
- `revenueStructureLocked`：营收结构表锁定状态
- `categoryModified`：类别已修改
- `originalEditingCategory`：原始类别数据（用于取消恢复）
- `generatingRevenueItems`：收入项目生成中
- `revenueItems`：收入项目列表

### 4.3 数据流转
```
AI推荐营收结构 
  → aiAnalysisResult（包含14类营收类型推荐）
  → 用户编辑确认
  → 锁定营收结构表
  → 进入收入建模
  → 自动调用LLM生成收入项目表
  → revenueItems（具体收入项目数据）
```

### 4.4 错误处理
1. LLM配置缺失：提示配置
2. 网络超时：显示错误通知
3. 数据解析失败：显示详细错误信息
4. 输入验证失败：橙色提示，不执行后续操作

---

## 五、用户操作流程

### 5.1 AI推荐营收结构
1. 进入"AI推荐结构"步骤
2. 点击"开始AI分析"（如已有数据，需确认覆盖）
3. 等待AI分析（最多2分钟）
4. 查看推荐的营收类别和收入类型
5. 点击"编辑"查看详情并调整
   - 删除不需要的收入类型
   - 编辑收入类型（可使用AI分析税率和计费模式）
   - 添加新的收入类型
   - 点击"应用"保存修改
6. 点击锁定开关，锁定营收结构表
7. 点击"下一步"进入收入建模

### 5.2 收入建模自动生成
1. 进入"收入建模"步骤
2. 系统自动调用AI生成收入项目表（约2秒）
3. 查看生成的收入项目数据
4. 可手动编辑、删除或添加收入项
5. 继续后续步骤

---

## 六、数据示例

### 6.1 AI推荐营收结构示例
**项目**：某中药材种植基地项目

**AI推荐结果**：
1. 🌾 农业种植类（相关度85%）
   - 中药材销售收入（高优先级，9%税率，按重量销售）
   - 种苗销售收入（中优先级，9%税率，按数量销售）
   
2. 🖥️ 数字平台类（相关度65%）
   - 技术咨询服务费（中优先级，6%税率，按服务次数）

3. 🌱 综合农服类（相关度70%）
   - 农技服务费（中优先级，6%税率，按亩收费）

### 6.2 收入建模自动生成示例
基于上述营收结构，自动生成：

| 序号 | 收入项 | 类别 | 单位 | 年产量 | 单价(元) | 年收入(万元) | 税率 |
|------|--------|------|------|--------|---------|-------------|------|
| A | 中药材销售收入 | 🌾农业种植 | 吨 | 100 | 50,000 | 500.00 | 9% |
| B | 种苗销售收入 | 🌾农业种植 | 株 | 50,000 | 10 | 50.00 | 9% |
| C | 技术咨询服务费 | 💻数字平台 | 次 | 200 | 5,000 | 100.00 | 6% |

---

## 七、待实现功能（TODO）

### 7.1 LLM API真实调用
当前使用模拟数据，需替换为真实的LLM API调用：
1. AI推荐营收结构：调用 `revenueCostApi.aiRecommend()`
2. AI分析税率和计费模式：需新增后端接口
3. AI生成收入项目表：需新增后端接口

### 7.2 数据持久化
1. 营收结构表数据保存到数据库
2. 收入项目表数据保存到数据库
3. 支持数据恢复和历史版本管理

### 7.3 增强功能
1. 支持批量导入收入项目
2. 支持导出收入项目表为Excel
3. 支持自定义营业收入类型模板
4. 达产率曲线可视化编辑

---

## 八、附录

### 8.1 相关文件
- 前端主文件：`/opt/Solution_Assistant/client/src/pages/RevenueCostModeling.tsx`
- 后端控制器：`/opt/Solution_Assistant/server/src/controllers/revenueCostController.ts`
- LLM服务：`/opt/Solution_Assistant/server/src/lib/llm.ts`
- API定义：`/opt/Solution_Assistant/client/src/lib/api.ts`

### 8.2 参考文档
- UI设计规范：`/opt/Solution_Assistant/doc/UI设计规范文档.md`
- 收入与成本使用说明：`/opt/Solution_Assistant/doc/2、收入与成本/使用说明.md`

### 8.3 更新日志
| 版本 | 日期 | 更新内容 |
|------|------|---------|
| v1.0 | 2025-12-17 | 初始版本，包含还本付息优化、AI推荐营收结构、收入建模自动生成三大功能 |

---

**文档结束**
