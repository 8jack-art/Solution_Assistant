# 投资估算简表数据持久化问题修复计划

## 问题描述
用户报告：关闭项目或重启后，再次进入"投资估算简表"会加载不了原来的数据，显示空白。其他模块正常，清除浏览器缓存后问题依然存在。

## 问题分析

### 1. 缓存TTL太短
- 当前缓存TTL只有5分钟（300000ms）
- 用户切换页面或短暂离开后缓存可能已过期
- 导致重新从数据库加载数据时出现异常

### 2. 缺乏持久化缓存机制
- 当前缓存仅存储在内存中
- 页面刷新或关闭后缓存完全丢失
- 没有使用localStorage等持久化存储

### 3. 缓存失效策略可能有问题
- 可能在不应该失效的时候失效了
- 缺乏智能的缓存管理策略

### 4. 数据加载逻辑可能存在竞态条件
- 在组件卸载和重新挂载时可能出现数据状态不一致
- AbortController实现可能不够完善

## 修复方案

### 1. 增强缓存策略
- **增加TTL时间**：从5分钟增加到30分钟（1800000ms）
- **实现持久化缓存**：使用localStorage存储投资估算数据
- **智能缓存恢复**：页面加载时自动从localStorage恢复缓存
- **分层缓存**：内存缓存 + localStorage持久化

### 2. 改进数据加载逻辑
- **优化AbortController使用**：确保请求取消机制正确工作
- **增强错误处理**：对各种异常情况提供更好的处理
- **添加数据完整性检查**：确保加载的数据是有效的

### 3. 实现数据降级策略
- **多级数据源**：API → localStorage缓存 → 默认数据
- **数据验证机制**：检查数据完整性和有效性
- **友好的错误提示**：提供明确的错误信息和恢复建议

### 4. 添加调试和监控
- **详细日志记录**：记录数据加载过程和错误信息
- **性能监控**：监控数据加载时间和成功率
- **用户反馈机制**：提供重试和手动刷新选项

## 具体实现

### 1. 修改DataCacheManager类
```typescript
class DataCacheManager {
  private cache = new Map<string, { data: any; timestamp: number; ttl: number }>()
  
  constructor() {
    // 从localStorage恢复缓存
    this.restoreFromLocalStorage()
  }
  
  set(key: string, data: any, ttl: number = 1800000) { // 默认30分钟TTL
    // 实现内存+localStorage双重缓存
  }
  
  get(key: string): any | null {
    // 先从内存获取，再从localStorage获取
  }
  
  // 其他方法...
}
```

### 2. 优化InvestmentSummary组件
- 改进loadProjectAndEstimate函数的错误处理
- 添加数据完整性检查
- 实现更智能的加载策略

### 3. 增强错误边界
- 创建专门的DataLoadingErrorBoundary组件
- 提供友好的错误提示和重试选项
- 记录详细的错误信息

### 4. 添加调试工具
- 实现缓存状态检查工具
- 添加数据加载日志
- 提供手动清理缓存选项

## 测试计划

### 1. 功能测试
- 测试页面刷新后数据是否能正确加载
- 测试关闭浏览器后重新打开是否能恢复数据
- 测试缓存过期后的行为

### 2. 性能测试
- 测试大量数据情况下的加载性能
- 测试localStorage存储限制
- 测试并发请求的处理

### 3. 边界测试
- 测试localStorage被禁用的情况
- 测试数据损坏的情况
- 测试网络异常的情况

## 预期效果

1. **数据持久化**：页面刷新或关闭后数据能够正确恢复
2. **性能提升**：减少不必要的API请求，提高加载速度
3. **用户体验改善**：减少数据加载失败的情况，提供更好的错误提示
4. **系统稳定性**：增强系统的容错能力和恢复能力

## 风险评估

1. **存储限制**：localStorage有存储大小限制（通常5-10MB）
2. **数据安全**：localStorage中的数据可能被用户清理
3. **兼容性**：某些浏览器可能限制localStorage的使用
4. **数据一致性**：需要确保内存缓存和localStorage数据的一致性

## 实施步骤

1. **修改DataCacheManager类**：实现持久化缓存机制
2. **优化InvestmentSummary组件**：改进数据加载逻辑
3. **添加错误处理**：实现更完善的错误处理机制
4. **创建测试用例**：验证修复效果
5. **部署和监控**：观察修复效果并持续优化