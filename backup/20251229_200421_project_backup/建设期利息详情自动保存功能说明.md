# 建设期利息详情自动保存功能说明

## 功能概述

本功能实现了当用户点击进入"收入及成本测算"页面时，系统自动检查投资估算数据中的建设期利息详情，如果尚未保存，则自动从partF数据中提取建设期利息信息并保存到数据库中。

## 实现背景

在项目投资估算过程中，建设期利息是一个重要的财务指标。原系统中，建设期利息详情（包括分年借款金额、利息计算等）只存在于partF数据中，没有单独的结构化存储。为了便于后续的财务分析和报表生成，需要将这些数据提取并保存为结构化的建设期利息详情。

## 技术实现

### 1. 实现位置

功能实现在 `client/src/pages/RevenueCostModeling.tsx` 文件中，主要涉及以下两个函数：

- `saveConstructionInterestDetailsIfNeeded`: 检查并自动保存建设期利息详情
- `prepareConstructionInterestDetails`: 准备建设期利息详情数据结构

### 2. 触发时机

当用户访问收入及成本测算页面时，在页面加载的 `useEffect` 钩子中触发自动保存逻辑：

```typescript
// 检查并自动保存建设期利息详情
await saveConstructionInterestDetailsIfNeeded(estimateData, projectData)
```

### 3. 数据处理流程

1. **检查现有数据**: 首先检查投资估算数据中是否已存在 `construction_interest_details` 字段
2. **验证partF数据**: 确认投资估算数据中包含 `partF` 数据（建设期利息数据）
3. **提取和格式化**: 从 `partF.分年利息` 中提取分年数据，并计算期末借款余额
4. **结构化存储**: 将数据组织为包含基本信息、分年数据和汇总信息的结构化格式
5. **API保存**: 调用投资估算API将数据保存到数据库

### 4. 数据结构

保存的建设期利息详情包含以下结构：

```typescript
{
  基本信息: {
    贷款总额: number,
    年利率: string,
    建设期年限: number,
    贷款期限: number
  },
  分年数据: [
    {
      年份: number,
      期初借款余额: number,
      当期借款金额: number,
      当期利息: number,
      期末借款余额: number
    }
  ],
  汇总信息: {
    总借款金额: number,
    总利息: number,
    期末借款余额: number
  }
}
```

## 测试验证

创建了测试脚本 `test_construction_interest.js` 来验证功能是否正常工作：

1. 登录系统获取访问令牌
2. 获取项目列表并选择第一个项目
3. 获取投资估算数据，检查是否有建设期利息详情
4. 如果没有，则从partF数据生成建设期利息详情并保存
5. 再次检查投资估算数据，确认建设期利息详情已成功保存

测试结果显示功能正常工作，建设期利息详情能够正确地从partF数据中提取并保存到数据库。

## 用户界面反馈

当建设期利息详情成功自动保存时，系统会显示通知：

```typescript
notifications.show({
  title: '数据已更新',
  message: '建设期利息详情已自动保存',
  color: 'green',
})
```

如果保存过程中发生错误，也会显示相应的错误通知。

## 注意事项

1. **幂等性**: 功能具有幂等性，如果建设期利息详情已存在，不会重复保存
2. **数据完整性**: 只有在partF数据完整的情况下才会进行自动保存
3. **错误处理**: 包含完整的错误处理机制，确保异常情况不会影响页面正常加载
4. **性能影响**: 自动保存操作在后台异步执行，不会阻塞页面加载

## 后续扩展

1. 可以考虑在其他需要建设期利息详情的页面也添加类似的自动检查和保存逻辑
2. 可以增加建设期利息详情的手动编辑功能，允许用户调整数据
3. 可以基于保存的建设期利息详情生成更详细的财务分析报表