# JSON 数据查看器功能测试指南

## 功能概述

在"项目投资现金流量配置"模块中添加了一个 JSON 数据查看器，用于查看"营业收入、营业税金及附加和增值税估算表"与"总成本费用估算表"的完整 JSON 数据。

## 功能特性

### 1. 图标按钮
- **位置**: 在"项目投资现金流量配置"标题右侧的操作栏中
- **图标**: 使用 `IconCode` 图标（蓝色）
- **功能**: 点击后打开 JSON 数据查看器模态框

### 2. JSON 数据查看器模态框

#### 工具栏功能
- **搜索框**: 实时搜索 JSON 数据中的关键字，匹配的内容会高亮显示
- **全部展开**: 展开所有 JSON 节点
- **全部折叠**: 折叠所有 JSON 节点（保留第一层）
- **复制按钮**: 一键复制当前标签页的 JSON 数据到剪贴板

#### 标签页
- **营业收入、营业税金及附加和增值税估算表**: 显示营业收入表的 JSON 数据
- **总成本费用估算表**: 显示总成本费用表的 JSON 数据

#### 数据展示
- **语法高亮**: 使用 VS Code 风格的颜色方案
  - 键名: 蓝色 (#9cdcfe)
  - 字符串值: 橙色 (#ce9178)
  - 数字值: 浅绿色 (#b5cea8)
  - 对象/数组符号: 蓝色 (#569cd6)
- **层级折叠**: 点击节点可展开/折叠
- **搜索高亮**: 匹配的文本用黄色背景高亮

### 3. 加载状态
- 按钮显示 loading 动画
- 模态框显示加载遮罩层
- 防止重复点击

### 4. 错误处理
- 显示错误提示信息
- 提供重试按钮
- 使用 Mantine notifications 显示错误通知

## 测试步骤

### 1. 基础功能测试

#### 测试 1.1: 打开 JSON 查看器
1. 进入"项目投资现金流量配置"模块
2. 点击标题右侧的蓝色代码图标按钮
3. 验证: 模态框正确打开

#### 测试 1.2: 查看数据
1. 在模态框中切换到"营业收入、营业税金及附加和增值税估算表"标签
2. 验证: 显示营业收入表的 JSON 数据
3. 切换到"总成本费用估算表"标签
4. 验证: 显示总成本费用表的 JSON 数据

### 2. 搜索功能测试

#### 测试 2.1: 搜索关键字
1. 在搜索框中输入"营业收入"
2. 验证: 匹配的内容用黄色背景高亮
3. 验证: 不匹配的内容保持原样

#### 测试 2.2: 清空搜索
1. 清空搜索框
2. 验证: 所有高亮消失，显示完整数据

### 3. 折叠/展开功能测试

#### 测试 3.1: 折叠节点
1. 点击任意 JSON 节点
2. 验证: 节点折叠，显示项目数量
3. 再次点击
4. 验证: 节点展开，显示完整内容

#### 测试 3.2: 全部展开
1. 点击"全部展开"按钮
2. 验证: 所有节点展开

#### 测试 3.3: 全部折叠
1. 点击"全部折叠"按钮
2. 验证: 所有节点折叠（保留第一层）

### 4. 复制功能测试

#### 测试 4.1: 复制数据
1. 切换到任意标签页
2. 点击复制按钮
3. 验证: 显示"复制成功"通知
4. 在其他应用中粘贴
5. 验证: 粘贴的内容是格式化的 JSON

#### 测试 4.2: 复制空数据
1. 如果某个标签页没有数据
2. 点击复制按钮
3. 验证: 显示"没有可复制的数据"错误

### 5. 加载状态测试

#### 测试 5.1: 加载动画
1. 点击 JSON 查看按钮
2. 验证: 按钮显示 loading 动画
3. 验证: 模态框显示加载遮罩层

#### 测试 5.2: 防止重复点击
1. 快速多次点击按钮
2. 验证: 只触发一次请求

### 6. 错误处理测试

#### 测试 6.1: 网络错误
1. 断开网络连接
2. 点击 JSON 查看按钮
3. 验证: 显示错误提示
4. 验证: 提供重试按钮

#### 测试 6.2: 无数据
1. 如果项目中没有表格数据
2. 点击 JSON 查看按钮
3. 验证: 显示"暂无数据"提示

### 7. 响应式测试

#### 测试 7.1: 不同屏幕尺寸
1. 在不同屏幕尺寸下打开模态框
2. 验证: 模态框正确适配
3. 验证: 内容可滚动

#### 测试 7.2: 大数据量
1. 如果 JSON 数据很大
2. 验证: 滚动流畅
3. 验证: 性能良好

## 数据结构

### 营业收入表数据结构
```typescript
{
  urbanTaxRate: number,    // 城市建设维护税税率
  rows: [
    {
      序号: string,
      收入项目: string,
      合计: number,
      运营期: number[]
    }
  ],
  updatedAt: string
}
```

### 总成本费用表数据结构
```typescript
{
  rows: [
    {
      序号: string,
      成本项目: string,
      合计: number,
      运营期: number[]
    }
  ],
  updatedAt: string
}
```

## 技术实现

### 前端组件
- **JsonDataViewer.tsx**: JSON 数据查看器组件
  - 支持语法高亮
  - 支持层级折叠
  - 支持关键字搜索
  - 支持一键复制
  - 加载状态和错误处理

- **FinancialIndicatorsTable.tsx**: 集成 JSON 查看按钮
  - 添加图标按钮
  - 实现数据获取逻辑
  - 状态管理

### API 接口
使用现有的 `revenueCostApi.getByProjectId()` 接口获取数据，无需新增后端接口。

### 数据获取逻辑
1. 优先从 Zustand store 获取数据（如果已加载）
2. 如果 store 中没有数据，则从后端 API 获取
3. 获取成功后显示数据
4. 获取失败后显示错误提示

## 已知问题和限制

1. **大数据量性能**: 对于非常大的 JSON 数据，可能需要进一步优化（如虚拟滚动）
2. **搜索性能**: 当前搜索是简单的字符串匹配，对于复杂查询可能不够强大
3. **编辑功能**: 当前只支持查看，不支持编辑 JSON 数据

## 后续优化建议

1. **导出功能**: 支持导出 JSON 为文件
2. **比较功能**: 支持比较不同版本的数据
3. **编辑功能**: 支持在线编辑 JSON 数据
4. **高级搜索**: 支持正则表达式和路径搜索
5. **主题切换**: 支持不同的颜色主题
6. **虚拟滚动**: 优化大数据量的渲染性能

## 测试检查清单

- [ ] 按钮正确显示在操作栏中
- [ ] 点击按钮能正确打开模态框
- [ ] 能正确加载和显示 JSON 数据
- [ ] 搜索功能正常工作
- [ ] 折叠/展开功能正常
- [ ] 复制功能正常
- [ ] 加载状态正确显示
- [ ] 错误处理正确
- [ ] 不同屏幕尺寸下显示正常
- [ ] 大数据量下性能良好