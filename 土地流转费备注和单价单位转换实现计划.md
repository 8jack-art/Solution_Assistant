# 土地流转费备注和单价单位转换实现计划

## 需求概述

根据用户需求，需要对土地流转费功能进行以下改进：

1. **备注格式化**：按照"项目流转10000亩土地，土地租赁单价按700元/亩·年估算。则运营期土地成本合计为11900.00万元。"的格式自动填充
2. **单价单位转换**：当土地租赁单价小于1万元时，采用元为单位（如0.75万元/亩·年写成"7500元/亩·年"）
3. **运营期土地成本合计计算**：确保计算公式为数量×单价×运营期数，单价始终以万元为单位，最终值保留2位小数

## 当前代码分析

### 1. 备注相关代码位置
- 文件：`client/src/components/revenue-cost/DynamicCostTable.tsx`
- 关键代码行：
  - 第317-318行：定义了`remark`字段
  - 第3783-3784行：`needsRemark`函数，检测费用名称是否需要备注
  - 第3807-3809行：自动填充默认模板文本
  - 第3935-3936行：`showRemarkField`变量，控制是否显示备注输入框
  - 第4155-4165行：备注输入框的渲染

### 2. 单价显示相关代码位置
- 文件：`client/src/components/revenue-cost/DynamicCostTable.tsx`
- 关键代码行：
  - 第4100-4106行：单价输入框，标签为"单价（万元/亩）"
  - 第4136-4138行：单价显示文本，格式为"万元/亩"

### 3. 运营期土地成本合计计算
- 文件：`client/src/components/revenue-cost/DynamicCostTable.tsx`
- 关键代码行：
  - 第3941-3942行：计算土地流转费金额（亩数 × 单价）
  - 第946-954行：`calculateOtherExpenses`函数中的土地流转费计算逻辑

## 实现方案

### 1. 土地流转费备注格式化功能

#### 1.1 创建格式化函数
```typescript
// 格式化土地流转费备注
const formatLandTransferRemark = (
  acreage: number,
  unitPrice: number,
  operationYears: number
): string => {
  // 计算运营期土地成本合计：数量×单价×运营期数
  const totalCost = acreage * unitPrice * operationYears;
  
  // 根据单价大小选择显示单位
  let displayPrice: string;
  if (unitPrice < 1) {
    // 小于1万元时，转换为元显示
    displayPrice = `${(unitPrice * 10000).toFixed(0)}元`;
  } else {
    // 大于等于1万元时，显示万元
    displayPrice = `${unitPrice.toFixed(2)}万元`;
  }
  
  return `项目流转${acreage.toLocaleString()}亩土地，土地租赁单价按${displayPrice}/亩·年估算。\n则运营期土地成本合计为${totalCost.toFixed(2)}万元。`;
};
```

#### 1.2 修改自动填充逻辑
在第3807-3809行和第3823-3825行，将默认模板文本替换为使用格式化函数

### 2. 土地流转费单价单位转换功能

#### 2.1 创建单位转换显示函数
```typescript
// 根据单价大小返回合适的显示单位
const getUnitPriceDisplay = (unitPrice: number): { value: string; unit: string } => {
  if (unitPrice < 1) {
    // 小于1万元时，转换为元显示
    return {
      value: (unitPrice * 10000).toFixed(0),
      unit: '元'
    };
  } else {
    // 大于等于1万元时，显示万元
    return {
      value: unitPrice.toFixed(2),
      unit: '万元'
    };
  }
};
```

#### 2.2 修改单价显示逻辑
在第4100-4106行和第4136-4138行，使用单位转换函数

### 3. 运营期土地成本合计计算优化

#### 3.1 创建计算函数
```typescript
// 计算运营期土地成本合计
const calculateLandTransferTotalCost = (
  acreage: number,
  unitPrice: number,
  operationYears: number
): number => {
  // 运营期土地成本合计 = 数量 × 单价 × 运营期数
  // 单价始终以万元为单位进行计算
  const totalCost = acreage * unitPrice * operationYears;
  
  // 保留2位小数
  return Number(totalCost.toFixed(2));
};
```

#### 3.2 修改相关计算逻辑
在所有涉及土地流转费计算的地方，确保使用新的计算函数

## 实现步骤

1. **创建格式化和转换函数**
   - 添加`formatLandTransferRemark`函数
   - 添加`getUnitPriceDisplay`函数
   - 添加`calculateLandTransferTotalCost`函数

2. **修改备注自动填充逻辑**
   - 更新第3807-3809行的代码
   - 更新第3823-3825行的代码

3. **修改单价显示逻辑**
   - 更新第4100行的单价输入框标签
   - 更新第4136-4138行的单价显示文本

4. **测试功能**
   - 测试单价小于1万元时的显示是否正确
   - 测试单价大于等于1万元时的显示是否正确
   - 测试备注格式化是否正确
   - 测试运营期土地成本合计计算是否正确

## 注意事项

1. **遵循编程规范**
   - 所有计算逻辑必须在JSX渲染前完成
   - 使用`useMemo`缓存复杂计算结果
   - 避免在JSX中直接执行算术运算

2. **数据一致性**
   - 确保所有地方使用相同的计算逻辑
   - 确保单位转换在所有相关地方一致

3. **用户体验**
   - 确保界面显示清晰易懂
   - 确保计算结果准确无误
