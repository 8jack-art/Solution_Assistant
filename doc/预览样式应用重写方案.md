# 预览样式应用重写方案

## 问题分析

当前预览样式设置与富文本预览区不对应，主要问题包括：

1. **行间距处理不一致**：
   - 没有正确处理 'fixed' 类型的行间距
   - 标题和段落的行间距应用方式不统一

2. **段落缩进计算不准确**：
   - 使用简单的像素值计算，没有考虑字体大小影响
   - 缩进值在不同字号下不一致

3. **样式配置结构混乱**：
   - 多套样式配置结构并存
   - 样式应用优先级不明确

4. **HTML 表格和图表样式未应用配置**：
   - 表格和图表样式硬编码，未使用配置中的样式

## 新架构设计

### 1. 样式计算工具函数

创建统一的样式计算工具函数，处理：
- 行间距计算（支持倍数和固定值）
- 段落缩进计算（基于字符宽度的相对计算）
- 字体大小和行高的关联计算

### 2. 样式应用组件

重写 MarkdownRenderer 组件，确保：
- 所有样式配置正确应用到预览区
- 支持动态样式更新
- 性能优化，避免不必要的重新渲染

### 3. 样式配置统一

统一样式配置结构，明确优先级：
- 优先使用 heading1/2/3 和 body 的独立样式
- 向后兼容 fonts、fontSizes、paragraph 等旧配置

## 实施计划

1. 创建样式计算工具函数
2. 重写 MarkdownRenderer 组件
3. 修复表格和图表样式应用
4. 测试所有样式配置的正确性
5. 性能优化

## 关键技术点

1. **行间距处理**：
   ```typescript
   // 支持倍数行距和固定行距
   const getLineHeight = (lineSpacing: number | 'fixed', fontSize: number, fixedValue?: number) => {
     if (lineSpacing === 'fixed' && fixedValue) {
       return `${fixedValue}px`
     }
     return lineSpacing
   }
   ```

2. **段落缩进计算**：
   ```typescript
   // 基于字符宽度的相对计算
   const getTextIndent = (indentChars: number, fontSize: number) => {
     // 中文字符宽度约等于字体大小
     return `${indentChars * fontSize}px`
   }
   ```

3. **样式缓存**：
   ```typescript
   // 使用 useMemo 缓存计算结果
   const computedStyles = useMemo(() => {
     return computeStyles(config)
   }, [config])
   ```

## 预期效果

重写后，预览区将能够：
- 正确应用所有样式设置
- 支持动态样式更新
- 保持良好的性能
- 提供一致的视觉体验