# 财务静态动态指标数据渲染异常修复计划

## 问题描述

点击指标卡片上的小眼睛图标展开JSON数据时，`{{DATA:financial_static_dynamic}}` 变量显示为0或空值。需要用户额外执行两步操作（打开"设置基准收益率"弹窗modal，然后点击"确定"按钮关闭弹窗），之后再次点击小眼睛图标才能正确显示JSON数据。

## 问题分析

### 数据流分析

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              数据流图                                                │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  localStorage                                    后端API                              │
│  ┌────────────────────┐                         ┌────────────────────────────────┐  │
│  │ financialIndicators│  ────query params──────▶│  getProjectSummary             │  │
│  │ _preTaxRate        │     preTaxRate           │  1. 从query接收参数            │  │
│  │ _postTaxRate       │     postTaxRate          │  2. collectProjectData         │  │
│  └────────────────────┘                         │  3. 注入到revenueCost          │  │
│                                                  │  4. buildAllTableDataJSON      │  │
│  前端                                            │  5. 返回tableDataJSON          │  │
│  ┌────────────────────┐                         └────────────────────────────────┘  │
│  │ FinancialIndicators│                          │  │                             │
│  │ Table.tsx          │  ◀── availableVariables──┘  │                             │
│  │ preTaxRate         │          cached            │                             │
│  │ postTaxRate        │                          │                             │
│  └────────────────────┘                          │                             │
│                                                  │                             │
│  ┌────────────────────┐                         │                             │
│  │ VariablePicker.tsx │  ◀── handleViewJson ────┘                             │
│  │ 小眼睛图标         │        读取variable.value                              │
│  └────────────────────┘                                                       │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 问题根源

1. **基准收益率参数传递问题**
   - `reportStore.ts` 的 `loadProjectData` 方法从 localStorage 读取基准收益率
   - 但在调用 `reportApi.getProjectSummary` 时，如果 localStorage 中没有存储值，传递的参数可能是 `undefined`
   - 后端 `getProjectSummary` API 只在 `preTaxRate !== undefined || postTaxRate !== undefined` 时才注入数据

2. **缓存问题**
   - `cachedTableDataJSON` 按项目ID隔离存储
   - 首次加载时，如果基准收益率没有正确传递，返回的 `financial_static_dynamic` 数据为空

3. **后端数据注入逻辑**
   ```typescript
   // reportController.ts 第881-895行
   if (preTaxRate !== undefined || postTaxRate !== undefined) {
     if (!projectData.revenueCost) {
       projectData.revenueCost = {}
     }
     if (!projectData.revenueCost.financialIndicators) {
       projectData.revenueCost.financialIndicators = {}
     }
     if (preTaxRate !== undefined) {
       projectData.revenueCost.financialIndicators.preTaxRate = preTaxRate
     }
     if (postTaxRate !== undefined) {
       projectData.revenueCost.financialIndicators.postTaxRate = postTaxRate
     }
   }
   ```

4. **前端读取逻辑问题**
   ```typescript
   // reportStore.ts 第577-584行
   const preTaxRateStr = localStorage.getItem(`financialIndicatorsPreTaxRate_${projectId}`)
   const postTaxRateStr = localStorage.getItem(`financialIndicatorsPostTaxRate_${projectId}`)
   
   const discountRates = {
     preTaxRate: preTaxRateStr ? parseFloat(preTaxRateStr) : undefined,
     postTaxRate: postTaxRateStr ? parseFloat(postTaxRateStr) : undefined
   }
   ```

5. **JSON构建函数逻辑**
   ```typescript
   // buildFinancialStaticDynamic.ts 第33-43行
   const preTaxRate = Number(financialIndicators.preTaxRate || 
                             financialIndicators.preTaxRateInput || 
                             financialIndicators.基准收益率所得税前 ||
                             revenueCost.preTaxRate ||
                             0)  // 默认值
   ```

### 触发条件对比

| 操作 | 当前行为 | 预期行为 |
|------|----------|----------|
| 首次点击小眼睛 | 显示0或空值 | 显示正确的基准收益率数据 |
| 打开设置弹窗并确定 | 重新加载数据 | 数据正确显示 |

## 修复方案

### 方案一：确保基准收益率始终有默认值

**修改文件**：`reportStore.ts` 的 `loadProjectData` 方法

```typescript
// 修改前
const discountRates = {
  preTaxRate: preTaxRateStr ? parseFloat(preTaxRateStr) : undefined,
  postTaxRate: postTaxRateStr ? parseFloat(postTaxRateStr) : undefined
}

// 修改后 - 使用默认值6%
const discountRates = {
  preTaxRate: preTaxRateStr ? parseFloat(preTaxRateStr) : 6,
  postTaxRate: postTaxRateStr ? parseFloat(postTaxRateStr) : 6
}
```

### 方案二：增强后端API的默认值处理

**修改文件**：`reportController.ts` 的 `getProjectSummary` 方法

```typescript
// 修改前
const preTaxRate = req.query.preTaxRate ? parseFloat(req.query.preTaxRate as string) : undefined
const postTaxRate = req.query.postTaxRate ? parseFloat(req.query.postTaxRate as string) : undefined

// 修改后 - 使用默认值6%
const preTaxRate = req.query.preTaxRate ? parseFloat(req.query.preTaxRate as string) : 6
const postTaxRate = req.query.postTaxRate ? parseFloat(req.query.postTaxRate as string) : 6
```

### 方案三：优化JSON构建函数的兜底逻辑

**修改文件**：`buildFinancialStaticDynamic.ts`

```typescript
// 修改前 - 只检查一个路径
const preTaxRate = Number(financialIndicators.preTaxRate || revenueCost.preTaxRate || 0)

// 修改后 - 检查多个可能的路径，并添加默认值
const preTaxRate = Number(
  financialIndicators?.preTaxRate ??
  financialIndicators?.preTaxRateInput ??
  financialIndicators?.基准收益率所得税前 ??
  revenueCost?.preTaxRate ??
  6  // 默认值
)
```

### 方案四：添加数据重新加载机制

**修改文件**：`reportStore.ts`

当用户修改基准收益率后，需要触发 `loadProjectData` 重新加载数据，并更新 `cachedTableDataJSON`。

## 实施步骤

### 步骤1：修改前端 reportStore.ts

**文件**：`client/src/stores/reportStore.ts`

**修改内容**：
1. 在 `loadProjectData` 方法中，确保基准收益率参数有默认值
2. 添加 `reloadProjectData` 方法，支持强制重新加载

```typescript
loadProjectData: async () => {
  // ... 现有代码 ...
  
  // 确保基准收益率有默认值
  const discountRates = {
    preTaxRate: preTaxRateStr ? parseFloat(preTaxRateStr) : 6,
    postTaxRate: postTaxRateStr ? parseFloat(postTaxRateStr) : 6
  }
  
  // ... 其余代码 ...
}

// 新增方法：强制重新加载项目数据
reloadProjectData: async () => {
  const { projectId } = get()
  if (!projectId) return
  
  // 清除当前项目的缓存
  set((state) => ({
    cachedTableDataJSON: {
      ...state.cachedTableDataJSON,
      [projectId]: {}  // 清空缓存，触发重新获取
    }
  }))
  
  // 重新加载数据
  await get().loadProjectData()
}
```

### 步骤2：修改后端 reportController.ts

**文件**：`server/src/controllers/reportController.ts`

**修改内容**：
1. 确保基准收益率参数有默认值6%

```typescript
// 修改前
const preTaxRate = req.query.preTaxRate ? parseFloat(req.query.preTaxRate as string) : undefined
const postTaxRate = req.query.postTaxRate ? parseFloat(req.query.postTaxRate as string) : undefined

// 修改后 - 使用默认值6%
const preTaxRate = req.query.preTaxRate ? parseFloat(req.query.preTaxRate as string) : 6
const postTaxRate = req.query.postTaxRate ? parseFloat(req.query.postTaxRate as string) : 6
```

### 步骤3：修改 buildFinancialStaticDynamic.ts

**文件**：`server/src/utils/tableDataBuilders/buildFinancialStaticDynamic.ts`

**修改内容**：
1. 使用可选链操作符避免空值错误
2. 明确设置默认值为6%

```typescript
// 修改后
const preTaxRate = Number(
  financialIndicators?.preTaxRate ??
  financialIndicators?.preTaxRateInput ??
  financialIndicators?.基准收益率所得税前 ??
  revenueCost?.preTaxRate ??
  6  // 默认值
)

const postTaxRate = Number(
  financialIndicators?.postTaxRate ??
  financialIndicators?.postTaxRateInput ??
  financialIndicators?.基准收益率所得税后 ??
  revenueCost?.postTaxRate ??
  6  // 默认值
)
```

### 步骤4：修改 FinancialIndicatorsTable.tsx

**文件**：`client/src/components/revenue-cost/FinancialIndicatorsTable.tsx`

**修改内容**：
1. 在保存基准收益率设置后，调用 `reloadProjectData` 重新加载数据

```typescript
// 在设置弹窗的确定按钮点击处理中
const handleSaveSettings = () => {
  // 保存设置
  setPreTaxRate(tempPreTaxRate)
  setPostTaxRate(tempPostTaxRate)
  localStorage.setItem(`financialIndicatorsPreTaxRate_${projectId}`, tempPreTaxRate.toString())
  localStorage.setItem(`financialIndicatorsPostTaxRate_${projectId}`, tempPostTaxRate.toString())
  
  // 重新加载项目数据
  const { reloadProjectData } = useReportStore.getState()
  reloadProjectData()
  
  setShowFinancialIndicatorsSettings(false)
}
```

## 验证方案

### 测试用例

| 用例 | 操作 | 预期结果 |
|------|------|----------|
| 首次加载 | 打开页面，直接点击财务静态动态指标的小眼睛 | 显示基准收益率数据（所得税前: 6%, 所得税后: 6%）|
| 修改设置 | 打开设置弹窗，修改基准收益率为8%，点击确定 | 数据正确更新，再次点击小眼睛显示新值8% |
| 刷新页面 | 刷新页面后点击小眼睛 | 数据保持一致 |
| 多项目 | 在多个项目间切换 | 每个项目的基准收益率独立存储 |

## 风险评估

| 风险 | 等级 | 缓解措施 |
|------|------|----------|
| 默认值覆盖用户设置 | 低 | 默认值只在参数未传递时使用，用户设置优先 |
| 缓存导致数据不更新 | 中 | 修改设置后清除相关缓存 |
| 后端API改动影响其他调用 | 低 | 只修改默认值逻辑，不改变API接口 |

## 总结

本次修复的核心问题是：
1. **基准收益率参数传递不完整**：首次加载时可能没有传递参数
2. **默认值缺失**：后端和JSON构建函数没有设置合理的默认值
3. **缓存机制问题**：修改设置后缓存没有及时更新

通过上述修改，可以确保：
- 首次加载时就能正确显示基准收益率数据
- 修改设置后数据能够及时更新
- 用户体验更加流畅，无需额外操作就能看到正确数据
