# investmentReturns 数据修复测试计划

## 测试目标
验证 `{{DATA:financial_indicators}}` 部分的 `investmentReturns` 数据能够正确获取和显示。

## 测试环境
- 前端环境：开发环境（localhost:5173）
- 后端环境：开发环境（localhost:3001）
- 浏览器：Chrome/Firefox 最新版本
- 测试项目：需要包含完整的项目数据（收入、成本、现金流等）

## 测试前置条件
1. 项目已启动并正常运行
2. 数据库中存在测试项目数据
3. 项目包含完整的收入和成本数据
4. 项目包含现金流表数据

## 测试用例

### 测试用例 1：财务指标数据保存功能
**测试目的**：验证财务指标数据能够正确保存到数据库

**测试步骤**：
1. 登录系统
2. 打开"收入成本模型"页面
3. 点击"财务计算指标表"按钮，打开财务指标弹窗
4. 等待财务指标计算完成（查看控制台是否有计算日志）
5. 关闭财务指标弹窗
6. 刷新页面
7. 再次打开"财务计算指标表"弹窗
8. 检查财务指标数据是否与之前一致

**预期结果**：
- 财务指标数据在刷新后仍然保持一致
- 所有指标值（IRR、NPV、投资回收期）都正确显示
- 数据库中的 `financialIndicators` 字段包含正确的 JSON 数据

**验证方法**：
```sql
SELECT financial_indicators FROM revenue_cost_models WHERE project_id = '测试项目ID';
```

### 测试用例 2：财务指标数据加载功能
**测试目的**：验证财务指标数据能够从数据库正确加载

**测试步骤**：
1. 打开浏览器开发者工具（F12）
2. 切换到 Network 标签页
3. 刷新"收入成本模型"页面
4. 查找 `/api/projects/:id/revenue-cost` 请求
5. 检查响应数据中的 `financialIndicators` 字段
6. 打开财务指标弹窗
7. 验证显示的数据是否与 API 返回的数据一致

**预期结果**：
- API 响应中包含 `financialIndicators` 字段
- `financialIndicators` 包含完整的财务指标数据
- 财务指标弹窗显示的数据与 API 返回的数据一致

### 测试用例 3：报告生成功能 - investmentReturns 数据
**测试目的**：验证报告生成时 `investmentReturns` 数据正确

**测试步骤**：
1. 打开"报告生成"页面
2. 选择包含财务指标数据的模板
3. 点击"生成报告"按钮
4. 打开浏览器开发者工具（F12）
5. 切换到 Console 标签页
6. 查找包含 `financial_indicators` 的日志输出
7. 检查 `investmentReturns` 对象中的所有值
8. 检查生成的报告内容

**预期结果**：
- 控制台输出的 `financial_indicators` JSON 数据中，`investmentReturns` 的所有字段值都不为 0
- `investmentReturns` 包含以下字段且值正确：
  - `firrBeforeTax`（税前财务内部收益率）
  - `firrAfterTax`（税后财务内部收益率）
  - `npvBeforeTax`（税前财务净现值）
  - `npvAfterTax`（税后财务净现值）
  - `paybackPeriodBeforeTax`（税前动态投资回收期）
  - `paybackPeriodAfterTax`（税后动态投资回收期）
- 生成的报告中财务指标部分显示正确的数据

### 测试用例 4：字段名称映射验证
**测试目的**：验证字段名称映射是否正确

**测试步骤**：
1. 打开 `client/src/utils/tableResourceBuilder.ts` 文件
2. 查找 `buildFinancialIndicatorsJSON` 函数
3. 确认 `investmentReturns` 中的字段映射：
   - `firrBeforeTax` 映射到 `indicators.preTaxIRR`
   - `firrAfterTax` 映射到 `indicators.postTaxIRR`
   - `npvBeforeTax` 映射到 `indicators.preTaxNPV`
   - `npvAfterTax` 映射到 `indicators.postTaxNPV`
   - `paybackPeriodBeforeTax` 映射到 `indicators.preTaxDynamicPaybackPeriod`
   - `paybackPeriodAfterTax` 映射到 `indicators.postTaxDynamicPaybackPeriod`

**预期结果**：
- 所有字段映射都使用正确的字段名称
- 没有使用旧的字段名称（如 `irrBeforeTax`、`npvBeforeTax` 等）

### 测试用例 5：财务指标计算准确性
**测试目的**：验证财务指标计算结果的准确性

**测试步骤**：
1. 准备测试数据：
   - 现金流入：每年 1000 万元
   - 现金流出：每年 800 万元
   - 建设期投资：5000 万元
   - 运营期：10 年
   - 折现率：6%
2. 使用财务计算器或 Excel 计算期望的财务指标值
3. 在系统中输入相同的测试数据
4. 打开财务指标弹窗
5. 对比系统计算的结果与期望值

**预期结果**：
- 系统计算的 IRR 值与期望值误差在 ±0.1% 以内
- 系统计算的 NPV 值与期望值误差在 ±1 万元以内
- 系统计算的投资回收期与期望值误差在 ±0.1 年以内

### 测试用例 6：边界条件测试
**测试目的**：验证财务指标在边界条件下的处理

**测试步骤**：
1. 测试场景 1：所有现金流为 0
2. 测试场景 2：只有建设期投资，没有运营期收益
3. 测试场景 3：运营期收益刚好等于建设期投资
4. 测试场景 4：运营期收益远大于建设期投资

**预期结果**：
- 所有场景下，财务指标都能正常计算
- 不会出现 NaN 或 Infinity 等异常值
- 系统对异常情况有合理的默认值处理

### 测试用例 7：数据持久化测试
**测试目的**：验证财务指标数据在数据库中的持久化

**测试步骤**：
1. 打开财务指标弹窗，记录当前的财务指标值
2. 修改项目的收入或成本数据
3. 重新计算财务指标
4. 刷新页面
5. 再次打开财务指标弹窗
6. 验证数据是否为最新计算的值

**预期结果**：
- 财务指标数据能够正确更新
- 刷新后数据保持最新计算的值
- 数据库中存储的是最新的财务指标数据

### 测试用例 8：多项目测试
**测试目的**：验证财务指标功能在不同项目中的正确性

**测试步骤**：
1. 创建多个不同的测试项目
2. 为每个项目输入不同的收入和成本数据
3. 计算每个项目的财务指标
4. 切换不同项目，验证财务指标数据是否正确
5. 为每个项目生成报告，验证 `investmentReturns` 数据

**预期结果**：
- 每个项目的财务指标数据独立存储
- 切换项目时，财务指标数据正确加载
- 每个项目的报告都包含正确的财务指标数据

## 测试报告模板

### 测试执行记录
| 测试用例 | 执行日期 | 执行人 | 测试结果 | 备注 |
|---------|---------|--------|---------|------|
| 测试用例 1：财务指标数据保存功能 | | | ☐ 通过 ☐ 失败 | |
| 测试用例 2：财务指标数据加载功能 | | | ☐ 通过 ☐ 失败 | |
| 测试用例 3：报告生成功能 | | | ☐ 通过 ☐ 失败 | |
| 测试用例 4：字段名称映射验证 | | | ☐ 通过 ☐ 失败 | |
| 测试用例 5：财务指标计算准确性 | | | ☐ 通过 ☐ 失败 | |
| 测试用例 6：边界条件测试 | | | ☐ 通过 ☐ 失败 | |
| 测试用例 7：数据持久化测试 | | | ☐ 通过 ☐ 失败 | |
| 测试用例 8：多项目测试 | | | ☐ 通过 ☐ 失败 | |

### 缺陷记录
| 缺陷编号 | 缺陷描述 | 严重程度 | 状态 | 备注 |
|---------|---------|---------|------|------|
| BUG-001 | | ☐ 严重 ☐ 一般 ☐ 轻微 | ☐ 待修复 ☐ 已修复 | |
| BUG-002 | | ☐ 严重 ☐ 一般 ☐ 轻微 | ☐ 待修复 ☐ 已修复 | |

## 回归测试清单
修复完成后，需要执行以下回归测试：

1. ✅ 收入成本模型页面正常显示
2. ✅ 财务指标弹窗能够正常打开
3. ✅ 财务指标能够正常计算
4. ✅ 财务指标数据能够正常保存
5. ✅ 财务指标数据能够正常加载
6. ✅ 报告生成功能正常
7. ✅ 报告中财务指标数据正确显示
8. ✅ 其他表格功能不受影响

## 验收标准
修复通过的标准：
- 所有测试用例通过
- 报告中 `{{DATA:financial_indicators}}` 部分的 `investmentReturns` 数据全部正确
- 没有引入新的缺陷
- 所有回归测试通过
