# 样式计算工具函数设计

## 文件位置
`client/src/utils/styleCalculator.ts`

## 功能概述
统一处理行间距、段落缩进等样式计算，确保样式配置能够正确应用到预览区。

## 主要函数

### 1. calculateLineHeight
计算行高，支持倍数行距和固定行距。

```typescript
export const calculateLineHeight = (
  lineSpacing: number | 'fixed',
  fontSize: number,
  lineSpacingValue?: number
): string => {
  if (lineSpacing === 'fixed' && lineSpacingValue) {
    // 固定行距，直接使用像素值
    return `${lineSpacingValue}px`
  }
  // 倍数行距，返回数字（CSS会自动计算）
  return lineSpacing.toString()
}
```

### 2. calculateTextIndent
计算段落缩进，基于字符宽度的相对计算。

```typescript
export const calculateTextIndent = (
  indentChars: number,
  fontSize: number
): string => {
  if (indentChars <= 0) {
    return '0'
  }
  // 中文字符宽度约等于字体大小，使用相对计算
  // 对于中文文档，1个字符缩进 ≈ 1em（当前字体大小）
  return `${indentChars}em`
}
```

### 3. calculateParagraphSpacing
计算段落间距。

```typescript
export const calculateParagraphSpacing = (
  spacingValue: number,
  fontSize: number,
  lineHeight: number | string
): string => {
  if (spacingValue <= 0) {
    return '0'
  }
  
  // 计算单行高度
  const singleLineHeight = typeof lineHeight === 'number' 
    ? fontSize * lineHeight 
    : parseFloat(lineHeight) * fontSize
  
  // 段落间距 = 间距行数 × 单行高度
  return `${spacingValue * singleLineHeight}px`
}
```

### 4. calculateParagraphStyle
计算完整的段落样式。

```typescript
export const calculateParagraphStyle = (
  style: ParagraphStyle,
  baseFontSize: number = 12
): React.CSSProperties => {
  const {
    font,
    fontSize,
    bold,
    lineSpacing,
    lineSpacingValue,
    spaceBefore,
    spaceAfter,
    firstLineIndent
  } = style

  const lineHeight = calculateLineHeight(
    lineSpacing,
    fontSize,
    lineSpacingValue
  )

  const textIndent = calculateTextIndent(firstLineIndent, fontSize)
  
  const marginTop = calculateParagraphSpacing(spaceBefore, fontSize, lineHeight)
  const marginBottom = calculateParagraphSpacing(spaceAfter, fontSize, lineHeight)

  return {
    fontFamily: font,
    fontSize: `${fontSize}px`,
    fontWeight: bold ? 'bold' : 'normal',
    lineHeight,
    textIndent,
    marginTop,
    marginBottom
  }
}
```

### 5. getComputedParagraphStyle
从样式配置中提取并计算段落样式，支持新旧配置结构。

```typescript
export const getComputedParagraphStyle = (
  config: ReportStyleConfig,
  type: 'heading1' | 'heading2' | 'heading3' | 'body'
): React.CSSProperties => {
  // 优先使用独立样式配置
  const paragraphStyle = config[type]
  if (paragraphStyle) {
    return calculateParagraphStyle(paragraphStyle)
  }

  // 向后兼容：使用旧配置
  const fallbackStyle: ParagraphStyle = {
    font: config.fonts?.body || '宋体',
    fontSize: config.fontSizes?.body || 12,
    bold: false,
    lineSpacing: config.paragraph?.lineSpacing || 1.5,
    lineSpacingValue: config.paragraph?.lineSpacingValue,
    spaceBefore: config.paragraph?.spaceBefore || 0,
    spaceAfter: config.paragraph?.spaceAfter || 0,
    firstLineIndent: config.paragraph?.firstLineIndent || 2
  }

  // 标题样式特殊处理
  if (type === 'heading1') {
    fallbackStyle.font = config.fonts?.heading || '黑体'
    fallbackStyle.fontSize = config.fontSizes?.title || 22
    fallbackStyle.bold = true
    fallbackStyle.firstLineIndent = config.paragraph?.headingIndent || 0
  } else if (type === 'heading2') {
    fallbackStyle.font = config.fonts?.heading || '黑体'
    fallbackStyle.fontSize = 16
    fallbackStyle.bold = true
    fallbackStyle.firstLineIndent = config.paragraph?.headingIndent || 0
  } else if (type === 'heading3') {
    fallbackStyle.font = config.fonts?.heading || '黑体'
    fallbackStyle.fontSize = 15
    fallbackStyle.bold = true
    fallbackStyle.firstLineIndent = config.paragraph?.headingIndent || 0
  }

  return calculateParagraphStyle(fallbackStyle)
}
```

### 6. getTableStyles
计算表格样式。

```typescript
export const getTableStyles = (config: ReportStyleConfig) => {
  const {
    fonts,
    fontSizes,
    table
  } = config

  return {
    table: {
      borderCollapse: 'collapse' as const,
      width: '100%',
      margin: '8px 0',
      fontSize: `${fontSizes?.tableBody || 12}px`,
      fontFamily: fonts?.body || '宋体'
    },
    header: {
      backgroundColor: table?.headerBg ? `#${table.headerBg}` : '#EEEEEE',
      fontWeight: 'bold' as const,
      textAlign: 'center' as const,
      padding: '8px',
      border: '1px solid #000',
      fontFamily: fonts?.body || '宋体',
      fontSize: `${fontSizes?.tableHeader || 12}px`
    },
    cell: {
      padding: '8px',
      border: '1px solid #000',
      textAlign: table?.alignment || 'left' as const,
      fontFamily: fonts?.body || '宋体',
      fontSize: `${fontSizes?.tableBody || 12}px`
    },
    title: {
      fontWeight: 'bold' as const,
      fontFamily: fonts?.body || '宋体',
      fontSize: `${fontSizes?.tableTitle || 18}px`,
      marginBottom: '8px',
      marginTop: '16px'
    }
  }
}
```

### 7. createStyleCacheKey
创建样式缓存键，用于性能优化。

```typescript
export const createStyleCacheKey = (config: ReportStyleConfig): string => {
  return JSON.stringify({
    fonts: config.fonts,
    fontSizes: config.fontSizes,
    paragraph: config.paragraph,
    heading1: config.heading1,
    heading2: config.heading2,
    heading3: config.heading3,
    body: config.body,
    table: config.table
  })
}
```

## 使用示例

```typescript
import { getComputedParagraphStyle, getTableStyles } from '../utils/styleCalculator'

// 在组件中使用
const heading1Style = getComputedParagraphStyle(config, 'heading1')
const bodyStyle = getComputedParagraphStyle(config, 'body')
const tableStyles = getTableStyles(config)
```

## 优势

1. **统一计算逻辑**：所有样式计算集中在一个文件中，便于维护
2. **支持新旧配置**：自动兼容新旧配置结构，平滑过渡
3. **精确计算**：使用相对单位（em）确保缩进在不同字号下一致
4. **性能优化**：提供缓存键，支持样式计算结果缓存
5. **类型安全**：完整的 TypeScript 类型定义