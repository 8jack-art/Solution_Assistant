# 利润税金表格实现计划

## 任务概述
在收入及成本预测中的利润税金中新建一个表格，表格格式模仿"营业成本估算表"，不需要有数据，是一个空表。表格列中增加建设的列，如建设期2年，就增加建设期2列，3年就增加3列。

## 表格结构设计

### 表头设计
- 序号
- 项目
- 合计
- 建设期（根据项目实际建设年数动态显示，如建设期1、建设期2等）
- 运营期（根据项目实际运营年数动态显示，如运营期1、运营期2等）

### 表格行设计
1. 现金流入
   1.1 营业收入
   1.2 补贴收入
   1.3 回收固定资产余值
   1.4 回收流动资金
2. 现金流出
   2.1 建设投资
   2.2 流动资金
   2.3 经营成本
   2.4 增值税、房产税等及附加
   2.5 维持运营投资
3. 所得税前净现金流量（1-2）
4. 累计所得税前净现金流量
5. 调整所得税
6. 所得税后净现金流量
7. 累计所得税后净现金流量

## 组件设计

### 文件结构
```
client/src/components/revenue-cost/ProfitTaxTable.tsx
```

### 组件接口
```typescript
interface ProfitTaxTableProps {
  repaymentTableData?: Array<{
    序号: string
    项目: string
    合计: number | null
    分年数据: number[]
  }>
  depreciationData?: Array<{
    序号: string
    资产类别: string
    原值: number
    年折旧摊销额: number
    分年数据: number[]
  }>
}
```

### 数据计算逻辑

#### 1. 现金流入计算
- **营业收入**: 从收入项中计算，应用达产率和涨价规则
- **补贴收入**: 目前为0，后续可扩展
- **回收固定资产余值**: 只在运营期最后一年计算，公式：建安费原值 × 残值率 + 设备原值 × 残值率
- **回收流动资金**: 只在运营期最后一年计算，目前为0，后续可扩展

#### 2. 现金流出计算
- **建设投资**: 只在建设期有数据，从投资估算数据中获取
- **流动资金**: 通常在运营期第1年投入，目前为0，后续可扩展
- **经营成本**: 从成本配置中计算，包括：
  - 外购原材料费（除税）
  - 外购燃料及动力费（除税）
  - 工资及福利费
  - 修理费
  - 其他费用
- **增值税、房产税等及附加**: 根据实际税率计算，目前为0，后续可扩展
- **维持运营投资**: 目前为0，后续可扩展

#### 3. 净现金流量计算
- **所得税前净现金流量**: 现金流入 - 现金流出
- **累计所得税前净现金流量**: 逐年累加所得税前净现金流量
- **调整所得税**: 根据实际税率计算，目前为0，后续可扩展
- **所得税后净现金流量**: 所得税前净现金流量 - 调整所得税
- **累计所得税后净现金流量**: 逐年累加所得税后净现金流量

## 实现步骤

### 1. 创建基础组件结构
- 创建 `ProfitTaxTable.tsx` 文件
- 实现基本的表格结构和样式
- 添加导出Excel功能

### 2. 实现建设期列逻辑
- 根据项目上下文中的建设年数动态生成建设期列
- 确保建设期数据只在建设期显示

### 3. 实现数据计算逻辑
- 实现各项数据的计算函数
- 确保数据在正确的年份列中显示
- 处理建设期和运营期的不同逻辑

### 4. 集成到主页面
- 在 `RevenueCostModeling.tsx` 中导入并使用 `ProfitTaxTable` 组件
- 替换当前的"功能开发中"占位符

### 5. 测试和优化
- 测试不同建设期和运营期配置下的表格显示
- 确保数据计算正确性
- 优化用户体验

## 技术要点

### 1. 动态列生成
```typescript
// 根据项目上下文动态生成表头
const years = Array.from({ length: totalYears }, (_, i) => i + 1);
const constructionYears = context.constructionYears;
const operationYears = context.operationYears;
```

### 2. 数据格式化
```typescript
// 格式化数字显示为2位小数，不四舍五入，无千分号
const formatNumberNoRounding = (value: number): string => {
  const isNegative = value < 0;
  const absValue = Math.abs(value);
  const truncated = Math.trunc(absValue * 100) / 100;
  // ... 格式化逻辑
}
```

### 3. Excel导出
```typescript
// 使用XLSX库导出表格数据
const handleExportProfitTaxTable = () => {
  // 准备Excel数据
  const excelData: any[] = [];
  // ... 数据准备逻辑
  
  // 创建工作簿和工作表
  const ws = XLSX.utils.json_to_sheet(excelData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, '利润税金表');
  
  // 导出文件
  XLSX.writeFile(wb, `利润税金表_${context.projectName || '项目'}.xlsx`);
}
```

## 后续扩展点

1. **数据来源扩展**
   - 从投资估算数据中获取建设投资和流动资金数据
   - 从税务配置中获取增值税、房产税等税率
   - 从投资配置中获取维持运营投资数据

2. **交互功能扩展**
   - 添加数据编辑功能
   - 添加数据验证功能
   - 添加图表可视化功能

3. **性能优化**
   - 使用 useMemo 优化复杂计算
   - 实现数据缓存机制
   - 添加加载状态指示

## 注意事项

1. 确保表格在不同屏幕尺寸下都能正常显示
2. 处理空数据情况，避免显示错误
3. 确保数据计算精度，避免浮点数精度问题
4. 添加适当的错误处理和用户提示
5. 保持与其他表格组件的一致性