# 预览样式应用重写总结

## 项目背景

用户反馈预览样式设置与富文本预览区不对应，特别是行间距和段落缩进设置没有正确应用到预览区。需要重写预览样式设置应用到预览区的代码。

## 问题分析

通过分析代码，发现了以下主要问题：

1. **行间距处理不一致**：
   - 没有正确处理 'fixed' 类型的行间距
   - 标题和段落的行间距应用方式不统一

2. **段落缩进计算不准确**：
   - 使用简单的像素值计算 `textIndent: (config.body?.firstLineIndent || 2) * 12`
   - 没有考虑字体大小对缩进的影响
   - 缩进值在不同字号下不一致

3. **样式配置结构混乱**：
   - 存在多套样式配置结构（fonts、fontSizes、paragraph、heading1/2/3、body）
   - 样式应用时优先级不明确

4. **HTML 表格和图表样式未应用配置**：
   - 表格和图表样式硬编码，未使用配置中的样式

## 解决方案

### 1. 创建样式计算工具函数

设计统一的样式计算工具函数，处理：
- 行间距计算（支持倍数和固定值）
- 段落缩进计算（基于字符宽度的相对计算）
- 字体大小和行高的关联计算

**关键改进**：
- 使用 `em` 单位进行段落缩进，确保相对一致性
- 正确处理 'fixed' 类型的行间距
- 统一样式计算逻辑

### 2. 重写 MarkdownRenderer 组件

确保：
- 所有样式配置正确应用到预览区
- 支持动态样式更新
- 性能优化，避免不必要的重新渲染

**关键改进**：
- 使用 useMemo 缓存样式计算结果
- 统一样式应用方式
- 修复表格和图表样式应用

### 3. 统一样式配置结构

明确样式优先级：
- 优先使用 heading1/2/3 和 body 的独立样式
- 向后兼容 fonts、fontSizes、paragraph 等旧配置

## 实施计划

### 第一步：创建样式计算工具函数
- 文件：`client/src/utils/styleCalculator.ts`
- 实现所有样式计算函数

### 第二步：重写 replaceVariablesInContent 函数
- 修改函数签名，添加 tableStyles 参数
- 使用计算后的表格样式替换硬编码样式

### 第三步：重写 MarkdownRenderer 组件
- 导入样式计算工具函数
- 使用 useMemo 缓存样式计算结果
- 使用计算后的样式配置 ReactMarkdown 组件

### 第四步：更新 ReportPreview 主组件
- 确保样式配置正确传递给 MarkdownRenderer
- 优化样式配置的合并逻辑

## 技术亮点

1. **精确的段落缩进计算**：
   ```typescript
   // 使用 em 单位，确保相对一致性
   export const calculateTextIndent = (indentChars: number, fontSize: number): string => {
     if (indentChars <= 0) return '0'
     return `${indentChars}em`
   }
   ```

2. **灵活的行间距处理**：
   ```typescript
   // 支持倍数行距和固定行距
   export const calculateLineHeight = (
     lineSpacing: number | 'fixed',
     fontSize: number,
     lineSpacingValue?: number
   ): string => {
     if (lineSpacing === 'fixed' && lineSpacingValue) {
       return `${lineSpacingValue}px`
     }
     return lineSpacing.toString()
   }
   ```

3. **性能优化**：
   ```typescript
   // 使用 useMemo 缓存样式计算结果
   const computedStyles = useMemo(() => {
     return {
       heading1: getComputedParagraphStyle(config, 'heading1'),
       heading2: getComputedParagraphStyle(config, 'heading2'),
       heading3: getComputedParagraphStyle(config, 'heading3'),
       body: getComputedParagraphStyle(config, 'body'),
       table: getTableStyles(config)
     }
   }, [config])
   ```

4. **向后兼容**：
   ```typescript
   // 优先使用新配置，向后兼容旧配置
   export const getComputedParagraphStyle = (
     config: ReportStyleConfig,
     type: 'heading1' | 'heading2' | 'heading3' | 'body'
   ): React.CSSProperties => {
     // 优先使用独立样式配置
     const paragraphStyle = config[type]
     if (paragraphStyle) {
       return calculateParagraphStyle(paragraphStyle)
     }
     
     // 向后兼容：使用旧配置
     // ...
   }
   ```

## 预期效果

重写后，预览区将能够：

1. **正确应用所有样式设置**：
   - 行间距（倍数和固定值）
   - 段落缩进（基于字符宽度的相对计算）
   - 字体、字号、加粗等基本样式

2. **支持动态样式更新**：
   - 实时反映配置变化
   - 无需刷新页面

3. **保持良好的性能**：
   - 缓存样式计算结果
   - 避免不必要的重新渲染

4. **提供一致的视觉体验**：
   - 预览区与设置完全对应
   - 不同字号下缩进一致

5. **完全兼容新旧配置结构**：
   - 平滑过渡
   - 不破坏现有功能

## 文档结构

1. [`预览样式应用重写方案.md`](./预览样式应用重写方案.md) - 总体方案概述
2. [`样式计算工具函数设计.md`](./样式计算工具函数设计.md) - 样式计算工具详细设计
3. [`MarkdownRenderer重写设计.md`](./MarkdownRenderer重写设计.md) - MarkdownRenderer 组件重写设计
4. [`预览样式应用重写实施计划.md`](./预览样式应用重写实施计划.md) - 详细实施计划和代码

## 下一步行动

建议切换到 Code 模式，按照实施计划逐步实现：

1. 创建 `client/src/utils/styleCalculator.ts` 文件
2. 修改 `client/src/components/report/ReportPreview.tsx` 文件
3. 测试样式应用效果
4. 性能优化

## 风险与对策

1. **性能风险**：大量样式计算可能影响性能
   - 对策：使用 useMemo 缓存计算结果

2. **兼容性风险**：新代码可能破坏现有功能
   - 对策：保持向后兼容，充分测试

3. **复杂性风险**：代码复杂度增加
   - 对策：良好的文档和注释，模块化设计

## 总结

本重写方案通过创建统一的样式计算工具函数和重写 MarkdownRenderer 组件，彻底解决了预览样式设置与富文本预览区不对应的问题。新架构具有以下优势：

- **精确计算**：使用相对单位确保样式一致性
- **性能优化**：缓存计算结果，避免重复计算
- **向后兼容**：支持新旧配置结构
- **易于维护**：统一样式计算逻辑，便于后续扩展

实施后，用户将能够看到预览样式设置与预览区完全对应，提升用户体验。