# 管理费用变量新增计划

## 任务概述

在投资项目方案报告生成页面中"可用变量"card，"财务指标"大类下新增"管理费用"变量，数据使用json格式。变量添加查看json数据小眼睛。数据来源为"总成本费用估算表"modal中序号2的"管理费用"列数据。

## 现有代码分析

### 1. VariablePicker.tsx 组件
- 位置: `client/src/components/report/VariablePicker.tsx`
- "财务指标"大类在第262-318行
- 现有变量: 投资回报率、内部收益率、净现值、修理费率
- 参考修理费率的实现方式(第293-316行)，包含小眼睛图标

### 2. reportStore.ts Store
- 位置: `client/src/stores/reportStore.ts`
- availableVariables数组在第649-721行定义
- 现有相关变量:
  - `{{repair_rate}}` (修理费率) - 第661-690行
  - `{{DATA:total_cost}}` (总成本费用估算表JSON) - 第695行

### 3. DynamicCostTable.tsx 组件
- 位置: `client/src/components/revenue-cost/DynamicCostTable.tsx`
- 管理费用是序号2，使用`calculateManagementExpenses`函数计算
- 数据结构:
  ```typescript
  const row2 = {
    序号: '2',
    成本项目: '管理费用',
    合计: 0,
    运营期: [] as number[]
  }
  ```

### 4. buildTotalCost.ts 后端
- 位置: `server/src/utils/tableDataBuilders/buildTotalCost.ts`
- 当前只包含: 外购原材料费、外购燃料和动力费、工资及福利费
- 缺少: 管理费用列数据

## 实施步骤

### 步骤1: 修改后端 buildTotalCost.ts

**文件**: `server/src/utils/tableDataBuilders/buildTotalCost.ts`

**修改内容**:
在第58-63行之后添加管理费用列数据的处理逻辑

```typescript
// 在第63行之后添加:
if (wagesRow?.运营期) {
  jsonData.yearlyData = jsonData.yearlyData.map((item: any, idx: number) => ({
    ...item,
    工资及福利费: Number(wagesRow.运营期[idx]) || 0
  }))
}

// 添加管理费用处理逻辑
const managementExpensesRow = tableData.rows.find((r: any) => r.序号 === '2')

if (managementExpensesRow?.运营期) {
  jsonData.yearlyData = jsonData.yearlyData.map((item: any, idx: number) => ({
    ...item,
    管理费用: Number(managementExpensesRow.运营期[idx]) || 0
  }))
}
```

### 步骤2: 修改前端 reportStore.ts

**文件**: `client/src/stores/reportStore.ts`

**修改位置**: 在第690行之后添加管理费用变量

```typescript
// 在第690行之后添加:
{ key: '{{management_expenses}}', label: '管理费用', value: (() => {
  const totalCostJSON = tableDataJSON['DATA:total_cost'] || '{}'
  const totalCostData = typeof totalCostJSON === 'string' ? JSON.parse(totalCostJSON) : totalCostJSON
  
  // 从总成本费用估算表JSON中提取管理费用数据
  if (totalCostData.yearlyData && Array.isArray(totalCostData.yearlyData)) {
    const managementData = totalCostData.yearlyData.map((item: any) => ({
      年份: item.年份,
      管理费用: item.管理费用 || 0
    }))
    
    return JSON.stringify(managementData, null, 2)
  }
  
  return '[]'
})() },
```

**同时更新 tableDataJSON 缓存**:
在第616行之后添加:

```typescript
// 将 management_expenses 存入 tableDataJSON
const managementExpensesValue = (() => {
  const totalCostJSON = tableDataJSON['DATA:total_cost'] || '{}'
  const totalCostData = typeof totalCostJSON === 'string' ? JSON.parse(totalCostJSON) : totalCostJSON
  
  if (totalCostData.yearlyData && Array.isArray(totalCostData.yearlyData)) {
    const managementData = totalCostData.yearlyData.map((item: any) => ({
      年份: item.年份,
      管理费用: item.管理费用 || 0
    }))
    
    return JSON.stringify(managementData, null, 2)
  }
  
  return '[]'
})()
tableDataJSON['management_expenses'] = managementExpensesValue
```

### 步骤3: 修改前端 VariablePicker.tsx

**文件**: `client/src/components/report/VariablePicker.tsx`

**修改位置**: 在第316行之后(修理费率badge之后)添加管理费用badge

```tsx
<Badge
  variant="light"
  color="green"
  style={{ cursor: 'pointer' }}
  onClick={() => handleCopyVariable('{{management_expenses}}')}
  title="点击复制"
  rightSection={
    <Tooltip label="查看JSON数据">
      <ActionIcon
        size="xs"
        variant="transparent"
        color="green"
        onClick={(e) => {
          e.stopPropagation()
          handleViewJson('{{management_expenses}}', '管理费用')
        }}
      >
        <Eye size={12} />
      </ActionIcon>
    </Tooltip>
  }
>
  管理费用
</Badge>
```

## 数据流图

```mermaid
flowchart TD
    A[总成本费用估算表 Modal] -->|序号2 管理费用列| B[DynamicCostTable calculateManagementExpenses]
    B --> C[后端 buildTotalCost.ts]
    C -->|生成JSON包含管理费用| D[tableDataJSON DATA:total_cost]
    D --> E[前端 reportStore.ts]
    E -->|提取管理费用数据| F[{{management_expenses}} 变量]
    F --> G[VariablePicker.tsx]
    G -->|显示badge和小眼睛| H[用户点击查看JSON]
    H --> I[JSON查看器Modal显示管理费用数据]
```

## 技术要点

### 1. 数据格式
- 管理费用变量使用JSON格式
- 数据结构包含年份和管理费用字段
- 与修理费率变量格式保持一致

### 2. 小眼睛图标
- 使用Eye图标(lucide-react)
- 点击后打开JSON查看器Modal
- 显示格式化的JSON数据

### 3. 数据一致性
- 后端JSON包含管理费用列数据
- 前端从tableDataJSON提取管理费用数据
- 确保小眼睛查看的数据与变量使用的数据一致

### 4. 编码规范
- 遵循JSX计算逻辑分离原则
- 计算逻辑在渲染前完成
- 使用空值兜底处理

## 测试验证清单

- [ ] 打开总成本费用估算表modal，确认序号2管理费用列有数据
- [ ] 打开投资项目方案报告生成页面
- [ ] 在"财务指标"大类下看到"管理费用"badge
- [ ] 点击"管理费用"badge，确认变量{{management_expenses}}被复制
- [ ] 点击小眼睛图标，确认JSON查看器显示管理费用数据
- [ ] 验证JSON数据格式正确，包含年份和管理费用字段
- [ ] 在提示词中使用{{management_expenses}}变量，确认替换为JSON数据

## 相关文件

- `server/src/utils/tableDataBuilders/buildTotalCost.ts` - 后端JSON构建
- `client/src/stores/reportStore.ts` - 前端变量定义
- `client/src/components/report/VariablePicker.tsx` - 前端UI组件
