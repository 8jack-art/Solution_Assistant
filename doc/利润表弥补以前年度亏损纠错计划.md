# 利润与利润分配表"弥补以前年度亏损"精准纠错计划

## 问题概述

当前代码中 `calculateCumulativeLoss` 函数的实现存在逻辑错误，导致"弥补以前年度亏损"列的计算结果不符合中国企业所得税法规定。

## 核心规则（根据任务要求）

1. **前提条件**：只有当期"利润总额"＞0时，才能用盈利弥补以前年度亏损；若当期"利润总额"≤0，则亏损继续累积，"弥补以前年度亏损"必须为0。

2. **计算逻辑**：
   - 先计算累计未弥补亏损（亏损期累加，盈利期开始减少）
   - 盈利期的弥补额 = min(当期利润总额, 累计未弥补亏损)，且弥补期限最长不超过5年
   - 弥补后，若当期利润＞剩余亏损，剩余部分为应纳税所得额；若当期利润＜剩余亏损，亏损继续累积

3. **常见错误识别**：
   - 错误1：在亏损期（利润总额为负）填写"弥补以前年度亏损"金额
   - 错误2：将"累计未弥补亏损"直接当作"弥补以前年度亏损"的金额

## 错误分析

### 表1（错误典型）
| 运营期 | 利润总额（万元） | "弥补以前年度亏损"（万元）- 当前错误值 |
|--------|------------------|--------------------------------|
| 1      | -629.38          | 0.00                           |
| 2      | -456.76          | 629.38 ❌                       |
| 3      | -202.06          | 1086.14 ❌                      |
| ...    | ...              | ...                            |

**问题**：所有运营期利润总额都是负数（亏损），但"弥补以前年度亏损"列却填了非0金额。这违反了核心规则1。

### 表2（部分正确，需验证）
| 计算期 | 利润总额（万元） | "弥补以前年度亏损"（万元）- 当前值 |
|--------|------------------|--------------------------------|
| 1      | -10.43           | 0.00                           |
| 2      | 8.11             | 8.11 ✅                        |
| 3      | 34.92            | 2.32 ✅                        |
| 4      | 36.94            | 0.00 ✅                        |
| 5      | 26.87            | 0.00 ✅                        |

**验证**：第2年利润8.11，应弥补额8.11（正确）；第3年利润34.92，应弥补2.32（正确，剩余亏损2.32在第4年被完全弥补）。

## 当前代码分析

### `calculateCumulativeLoss` 函数（第1861-1874行）

```typescript
const calculateCumulativeLoss = (year: number): number => {
  if (!context) return 0;
  let cumulativeLoss = 0;
  for (let y = 1; y < year; y++) {
    const profit = calculateTotalProfit(y);
    if (profit < 0) {
      cumulativeLoss += Math.abs(profit);
    } else {
      cumulativeLoss = Math.max(0, cumulativeLoss - profit);
    }
  }
  return cumulativeLoss;
};
```

### 问题根源

1. **函数命名误导**：函数名为 `calculateCumulativeLoss`（计算累计亏损），但实际返回的是"累计未弥补亏损"，这个值应该作为"弥补以前年度亏损"的计算依据，而不是直接作为"弥补以前年度亏损"的返回值。

2. **语义混淆**：
   - **累计未弥补亏损**：截至到上一年末尚未弥补的亏损总额
   - **弥补以前年度亏损**：当年实际用来弥补以前年度亏损的金额
   - 这两个概念不同，不应该混淆使用

3. **返回值错误**：
   - 当前函数返回的是"累计未弥补亏损"
   - 应该返回的是"弥补以前年度亏损"（当年实际弥补额）

## 修复方案

### 修复思路

需要重新设计相关函数的逻辑，明确区分：
1. **累计未弥补亏损**：截至到某年年初尚未弥补的亏损总额
2. **弥补以前年度亏损**：当年实际弥补的金额（只有盈利年才有值）
3. **应纳税所得额**：当年利润 - 当年弥补额（最小为0）

### 修复后的函数逻辑

#### 1. 新增 `calculateUncoveredLoss` 函数 - 计算累计未弥补亏损

```typescript
// 计算截至到某年年初的累计未弥补亏损
const calculateUncoveredLoss = (year: number): number => {
  if (!context) return 0;
  let uncoveredLoss = 0; // 累计未弥补亏损
  
  for (let y = 1; y < year; y++) {
    const profit = calculateTotalProfit(y);
    if (profit < 0) {
      // 亏损期：亏损累加到未弥补亏损
      uncoveredLoss += Math.abs(profit);
    } else {
      // 盈利期：用利润弥补未弥补亏损
      uncoveredLoss = Math.max(0, uncoveredLoss - profit);
    }
  }
  
  return uncoveredLoss;
};
```

#### 2. 修改 `calculateCumulativeLoss` 函数 - 计算当年弥补额

```typescript
// 计算当年弥补以前年度亏损的金额
const calculateCumulativeLoss = (year: number): number => {
  if (!context) return 0;
  
  // 前提条件：只有当年利润 > 0 才能弥补
  const currentProfit = calculateTotalProfit(year);
  if (currentProfit <= 0) {
    return 0; // 亏损期不能弥补
  }
  
  // 获取截至到年初的累计未弥补亏损
  const uncoveredLoss = calculateUncoveredLoss(year);
  
  // 弥补额 = min(当年利润, 累计未弥补亏损)
  return Math.min(currentProfit, uncoveredLoss);
};
```

#### 3. 修改 `calculateYearlyTaxableIncome` 函数 - 计算应纳税所得额

```typescript
const calculateYearlyTaxableIncome = (year?: number): number => {
  if (year !== undefined) {
    const profit = calculateTotalProfit(year);
    const lossRecovery = calculateCumulativeLoss(year);
    // 应纳税所得额 = 利润 - 弥补额（最小为0）
    return Math.max(0, profit - lossRecovery);
  } else {
    if (!context) return 0;
    const years = Array.from({ length: context.operationYears }, (_, i) => i + 1);
    let totalSum = 0;
    years.forEach((y) => {
      totalSum += calculateYearlyTaxableIncome(y);
    });
    return totalSum;
  }
};
```

## 需要修复的函数列表

| 序号 | 函数名 | 修复内容 |
|------|--------|----------|
| 1 | `calculateUncoveredLoss` | 新增函数，计算累计未弥补亏损 |
| 2 | `calculateCumulativeLoss` | 修改逻辑，只返回当年实际弥补额 |
| 3 | `calculateYearlyTaxableIncome` | 确保应纳税所得额计算正确 |
| 4 | `calculateIncomeTax` | 确保所得税基于正确的应纳税所得额 |
| 5 | `calculateNetProfit` | 确保净利润 = 利润总额 - 所得税 |
| 6 | `calculateInitialUndistributedProfit` | 确保期初未分配利润计算正确 |
| 7 | `calculateDistributableProfit` | 确保可供分配利润计算正确 |
| 8 | `calculateUndistributedProfit` | 确保未分配利润计算正确 |

## 修复后的预期结果

### 表1（修复后）- 所有亏损期，弥补额应为0

| 运营期 | 利润总额（万元） | "弥补以前年度亏损"（万元）- 修复后 |
|--------|------------------|--------------------------------|
| 1      | -629.38          | 0.00                           |
| 2      | -456.76          | 0.00                           |
| 3      | -202.06          | 0.00                           |
| ...    | ...              | 0.00                           |

### 表2（修复后）- 验证正确性

| 计算期 | 利润总额（万元） | "弥补以前年度亏损"（万元）- 修复后 |
|--------|------------------|--------------------------------|
| 1      | -10.43           | 0.00                           |
| 2      | 8.11             | 8.11                           |
| 3      | 34.92            | 2.32                           |
| 4      | 36.94            | 0.00                           |
| 5      | 26.87            | 0.00                           |

## 修复步骤

1. **添加新函数**：添加 `calculateUncoveredLoss` 函数
2. **修改 `calculateCumulativeLoss`**：修改为返回当年实际弥补额
3. **修改 `calculateYearlyTaxableIncome`**：确保逻辑正确
4. **修改 `calculateIncomeTax`**：确保基于正确的应纳税所得额
5. **修改 `calculateNetProfit`**：确保净利润计算正确
6. **修改 `calculateInitialUndistributedProfit`**：基于净利润计算
7. **修改 `calculateDistributableProfit`**：确保逻辑正确
8. **修改 `calculateUndistributedProfit`**：确保逻辑正确
9. **测试验证**：验证修复后的计算结果
10. **编写修复总结**：记录修复内容

## 涉及的文件

- `client/src/components/revenue-cost/FinancialIndicatorsTable.tsx`

## 补充说明

根据企业所得税法，企业发生亏损可以用以后年度的应纳税所得额弥补，但最长不超过5年。本方案暂不实现5年限制，如需实现，需要记录每笔亏损的发生年份，确保弥补期限不超过5年。

## 实施计划

实施计划详见 `plans/利润表弥补以前年度亏损纠错实施计划.md`
