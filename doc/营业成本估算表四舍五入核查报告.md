# 营业成本估算表四舍五入核查报告

## 核查日期
2025-12-23

## 核查范围
`client/src/components/revenue-cost/DynamicCostTable.tsx`

## 核查结果

### ✅ 修改完成

**已去除外购原材料费估算表和外购燃料及动力费估算表中的四舍五入操作。营业成本估算表主表保留2位小数显示。**

---

## 修改说明

### 修改内容

#### 1. 外购原材料费估算表（renderRawMaterialsModal）
- ✅ **已去除**所有 `.toFixed(2)` 四舍五入操作
- 现在显示原始计算值，保留完整精度

#### 2. 外购燃料及动力费估算表（renderFuelPowerModal）
- ✅ **已去除**所有 `.toFixed(2)` 四舍五入操作
- 现在显示原始计算值，保留完整精度

#### 3. 营业成本估算表主表（showCostDetailModal）
- ✅ **保留** `.toFixed(2)` 2位小数显示
- 按照要求，仅在营业成本估算表显示2位小数

---

## 详细分析

### 1. 外购原材料费估算表（renderRawMaterialsModal）- ✅ 已修改

| 行号 | 位置 | 修改前 | 修改后 |
|------|------|--------|--------|
| 757 | 序号1合计列 | `totalSum.toFixed(2)` | `totalSum` ✅ |
| 793 | 序号1各年列 | `yearTotal.toFixed(2)` | `yearTotal` ✅ |
| 848 | 原材料项目合计列 | `totalSum.toFixed(2)` | `totalSum` ✅ |
| 882 | 原材料项目各年列 | `yearTotal.toFixed(2)` | `yearTotal` ✅ |
| 1003 | 进项税额合计列 | `totalSum.toFixed(2)` | `totalSum` ✅ |
| 1023 | 进项税额各年列 | `yearInputTax.toFixed(2)` | `yearInputTax` ✅ |
| 1037 | 外购原材料（除税）合计列 | `calculateRawMaterialsExcludingTax(undefined, years).toFixed(2)` | `calculateRawMaterialsExcludingTax(undefined, years)` ✅ |
| 1070 | 外购原材料（除税）各年列 | `excludingTax.toFixed(2)` | `excludingTax` ✅ |

### 2. 外购燃料及动力费估算表（renderFuelPowerModal）- ✅ 已修改

| 行号 | 位置 | 修改前 | 修改后 |
|------|------|--------|--------|
| 2008 | 序号1合计列 | `totalSum.toFixed(2)` | `totalSum` ✅ |
| 2029 | 序号1各年列 | `yearTotal.toFixed(2)` | `yearTotal` ✅ |
| 2063 | 燃料项目合计列 | `totalSum.toFixed(2)` | `totalSum` ✅ |
| 2081 | 燃料项目各年列 | `yearTotal.toFixed(2)` | `yearTotal` ✅ |
| 2156 | 进项税额合计列 | `totalSum.toFixed(2)` | `totalSum` ✅ |
| 2181 | 进项税额各年列 | `yearInputTax.toFixed(2)` | `yearInputTax` ✅ |
| 2228 | 外购燃料及动力（除税）合计列 | `totalSum.toFixed(2)` | `totalSum` ✅ |
| 2260 | 外购燃料及动力（除税）各年列 | `yearTotal.toFixed(2)` | `yearTotal` ✅ |

### 3. 营业成本估算表（主表）- ✅ 保留2位小数

| 行号 | 位置 | 四舍五入操作 |
|------|------|-------------|
| 2690 | 营业成本合计列 | `total.toFixed(2)` |
| 2745 | 营业成本各年列 | `total.toFixed(2)` |
| 2761 | 外购原材料费合计列 | `calculateRawMaterialsExcludingTax(undefined, years).toFixed(2)` |
| 2768 | 外购原材料费各年列 | `calculateRawMaterialsExcludingTax(year, years).toFixed(2)` |
| 2797 | 外购燃料及动力费合计列 | `calculateFuelPowerExcludingTax(undefined, years).toFixed(2)` |
| 2806 | 外购燃料及动力费各年列 | `yearTotal.toFixed(2)` |
| 2833 | 工资及福利费合计列 | `calculateWagesTotal(undefined, years).toFixed(2)` |
| 2840 | 工资及福利费各年列 | `calculateWagesTotal(year, years).toFixed(2)` |
| 2879 | 修理费合计列 | `total.toFixed(2)` |
| 2894 | 修理费各年列 | `yearTotal.toFixed(2)` |
| 2939 | 其他费用合计列 | `total.toFixed(2)` |
| 2960 | 其他费用各年列 | `yearTotal.toFixed(2)` |
| 3008 | 利息支出合计列 | `totalInterest.toFixed(2)` |
| 3023 | 利息支出各年列 | `yearInterest.toFixed(2)` |
| 3048 | 折旧费合计列 | `totalDepreciation.toFixed(2)` |
| 3060 | 折旧费各年列 | `yearDepreciation.toFixed(2)` |
| 3083 | 摊销费合计列 | `totalAmortization.toFixed(2)` |
| 3093 | 摊销费各年列 | `yearAmortization.toFixed(2)` |
| 3193 | 总成本费用合计列 | `total.toFixed(2)` |
| 3274 | 总成本费用各年列 | `yearTotal.toFixed(2)` |

---

## 修改后的效果

### ✅ 子表显示完整精度

- 外购原材料费估算表：显示原始计算值，无四舍五入
- 外购燃料及动力费估算表：显示原始计算值，无四舍五入
- 营业成本估算表主表：显示2位小数，符合财务规范

### ✅ 数据一致性

由于子表不再四舍五入，主表直接引用子表的计算结果，确保数据完全一致。

---

## 代码示例

### 典型的四舍五入代码模式

```typescript
// 合计列计算
let totalSum = 0;
years.forEach((year) => {
  // 计算该年的数值
  let yearTotal = /* 计算逻辑 */;
  totalSum += yearTotal;  // 累加原始值
});
return totalSum.toFixed(2);  // 最后统一四舍五入

// 各年列显示
let yearTotal = /* 计算逻辑 */;
return (
  <Table.Td>
    {yearTotal.toFixed(2)}  // 独立四舍五入
  </Table.Td>
);
```

---

## 建议

### 当前实现的特点
- ✅ 显示统一：所有数值都显示为2位小数
- ✅ 计算准确：累加时使用原始值，只在显示时四舍五入
- ⚠️ 可能存在视觉差异：合计列与各年列之和可能存在±0.01的差异

### 如需确保完全一致
可以考虑在累加时使用四舍五入后的值，但这会影响计算精度。建议保持当前实现，因为：
1. 财务计算中保留更多精度是合理的
2. 微小的显示差异在可接受范围内
3. Excel导出时也使用相同的逻辑

---

## 结论

**已完成修改：去除外购原材料费估算表和外购燃料及动力费估算表中的四舍五入操作，仅在营业成本估算表主表中保留2位小数显示。**

### 修改总结

| 表格 | 四舍五入状态 | 说明 |
|------|---------------|------|
| 外购原材料费估算表 | ❌ 已去除 | 显示原始计算值 |
| 外购燃料及动力费估算表 | ❌ 已去除 | 显示原始计算值 |
| 营业成本估算表主表 | ✅ 保留 | 显示2位小数 |

### 优势

1. **计算精度**：子表保留完整精度，避免中间计算的四舍五入误差累积
2. **数据一致性**：主表引用子表的原始值，确保数据完全一致
3. **财务规范**：主表显示2位小数，符合财务报表的显示标准
