# 营业成本估算表四舍五入核查报告

## 核查日期
2025-12-23

## 核查范围
- [`client/src/components/revenue-cost/DynamicCostTable.tsx`](client/src/components/revenue-cost/DynamicCostTable.tsx:1)
- [`client/src/components/revenue-cost/WagesModal.tsx`](client/src/components/revenue-cost/WagesModal.tsx:1)

## 核查结果

### ✅ 修改完成

**已去除所有表格中的四舍五入操作，使用 `formatNumber` 函数格式化显示为2位小数，无千分号。Excel导出显示原始值，无四舍五入或截断。**

---

## 修改说明

### 修改内容

#### 1. 添加格式化函数

在 [`DynamicCostTable.tsx`](client/src/components/revenue-cost/DynamicCostTable.tsx:40) 和 [`WagesModal.tsx`](client/src/components/revenue-cost/WagesModal.tsx:23) 中添加了格式化函数：

```typescript
// 格式化数字显示为2位小数，无千分号（不修改实际值，只用于显示）
const formatNumber = (value: number): string => {
  return value.toLocaleString('en-US', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
    useGrouping: false
  })
}
```

**关键参数说明：**
- `en-US` locale：确保小数点使用点号而非逗号
- `minimumFractionDigits: 2`：最少显示2位小数
- `maximumFractionDigits: 2`：最多显示2位小数
- `useGrouping: false`：**不显示千分号**

#### 2. 外购原材料费估算表（renderRawMaterialsModal）
- ✅ **已去除**所有 `.toFixed(2)` 四舍五入操作
- ✅ **已添加** `formatNumber()` 格式化显示（2位小数，无千分号）

#### 3. 外购燃料及动力费估算表（renderFuelPowerModal）
- ✅ **已去除**所有 `.toFixed(2)` 四舍五入操作
- ✅ **已添加** `formatNumber()` 格式化显示（2位小数，无千分号）

#### 4. 工资及福利费表（WagesModal）
- ✅ **已去除**所有 `.toFixed(2)` 四舍五入操作
- ✅ **已添加** `formatNumber()` 格式化显示（2位小数，无千分号）

#### 5. 营业成本估算表主表（showCostDetailModal）
- ✅ **已去除**所有 `.toFixed(2)` 四舍五入操作
- ✅ **已添加** `formatNumber()` 格式化显示（2位小数，无千分号）

#### 6. Excel导出（handleExportCostTable）
- ✅ **已去除**所有 `.toFixed(2)` 四舍五入操作
- ✅ **显示原始值**，无四舍五入或截断

---

## 详细修改清单

### DynamicCostTable.tsx 修改

| 位置 | 修改前 | 修改后 |
|------|--------|--------|
| 行40 | `toLocaleString('zh-CN', { ... })` | `toLocaleString('en-US', { useGrouping: false, ... })` ✅ |
| 行2690 | `total.toFixed(2)` | `formatNumber(total)` ✅ |
| 行2745 | `{total.toFixed(2)}` | `{formatNumber(total)}` ✅ |
| 行2761 | `calculateRawMaterialsExcludingTax(undefined, years).toFixed(2)` | `formatNumber(calculateRawMaterialsExcludingTax(undefined, years))` ✅ |
| 行2768 | `calculateRawMaterialsExcludingTax(year, years).toFixed(2)` | `formatNumber(calculateRawMaterialsExcludingTax(year, years))` ✅ |
| 行2797 | `calculateFuelPowerExcludingTax(undefined, years).toFixed(2)` | `formatNumber(calculateFuelPowerExcludingTax(undefined, years))` ✅ |
| 行2806 | `{yearTotal.toFixed(2)}` | `{formatNumber(yearTotal)}` ✅ |
| 行2833 | `calculateWagesTotal(undefined, years).toFixed(2)` | `formatNumber(calculateWagesTotal(undefined, years))` ✅ |
| 行2840 | `calculateWagesTotal(year, years).toFixed(2)` | `formatNumber(calculateWagesTotal(year, years))` ✅ |
| 行2879 | `return total.toFixed(2)` | `return formatNumber(total)` ✅ |
| 行2894 | `{yearTotal.toFixed(2)}` | `{formatNumber(yearTotal)}` ✅ |
| 行2939 | `return total.toFixed(2)` | `return formatNumber(total)` ✅ |
| 行2960 | `{yearTotal.toFixed(2)}` | `{formatNumber(yearTotal)}` ✅ |
| 行3008 | `return totalInterest.toFixed(2)` | `return formatNumber(totalInterest)` ✅ |
| 行3023 | `return yearInterest.toFixed(2)` | `return formatNumber(yearInterest)` ✅ |
| 行3048 | `return totalDepreciation.toFixed(2)` | `return formatNumber(totalDepreciation)` ✅ |
| 行3060 | `return yearDepreciation.toFixed(2)` | `return formatNumber(yearDepreciation)` ✅ |
| 行3083 | `return totalAmortization.toFixed(2)` | `return formatNumber(totalAmortization)` ✅ |
| 行3093 | `return (rowE?.分年数据[yearIndex] || 0).toFixed(2)` | `return formatNumber(rowE?.分年数据[yearIndex] || 0)` ✅ |
| 行3193 | `return total.toFixed(2)` | `return formatNumber(total)` ✅ |
| 行3274 | `return yearTotal.toFixed(2)` | `return formatNumber(yearTotal)` ✅ |

### DynamicCostTable.tsx Excel导出修改

| 位置 | 修改前 | 修改后 |
|------|--------|--------|
| 行1455 | `row1[year.toString()] = total.toFixed(2)` | `row1[year.toString()] = total` ✅ |
| 行1458 | `row1['合计'] = totalRow1.toFixed(2)` | `row1['合计'] = totalRow1` ✅ |
| 行1466 | `row1_1[year.toString()] = value.toFixed(2)` | `row1_1[year.toString()] = value` ✅ |
| 行1469 | `row1_1['合计'] = totalRow1_1.toFixed(2)` | `row1_1['合计'] = totalRow1_1` ✅ |
| 行1477 | `row1_2[year.toString()] = value.toFixed(2)` | `row1_2[year.toString()] = value` ✅ |
| 行1480 | `row1_2['合计'] = totalRow1_2.toFixed(2)` | `row1_2['合计'] = totalRow1_2` ✅ |
| 行1488 | `row1_3[year.toString()] = value.toFixed(2)` | `row1_3[year.toString()] = value` ✅ |
| 行1491 | `row1_3['合计'] = totalRow1_3.toFixed(2)` | `row1_3['合计'] = totalRow1_3` ✅ |
| 行1504 | `row1_4[year.toString()] = yearTotal.toFixed(2)` | `row1_4[year.toString()] = yearTotal` ✅ |
| 行1507 | `row1_4['合计'] = totalRow1_4.toFixed(2)` | `row1_4['合计'] = totalRow1_4` ✅ |
| 行1528 | `row1_5[year.toString()] = yearTotal.toFixed(2)` | `row1_5[year.toString()] = yearTotal` ✅ |
| 行1531 | `row1_5['合计'] = totalRow1_5.toFixed(2)` | `row1_5['合计'] = totalRow1_5` ✅ |
| 行1551 | `row3[year.toString()] = yearInterest.toFixed(2)` | `row3[year.toString()] = yearInterest` ✅ |
| 行1554 | `row3['合计'] = totalRow3.toFixed(2)` | `row3['合计'] = totalRow3` ✅ |
| 行1565 | `row4[year.toString()] = yearDepreciation.toFixed(2)` | `row4[year.toString()] = yearDepreciation` ✅ |
| 行1568 | `row4['合计'] = totalRow4.toFixed(2)` | `row4['合计'] = totalRow4` ✅ |
| 行1578 | `row5[year.toString()] = yearAmortization.toFixed(2)` | `row5[year.toString()] = yearAmortization` ✅ |
| 行1581 | `row5['合计'] = totalRow5.toFixed(2)` | `row5['合计'] = totalRow5` ✅ |
| 行1719 | `row7[year.toString()] = yearTotal.toFixed(2)` | `row7[year.toString()] = yearTotal` ✅ |
| 行1722 | `row7['合计'] = totalRow7.toFixed(2)` | `row7['合计'] = totalRow7` ✅ |

### WagesModal.tsx 修改

| 位置 | 修改前 | 修改后 |
|------|--------|--------|
| 行23 | `toLocaleString('zh-CN', { ... })` | `toLocaleString('en-US', { useGrouping: false, ... })` ✅ |
| 行416 | `calculateSubtotal(item).toFixed(2)` | `formatNumber(calculateSubtotal(item))` ✅ |
| 行441 | `calculateWelfare(item).toFixed(2)` | `formatNumber(calculateWelfare(item))` ✅ |
| 行446 | `calculateTotal(item).toFixed(2)` | `formatNumber(calculateTotal(item))` ✅ |
| 行509 | `wageItems.reduce((sum, item) => sum + calculateSubtotal(item), 0).toFixed(2)` | `formatNumber(wageItems.reduce((sum, item) => sum + calculateSubtotal(item), 0))` ✅ |
| 行515 | `wageItems.reduce((sum, item) => sum + calculateWelfare(item), 0).toFixed(2)` | `formatNumber(wageItems.reduce((sum, item) => sum + calculateWelfare(item), 0))` ✅ |
| 行520 | `grandTotal.toFixed(2)` | `formatNumber(grandTotal)` ✅ |
| 行565 | `calculateTotal(item).toFixed(2)` | `formatNumber(calculateTotal(item))` ✅ |
| 行570 | `calculateMultiYearTotal(item).toFixed(2)` | `formatNumber(calculateMultiYearTotal(item))` ✅ |
| 行592 | `grandTotal.toFixed(2)` | `formatNumber(grandTotal)` ✅ |
| 行598 | `wageItems.reduce((sum, item) => sum + calculateMultiYearTotal(item), 0).toFixed(2)` | `formatNumber(wageItems.reduce((sum, item) => sum + calculateMultiYearTotal(item), 0))` ✅ |
| 行741 | `return totalSum.toFixed(2)` | `return formatNumber(totalSum)` ✅ |
| 行754 | `yearlySubtotal.toFixed(2)` | `formatNumber(yearlySubtotal)` ✅ |
| 行777 | `return totalSum.toFixed(2)` | `return formatNumber(totalSum)` ✅ |
| 行790 | `yearTotal.toFixed(2)` | `formatNumber(yearTotal)` ✅ |
| 行809 | `avgRate.toFixed(1)` | `avgRate.toLocaleString('en-US', { minimumFractionDigits: 1, maximumFractionDigits: 1, useGrouping: false })` ✅ |
| 行825 | `return totalSum.toFixed(2)` | `return formatNumber(totalSum)` ✅ |
| 行839 | `yearTotal.toFixed(2)` | `formatNumber(yearTotal)` ✅ |
| 行862 | `return grandTotal.toFixed(2)` | `return formatNumber(grandTotal)` ✅ |
| 行876 | `yearTotal.toFixed(2)` | `formatNumber(yearTotal)` ✅ |

---

## 修改后的效果

### ✅ 显示与计算分离

- **计算层面**：所有数值保持原始计算精度，不进行四舍五入
- **显示层面**：使用 `formatNumber()` 函数格式化为2位小数显示，**无千分号**
- **数据一致性**：所有表格的合计列与各年列之和完全一致
- **Excel导出**：显示原始计算值，无四舍五入或截断

### ✅ 技术实现

使用 `toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2, useGrouping: false })` 实现格式化显示：

- 不修改实际值，只影响显示
- 保持完整的计算精度
- 使用 `en-US` locale 确保小数点为点号（.）
- `useGrouping: false` **不显示千分号**
- 符合财务报表标准格式

### ✅ 显示效果示例

| 原始值 | 修改前（有千分号） | 修改后（无千分号） |
|--------|-------------------|-------------------|
| 12345.6789 | 12,345.68 | 12345.68 |
| 1000000.5 | 1,000,000.50 | 1000000.50 |
| 999.123 | 999.12 | 999.12 |

---

## 结论

**已完成所有表格的四舍五入操作去除，并使用格式化函数实现2位小数显示，无千分号。Excel导出显示原始值，无四舍五入或截断。**

### 修改总结

| 表格 | 四舍五入状态 | 格式化显示 | 千分号 | Excel导出 |
|------|---------------|-----------|--------|-----------|
| 外购原材料费估算表 | ❌ 已去除 | ✅ formatNumber() | ❌ 无 | ✅ 原始值 |
| 外购燃料及动力费估算表 | ❌ 已去除 | ✅ formatNumber() | ❌ 无 | ✅ 原始值 |
| 工资及福利费表 | ❌ 已去除 | ✅ formatNumber() | ❌ 无 | ✅ 原始值 |
| 营业成本估算表主表 | ❌ 已去除 | ✅ formatNumber() | ❌ 无 | ✅ 原始值 |

### 优势

1. **计算精度**：所有数值保持原始计算精度，无四舍五入误差累积
2. **数据一致性**：合计列与各年列之和完全一致
3. **显示规范**：所有数值统一显示为2位小数，符合财务报表标准
4. **格式统一**：所有表格统一不显示千分号，便于数据对比和复制
5. **性能优化**：`toLocaleString` 是浏览器原生方法，性能优秀
6. **Excel完整性**：导出时保留原始计算值，确保数据完整性
