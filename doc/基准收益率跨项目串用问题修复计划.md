# 基准收益率跨项目串用问题修复计划

## 问题描述

在设置基准收益率modal窗口中设置的"基准收益率（所得税前）%"及"基准收益率（所得税后）%"的值会串到其他项目。例如在A项目设置了税前基准收益率为3，税后为4，则在B项目的这个modal窗口也会变成这个值。

## 问题根因

在 [`FinancialIndicatorsTable.tsx`](client/src/components/revenue-cost/FinancialIndicatorsTable.tsx) 中，基准收益率使用 `localStorage` 存储时**没有按项目隔离**，导致所有项目共享同一份数据。

### 问题代码位置

**读取逻辑**（第340-353行）：
```javascript
// 当前错误写法 - 所有项目共享同一存储
const savedPreTaxRate = localStorage.getItem('financialIndicatorsPreTaxRate');
const savedPostTaxRate = localStorage.getItem('financialIndicatorsPostTaxRate');
```

**保存逻辑**（第3088-3089行）：
```javascript
// 当前错误写法 - 所有项目共享同一存储
localStorage.setItem('financialIndicatorsPreTaxRate', tempPreTaxRate.toString());
localStorage.setItem('financialIndicatorsPostTaxRate', tempPostTaxRate.toString());
```

## 解决方案

将 `localStorage` 的 key 改为按项目隔离，使用 `context.projectId` 作为前缀。

### 修复后的存储逻辑

**读取逻辑**：
```javascript
const projectId = context?.projectId || 'default'
const savedPreTaxRate = localStorage.getItem(`financialIndicatorsPreTaxRate_${projectId}`);
const savedPostTaxRate = localStorage.getItem(`financialIndicatorsPostTaxRate_${projectId}`);
```

**保存逻辑**：
```javascript
const projectId = context?.projectId || 'default'
localStorage.setItem(`financialIndicatorsPreTaxRate_${projectId}`, tempPreTaxRate.toString());
localStorage.setItem(`financialIndicatorsPostTaxRate_${projectId}`, tempPostTaxRate.toString());
```

## 修复流程图

```mermaid
flowchart TD
    A[组件初始化] --> B{读取localStorage}
    
    subgraph 修复前
        B --> C1[使用通用key: financialIndicatorsPreTaxRate]
        C1 --> D1[所有项目共享同一数据]
        D1 --> E1[项目A设置 → 影响项目B]
    end
    
    subgraph 修复后
        B --> C2[使用项目隔离key: financialIndicatorsPreTaxRate_{projectId}]
        C2 --> D2[每个项目独立数据]
        D2 --> E2[项目A设置 → 仅影响项目A]
    end
```

## 具体修改步骤

### 第1步：修改读取逻辑（第340-353行）

将：
```javascript
// 加载财务指标基准收益率设置
const savedPreTaxRate = localStorage.getItem('financialIndicatorsPreTaxRate');
const savedPostTaxRate = localStorage.getItem('financialIndicatorsPostTaxRate');

if (savedPreTaxRate !== null) {
  setPreTaxRate(Number(savedPreTaxRate));
  setTempPreTaxRate(Number(savedPreTaxRate));
}
if (savedPostTaxRate !== null) {
  setPostTaxRate(Number(savedPostTaxRate));
  setTempPostTaxRate(Number(savedPostTaxRate));
}
```

修改为：
```javascript
// 加载财务指标基准收益率设置（按项目隔离存储）
const projectId = context?.projectId || 'default';
const savedPreTaxRate = localStorage.getItem(`financialIndicatorsPreTaxRate_${projectId}`);
const savedPostTaxRate = localStorage.getItem(`financialIndicatorsPostTaxRate_${projectId}`);

if (savedPreTaxRate !== null) {
  setPreTaxRate(Number(savedPreTaxRate));
  setTempPreTaxRate(Number(savedPreTaxRate));
}
if (savedPostTaxRate !== null) {
  setPostTaxRate(Number(savedPostTaxRate));
  setTempPostTaxRate(Number(savedPostTaxRate));
}
```

### 第2步：修改保存逻辑（第3084-3099行）

将：
```javascript
<Button
  onClick={() => {
    // 保存设置并关闭弹窗
    setPreTaxRate(tempPreTaxRate);
    setPostTaxRate(tempPostTaxRate);
    localStorage.setItem('financialIndicatorsPreTaxRate', tempPreTaxRate.toString());
    localStorage.setItem('financialIndicatorsPostTaxRate', tempPostTaxRate.toString());
    
    // 强制刷新财务指标表
    setFinancialIndicatorsRefreshKey(prev => prev + 1);
    setShowFinancialIndicatorsSettings(false);
    
    // 重新打开财务指标表modal，保持用户操作流程连贯
    setTimeout(() => {
      setShowFinancialIndicatorsModal(true);
    }, 100);
  }}
>
  确定
</Button>
```

修改为：
```javascript
<Button
  onClick={() => {
    // 保存设置并关闭弹窗
    const projectId = context?.projectId || 'default';
    setPreTaxRate(tempPreTaxRate);
    setPostTaxRate(tempPostTaxRate);
    localStorage.setItem(`financialIndicatorsPreTaxRate_${projectId}`, tempPreTaxRate.toString());
    localStorage.setItem(`financialIndicatorsPostTaxRate_${projectId}`, tempPostTaxRate.toString());
    
    // 强制刷新财务指标表
    setFinancialIndicatorsRefreshKey(prev => prev + 1);
    setShowFinancialIndicatorsSettings(false);
    
    // 重新打开财务指标表modal，保持用户操作流程连贯
    setTimeout(() => {
      setShowFinancialIndicatorsModal(true);
    }, 100);
  }}
>
  确定
</Button>
```

## 验收标准

1. ✅ 在项目A设置基准收益率（所得税前）为3，所得税后为4
2. ✅ 切换到项目B，项目B的基准收益率应该显示默认值6，而不是项目A的3和4
3. ✅ 在项目B修改基准收益率后，切换回项目A，项目A的基准收益率保持不变

## 风险评估

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| context可能为null | 项目ID获取失败 | 使用 `'default'` 作为后备值 |
| 已有数据迁移 | 旧项目的数据可能丢失 | 保留旧key的兼容读取逻辑 |

## 后续优化建议

1. 考虑将这些设置存储到后端数据库中，而不是localStorage
2. 添加项目切换时的数据刷新机制，确保UI及时反映最新数据
