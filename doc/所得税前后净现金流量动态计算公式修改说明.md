# 所得税前后净现金流量动态计算公式修改说明

## 修改背景

根据用户需求，需要修改项目投资现金流量表中"所得税前净现金流量（动态）"和"所得税后净现金流量（动态）"的计算公式。

## 修改内容

### 1. 修改文件
- 文件路径：`client/src/components/revenue-cost/FinancialIndicatorsTable.tsx`
- 修改函数：`renderProfitTaxModal`（第1922行开始）
- 修改行号：第2578-2848行

### 2. 新的计算公式

#### 所得税前净现金流量（动态）
```
所得税前净现金流量（动态）=所得税前净现金流量/(1+A)^B
```

其中：
- A为：基准收益率（所得税前），从财务指标设置中的preTaxRate获取，转换为小数（如0.06）
- B为：计算期中的第n年，从建设期第1年开始计算，对应当前数据所在的列

#### 所得税后净现金流量（动态）
```
所得税后净现金流量（动态）=C-D/(1+E)^B
```

其中：
- C为：所得税前净现金流量（动态）
- D为：调整所得税
- E为：基准收益率（所得税后），从财务指标设置中的postTaxRate获取，转换为小数（如0.06）
- B为：计算期中的第n年，从建设期第1年开始计算，对应当前数据所在的列

### 3. 累计动态净现金流量的计算

#### 累计所得税前净现金流量（动态）
```
累计所得税前净现金流量（动态）= Σ(各年所得税前净现金流量（动态）)
```

#### 累计所得税后净现金流量（动态）
```
累计所得税后净现金流量（动态）= Σ(各年所得税后净现金流量（动态）)
```

## 技术实现

### 1. 所得税前净现金流量（动态）实现

```typescript
// 应用动态计算公式：所得税前净现金流量/(1+A)^B
// B从建设期第1年开始计算，所以直接使用year
const preTaxRate = preTaxRate / 100; // 转换为小数
const discountFactor = Math.pow(1 + preTaxRate, year);
const dynamicValue = yearPreTaxCashFlow / discountFactor;
```

### 2. 所得税后净现金流量（动态）实现

```typescript
// 应用动态计算公式：C-D/(1+E)^B
// B从建设期第1年开始计算，所以直接使用year
const postTaxRate = postTaxRate / 100; // 转换为小数
const discountFactor = Math.pow(1 + postTaxRate, year);
const dynamicValue = (yearPreTaxCashFlow - yearAdjustedTax) / discountFactor;
```

### 3. 建设期特殊处理

在建设期，由于只有现金流出，没有现金流入，所以：
- 所得税前净现金流量 = -现金流出
- 调整所得税 = 0（建设期没有调整所得税）

## 修改影响

1. **界面影响**：项目投资现金流量表中的动态净现金流量数据将按照新的公式计算
2. **功能影响**：动态净现金流量的计算更加符合财务分析的要求
3. **性能影响**：新增的计算逻辑对性能影响极小，因为计算量较小

## 测试建议

1. 验证所得税前净现金流量（动态）是否按照公式正确计算
2. 验证所得税后净现金流量（动态）是否按照公式正确计算
3. 验证累计动态净现金流量是否正确累计
4. 测试不同基准收益率设置下的计算结果
5. 验证建设期和运营期的不同计算逻辑
6. 验证Excel导出功能是否包含正确的动态计算数据

## 注意事项

1. 基准收益率A和E使用小数值（如0.06），不是百分比（如6%）
2. B从建设期第1年开始计算，不是从运营期开始
3. 建设期的净现金流量为负值，因为只有现金流出
4. 建设期的调整所得税为0
5. 动态计算公式应用于每一年的数据，然后累计得到合计值