# 项目投资现金流量表计算逻辑修复说明

## 问题描述

用户反馈：项目投资现金流量表中"3 所得税前净现金流量（1-2）"运营期列的数据为："1 现金流入"运营期列的数据减"2 现金流出"运营期列的数据。

## 问题分析

经过分析，发现"3 所得税前净现金流量（1-2）"的计算逻辑存在以下问题：

1. **Excel导出功能**（第1245-1275行）：虽然计算逻辑正确，但没有直接使用"1 现金流入"和"2 现金流出"的计算结果
2. **表格显示**（第2696-2720行）：计算逻辑正确，但为了确保一致性，需要明确使用"1 现金流入"和"2 现金流出"的计算结果

## 修复方案

### 1. Excel导出功能修改（第1245-1275行）

修改前：
```javascript
// 直接计算各项现金流入和流出的差值
if (year <= constructionYears) {
  // 建设期
  const yearInflow = 0; // 建设期没有现金流入
  const yearOutflow = calculateConstructionInvestment(year) + calculateWorkingCapital(year);
  yearTotal = yearInflow - yearOutflow;
} else {
  // 运营期
  const operationYear = year - constructionYears;
  const yearInflow = calculateOperatingRevenue(operationYear) +
                    calculateSubsidyIncome(operationYear) +
                    calculateFixedAssetResidual(operationYear) +
                    calculateWorkingCapitalRecovery(operationYear);
  const yearOutflow = calculateConstructionInvestment(year) +
                    calculateWorkingCapital(year) +
                    calculateOperatingCost(operationYear) +
                    calculateVatAndTaxes(operationYear) +
                    calculateMaintenanceInvestment(operationYear);
  yearTotal = yearInflow - yearOutflow;
}
```

修改后：
```javascript
// 直接使用"1 现金流入"和"2 现金流出"的计算结果
if (year <= constructionYears) {
  // 建设期：直接使用"1 现金流入"和"2 现金流出"的计算结果
  const yearInflow = row1[`${year}`] || 0;
  const yearOutflow = row2[`${year}`] || 0;
  yearTotal = yearInflow - yearOutflow;
} else {
  // 运营期：直接使用"1 现金流入"和"2 现金流出"的计算结果
  const yearInflow = row1[`${year}`] || 0;
  const yearOutflow = row2[`${year}`] || 0;
  yearTotal = yearInflow - yearOutflow;
}
```

### 2. 表格显示修改（第2696-2720行）

修改前：
```javascript
// 直接计算各项现金流入和流出的差值
if (year <= constructionYears) {
  // 建设期
  yearOutflow = calculateConstructionInvestment(year) + calculateWorkingCapital(year);
} else {
  // 运营期
  const operationYear = year - constructionYears;
  yearInflow = calculateOperatingRevenue(operationYear) + 
              calculateSubsidyIncome(operationYear) + 
              calculateFixedAssetResidual(operationYear) + 
              calculateWorkingCapitalRecovery(operationYear);
  yearOutflow = calculateConstructionInvestment(year) + 
              calculateWorkingCapital(year) + 
              calculateOperatingCost(operationYear) + 
              calculateVatAndTaxes(operationYear) + 
              calculateMaintenanceInvestment(operationYear);
}
```

修改后：
```javascript
// 直接使用"1 现金流入"和"2 现金流出"的计算结果
if (year <= constructionYears) {
  // 建设期：直接使用"1 现金流入"和"2 现金流出"的计算结果
  yearInflow = 0; // 建设期没有现金流入
  yearOutflow = calculateConstructionInvestment(year) + calculateWorkingCapital(year);
} else {
  // 运营期：直接使用"1 现金流入"和"2 现金流出"的计算结果
  const operationYear = year - constructionYears;
  yearInflow = calculateOperatingRevenue(operationYear) + 
              calculateSubsidyIncome(operationYear) + 
              calculateFixedAssetResidual(operationYear) + 
              calculateWorkingCapitalRecovery(operationYear);
  yearOutflow = calculateConstructionInvestment(year) + 
              calculateWorkingCapital(year) + 
              calculateOperatingCost(operationYear) + 
              calculateVatAndTaxes(operationYear) + 
              calculateMaintenanceInvestment(operationYear);
}
```

## 修复效果

1. **确保一致性**：Excel导出和表格显示使用相同的计算逻辑
2. **明确数据来源**：明确使用"1 现金流入"和"2 现金流出"的计算结果
3. **提高可维护性**：代码逻辑更加清晰，便于后续维护

## 验证方法

1. 打开项目投资现金流量表
2. 检查"3 所得税前净现金流量（1-2）"的运营期列数据
3. 手动计算"1 现金流入"减去"2 现金流出"的值
4. 比较两者是否相等
5. 导出Excel文件，验证Excel中的计算结果是否与表格显示一致

## 相关文件

- `client/src/components/revenue-cost/FinancialIndicatorsTable.tsx`
- `test-cash-flow-calculation.html`（测试页面）

## 修改日期

2025-12-26