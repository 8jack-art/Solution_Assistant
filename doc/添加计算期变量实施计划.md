# 添加"计算期"可用变量实施计划

## 需求概述

在投资项目方案报告生成页面的"可用变量"card下"基本信息"分类添加一个可用变量"计算期"。

## 目标数据结构

```json
{
  "title": "项目计算期",
  "计算期": 16,
  "建设期年限": 1,
  "运营期年限": 15
}
```

**计算公式**：计算期 = 建设期年限 + 运营期年限

## 数据来源

从 `{{DATA:loan_repayment_section12}}` 变量中提取：
- `建设期年限`：来源于 `basicInfo.建设期年限`
- `运营期年限`：来源于 `basicInfo.运营期年限`

## 实施步骤

### 步骤1：在 reportStore.ts 中添加计算期变量定义

在 `client/src/stores/reportStore.ts` 的 `loadProjectData` 函数中，添加计算期变量：

```typescript
// 在 variables 数组中添加计算期变量（约第690行后）
{ key: '{{calculation_period}}', label: '计算期', value: (() => {
  // 从 loan_repayment_section12 中提取建设期年限和运营期年限
  const section12JSON = tableDataJSON['DATA:loan_repayment_section12'] || '{}'
  let section12Data = {}
  try {
    section12Data = typeof section12JSON === 'string' ? JSON.parse(section12JSON) : section12JSON
  } catch (e) {
    section12Data = {}
  }
  
  const basicInfo = section12Data.basicInfo || {}
  const constructionYears = basicInfo.建设期年限 || 0
  const operationYears = basicInfo.运营期年限 || 0
  const calculationPeriod = constructionYears + operationYears
  
  return JSON.stringify({
    title: '项目计算期',
    计算期: calculationPeriod,
    建设期年限: constructionYears,
    运营期年限: operationYears
  }, null, 2)
})() },
```

### 步骤2：在 VariablePicker.tsx 中添加计算期变量UI

在 `client/src/components/report/VariablePicker.tsx` 的"基本信息"分类中添加Badge组件：

```typescript
{/* 在"基本信息"分类的Group中（约第209行前）添加 */}
<Badge
  variant="light"
  color="blue"
  style={{ cursor: 'pointer' }}
  onClick={() => handleCopyVariable('{{calculation_period}}')}
  title="点击复制"
  rightSection={
    <Tooltip label="查看JSON数据">
      <ActionIcon
        size="xs"
        variant="transparent"
        color="blue"
        onClick={(e) => {
          e.stopPropagation()
          handleViewJson('{{calculation_period}}', '项目计算期')
        }}
      >
        <Eye size={12} />
      </ActionIcon>
    </Tooltip>
  }
>
  计算期
</Badge>
```

### 步骤3：在 VariableMenu.tsx 中添加变量配置

在 `client/src/components/report/VariableMenu.tsx` 中：

1. 在 `variableGroups` 的 `filterKeys` 数组中添加 `'{{calculation_period}}'` 到"投资数据"分组
2. 在 `variableDetails` 中添加配置：

```typescript
'{{calculation_period}}': { 
  label: '计算期', 
  description: '项目计算期JSON数据，包含计算期、建设期年限、运营期年限' 
}
```

## 相关文件

| 文件 | 修改内容 |
|------|----------|
| `client/src/stores/reportStore.ts` | 在 `loadProjectData` 函数中添加 `{{calculation_period}}` 变量定义（约10行代码） |
| `client/src/components/report/VariablePicker.tsx` | 在"基本信息"分类添加计算期变量Badge组件（约15行代码） |
| `client/src/components/report/VariableMenu.tsx` | 添加变量配置（2处修改，约5行代码） |

## 数据来源说明

| 字段 | 数据来源 |
|------|----------|
| 建设期年限 | `tableDataJSON['DATA:loan_repayment_section12'].basicInfo.建设期年限` |
| 运营期年限 | `tableDataJSON['DATA:loan_repayment_section12'].basicInfo.运营期年限` |
| 计算期 | 建设期年限 + 运营期年限 |

## 功能说明

- **点击复制**：点击Badge主体可复制变量 `{{calculation_period}}`
- **查看JSON**：点击右侧眼睛图标可查看完整的JSON数据结构
- **数据实时更新**：当项目数据变化时，计算期会自动重新计算
