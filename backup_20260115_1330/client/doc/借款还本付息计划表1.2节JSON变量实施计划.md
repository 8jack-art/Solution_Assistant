# 借款还本付息计划表1.2节JSON变量实施计划

## 需求概述

重写投资项目方案报告生成模块里，可用变量card中"借款还本付息计划表"可用变量，使其JSON数据来源于"借款还本付息计划表"modal表格中**序号为1.2及其子项**的值。

## 目标数据结构

从 [`LoanRepaymentScheduleTable.tsx`](client/src/components/revenue-cost/LoanRepaymentScheduleTable.tsx) 中提取序号1.2及其子项：

| 序号 | 项目 | 说明 |
|------|------|------|
| 1.2 | 当期还本付息 | 主行 |
| （空） | 其中：还本 | 1.2的子项 |
| （空） | 付息 | 1.2的子项 |

## 输出JSON结构

```json
{
  "title": "借款还本付息计划表-当期还本付息",
  "basicInfo": {
    "贷款总额": 5000,
    "年利率": 0.05,
    "贷款期限": 12,
    "建设期年限": 2,
    "运营期年限": 10
  },
  "section12": {
    "当期还本付息": {
      "序号": "1.2",
      "项目": "当期还本付息",
      "合计": 150.00,
      "建设期": [25.50, 38.25],
      "运营期": [43.25, 43.00, ...]
    },
    "其中还本": {
      "序号": "",
      "项目": "其中：还本",
      "合计": 86.25,
      "建设期": [0, 0],
      "运营期": [18.25, 23.00, ...]
    },
    "付息": {
      "序号": "",
      "项目": "付息",
      "合计": 150.00,
      "建设期": [25.50, 38.25],
      "运营期": [25.00, 20.00, ...]
    }
  },
  "interestSummary": {
    "建设期利息总和": 63.75,
    "运营期利息总和": 86.25,
    "贷款利息总和": 150.00
  }
}
```

## 实施步骤

### 步骤1: 创建新函数 `buildLoanRepaymentSection12JSON`

在 [`tableResourceBuilder.ts`](client/src/utils/tableResourceBuilder.ts) 中添加新函数（第1577行后）：

```typescript
/**
 * 构建借款还本付息计划表JSON数据 - 仅1.2节（当期还本付息及子项）
 * 用于LLM提示词
 * 
 * 输出结构：
 * - basicInfo: 基本信息（贷款总额、年利率、贷款期限、建设期年限、运营期年限）
 * - section12: 序号1.2及其子项数据
 * - interestSummary: 利息汇总（建设期利息总和、运营期利息总和、贷款利息总和）
 */
export function buildLoanRepaymentSection12JSON(loanData: any, context?: any): string {
  if (!loanData) return '{}'
  
  // 获取建设期和运营期
  let constructionYears = 2
  let operationYears = 10
  
  if (context) {
    constructionYears = context.constructionYears || constructionYears
    operationYears = context.operationYears || operationYears
  }
  
  if (loanData.partF?.建设期年限) {
    constructionYears = loanData.partF.建设期年限
  }
  
  const totalYears = constructionYears + operationYears
  const loanTerm = context?.loanTerm || totalYears // 贷款期限
  
  // 解析还款计划数据
  const repaymentSchedule = loanData.loan_repayment_schedule_simple || 
                            loanData.loan_repayment_schedule_detailed ||
                            loanData.construction_interest_details
  
  let scheduleData = null
  if (repaymentSchedule) {
    if (typeof repaymentSchedule === 'string') {
      try {
        scheduleData = JSON.parse(repaymentSchedule)
      } catch (e) {}
    } else {
      scheduleData = repaymentSchedule
    }
  }
  
  // 构建JSON结构
  const jsonData: any = {
    title: '借款还本付息计划表-当期还本付息',
    basicInfo: {
      贷款总额: loanData.partF?.贷款总额 || 0,
      年利率: loanData.partF?.年利率 || 0,
      贷款期限: loanTerm,
      建设期年限: constructionYears,
      运营期年限: operationYears
    },
    section12: {},
    interestSummary: {
      建设期利息总和: 0,
      运营期利息总和: 0,
      贷款利息总和: 0
    }
  }
  
  // 从分年利息获取建设期利息数据
  const yearlyInterestData = loanData.partF?.分年利息 || []
  let constructionInterestTotal = 0
  yearlyInterestData.forEach((data: any, idx: number) => {
    if (idx < constructionYears) {
      constructionInterestTotal += data?.当期利息 || 0
    }
  })
  jsonData.interestSummary.建设期利息总和 = Number(constructionInterestTotal.toFixed(2))
  
  // 提取section12数据
  if (scheduleData?.rows && Array.isArray(scheduleData.rows)) {
    let foundSection12 = false
    let operationInterestTotal = 0
    
    scheduleData.rows.forEach((row: any) => {
      // 查找序号1.2的行
      if (row.序号 === '1.2') {
        foundSection12 = true
        jsonData.section12['当期还本付息'] = {
          序号: row.序号,
          项目: row.项目,
          合计: row.合计,
          建设期: row.建设期 || [],
          运营期: row.运营期 || []
        }
      }
      
      // 查找子项"其中：还本"（序号为空，项目名包含"还本"）
      if (foundSection12 && row.序号 === '' && row.项目?.includes('还本')) {
        jsonData.section12['其中还本'] = {
          序号: row.序号,
          项目: row.项目,
          合计: row.合计,
          建设期: row.建设期 || [],
          运营期: row.运营期 || []
        }
      }
      
      // 查找子项"付息"（序号为空，项目名为"付息"）
      if (foundSection12 && row.序号 === '' && row.项目 === '付息') {
        jsonData.section12['付息'] = {
          序号: row.序号,
          项目: row.项目,
          合计: row.合计,
          建设期: row.建设期 || [],
          运营期: row.运营期 || []
        }
        
        // 计算运营期利息总和
        if (row.运营期 && Array.isArray(row.运营期)) {
          operationInterestTotal = row.运营期.reduce((sum: number, val: number) => sum + (val || 0), 0)
        }
      }
    })
    
    jsonData.interestSummary.运营期利息总和 = Number(operationInterestTotal.toFixed(2))
  }
  
  // 计算贷款利息总和
  jsonData.interestSummary.贷款利息总和 = Number(
    (jsonData.interestSummary.建设期利息总和 + jsonData.interestSummary.运营期利息总和).toFixed(2)
  )
  
  return JSON.stringify(jsonData, null, 2)
}
```

### 步骤2: 在VariableMenu.tsx中添加新变量

在 [`VariableMenu.tsx`](client/src/components/report/VariableMenu.tsx) 中：

1. 在 `variableGroups` 的 `filterKeys` 数组中添加 `'{{DATA:loan_repayment_section12}}'`
2. 在 `variableDetails` 中添加配置：
```typescript
'{{DATA:loan_repayment_section12}}': { 
  label: '借款还本付息计划表1.2节JSON', 
  description: '借款还本付息计划表中序号1.2当期还本付息及其子项的JSON数据，包含贷款基本信息、section12数据、利息汇总' 
}
```

### 步骤3: 在buildAllTableDataJSON中集成新函数

在 [`tableResourceBuilder.ts`](client/src/utils/tableResourceBuilder.ts) 的 `buildAllTableDataJSON` 函数中添加：

```typescript
// 借款还本付息计划表1.2节
jsonData['DATA:loan_repayment_section12'] = buildLoanRepaymentSection12JSON(
  projectData.investment, context
)
```

## 相关文件

| 文件 | 修改内容 |
|------|---------|
| [`client/src/utils/tableResourceBuilder.ts`](client/src/utils/tableResourceBuilder.ts) | 添加 `buildLoanRepaymentSection12JSON` 函数（约100行），在 `buildAllTableDataJSON` 中集成 |
| [`client/src/components/report/VariableMenu.tsx`](client/src/components/report/VariableMenu.tsx) | 添加新变量 `{{DATA:loan_repayment_section12}}` 的配置（2处） |

## 数据来源说明

| 字段 | 数据来源 |
|------|---------|
| 贷款总额 | `loanData.partF.贷款总额` |
| 年利率 | `loanData.partF.年利率` |
| 贷款期限 | `context.loanTerm` 或 `totalYears` |
| 建设期年限 | `context.constructionYears` 或 `loanData.partF.建设期年限` |
| 运营期年限 | `context.operationYears` |
| 建设期利息总和 | 从 `loanData.partF.分年利息` 计算建设期各年利息之和 |
| 运营期利息总和 | 从 `scheduleData.rows` 中"付息"行的运营期数据求和 |
| 贷款利息总和 | 建设期利息总和 + 运营期利息总和 |
