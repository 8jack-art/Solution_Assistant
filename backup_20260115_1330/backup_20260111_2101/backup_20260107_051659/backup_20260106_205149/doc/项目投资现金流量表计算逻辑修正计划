# 项目投资现金流量表计算逻辑修正计划

目标

以Excel导出文件为绝对基准，修正"## 任务3 所得税前净现金流量（1-2）"行之后所有行及其各列在系统渲染时的计算逻辑，确保系统生成的表格数据与Excel导出结果逐项完全吻合。

## 现状分析

### Excel导出逻辑（正确基准）

Excel导出函数 `handleExportProfitTaxTable`（第1227-1530行）直接使用 `generateCashFlowTableData` 函数生成的标准化数据：

```typescript
const cashFlowTableData = generateCashFlowTableData(
  context,
  calculateConstructionInvestment,
  calculateWorkingCapital,
  calculateOperatingRevenue,  // 不含税营业收入
  calculateSubsidyIncome,
  calculateFixedAssetResidual,
  calculateWorkingCapitalRecovery,
  calculateOperatingCost,
  calculateVatAndTaxes,
  calculateMaintenanceInvestment,
  calculateAdjustedIncomeTax,
  calculateOperatingCostWithoutTax,
  preTaxRate,
  postTaxRate
);
```

各行数据来源：
- **Row 3**: `yearData.preTaxCashFlow`
- **Row 4**: `yearData.cumulativePreTaxCashFlow`
- **Row 5**: `calculateAdjustedIncomeTax(operationYear)`
- **Row 6**: `yearData.postTaxCashFlow`
- **Row 7**: `yearData.cumulativePostTaxCashFlow`
- **Row 8-11**: `yearData.preTaxCashFlowDynamic` 等动态数据

### 表格渲染逻辑（存在问题）

表格渲染的 `profitTaxTableData` useMemo（第2274-2896行）存在多处独立计算，与Excel导出不一致。

## 差异点详细分析

### 差异1：Row 3 所得税前净现金流量（1-2）

**Excel导出（正确）**:
```typescript
// 使用 cashFlowTableData.yearlyData[year - 1].preTaxCashFlow
const yearData = cashFlowTableData.yearlyData[year - 1];
const yearTotal = yearData ? yearData.preTaxCashFlow : 0;
```

**表格渲染（错误）**:
```typescript
// 第2471-2513行：独立计算，未使用 cashFlowTableData
yearlyData: years.map(year => {
  let yearInflow = 0;
  let yearOutflow = 0;
  // ... 独立计算逻辑
  return { year, value: yearInflow - yearOutflow };
})
```

### 差异2：Row 4 累计所得税前净现金流量

**表格渲染问题**：使用独立累计计算，而非使用 `yearData.cumulativePreTaxCashFlow`

### 差异3：Row 6 所得税后净现金流量

**表格渲染问题**：独立计算，未使用 `yearData.postTaxCashFlow`

### 差异4：Row 7 累计所得税后净现金流量

**关键问题**：使用了错误的营业收入函数

**表格渲染（错误）**:
```typescript
// 第2633行：使用含税营业收入
yearInflow = calculateTaxableOperatingRevenue(operationYear) + ...
```

**Excel导出（正确）**:
```typescript
// 使用不含税营业收入
yearInflow = calculateOperatingRevenue(operationYear) + ...
// 即：yearData.operatingRevenue = calculateOperatingRevenue(operationYear)
```

### 差异5：动态计算行（Row 8-11）

**表格渲染问题**：同样使用 `calculateTaxableOperatingRevenue` 而非 `calculateOperatingRevenue`

**涉及行**：
- 第2708行：所得税前净现金流量（动态）
- 第2757行：累计所得税前净现金流量（动态）
- 第2811行：所得税后净现金流量（动态）
- 第2866行：累计所得税后净现金流量（动态）

## 修复方案

### 核心原则

1. **统一数据源**：表格渲染应直接使用 `generateCashFlowTableData` 返回的 `cashFlowTableData`，而非独立计算
2. **复用Excel导出逻辑**：确保渲染逻辑与导出逻辑使用相同的计算函数和公式
3. **遵循编码规范**：计算逻辑前置化，使用useMemo缓存

### 具体修复步骤

#### 步骤1：重构 profitTaxTableData 使用 cashFlowTableData

将 `profitTaxTableData` 的各行数据直接映射自 `cashFlowTableData`：

```typescript
const profitTaxTableData = useMemo(() => {
  const cashFlowTableData = generateCashFlowTableData(...);
  
  const tableRows = [
    // Row 3: 所得税前净现金流量（1-2）
    {
      id: '3',
      name: '所得税前净现金流量（1-2）',
      total: cashFlowTableData.totals.totalPreTaxCashFlow,
      yearlyData: years.map(year => ({
        year,
        value: cashFlowTableData.yearlyData[year - 1]?.preTaxCashFlow ?? 0
      }))
    },
    // Row 4: 累计所得税前净现金流量
    {
      id: '4',
      name: '累计所得税前净现金流量',
      total: cashFlowTableData.yearlyData.reduce((sum, d) => sum + d.cumulativePreTaxCashFlow, 0),
      yearlyData: years.map(year => ({
        year,
        value: cashFlowTableData.yearlyData[year - 1]?.cumulativePreTaxCashFlow ?? 0
      }))
    },
    // Row 5: 调整所得税
    {
      id: '5',
      name: '调整所得税',
      total: cashFlowTableData.totals.totalAdjustedIncomeTax,
      yearlyData: years.map(year => ({
        year,
        value: cashFlowTableData.yearlyData[year - 1]?.adjustedIncomeTax ?? 0
      }))
    },
    // Row 6: 所得税后净现金流量
    {
      id: '6',
      name: '所得税后净现金流量',
      total: cashFlowTableData.totals.totalPostTaxCashFlow,
      yearlyData: years.map(year => ({
        year,
        value: cashFlowTableData.yearlyData[year - 1]?.postTaxCashFlow ?? 0
      }))
    },
    // Row 7: 累计所得税后净现金流量
    {
      id: '7',
      name: '累计所得税后净现金流量',
      total: cashFlowTableData.yearlyData.reduce((sum, d) => sum + d.cumulativePostTaxCashFlow, 0),
      yearlyData: years.map(year => ({
        year,
        value: cashFlowTableData.yearlyData[year - 1]?.cumulativePostTaxCashFlow ?? 0
      }))
    }
  ];
  
  // 动态计算行
  const dynamicRows = [
    {
      id: '1',
      name: '所得税前净现金流量（动态）',
      total: cashFlowTableData.yearlyData.reduce((sum, d) => sum + d.preTaxCashFlowDynamic, 0),
      yearlyData: years.map(year => ({
        year,
        value: cashFlowTableData.yearlyData[year - 1]?.preTaxCashFlowDynamic ?? 0
      }))
    },
    {
      id: '2',
      name: '累计所得税前净现金流量（动态）',
      total: cashFlowTableData.yearlyData[cashFlowTableData.yearlyData.length - 1]?.cumulativePreTaxCashFlowDynamic ?? 0,
      yearlyData: years.map(year => ({
        year,
        value: cashFlowTableData.yearlyData[year - 1]?.cumulativePreTaxCashFlowDynamic ?? 0
      }))
    },
    {
      id: '3',
      name: '所得税后净现金流量（动态）',
      total: cashFlowTableData.yearlyData.reduce((sum, d) => sum + d.postTaxCashFlowDynamic, 0),
      yearlyData: years.map(year => ({
        year,
        value: cashFlowTableData.yearlyData[year - 1]?.postTaxCashFlowDynamic ?? 0
      }))
    },
    {
      id: '4',
      name: '累计所得税后净现金流量（动态）',
      total: cashFlowTableData.yearlyData[cashFlowTableData.yearlyData.length - 1]?.cumulativePostTaxCashFlowDynamic ?? 0,
      yearlyData: years.map(year => ({
        year,
        value: cashFlowTableData.yearlyData[year - 1]?.cumulativePostTaxCashFlowDynamic ?? 0
      }))
    }
  ];
  
  return { years, tableRows, dynamicRows };
}, [context, preTaxRate, postTaxRate, ...]);
```

#### 步骤2：删除重复的独立计算逻辑

删除以下位置的重复计算代码：
- 第2471-2513行：Row 3 的独立计算
- 第2514-2560行：Row 4 的独立计算
- 第2574-2620行：Row 6 的独立计算
- 第2621-2671行：Row 7 的独立计算（含错误的 calculateTaxableOperatingRevenue）
- 第2675-2886行：动态计算行的独立计算

#### 步骤3：验证 renderProfitTaxModal 渲染逻辑

确保渲染函数直接使用预计算的 `tableRows` 和 `dynamicRows`，JSX中不做任何计算。

## 涉及修改的文件和代码位置

| 文件 | 位置 | 修改内容 |
|------|------|----------|
| `client/src/components/revenue-cost/FinancialIndicatorsTable.tsx` | 第2274-2896行 `profitTaxTableData` useMemo | 重构为直接使用 cashFlowTableData |
| `client/src/components/revenue-cost/FinancialIndicatorsTable.tsx` | 第2898-2965行 `renderProfitTaxModal` | 检查并确保使用预计算数据 |

## 验证方法

1. **导出Excel并对比**：
   - 打开项目投资现金流量表
   - 点击导出Excel
   - 对比导出的数值与表格显示的数值

2. **使用JSON数据导出验证**：
   - 点击查看JSON数据
   - 导出JSON并与Excel导出对比

3. **控制台调试**：
   - 在 `profitTaxTableData` 计算中添加日志
   - 输出各行的 total 和 yearlyData 值
   - 与 `handleExportProfitTaxTable` 中的值对比

## 数据流程图

```mermaid
graph TD
    subgraph "Excel导出 - 正确逻辑"
        A[generateCashFlowTableData] --> B[cashFlowTableData]
        B --> C[Row 3: preTaxCashFlow]
        B --> D[Row 4: cumulativePreTaxCashFlow]
        B --> E[Row 5: adjustedIncomeTax]
        B --> F[Row 6: postTaxCashFlow]
        B --> G[Row 7: cumulativePostTaxCashFlow]
        B --> H[动态数据]
        C --> I[Excel导出]
        D --> I
        E --> I
        F --> I
        G --> I
        H --> I
    end
    
    subgraph "表格渲染 - 问题逻辑"
        J[独立计算] --> K[Row 3: 错误值]
        J --> L[Row 4: 错误值]
        J --> M[Row 7: 含税收入错误]
        J --> N[动态行: 含税收入错误]
        K --> O[表格渲染]
        L --> O
        M --> O
        N --> O
    end
    
    subgraph "修复后 - 统一逻辑"
        P[generateCashFlowTableData] --> Q[cashFlowTableData]
        Q --> R[直接映射各行数据]
        R --> S[Excel导出]
        R --> T[表格渲染]
    end
    
    style I fill:#90EE90
    style O fill:#FFB6C1
    style S fill:#90EE90
    style T fill:#90EE90
```

## 注意事项

1. **不要修改Excel导出逻辑**：Excel导出逻辑已经正确，作为唯一基准
2. **不要修改 generateCashFlowTableData**：该函数已经正确实现，确保渲染逻辑向其对齐
3. **确保依赖项完整**：`useMemo` 的依赖数组需要包含所有影响计算的因素
4. **测试边界情况**：建设期年份、运营期年份为0等特殊情况
