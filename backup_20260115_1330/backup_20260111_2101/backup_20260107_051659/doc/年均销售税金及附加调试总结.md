# 年均销售税金及附加调试总结

## 问题描述

用户反馈"年均销售税金及附加"值不正确。

## 当前实现

### 计算公式

```
年均销售税金及附加 = 销售税金及附加合计 ÷ 运营期年数
                   = calculateTaxAndSurcharges(合计) ÷ context.operationYears
```

### 数据来源

1. **主要数据源**：`revenueTableData.rows.find(r => r.序号 === '3').合计`
2. **备用计算**：`calculateOtherTaxesAndSurcharges()` 函数

### 计算逻辑（generateRevenueTableData 中的实现）

```typescript
// 3. 其他税费及附加
const row3 = { 序号: '3', 收入项目: '其他税费及附加', 合计: 0, 运营期: [] as number[] }
years.forEach((year) => {
  const vatAmount = state.calculateVatForYear(year, deductibleInputTax)
  const urbanTax = vatAmount * urbanTaxRate           // 城市维护建设税 (默认7%)
  const educationTax = vatAmount * 0.05               // 教育费附加 (5%)
  const otherTaxes = urbanTax + educationTax
  row3.运营期.push(otherTaxes)
  row3.合计 += otherTaxes
})
```

### 增值税计算逻辑

```
增值税 = 销项税额 - 进项税额 - 进项税额（固定资产待抵扣）

其中：
- 销项税额 = Σ(各产品含税收入 - 各产品含税收入/(1+增值税率))
- 进项税额 = Σ(外购原材料进项税) + Σ(外购燃料动力进项税)
```

## 已添加的调试信息

在 `FinancialIndicatorsTable.tsx` 的 `financialSummaryRows` 中添加了详细的控制台调试输出：

```
========== 年均销售税金及附加调试信息 ==========
1. calculateTaxAndSurcharges(合计) = [值]
2. calculateVatAndTaxes(合计) = [值]
3. context.operationYears = [值]
4. revenueTableData 状态: {...}
5. revenueTableData.序号3 = {...}

========== 年均销售税金及附加代数计算过程 ==========
代数表达式: 年均销售税金及附加 = 销售税金及附加合计 ÷ 运营年数
           = calculateTaxAndSurcharges(合计) ÷ context.operationYears
           = [合计值] ÷ [运营期年数]
           = [年均值] (万元)
```

## 可能的问题原因

| 原因 | 排查方法 |
|------|----------|
| `revenueTableData` 未生成 | 检查 `rowsExist` 是否为 `true` |
| 序号3的行不存在 | 检查 `row3Exist` 是否为 `true` |
| 序号3的`合计`为0 | 检查 `revenueTableData.序号3.合计` 值 |
| `revenueItems` 为空 | 检查是否有收入项数据 |
| 增值税计算为0 | 检查销项税额和进项税额计算 |

## 调试步骤

1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签
3. 点击"财务评价指标汇总表"按钮
4. 查看控制台中的调试输出

## 相关文件

- `client/src/components/revenue-cost/FinancialIndicatorsTable.tsx` - 财务评价指标汇总表
- `client/src/stores/revenueCostStore.ts` - 收入成本状态管理
- `client/src/components/revenue-cost/DynamicRevenueTable.tsx` - 营业收入表

## 后续修复建议

如果调试发现数据源有问题，需要检查：

1. `DynamicRevenueTable` 是否正确生成了 `revenueTableData`
2. `generateRevenueTableData` 函数是否正确执行
3. `revenueItems` 是否有数据
4. `costConfig` 中的进项税配置是否正确
