这份文档将作为开发、测试和产品验收的基准。我已将你的需求整理为标准的**产品需求文档 (PRD)** 格式，涵盖了功能、UI、技术实现及验收标准。
---
# 投资项目智能报告生成模块 - 需求文档 (PRD)
| 文档版本 | V1.0 |
| :--- | :--- |
| **撰写日期** | 2023-10-27 |
| **项目名称** | 投资项目管理系统 |
| **模块名称** | 智能报告生成 |
---
## 1. 项目背景与目标
### 1.1 背景
现有投资管理系统已具备投资估算、收入成本分析、财务指标计算等核心模块。然而，项目最终的投资方案报告仍需人工撰写，效率低且容易遗漏关键数据。
### 1.2 目标
开发一个**智能报告生成模块**，集成大语言模型（LLM）能力，自动整合项目各阶段数据，实时生成专业的投资方案报告，并支持导出为 Word 文档。该模块需置于财务指标模块之后，作为项目分析的收尾环节。
---
## 2. 功能需求
### 2.1 LLM 大模型集成
- **核心能力**：利用现有 LLM 配置（参考 `LLMProvider`），基于用户输入的提示词和项目数据生成报告。
- **流式响应**：必须支持流式输出，实现“打字机”效果，让用户实时看到内容生成过程。
- **超时控制**：优化调用性能，避免因生成时间过长导致 HTTP 请求超时。
### 2.2 提示词编辑与管理
- **富文本编辑**：提供基于 Tiptap 的富文本编辑器，支持文本格式化（加粗、列表、标题等），以增强提示词的可读性和结构化。
- **变量引用**：支持在提示词中插入项目数据变量（如 `{{project_name}}`、`{{total_investment}}`、`{{roi}}`）。
- **模板功能**：
  - 支持将当前提示词保存为模板。
  - 支持加载已保存的模板，方便快速复用。
  - 提供“变量提示”功能，告诉用户当前可用的数据字段有哪些。
### 2.3 实时生成控制
- **状态反馈**：界面需明确显示“正在生成”、“暂停”、“完成”等状态，并伴有视觉反馈（如光标闪烁动画）。
- **交互控制**：
  - **开始**：触发生成任务。
  - **暂停**：暂停当前的流式输出（但不中断后端连接）。
  - **继续**：恢复暂停的输出。
  - **停止/重置**：清空当前内容，重新开始。
### 2.4 Word 格式预览与导出
- **实时预览**：在生成过程中和完成后，右侧（或独立区域）需提供类似 Word 文档的 A4 纸张预览效果。
- **样式还原**：预览需尽可能还原 Word 的排版（标题层级、缩进、段落间距），支持 Markdown 渲染或 HTML 渲染。
- **文档导出**：
  - 支持一键导出为 `.docx` 格式。
  - 导出的文档需保持良好的格式，包含标题、正文、列表、表格（如有）。
  - 支持自定义文档元数据（如文件名默认包含项目名称）。
### 2.5 数据关联与注入
- **自动数据抓取**：系统应根据当前选中的项目 ID，自动抓取“投资估算”、“财务指标”、“现金流量”、“收入成本分析”等模块的数据。
- **模板变量替换**：在发送请求给 LLM 之前，后端需将提示词中的 `{{变量}}` 替换为实际的业务数据。
### 2.6 历史记录
- **生成历史**：系统应记录每次生成的报告快照（标题、生成时间、部分内容摘要），允许用户查看历史版本。
---
## 3. 用户界面设计 (UI/UX)
### 3.1 整体布局
采用 **分屏布局**（左侧编辑，右侧预览）：
- **左侧区域 (30-40%)**：
  - 提示词编辑器（富文本）。
  - 模板选择下拉框。
  - 可用变量列表（Chip 样式，点击可插入）。
  - 控制按钮组（生成、暂停、重置）。
- **右侧区域 (60-70%)**：
  - A4 纸张模拟预览区（灰色背景，白色纸张居中）。
  - 导出按钮悬浮或置于顶部工具栏。
### 3.2 设计规范
- **组件库**：严格遵循 **Mantine UI** 设计规范（颜色、字体、圆角、阴影）。
- **响应式**：在移动端自动切换为上下布局，确保操作可用。
- **空状态**：预览区在无内容时显示占位图或引导文案。
---
## 4. 技术实现要求
### 4.1 前端技术栈
- **框架**：React 18 + TypeScript。
- **UI 组件**：Mantine UI (`@mantine/core`, `@mantine/hooks`)。
- **富文本**：`@tiptap/react` 及其扩展包。
- **状态管理**：Zustand（新建 `reportStore`）。
- **HTTP 客户端**：Axios（用于普通 API），原生 `fetch`（用于处理流式响应）。
- **安全**：使用 `dompurify` 对 LLM 返回的 HTML 进行净化，防止 XSS 攻击。
### 4.2 后端技术栈
- **框架**：Express + TypeScript。
- **架构**：遵循现有的 MVC 模式（Controller -> Service -> Repository）。
- **数据库**：MySQL（存储报告模板、生成历史记录）。
- **文档生成**：使用 `docx` 库将内容转换为 Word 文档流。
### 4.3 性能与安全
- **流式传输**：后端使用 `Server-Sent Events (SSE)` 或 HTTP Chunked Transfer 将 LLM 的响应实时推送到前端。
- **并发控制**：限制单个用户的并发生成请求数（如最多 1 个），防止资源耗尽。
- **敏感词过滤**：如需合规，后端在返回前端前应对生成内容进行二次校验。
---
## 5. API 接口定义
| 接口名称 | 方法 | 路径 | 描述 |
| :--- | :--- | :--- | :--- |
| **生成报告** | POST | `/api/report/generate` | 接收 `projectId` 和 `prompt`，返回 SSE 流式文本。 |
| **导出 Word** | POST | `/api/report/export` | 接收报告 `content`，返回 `.docx` 文件流。 |
| **保存模板** | POST | `/api/report/templates` | 创建新的提示词模板。 |
| **获取模板列表** | GET | `/api/report/templates` | 获取当前用户的模板列表。 |
| **获取项目数据** | GET | `/api/projects/:id/summary` | 聚合获取该项目所有模块的关键数据（供变量替换用）。 |
| **获取历史记录** | GET | `/api/report/history` | 获取当前项目的报告生成历史。 |
**请求示例 (生成报告):**
```json
POST /api/report/generate
{
  "projectId": "proj_123",
  "prompt": "请分析项目 {{project_name}} 的财务状况，ROI为 {{roi}}..."
}
```
**响应 (Stream):**
```
data: 根据您提供的财务数据...
data: 该项目的投资回报率 (ROI) 为 15%...
```
---
## 6. 数据模型设计
### 6.1 报告模板表 (`report_templates`)
| 字段名 | 类型 | 描述 |
| :--- | :--- | :--- |
| id | VARCHAR(36) | 主键 UUID |
| user_id | VARCHAR(36) | 创建人 ID |
| title | VARCHAR(255) | 模板名称 |
| content_html | TEXT | 提示词 HTML 内容 |
| content_text | TEXT | 提示词纯文本（用于发送给 LLM） |
| created_at | DATETIME | 创建时间 |
### 6.2 生成历史表 (`report_history`)
| 字段名 | 类型 | 描述 |
| :--- | :--- | :--- |
| id | VARCHAR(36) | 主键 UUID |
| project_id | VARCHAR(36) | 关联的项目 ID |
| content | LONGTEXT | 生成的报告内容 |
| status | TINYINT | 状态 (0:失败, 1:成功, 2:暂停) |
| created_at | DATETIME | 生成时间 |
---
## 7. 验收标准
- [ ] **基本功能**：能够通过简单的提示词生成一段通用的项目描述，并显示在预览区。
- [ ] **流式效果**：文字逐字出现，无长时间白屏，暂停/继续功能正常。
- [ ] **数据注入**：提示词中包含 `{{total_investment}}` 时，生成的内容中自动填充了该项目具体的投资金额。
- [ ] **Word 导出**：点击导出，下载的 Word 文档排版整洁，无乱码，包含预览区的所有内容。
- [ ] **样式一致性**：UI 风格与系统其他模块保持一致（颜色、按钮样式）。
- [ ] **错误处理**：LLM 服务不可用时，前端显示友好的错误提示，而非直接崩溃。
---
**批准人签字**: ____________________
**日期**: ____________________
