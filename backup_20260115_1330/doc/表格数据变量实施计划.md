# 投资项目方案报告模块 - 表格数据变量实施计划

## 任务概述

将投资项目方案报告生成模块中的10个表格的渲染输出值做成可用变量，在"表格资源"上方新建一个大类"表格数据"，使用JSON格式输出。

## 目标表格清单

| 序号 | 表格名称 | 变量标识 | 状态 |
|------|----------|----------|------|
| 1 | 投资估算简表 | `{{TABLE_DATA:investment_estimate}}` | 已有 |
| 2 | 折旧与摊销估算表 | `{{TABLE_DATA:depreciation_amortization}}` | 新增 |
| 3 | 含税收入估算表 | `{{TABLE_DATA:revenue_tax}}` | 新增 |
| 4 | 外购原材料费估算表 | `{{TABLE_DATA:raw_materials}}` | 新增 |
| 5 | 外购燃料和动力费估算表 | `{{TABLE_DATA:fuel_power}}` | 新增 |
| 6 | 利润与利润分配表 | `{{TABLE_DATA:profit_distribution}}` | 新增 |
| 7 | 项目投资现金流量表 | `{{TABLE_DATA:project_cash_flow}}` | 新增 |
| 8 | 财务计算指标表 | `{{TABLE_DATA:financial_indicators}}` | 新增 |
| 9 | 借款还本付息计划表 | `{{TABLE_DATA:loan_repayment}}` | 已有 |
| 10 | 财务评价指标汇总表 | `{{TABLE_DATA:financial_summary}}` | 新增 |

## JSON变量格式设计

### 通用表格数据结构

```json
{
  "id": "表格唯一标识",
  "title": "表格标题",
  "metadata": {
    "projectName": "项目名称",
    "constructionYears": 建设期年限,
    "operationYears": 运营期年限,
    "generatedAt": "生成时间"
  },
  "columns": ["列1", "列2", ...],
  "data": [
    {
      "序号": "1",
      "项目": "项目名称",
      "合计": 1000.00,
      "year1": 100.00,
      "year2": 200.00
    }
  ],
  "summary": {
    "total": 总计值,
    "average": 平均值
  }
}
```

### 1. 投资估算简表 JSON结构

```json
{
  "id": "investment_estimate",
  "title": "投资估算简表",
  "metadata": {
    "totalInvestment": 10000.00
  },
  "columns": ["序号", "工程或费用名称", "建设工程费", "设备购置费", "安装工程费", "其它费用", "合计", "占总投资比例"],
  "data": [
    {
      "序号": "A",
      "工程或费用名称": "第一部分 工程费用",
      "建设工程费": 5000.00,
      "设备购置费": 2000.00,
      "安装工程费": 1000.00,
      "其它费用": 0,
      "合计": 8000.00,
      "占总投资比例": "80.00%"
    }
  ],
  "summary": {
    "totalInvestment": 10000.00,
    "constructionInvestment": 9000.00,
    "interest": 1000.00
  }
}
```

### 2. 折旧与摊销估算表 JSON结构

```json
{
  "id": "depreciation_amortization",
  "title": "折旧与摊销估算表",
  "metadata": {
    "operationYears": 10
  },
  "columns": ["序号", "资产类别", "原值", "使用年限", "年折旧摊销额", "合计"],
  "data": [
    {
      "序号": "A",
      "资产类别": "建筑物、构筑物",
      "原值": 5000.00,
      "使用年限": 20,
      "年折旧摊销额": 250.00,
      "分年数据": [250.00, 250.00, ..., 250.00],
      "合计": 2500.00
    },
    {
      "序号": "D",
      "资产类别": "机器设备",
      "原值": 3000.00,
      "使用年限": 10,
      "年折旧摊销额": 300.00,
      "分年数据": [300.00, 300.00, ..., 300.00],
      "合计": 3000.00
    }
  ],
  "summary": {
    "totalOriginalValue": 8000.00,
    "totalAnnualDepreciation": 550.00,
    "totalDepreciation": 5500.00
  }
}
```

### 3. 营业收入、营业税金及附加和增值税估算表 JSON结构

```json
{
  "id": "revenue_tax",
  "title": "营业收入、营业税金及附加和增值税估算表",
  "metadata": {
    "operationYears": 10,
    "urbanTaxRate": 0.07,
    "educationSurchargeRate": 0.03,
    "localEducationSurchargeRate": 0.01
  },
  "columns": ["序号", "项目", "合计", "建设期", "运营期1", "运营期2", ...],
  "data": [
    {
      "序号": "1",
      "项目": "营业收入",
      "合计": 50000.00,
      "运营期": [5000.00, 5000.00, ..., 5000.00]
    },
    {
      "序号": "2",
      "项目": "增值税",
      "合计": 3000.00,
      "运营期": [300.00, 300.00, ..., 300.00]
    },
    {
      "序号": "3",
      "项目": "营业税金及附加",
      "合计": 500.00,
      "运营期": [50.00, 50.00, ..., 50.00]
    }
  ],
  "summary": {
    "totalRevenue": 50000.00,
    "totalVAT": 3000.00,
    "totalTaxAndSurcharges": 500.00
  }
}
```

### 4. 外购原材料费估算表 JSON结构

```json
{
  "id": "raw_materials",
  "title": "外购原材料费估算表",
  "metadata": {
    "operationYears": 10
  },
  "columns": ["序号", "材料名称", "单位", "单价", "数量", "合计", "分年数据"],
  "data": [
    {
      "序号": "1",
      "材料名称": "种子",
      "单位": "元/公斤",
      "单价": 10.00,
      "数量": 10000.00,
      "合计": 100000.00,
      "分年数据": [10000.00, 10000.00, ..., 10000.00]
    }
  ],
  "summary": {
    "totalRawMaterialsCost": 100000.00
  }
}
```

### 5. 外购燃料和动力费估算表 JSON结构

```json
{
  "id": "fuel_power",
  "title": "外购燃料和动力费估算表",
  "metadata": {
    "operationYears": 10
  },
  "columns": ["序号", "费用名称", "单位", "消耗量", "单价", "合计", "分年数据"],
  "data": [
    {
      "序号": "1",
      "费用名称": "电费",
      "单位": "度",
      "消耗量": 100000.00,
      "单价": 0.80,
      "合计": 80000.00,
      "分年数据": [8000.00, 8000.00, ..., 8000.00]
    }
  ],
  "summary": {
    "totalFuelPowerCost": 80000.00
  }
}
```

### 6. 利润与利润分配表 JSON结构

```json
{
  "id": "profit_distribution",
  "title": "利润与利润分配表",
  "metadata": {
    "operationYears": 10,
    "incomeTaxRate": 0.25,
    "statutorySurplusRate": 0.10
  },
  "columns": ["序号", "项目", "合计", "运营期1", "运营期2", ...],
  "data": [
    {
      "序号": "1",
      "项目": "营业收入",
      "合计": 50000.00,
      "运营期": [5000.00, 5000.00, ..., 5000.00]
    },
    {
      "序号": "5",
      "项目": "利润总额（1-2-3+4）",
      "合计": 3000.00,
      "运营期": [300.00, 300.00, ..., 300.00]
    },
    {
      "序号": "9",
      "项目": "净利润（5-8）",
      "合计": 2250.00,
      "运营期": [225.00, 225.00, ..., 225.00]
    }
  ],
  "summary": {
    "totalOperatingRevenue": 50000.00,
    "totalProfit": 3000.00,
    "totalNetProfit": 2250.00,
    "averageNetProfit": 225.00
  }
}
```

### 7. 项目投资现金流量表 JSON结构

```json
{
  "id": "project_cash_flow",
  "title": "项目投资现金流量表",
  "metadata": {
    "constructionYears": 2,
    "operationYears": 10,
    "preTaxRate": 6,
    "postTaxRate": 6
  },
  "columns": ["序号", "项目", "合计", "建设期1", "建设期2", "运营期1", "运营期2", ...],
  "data": [
    {
      "序号": "1",
      "项目": "现金流入",
      "合计": 55000.00,
      "分年数据": [0, 0, 5000.00, 5000.00, ..., 5500.00]
    },
    {
      "序号": "1.1",
      "项目": "营业收入",
      "合计": 50000.00,
      "分年数据": [0, 0, 5000.00, 5000.00, ..., 5000.00]
    },
    {
      "序号": "2",
      "项目": "现金流出",
      "合计": 15000.00,
      "分年数据": [5000.00, 5000.00, 500.00, 500.00, ..., 500.00]
    },
    {
      "序号": "3",
      "项目": "所得税前净现金流量（1-2）",
      "合计": 40000.00,
      "分年数据": [-5000.00, -5000.00, 4500.00, 4500.00, ..., 5000.00]
    }
  ],
  "summary": {
    "totalInflow": 55000.00,
    "totalOutflow": 15000.00,
    "preTaxCashFlow": 40000.00,
    "postTaxCashFlow": 37500.00
  }
}
```

### 8. 财务计算指标表 JSON结构

```json
{
  "id": "financial_indicators",
  "title": "财务计算指标表",
  "metadata": {
    "preTaxRate": 6,
    "postTaxRate": 6
  },
  "data": {
    "preTaxIRR": 12.50,
    "postTaxIRR": 10.20,
    "preTaxNPV": 2500.00,
    "postTaxNPV": 1800.00,
    "preTaxStaticPaybackPeriod": 5.50,
    "postTaxStaticPaybackPeriod": 6.20,
    "preTaxDynamicPaybackPeriod": 6.50,
    "postTaxDynamicPaybackPeriod": 7.20
  }
}
```

### 9. 借款还本付息计划表 JSON结构

```json
{
  "id": "loan_repayment",
  "title": "借款还本付息计划表",
  "metadata": {
    "constructionYears": 2,
    "operationYears": 10,
    "loanAmount": 6000.00,
    "interestRate": 0.048
  },
  "columns": ["序号", "项目", "合计", "建设期1", "建设期2", "运营期1", "运营期2", ...],
  "data": [
    {
      "序号": "1.1",
      "项目": "期初借款余额",
      "合计": 6000.00,
      "建设期": [3000.00, 6000.00],
      "运营期": [6000.00, 5500.00, ..., 0]
    },
    {
      "序号": "1.2",
      "项目": "当期还本付息",
      "合计": 8000.00,
      "建设期": [144.00, 288.00],
      "运营期": [1200.00, 1100.00, ..., 0]
    },
    {
      "序号": "3.4",
      "项目": "利息备付率",
      "合计": 2.50,
      "运营期": [1.50, 2.00, ..., 5.00]
    },
    {
      "序号": "3.5",
      "项目": "偿债备付率",
      "合计": 1.80,
      "运营期": [1.20, 1.50, ..., 3.00]
    }
  ],
  "summary": {
    "totalLoanAmount": 6000.00,
    "totalInterest": 2000.00,
    "totalPrincipal": 6000.00,
    "averageInterestCoverageRatio": 2.50,
    "averageDebtServiceCoverageRatio": 1.80
  }
}
```

### 10. 财务评价指标汇总表 JSON结构

```json
{
  "id": "financial_summary",
  "title": "财务评价指标汇总表",
  "metadata": {
    "constructionYears": 2,
    "operationYears": 10
  },
  "columns": ["序号", "项目名称", "单位", "数值"],
  "data": [
    { "序号": "1", "项目名称": "项目总投资", "单位": "万元", "数值": 10000.00 },
    { "序号": "1.1", "项目名称": "建设投资", "单位": "万元", "数值": 9000.00 },
    { "序号": "1.2", "项目名称": "建设期利息", "单位": "万元", "数值": 1000.00 },
    { "序号": "2", "项目名称": "资金筹措", "单位": "万元", "数值": 10000.00 },
    { "序号": "2.1", "项目名称": "项目资本金", "单位": "万元", "数值": 4000.00 },
    { "序号": "2.2", "项目名称": "项目债务资金", "单位": "万元", "数值": 6000.00 },
    { "序号": "3", "项目名称": "年均销售收入", "单位": "万元", "数值": 5000.00 },
    { "序号": "11", "项目名称": "总投资收益率", "单位": "％", "数值": 15.00 },
    { "序号": "13", "项目名称": "项目资本金净利润率", "单位": "％", "数值": 18.75 },
    { "序号": "16.1", "项目名称": "财务内部收益率（所得税前）", "单位": "％", "数值": 12.50 },
    { "序号": "16.2", "项目名称": "项目投资财务净现值（所得税前）", "单位": "万元", "数值": 2500.00 },
    { "序号": "16.3", "项目名称": "全部投资回收期（所得税前）", "单位": "年", "数值": 6.50 }
  ],
  "summary": {
    "totalInvestment": 10000.00,
    "equity": 4000.00,
    "debt": 6000.00,
    "roi": 15.00,
    "roe": 18.75,
    "irrPreTax": 12.50,
    "npvPreTax": 2500.00,
    "paybackPeriodPreTax": 6.50
  }
}
```

## 实施步骤详解

### 第一阶段：变量系统修改

#### 1.1 修改 VariableMenu.tsx

**文件**: `client/src/components/report/VariableMenu.tsx`

**修改内容**:
1. 在 `variableGroups` 数组中，在"表格资源"分组前新增"表格数据"分组
2. 更新 `variableDetails` 对象，添加新变量的详细信息

```typescript
// 新增变量分组配置
{
  label: '表格数据',
  icon: <Table size={14} />,
  color: 'blue',
  filterKeys: [
    '{{TABLE_DATA:investment_estimate}}',
    '{{TABLE_DATA:depreciation_amortization}}',
    '{{TABLE_DATA:revenue_tax}}',
    '{{TABLE_DATA:raw_materials}}',
    '{{TABLE_DATA:fuel_power}}',
    '{{TABLE_DATA:profit_distribution}}',
    '{{TABLE_DATA:project_cash_flow}}',
    '{{TABLE_DATA:financial_indicators}}',
    '{{TABLE_DATA:loan_repayment}}',
    '{{TABLE_DATA:financial_summary}}'
  ]
}
```

#### 1.2 修改 VariablePicker.tsx

**文件**: `client/src/components/report/VariablePicker.tsx`

**修改内容**:
1. 在"表格资源"分类上方新增"表格数据"分类
2. 添加对应的 Badge 组件

#### 1.3 修改 reportStore.ts

**文件**: `client/src/stores/reportStore.ts`

**修改内容**:
1. 在 `loadProjectData` 函数的 `variables` 数组中新增表格数据变量
2. 每个变量包含 `key`、`label`、`category: 'tableData'`

### 第二阶段：表格构建器开发

#### 2.1 新建 depreciationTableBuilder.ts

**文件**: `client/src/utils/depreciationTableBuilder.ts`

**功能**: 构建折旧与摊销估算表的JSON数据

#### 2.2 新建 revenueTaxTableBuilder.ts

**文件**: `client/src/utils/revenueTaxTableBuilder.ts`

**功能**: 构建营业收入、营业税金及增值税估算表的JSON数据

#### 2.3 新建 costTableBuilder.ts

**文件**: `client/src/utils/costTableBuilder.ts`

**功能**: 构建外购原材料费和燃料动力费估算表的JSON数据

#### 2.4 修改 tableResourceBuilder.ts

**文件**: `client/src/utils/tableResourceBuilder.ts`

**新增函数**:
- `buildProfitDistributionTable()` - 利润与利润分配表
- `buildProjectCashFlowTable()` - 项目投资现金流量表
- `buildFinancialIndicatorsTableData()` - 财务计算指标表
- `buildLoanRepaymentTableData()` - 借款还本付息计划表（重构）
- `buildFinancialSummaryTable()` - 财务评价指标汇总表

### 第三阶段：数据集成

#### 3.1 修改 reportStore.ts

**修改内容**:
1. 在 `buildAllTableResources` 函数中调用新的构建函数
2. 将构建的表格数据添加到 `resources.tables` 中

#### 3.2 修改 htmlTemplateBuilder.ts

**文件**: `client/src/utils/htmlTemplateBuilder.ts`

**修改内容**:
1. 添加 `replaceTableDataVariables()` 函数
2. 在模板构建过程中替换 `{{TABLE_DATA:xxx}}` 变量

### 第四阶段：测试验证

#### 4.1 测试用例

1. **变量显示测试**: 验证变量菜单中显示新增的表格数据变量
2. **变量插入测试**: 验证在编辑器中插入变量后正确显示
3. **JSON数据测试**: 验证每个表格的JSON数据格式正确
4. **渲染测试**: 验证报告预览中表格数据正确显示

## 文件修改清单

| 文件路径 | 操作 | 说明 |
|----------|------|------|
| `client/src/components/report/VariableMenu.tsx` | 修改 | 新增"表格数据"变量分组 |
| `client/src/components/report/VariablePicker.tsx` | 修改 | 新增"表格数据"分类显示 |
| `client/src/stores/reportStore.ts` | 修改 | 添加表格数据变量定义和构建调用 |
| `client/src/utils/tableResourceBuilder.ts` | 修改 | 添加利润分配表、现金流量表等构建函数 |
| `client/src/utils/depreciationTableBuilder.ts` | 新建 | 折旧与摊销估算表构建器 |
| `client/src/utils/revenueTaxTableBuilder.ts` | 新建 | 营业收入、税金及增值税估算表构建器 |
| `client/src/utils/costTableBuilder.ts` | 新建 | 外购原材料费、燃料动力费估算表构建器 |
| `client/src/utils/htmlTemplateBuilder.ts` | 修改 | 支持表格数据变量替换 |

## 变量命名规范

### 前缀规则

| 前缀 | 用途 | 示例 |
|------|------|------|
| `{{TABLE_DATA:` | 表格数据变量（JSON格式） | `{{TABLE_DATA:investment_estimate}}` |
| `{{TABLE:` | 表格资源变量（渲染HTML） | `{{TABLE:investment_estimate}}` |

### 变量标识命名规则

- 使用小写字母
- 使用下划线分隔单词
- 保持简洁明了
- 与表格ID保持一致

## 注意事项

1. **计算逻辑分离**: 所有表格数据的计算必须在渲染前完成，使用 `useMemo` 或独立函数计算
2. **数据缓存**: 大型表格数据需要缓存，避免重复计算
3. **空值处理**: 对 `undefined`/`null` 值做兜底处理，避免渲染异常
4. **格式统一**: 所有表格JSON数据保持统一的结构格式
5. **向后兼容**: 保留现有的 `{{TABLE:xxx}}` 变量，继续支持表格资源渲染
