# è·¨é¡¹ç›®æ•°æ®æ®‹ç•™é—®é¢˜ä¿®å¤è®¡åˆ’

## é—®é¢˜æè¿°

**ç—‡çŠ¶**ï¼šé¡¹ç›®Aåˆ é™¤ä»¥åï¼Œå†æ¬¡æ–°å»ºBé¡¹ç›®ï¼Œè¿›å…¥AIæ¨èè¥æ”¶ç»“æ„é¡µé¢ã€æ”¶å…¥é¡µé¢ã€æˆæœ¬é¡µé¢ï¼Œä¼šå‡ºç°Aé¡¹ç›®çš„ä¿¡æ¯ï¼Œè€Œä¸æ˜¯å…¨æ–°çš„ã€ç©ºçš„ä¿¡æ¯ã€‚

## é—®é¢˜æ ¹å› åˆ†æ

### 1. æ•°æ®æµæ¦‚è¿°

```
æ–°é¡¹ç›®Båˆ›å»º â†’ RevenueCostModeling.tsx â†’ loadFromBackend() â†’ revenueCostApi.getByProjectId()
                                                                            â†“
                                                                    åç«¯æŸ¥è¯¢æ•°æ®åº“
                                                                    â†“
                                                            æ–°é¡¹ç›®æ— æ•°æ®ï¼Œè¿”å› { estimate: null }
                                                                            â†“
                                                                å‰ç«¯ loadFromBackend() å¤±è´¥
                                                                            â†“
                                                                âŒ é—®é¢˜ï¼šçŠ¶æ€æœªé‡ç½®ï¼Œæ—§æ•°æ®æ®‹ç•™
```

### 2. å…·ä½“é—®é¢˜ç‚¹

#### é—®é¢˜ç‚¹1ï¼šåç«¯ API è¡Œä¸ºï¼ˆç¬¬276-281è¡Œï¼‰
**æ–‡ä»¶**ï¼š`server/src/controllers/revenueCostController.ts`

```typescript
if (!estimates || estimates.length === 0) {
  return res.json({
    success: true,
    data: { estimate: null }  // è¿”å› null
  })
}
```

å½“æ–°é¡¹ç›®æ²¡æœ‰ revenue_cost_estimates è®°å½•æ—¶ï¼Œåç«¯æ­£ç¡®è¿”å› `estimate: null`ã€‚

#### é—®é¢˜ç‚¹2ï¼šå‰ç«¯ loadFromBackend ä¸å¤„ç† null çŠ¶æ€
**æ–‡ä»¶**ï¼š`client/src/stores/revenueCostStore.ts`ï¼ˆç¬¬1439-1523è¡Œï¼‰

```typescript
loadFromBackend: async (projectId: string) => {
  const response = await revenueCostApi.getByProjectId(projectId)
  
  if (response.success && response.data?.estimate) {
    // âœ… æœ‰æ•°æ®æ—¶å¤„ç†
    // ... è®¾ç½® revenueItems, costItems, aiAnalysisResult ç­‰
  }
  // âŒ å½“ estimate ä¸º null æ—¶ï¼Œä»€ä¹ˆéƒ½ä¸åšï¼
  //    Zustand store çŠ¶æ€ä¿æŒä¸å˜ï¼Œæ—§é¡¹ç›®æ•°æ®ä»ç„¶å­˜åœ¨
}
```

#### é—®é¢˜ç‚¹3ï¼šRevenueCostModeling.tsx æœªæ˜¾å¼è°ƒç”¨ reset
**æ–‡ä»¶**ï¼š`client/src/pages/RevenueCostModeling.tsx`ï¼ˆç¬¬138-258è¡Œï¼‰

```typescript
useEffect(() => {
  const loadProjectData = async () => {
    // åŠ è½½æ•°æ®å‰æ²¡æœ‰é‡ç½® store
    const { loadFromBackend } = useRevenueCostStore.getState()
    // ...
    await loadFromBackend(id!)
    // loadFromBackend åœ¨ estimate ä¸º null æ—¶ä¸ä¼šé‡ç½®çŠ¶æ€
  }
}, [id, navigate])
```

### 3. Zustand Store åˆå§‹çŠ¶æ€ vs æ®‹ç•™çŠ¶æ€

| çŠ¶æ€å­—æ®µ | åˆå§‹å€¼ï¼ˆreset()ï¼‰ | é—®é¢˜ï¼šæ®‹ç•™å€¼ |
|---------|------------------|-------------|
| revenueItems | `[]` | é¡¹ç›®Açš„æ•°æ® |
| costItems | `[]` | é¡¹ç›®Açš„æ•°æ® |
| aiAnalysisResult | `null` | é¡¹ç›®Açš„æ•°æ® |
| revenueStructureLocked | `false` | å¯èƒ½è¢«é”å®š |
| costConfig | `getDefaultCostConfig()` | å¯èƒ½æ˜¯è‡ªå®šä¹‰é…ç½® |
| currentStep | `'period'` | å¯èƒ½åœç•™åœ¨æŸä¸ªæ­¥éª¤ |

## ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¿®å¤ loadFromBackend æ–¹æ³•ï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰

**æ–‡ä»¶**ï¼š`client/src/stores/revenueCostStore.ts`

**ä¿®æ”¹ä½ç½®**ï¼šç¬¬1439-1523è¡Œçš„ `loadFromBackend` æ–¹æ³•

**ä¿®æ”¹é€»è¾‘**ï¼š
```typescript
loadFromBackend: async (projectId: string) => {
  try {
    set({ isSubmitting: true })
    
    const response = await revenueCostApi.getByProjectId(projectId)
    
    if (response.success && response.data?.estimate) {
      // æœ‰æ•°æ®æ—¶ï¼Œæ¢å¤çŠ¶æ€
      // ... ç°æœ‰é€»è¾‘ä¸å˜
    } else {
      // ğŸ”§ ä¿®å¤ï¼šå½“ estimate ä¸º null æ—¶ï¼Œé‡ç½®çŠ¶æ€ä¸ºç©º
      console.log('âš ï¸ æ²¡æœ‰æ‰¾åˆ°æ”¶å…¥æˆæœ¬æ•°æ®ï¼Œé‡ç½®çŠ¶æ€ä¸ºç©º')
      
      // è·å–å½“å‰ context ä»¥ä¿ç•™é¡¹ç›®åŸºæœ¬ä¿¡æ¯
      const currentContext = useRevenueCostStore.getState().context
      
      const newContext = currentContext 
        ? {
            ...currentContext,
            depreciationAmortization: null
          }
        : null
      
      set({
        revenueItems: [],
        costItems: [],
        productionRates: currentContext 
          ? generateDefaultProductionRates(currentContext.operationYears)
          : [],
        aiAnalysisResult: null,
        revenueStructureLocked: false,
        costConfig: getDefaultCostConfig(),
        revenueTableData: null,
        costTableData: null,
        profitDistributionTableData: null,
        loanRepaymentTableData: null,
        financialIndicators: null,
        loanConfig: getDefaultLoanConfig(),
        currentStep: 'period',
        context: newContext
      })
    }
    
    set({ isSubmitting: false })
    return response.success
  } catch (error) {
    console.error('åŠ è½½å¤±è´¥:', error)
    set({ isSubmitting: false })
    return false
  }
}
```

### æ–¹æ¡ˆ2ï¼šä¼˜åŒ– RevenueCostModeling.tsx çš„æ•°æ®åŠ è½½é€»è¾‘

**æ–‡ä»¶**ï¼š`client/src/pages/RevenueCostModeling.tsx`

**ä¿®æ”¹ä½ç½®**ï¼šç¬¬138-258è¡Œçš„ `loadProjectData` å‡½æ•°

**ä¿®æ”¹é€»è¾‘**ï¼š
```typescript
useEffect(() => {
  const loadProjectData = async () => {
    try {
      setLoading(true)
      
      // ğŸ”§ å…³é”®ä¿®å¤ï¼šå…ˆé‡ç½® storeï¼Œç¡®ä¿æ¸…é™¤ä»»ä½•æ®‹ç•™æ•°æ®
      reset()
      console.log('âœ… å·²é‡ç½® RevenueCostStore çŠ¶æ€')
      
      // ç„¶ååŠ è½½æ–°é¡¹ç›®æ•°æ®
      const { loadFromBackend } = useRevenueCostStore.getState()
      // ... åç»­é€»è¾‘ä¸å˜
    } finally {
      setLoading(false)
      setDataLoaded(true)
    }
  }

  if (id) {
    loadProjectData()
  }
}, [id, navigate])
```

### æ–¹æ¡ˆ3ï¼šæ·»åŠ é¡¹ç›®åˆ‡æ¢æ—¶çš„ç¼“å­˜å¤±æ•ˆæœºåˆ¶

**æ–‡ä»¶**ï¼š`client/src/lib/api.ts`

**ä¿®æ”¹ä½ç½®**ï¼šç¬¬541-546è¡Œçš„ `revenueCostApi`

```typescript
export const revenueCostApi = {
  save: (params: any) =>
    api.post<any, ApiResponse<{ estimate: any }>>('/revenue-cost/save', params),

  getByProjectId: (projectId: string) => {
    // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿ä¸ä½¿ç”¨ä»»ä½•ç¼“å­˜ï¼Œæ¯æ¬¡éƒ½ä»æœåŠ¡å™¨è·å–æœ€æ–°æ•°æ®
    return api.get<any, ApiResponse<{ estimate?: any }>>(`/revenue-cost/project/${projectId}`)
  },
  // ...
}
```

## ä¿®å¤ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | ä¿®å¤é¡¹ | å½±å“èŒƒå›´ |
|-------|-------|---------|
| P0 | æ–¹æ¡ˆ1ï¼šloadFromBackend é‡ç½®çŠ¶æ€ | æ‰€æœ‰æ–°å»ºé¡¹ç›®åœºæ™¯ |
| P0 | æ–¹æ¡ˆ2ï¼šRevenueCostModeling é‡ç½® store | é¡µé¢çº§åˆ«æ•°æ®æ¸…é™¤ |
| P1 | æ–¹æ¡ˆ3ï¼šç¦ç”¨ç¼“å­˜ | æ•°æ®ä¸€è‡´æ€§ä¿éšœ |

## éªŒè¯æµ‹è¯•

### æµ‹è¯•åœºæ™¯

#### åœºæ™¯1ï¼šæ–°å»ºé¡¹ç›®æ— æ•°æ®æ®‹ç•™
**å‰ç½®æ¡ä»¶**ï¼šç”¨æˆ·å·²ç™»å½•ï¼Œå­˜åœ¨é¡¹ç›®Aï¼ˆæœ‰æ”¶å…¥æˆæœ¬æ•°æ®ï¼‰

**æ“ä½œæ­¥éª¤**ï¼š
1. è¿›å…¥é¡¹ç›®Açš„æ”¶å…¥æˆæœ¬é¡µé¢ï¼Œæ·»åŠ æ”¶å…¥é¡¹ã€æˆæœ¬é¡¹
2. ä¿å­˜æ•°æ®
3. åˆ é™¤é¡¹ç›®A
4. æ–°å»ºé¡¹ç›®B
5. è¿›å…¥é¡¹ç›®Bçš„æ”¶å…¥æˆæœ¬é¡µé¢

**é¢„æœŸç»“æœ**ï¼š
- AIæ¨èè¥æ”¶ç»“æ„é¡µé¢ï¼šæ˜¾ç¤ºç©ºçš„é€‰æ‹©åˆ—è¡¨
- æ”¶å…¥é¡µé¢ï¼šæ— æ”¶å…¥é¡¹ï¼Œæ˜¾ç¤ºç©ºè¡¨æ ¼æˆ–"æš‚æ— æ•°æ®"
- æˆæœ¬é¡µé¢ï¼šæ— æˆæœ¬é¡¹ï¼Œæ˜¾ç¤ºç©ºè¡¨æ ¼æˆ–"æš‚æ— æ•°æ®"
- éªŒè¯æ–¹æ³•ï¼šæ£€æŸ¥ Network é¢æ¿ï¼ŒAPI è¯·æ±‚è¿”å› `estimate: null`

**å®é™…ç»“æœ**ï¼ˆä¿®å¤å‰ï¼‰ï¼š
- æ˜¾ç¤ºé¡¹ç›®Açš„æ”¶å…¥é¡¹ã€æˆæœ¬é¡¹

#### åœºæ™¯2ï¼šåˆ‡æ¢é¡¹ç›®æ•°æ®éš”ç¦»
**å‰ç½®æ¡ä»¶**ï¼šç”¨æˆ·å·²ç™»å½•ï¼Œå­˜åœ¨é¡¹ç›®Aå’Œé¡¹ç›®B

**æ“ä½œæ­¥éª¤**ï¼š
1. è¿›å…¥é¡¹ç›®Açš„æ”¶å…¥æˆæœ¬é¡µé¢ï¼Œæ·»åŠ æ”¶å…¥é¡¹
2. ä¿å­˜æ•°æ®
3. è¿”å›é¡¹ç›®åˆ—è¡¨
4. è¿›å…¥é¡¹ç›®Bçš„æ”¶å…¥æˆæœ¬é¡µé¢

**é¢„æœŸç»“æœ**ï¼š
- é¡¹ç›®Bæ˜¾ç¤ºç©ºæ•°æ®
- é¡¹ç›®Açš„æ•°æ®ä¸å½±å“é¡¹ç›®B

**å®é™…ç»“æœ**ï¼ˆä¿®å¤å‰ï¼‰ï¼š
- å¯èƒ½æ˜¾ç¤ºé¡¹ç›®Açš„æ•°æ®ï¼ˆå–å†³äºç¼“å­˜ç­–ç•¥ï¼‰

#### åœºæ™¯3ï¼šåˆ é™¤é¡¹ç›®åé‡å»ºåŒåé¡¹ç›®
**å‰ç½®æ¡ä»¶**ï¼šç”¨æˆ·å·²ç™»å½•ï¼Œå­˜åœ¨é¡¹ç›®Aï¼ˆæœ‰æ”¶å…¥æˆæœ¬æ•°æ®ï¼‰

**æ“ä½œæ­¥éª¤**ï¼š
1. è¿›å…¥é¡¹ç›®Açš„æ”¶å…¥æˆæœ¬é¡µé¢ï¼Œæ·»åŠ æ”¶å…¥é¡¹"äº§å“é”€å”®æ”¶å…¥"
2. ä¿å­˜æ•°æ®
3. åˆ é™¤é¡¹ç›®A
4. æ–°å»ºåŒåé¡¹ç›®Aï¼ˆæˆ–ä¸åŒåé¡¹ç›®Bï¼‰
5. è¿›å…¥é¡¹ç›®çš„æ”¶å…¥æˆæœ¬é¡µé¢

**é¢„æœŸç»“æœ**ï¼š
- æ–°é¡¹ç›®æ— æ—§é¡¹ç›®çš„æ”¶å…¥é¡¹æ•°æ®
- æ”¶å…¥é¡¹åˆ—è¡¨ä¸ºç©º

**å®é™…ç»“æœ**ï¼ˆä¿®å¤å‰ï¼‰ï¼š
- å¯èƒ½ä»æ˜¾ç¤º"äº§å“é”€å”®æ”¶å…¥"æ”¶å…¥é¡¹

#### åœºæ™¯4ï¼šé¡¹ç›®æœ‰éƒ¨åˆ†æ•°æ®æ—¶çš„åˆ‡æ¢
**å‰ç½®æ¡ä»¶**ï¼šç”¨æˆ·å·²ç™»å½•ï¼Œå­˜åœ¨é¡¹ç›®Aï¼ˆæœ‰AIåˆ†æç»“æœä½†æœªæ·»åŠ æ”¶å…¥é¡¹ï¼‰

**æ“ä½œæ­¥éª¤**ï¼š
1. è¿›å…¥é¡¹ç›®Açš„AIæ¨èé¡µé¢ï¼Œå®ŒæˆAIåˆ†æ
2. åˆ‡æ¢åˆ°é¡¹ç›®B

**é¢„æœŸç»“æœ**ï¼š
- é¡¹ç›®Bçš„AIæ¨èé¡µé¢æ˜¾ç¤ºç©ºçŠ¶æ€
- æ— é¡¹ç›®Açš„AIåˆ†æç»“æœ

#### åœºæ™¯5ï¼šå·¥ä½œæµæ­¥éª¤æ®‹ç•™
**å‰ç½®æ¡ä»¶**ï¼šç”¨æˆ·å·²ç™»å½•ï¼Œé¡¹ç›®Açš„å·¥ä½œæµæ­¥éª¤ä¸º 'revenue'ï¼ˆæ”¶å…¥å»ºæ¨¡ï¼‰

**æ“ä½œæ­¥éª¤**ï¼š
1. é¡¹ç›®Aå®ŒæˆAIåˆ†æåï¼Œé”å®šè¥æ”¶ç»“æ„
2. åˆ é™¤é¡¹ç›®A
3. æ–°å»ºé¡¹ç›®B

**é¢„æœŸç»“æœ**ï¼š
- é¡¹ç›®Bçš„å·¥ä½œæµæ­¥éª¤ä¸ºåˆå§‹çŠ¶æ€ 'period'
- ä¸æ˜¾ç¤ºé¡¹ç›®Açš„é”å®šçŠ¶æ€

### è‡ªåŠ¨åŒ–æµ‹è¯•ç”¨ä¾‹å»ºè®®

```typescript
// Jest æµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹

describe('è·¨é¡¹ç›®æ•°æ®éš”ç¦»', () => {
  beforeEach(() => {
    // æ¯ä¸ªæµ‹è¯•å‰é‡ç½® store
    reset()
  })

  it('æ–°é¡¹ç›®åº”æ˜¾ç¤ºç©ºæ•°æ®', async () => {
    // æ¨¡æ‹Ÿ API è¿”å› null
    revenueCostApi.getByProjectId.mockResolvedValue({
      success: true,
      data: { estimate: null }
    })

    await loadFromBackend('project-b')

    // éªŒè¯çŠ¶æ€è¢«é‡ç½®
    expect(revenueItems).toEqual([])
    expect(costItems).toEqual([])
    expect(aiAnalysisResult).toBeNull()
    expect(currentStep).toBe('period')
  })

  it('æœ‰æ•°æ®æ—¶åº”æ­£ç¡®æ¢å¤', async () => {
    const mockData = {
      revenueItems: [{ id: '1', name: 'äº§å“é”€å”®' }],
      costItems: [],
      aiAnalysisResult: null,
      currentStep: 'revenue'
    }

    revenueCostApi.getByProjectId.mockResolvedValue({
      success: true,
      data: { estimate: { model_data: mockData } }
    })

    await loadFromBackend('project-a')

    expect(revenueItems).toHaveLength(1)
    expect(revenueItems[0].name).toBe('äº§å“é”€å”®')
  })
})
```

### æ‰‹åŠ¨æµ‹è¯•æ£€æŸ¥æ¸…å•

| æ£€æŸ¥é¡¹ | æ“ä½œ | é¢„æœŸç»“æœ |
|-------|------|---------|
| AIæ¨èé¡µé¢ | æ–°å»ºé¡¹ç›®åè¿›å…¥ | ç©ºçš„é€‰æ‹©åˆ—è¡¨ï¼Œæ— æ®‹ç•™ç±»åˆ« |
| æ”¶å…¥é¡µé¢ | æ–°å»ºé¡¹ç›®åè¿›å…¥ | æ— æ”¶å…¥é¡¹ï¼Œç©ºè¡¨æ ¼ |
| æˆæœ¬é¡µé¢ | æ–°å»ºé¡¹ç›®åè¿›å…¥ | æ— æˆæœ¬é¡¹ï¼Œç©ºè¡¨æ ¼ |
| è´¢åŠ¡æŒ‡æ ‡é¡µé¢ | æ–°å»ºé¡¹ç›®åè¿›å…¥ | æ— æŒ‡æ ‡æ•°æ®ï¼Œæ˜¾ç¤º0 |
| å·¥ä½œæµæ­¥éª¤ | æ–°å»ºé¡¹ç›®åè¿›å…¥ | åˆå§‹æ­¥éª¤ä¸º'åŸºç¡€æ•°æ®' |
| ä¿å­˜ååˆ·æ–° | åœ¨é¡¹ç›®Bä¿å­˜ååˆ·æ–° | æ•°æ®ä¿æŒï¼Œæ— Aé¡¹ç›®æ•°æ® |

## é£é™©è¯„ä¼°

| é£é™© | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½ |
|-----|-------|-----|---------|
| é‡ç½®é€»è¾‘è¦†ç›–æœ‰æ•ˆæ•°æ® | ä½ | ä¸­ | åªåœ¨ estimate ä¸º null æ—¶é‡ç½® |
| æ€§èƒ½å½±å“ï¼ˆæ¯æ¬¡éƒ½é‡ç½®ï¼‰ | ä½ | ä½ | æ•°æ®é‡å°ï¼Œé‡ç½®æ“ä½œæå¿« |
| ç¼“å­˜å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ | ä¸­ | ä¸­ | ç¡®ä¿ getByProjectId ä¸ä½¿ç”¨ç¼“å­˜ |

## æ‰§è¡Œæ­¥éª¤

1. ä¿®æ”¹ `revenueCostStore.ts` çš„ `loadFromBackend` æ–¹æ³•
2. ä¿®æ”¹ `RevenueCostModeling.tsx` çš„æ•°æ®åŠ è½½é€»è¾‘
3. éªŒè¯ `revenueCostApi.getByProjectId` ä¸ä½¿ç”¨ç¼“å­˜
4. æ‰‹åŠ¨æµ‹è¯•éªŒè¯ä¿®å¤æ•ˆæœ
5. ç¼–å†™è‡ªåŠ¨åŒ–æµ‹è¯•ç”¨ä¾‹ï¼ˆå¯é€‰ï¼‰

## ç›¸å…³æ–‡ä»¶ä¿®æ”¹æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|-----|---------|
| `client/src/stores/revenueCostStore.ts` | loadFromBackend æ–¹æ³•å¢åŠ  null å¤„ç† |
| `client/src/pages/RevenueCostModeling.tsx` | æ•°æ®åŠ è½½å‰è°ƒç”¨ reset() |
| `client/src/lib/api.ts` | ç¡®è®¤ getByProjectId ä¸ä½¿ç”¨ç¼“å­˜ |
