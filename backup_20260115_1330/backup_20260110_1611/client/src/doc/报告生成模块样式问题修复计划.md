# 报告生成模块样式设置问题修复计划

## 问题描述

1. **数据库中的样式配置不完整** - 保存时只保存了部分字段
2. **Word导出没有应用样式** - 导出时使用的是不完整的配置

## 问题分析

### 数据库中的配置（当前）
```json
{
  "heading1": {"fontSize": 16},
  "heading2": {"font":"宋体","fontSize":14,"bold":false},
  "body": {},
  "fonts": {"heading":"宋体"}
}
```

### 默认配置（应该是）
```json
{
  "heading1": {"font":"黑体","fontSize":22,"bold":true,"lineSpacing":1.5,"spaceBefore":0,"spaceAfter":6,"firstLineIndent":0},
  "heading2": {"font":"黑体","fontSize":16,"bold":true,"lineSpacing":1.5,"spaceBefore":6,"spaceAfter":6,"firstLineIndent":0},
  "body": {"font":"宋体","fontSize":12,"bold":false,"lineSpacing":1.5,"spaceBefore":0,"spaceAfter":0,"firstLineIndent":2}
}
```

## 修复方案

### 1. 修复客户端样式保存逻辑

**文件**: `client/src/components/report/StyleSettingsPanel.tsx`

**问题**: `autoSave` 函数比较配置时使用的是 `JSON.stringify`，但保存的 `styleConfig` 可能只包含更新的字段，而不是完整的配置。

**修复**: 
- 在保存前确保使用完整的配置结构
- 使用深度合并确保所有字段都存在

### 2. 修复服务器端保存逻辑

**文件**: `server/src/controllers/reportController.ts`

**问题**: `saveStyleConfig` 方法只保存前端传递的 `config` 字段，没有合并默认配置。

**修复**:
- 添加配置验证和补全逻辑
- 确保保存的配置包含所有必要字段

### 3. 添加配置验证

**文件**: `client/src/types/report.ts`

**修复**:
- 添加 `validateStyleConfig` 函数
- 确保配置包含所有必要字段

## 执行步骤

### 步骤 1: 添加配置验证函数
- 在 `client/src/types/report.ts` 中添加 `validateStyleConfig` 函数
- 确保返回完整的配置结构

### 步骤 2: 修复客户端保存逻辑
- 修改 `StyleSettingsPanel.tsx` 中的 `autoSave` 函数
- 在保存前使用 `validateStyleConfig` 补全配置

### 步骤 3: 修复服务器端保存逻辑
- 修改 `reportController.ts` 中的 `saveStyleConfig` 方法
- 添加配置验证和补全逻辑

### 步骤 4: 添加调试日志
- 在保存和加载时添加控制台日志
- 便于后续问题排查

## 预期结果

1. 保存样式配置时，确保数据库中保存的是完整的配置结构
2. 加载样式配置时，能够正确恢复所有字段
3. Word导出时能够正确应用所有样式设置

## 后续测试

1. 保存样式配置后，检查数据库中的配置是否完整
2. 重新打开Modal，检查显示的样式是否与保存的一致
3. 导出Word文档，检查样式是否正确应用
