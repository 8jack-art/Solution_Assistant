import { modals } from '@mantine/modals'
import React, { useState, useEffect, useRef } from 'react'
import {
  Table,
  Button,
  Modal,
  TextInput,
  NumberInput,
  Select,
  Group,
  Stack,
  Text,
  ActionIcon,
  Tooltip,
  Badge,
  Grid,

SegmentedControl,
  } from '@mantine/core'
import { IconEdit, IconTrash, IconPlus, IconChartLine, IconSparkles, IconTable } from '@tabler/icons-react'
import { notifications } from '@mantine/notifications'
import ProductionRateModal from './ProductionRateModal'
import { revenueCostApi } from '@/lib/api'
import {
  RevenueItem,
  RevenueCategory,
  FieldTemplate,
  useRevenueCostStore,
  calculateTaxableIncome,
  calculateNonTaxIncome,
  calculateVatAmount,
  calculateYearlyRevenue,
  getProductionRateForYear,
} from '../../stores/revenueCostStore'

/**
 * ç±»åˆ«æ ‡ç­¾æ˜ å°„
 */
const CATEGORY_LABELS: Record<RevenueCategory, string> = {
  'digital-platform': 'æ•°å­—å¹³å°',
  'agriculture-crop': 'å†œä¸šç§æ¤',
  'manufacturing': 'åˆ¶é€ ä¸š',
  'service': 'æœåŠ¡ä¸š',
  'real-estate': 'æˆ¿åœ°äº§',
  'other': 'å…¶ä»–',
}

/**
 * å­—æ®µæ¨¡æ¿æ ‡ç­¾æ˜ å°„
 */
const TEMPLATE_LABELS: Record<FieldTemplate, string> = {
  'quantity-price': 'æ•°é‡ Ã— å•ä»·',
  'area-yield-price': 'é¢ç§¯ Ã— äº©äº§é‡ Ã— å•ä»·',
  'capacity-utilization': 'äº§èƒ½ Ã— åˆ©ç”¨ç‡ Ã— å•ä»·',
  'subscription': 'è®¢é˜…æ•° Ã— å•ä»·',
  'direct-amount': 'ç›´æ¥é‡‘é¢',
}

/**
 * åŠ¨æ€æ”¶å…¥è¡¨æ ¼ç»„ä»¶
 */
const DynamicRevenueTable: React.FC = () => {
  const { 
    context,
    aiAnalysisResult,
    revenueItems, 
    addRevenueItem, 
    updateRevenueItem, 
    deleteRevenueItem
  } = useRevenueCostStore()
  
  const [showEditModal, setShowEditModal] = useState(false)
  const [editingItem, setEditingItem] = useState<RevenueItem | null>(null)
  const [isNewItem, setIsNewItem] = useState(false)
  const [productionRateModalOpened, setProductionRateModalOpened] = useState(false) // è¾¾äº§ç‡é…ç½®å¼¹çª—
  const [aiEstimating, setAiEstimating] = useState(false) // AIæµ‹ç®—ä¸­
  const [showRevenueDetailModal, setShowRevenueDetailModal] = useState(false) // æ”¶å…¥è¯¦è¡¨å¼¹çª—
  const [urbanTaxRate, setUrbanTaxRate] = useState<number>(0.07); // åŸå¸‚å»ºè®¾ç»´æŠ¤ç¨ç¨ç‡ (7% æˆ– 5%)
  const hasAutoGeneratedRef = useRef(false) // ä½¿ç”¨refé˜²æ­¢ç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶ä¸¢å¤±æ ‡è®°
  const isGeneratingRef = useRef(false) // é˜²æ­¢å¹¶å‘è°ƒç”¨

  // ç¼–è¾‘è¡¨å•çŠ¶æ€
  const [formData, setFormData] = useState<Partial<RevenueItem>>({})

  /**
   * æ‰“å¼€æ–°å¢å¯¹è¯æ¡†
   */
  const handleAdd = () => {
    setFormData({
      name: '',
      category: 'other',
      fieldTemplate: 'quantity-price',
      vatRate: 0.13,

      priceIncreaseInterval: 0, // é»˜è®¤ä¸æ¶¨ä»·
      priceIncreaseRate: 0,
      quantity: 0,
      unitPrice: 0,
      area: 0,
      yieldPerArea: 0,
      capacity: 0,
      utilizationRate: 0,
      subscriptions: 0,
      directAmount: 0,
    })
    setEditingItem(null)
    setIsNewItem(true)
    setShowEditModal(true)
  }

  /**
   * æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†
   */
  const handleEdit = (item: RevenueItem) => {
    const formDataToSet = { ...item }
    
    console.log('ğŸ” [ç¼–è¾‘] åŸå§‹æ•°æ®:', { 
 
      unitPrice: item.unitPrice,
      name: item.name 
    })
    
    // ç®€åŒ–é€»è¾‘ï¼šæ•°æ®åº“ç»Ÿä¸€ä¿å­˜ä¸‡å…ƒå•ä½ï¼Œç¼–è¾‘æ—¶é»˜è®¤ä»¥ä¸‡å…ƒå•ä½æ˜¾ç¤º

    
    // æ•°æ®åº“ä¸­çš„å•ä»·å·²ç»æ˜¯ä¸‡å…ƒå•ä½ï¼Œç›´æ¥ä½¿ç”¨
    if (formDataToSet.unitPrice !== undefined) {
      console.log('ğŸ”„ [ç¼–è¾‘] ç›´æ¥æ˜¾ç¤ºä¸‡å…ƒå•ä½:', {
        æ•°æ®åº“å€¼: formDataToSet.unitPrice, // ä¸‡å…ƒ
        æ˜¾ç¤ºå€¼: formDataToSet.unitPrice, // ä¸‡å…ƒ
        é»˜è®¤å•ä½: 'wan-yuan'
      })
    }    
    setFormData(formDataToSet)
    setEditingItem(item)
    setIsNewItem(false)
    setShowEditModal(true)
    
    console.log('âœ… [ç¼–è¾‘] è¡¨å•è®¾ç½®å®Œæˆ:', formDataToSet)
  }
  /**
   * åˆ é™¤æ”¶å…¥é¡¹
   */
  const handleDelete = (item: RevenueItem) => {
    modals.openConfirmModal({
      title: 'ç¡®è®¤åˆ é™¤',
      centered: true,
      children: (
        <Text size="sm">
          ç¡®å®šè¦åˆ é™¤æ”¶å…¥é¡¹â€œ<Text component="span" fw={600} c="red">{item.name}</Text>â€å—ï¼Ÿ
        </Text>
      ),
      labels: { confirm: 'ç¡®å®šåˆ é™¤', cancel: 'å–æ¶ˆ' },
      confirmProps: { color: 'red' },
      onConfirm: () => {
        deleteRevenueItem(item.id)
        notifications.show({
          title: 'æˆåŠŸ',
          message: 'æ”¶å…¥é¡¹å·²åˆ é™¤',
          color: 'green',
        })
      },
    })
  }

  /**
   * AIæµ‹ç®—æ”¶å…¥é¡¹
   */
  const handleAiEstimate = async () => {
    if (!formData.name || formData.name.trim() === '') {
      notifications.show({
        title: 'é”™è¯¯',
        message: 'è¯·å…ˆè¾“å…¥æ”¶å…¥é¡¹åç§°',
        color: 'red',
      })
      return
    }

    if (!context?.projectId) {
      notifications.show({
        title: 'é”™è¯¯',
        message: 'æœªæ‰¾åˆ°é¡¹ç›®ID',
        color: 'red',
      })
      return
    }

    setAiEstimating(true)
    try {
      const response = await revenueCostApi.estimateItem(context.projectId, formData.name)

      if (response.success && response.data) {
        // åº”ç”¨AIä¼°ç®—ç»“æœï¼ŒåŒ…å«remarkå¤‡æ³¨
        const aiData: any = response.data
        setFormData({
          ...formData,
          category: aiData.category as RevenueCategory,
          fieldTemplate: aiData.fieldTemplate as FieldTemplate,
          quantity: aiData.quantity,
          unit: aiData.unit,
          unitPrice: aiData.unitPrice,

          vatRate: aiData.vatRate,
          area: aiData.area,
          yieldPerArea: aiData.yieldPerArea,
          capacity: aiData.capacity,
          utilizationRate: aiData.utilizationRate,
          subscriptions: aiData.subscriptions,
          directAmount: aiData.directAmount,
          remark: aiData.remark || '',
        } as any)

        notifications.show({
          title: 'AIæµ‹ç®—æˆåŠŸ',
          message: 'å·²è‡ªåŠ¨å¡«å……å…³é”®ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥å¹¶è°ƒæ•´',
          color: 'green',
        })
      } else {
        throw new Error(response.error || 'AIæµ‹ç®—å¤±è´¥')
      }
    } catch (error: any) {
      console.error('AIæµ‹ç®—å¤±è´¥:', error)
      notifications.show({
        title: 'æµ‹ç®—å¤±è´¥',
        message: error.message || 'è¯·ç¨åé‡è¯•',
        color: 'red',
      })
    } finally {
      setAiEstimating(false)
    }
  }

  /**
   * ä¿å­˜æ”¶å…¥é¡¹
   */
  const handleSave = async () => {
    if (!formData.name || formData.name.trim() === '') {
      notifications.show({
        title: 'é”™è¯¯',
        message: 'è¯·è¾“å…¥æ”¶å…¥é¡¹åç§°',
        color: 'red',
      })
      return
    }

    // ç›´æ¥ä¿å­˜ï¼Œå•ä½ç»Ÿä¸€ä¸ºä¸‡å…ƒ
    const dataToSave = { ...formData }
    console.log('ğŸ” [ä¿å­˜] ä¿å­˜å‰çš„formData:', formData)
    console.log('ğŸ” æœ€ç»ˆä¿å­˜åˆ°æ•°æ®åº“çš„æ•°æ®(ä¸‡å…ƒå•ä½):', dataToSave)

    // å…ˆæ›´æ–°æœ¬åœ°çŠ¶æ€
    if (isNewItem) {
      addRevenueItem(dataToSave)
      notifications.show({
        title: 'æˆåŠŸ',
        message: 'æ”¶å…¥é¡¹å·²æ·»åŠ ',
        color: 'green',
      })
    } else if (editingItem) {
      updateRevenueItem(editingItem.id, dataToSave)
      notifications.show({
        title: 'æˆåŠŸ',
        message: 'æ”¶å…¥é¡¹å·²æ›´æ–°',
        color: 'green',
      })
    }

    // ç­‰å¾…çŠ¶æ€æ›´æ–°åå†ä¿å­˜åˆ°åç«¯
    setTimeout(async () => {
      try {
        const state = useRevenueCostStore.getState();
        if (state.context?.projectId) {
          // ä½¿ç”¨æœ€æ–°çš„çŠ¶æ€æ•°æ®
          await revenueCostApi.save({
            project_id: state.context.projectId,
            model_data: {
              revenueItems: state.revenueItems,
              productionRates: state.productionRates,
              aiAnalysisResult: state.aiAnalysisResult,
              workflow_step: state.currentStep
            },
            workflow_step: state.currentStep
          });
          console.log('âœ… æ”¶å…¥é¡¹å·²ä¿å­˜åˆ°æ•°æ®åº“');
        }
      } catch (error) {
        console.error('âŒ ä¿å­˜åˆ°æ•°æ®åº“å¤±è´¥:', error);
        notifications.show({
          title: 'ä¿å­˜å¤±è´¥',
          message: 'æ•°æ®æœªä¿å­˜åˆ°æ•°æ®åº“ï¼Œè¯·ç¨åé‡è¯•',
          color: 'red',
        });
      }
    }, 100); // ç»™çŠ¶æ€æ›´æ–°ä¸€ç‚¹æ—¶é—´

    setShowEditModal(false)
    setFormData({})
  }

  /**
   * AIè‡ªåŠ¨ç”Ÿæˆæ”¶å…¥é¡¹ç›®è¡¨
   */
  const handleGenerateItems = async () => {
    // é˜²æ­¢å¹¶å‘è°ƒç”¨
    if (isGeneratingRef.current) {
      console.log('âš ï¸ æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè·³è¿‡é‡å¤è°ƒç”¨')
      return
    }
    
    if (!context?.projectId) {
      console.warn('AIç”Ÿæˆè·³è¿‡ï¼šæœªæ‰¾åˆ°é¡¹ç›®ID')
      return
    }

    if (!aiAnalysisResult || !aiAnalysisResult.selected_categories || aiAnalysisResult.selected_categories.length === 0) {
      console.warn('AIç”Ÿæˆè·³è¿‡ï¼šæœªå®ŒæˆAIè¥æ”¶ç»“æ„åˆ†æ')
      return
    }

    // è®¾ç½®ç”Ÿæˆä¸­æ ‡è®°
    isGeneratingRef.current = true

    // ä» context ä¸­æ„å»ºæŠ•èµ„æ•°æ®ï¼ˆä½¿ç”¨åŸºç¡€ä¿¡æ¯ï¼‰
    const investmentData = {
      total_investment: context.totalInvestment,
      construction_years: context.constructionYears,
      operation_years: context.operationYears,
      construction_cost: 0, // é»˜è®¤å€¼
      equipment_cost: 0, // é»˜è®¤å€¼
    }

    console.log('ğŸ¤– å¼€å§‹è‡ªåŠ¨ç”Ÿæˆæ”¶å…¥é¡¹...')
    console.log('ğŸ“Š è¥æ”¶ç±»åˆ«æ•°é‡:', aiAnalysisResult.selected_categories.length)
    console.log('ğŸ“„ è¥æ”¶ç±»åˆ«è¯¦æƒ…:', aiAnalysisResult.selected_categories.map(c => c.category_name).join(', '))
    
    try {
      const response = await revenueCostApi.generateItems(context.projectId, {
        revenueStructure: aiAnalysisResult,
        investmentData,
      })

      if (response.success && response.data?.revenue_items) {
        console.log(`âœ… åç«¯LLMç”ŸæˆæˆåŠŸï¼š${response.data.revenue_items.length} ä¸ªæ”¶å…¥é¡¹`)
        console.log('ğŸ“ æ”¶å…¥é¡¹åˆ—è¡¨:', response.data.revenue_items.map((item: any) => item.name).join(', '))
        
        const generatedItems = response.data.revenue_items
        const itemCount = generatedItems.length
        
        // å…ˆè®°å½•å½“å‰æ”¶å…¥é¡¹æ•°é‡
        console.log(`ğŸ—‘ï¸ å‡†å¤‡æ¸…ç©ºç°æœ‰ ${revenueItems.length} ä¸ªæ”¶å…¥é¡¹`)
        
        // æ¸…ç©ºç°æœ‰æ”¶å…¥é¡¹ - æ³¨æ„ï¼šè¦åœ¨æ·»åŠ æ–°é¡¹ä¹‹å‰å®Œæˆ
        const itemsToDelete = [...revenueItems]
        console.log(`ğŸ—‘ï¸ å¼€å§‹åˆ é™¤æ”¶å…¥é¡¹:`, itemsToDelete.map(i => i.name).join(', '))
        itemsToDelete.forEach(item => {
          console.log(`  âŒ åˆ é™¤: ${item.name} (ID: ${item.id})`)
          deleteRevenueItem(item.id)
        })

        // ç­‰å¾…ä¸€ä¸ªå¾®ä»»åŠ¡å‘¨æœŸï¼Œç¡®ä¿åˆ é™¤æ“ä½œå®Œæˆ
        await new Promise(resolve => setTimeout(resolve, 0))
        
        console.log(`âœ… æ¸…ç©ºå®Œæˆï¼Œå½“å‰å‰©ä½™æ”¶å…¥é¡¹: ${revenueItems.length} ä¸ª`)
        console.log(`â• å¼€å§‹æ·»åŠ  ${itemCount} ä¸ªæ–°æ”¶å…¥é¡¹`)

        // æ·»åŠ AIç”Ÿæˆçš„æ”¶å…¥é¡¹
        generatedItems.forEach((item: any, index: number) => {
          console.log(`  â• [${index + 1}/${itemCount}] æ·»åŠ : ${item.name}`)
          addRevenueItem({
            name: item.name,
            category: item.category || 'other',
            fieldTemplate: item.field_template || 'quantity-price',
            quantity: item.quantity || 0,
            unitPrice: item.unit_price || 0,
            area: item.area || 0,
            yieldPerArea: item.yield_per_area || 0,
            capacity: item.capacity || 0,
            utilizationRate: item.utilization_rate || 0,
            subscriptions: item.subscriptions || 0,
            directAmount: item.direct_amount || 0,
          })
        })

        console.log(`âœ… AIç”Ÿæˆå®Œæˆï¼šæ·»åŠ äº† ${itemCount} ä¸ªæ”¶å…¥é¡¹`)
        notifications.show({
          title: 'è‡ªåŠ¨ç”ŸæˆæˆåŠŸ',
          message: `å·²è‡ªåŠ¨ç”Ÿæˆ ${itemCount} ä¸ªæ”¶å…¥é¡¹ï¼Œå¯ç»§ç»­ç¼–è¾‘è°ƒæ•´`,
          color: 'green',
        })
      } else {
        throw new Error(response.error || 'AIç”Ÿæˆå¤±è´¥')
      }
    } catch (error: any) {
      console.error('âŒ AIç”Ÿæˆæ”¶å…¥é¡¹å¤±è´¥:', error)
      // ä¸æ˜¾ç¤ºé”™è¯¯é€šçŸ¥ï¼Œåªè®°å½•æ—¥å¿—
    } finally {
      // æ¸…é™¤ç”Ÿæˆä¸­æ ‡è®°
      isGeneratingRef.current = false
    }
  }

  /**
   * ç»„ä»¶æŒ‚è½½æ—¶è‡ªåŠ¨ç”Ÿæˆï¼ˆå¦‚æœæ”¶å…¥é¡¹ä¸ºç©ºä¸”æœ‰AIåˆ†æç»“æœï¼‰
   * ä½¿ç”¨ useRef é˜²æ­¢é‡å¤ç”Ÿæˆ
   */
  useEffect(() => {
    console.log('=== useEffect è¢«è§¦å‘ ===')
    console.log('ğŸ”¹ hasAutoGeneratedRef.current:', hasAutoGeneratedRef.current)
    console.log('ğŸ”¹ revenueItems.length:', revenueItems.length)
    console.log('ğŸ”¹ aiAnalysisResult:', aiAnalysisResult ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨')
    console.log('ğŸ”¹ context:', context ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨')
    
    // å¦‚æœå·²ç»ç”Ÿæˆè¿‡ï¼Œä¸å†ç”Ÿæˆ
    if (hasAutoGeneratedRef.current) {
      console.log('â­ï¸ å·²ç»ç”Ÿæˆè¿‡æ”¶å…¥é¡¹ï¼Œè·³è¿‡è‡ªåŠ¨ç”Ÿæˆ')
      return
    }
    
    // å¦‚æœæœ‰æ”¶å…¥é¡¹ï¼Œä¹Ÿä¸ç”Ÿæˆ
    if (revenueItems.length > 0) {
      console.log('âš ï¸ å·²æœ‰æ”¶å…¥é¡¹ï¼Œè·³è¿‡è‡ªåŠ¨ç”Ÿæˆ')
      console.log('ğŸ“ å½“å‰æ”¶å…¥é¡¹:', revenueItems.map(i => i.name).join(', '))
      hasAutoGeneratedRef.current = true
      return
    }
    
    if (aiAnalysisResult && aiAnalysisResult.selected_categories && aiAnalysisResult.selected_categories.length > 0 && context) {
      console.log('ğŸ”µ æ£€æµ‹åˆ°AIåˆ†æç»“æœï¼Œå¼€å§‹è‡ªåŠ¨ç”Ÿæˆæ”¶å…¥é¡¹...')
      console.log('ğŸ“¦ AIæ¨èçš„æ”¶å…¥ç±»åˆ«æ•°:', aiAnalysisResult.selected_categories.length)
      console.log('ğŸ“ AIæ¨èçš„ç±»åˆ«:', aiAnalysisResult.selected_categories.map(c => c.category_name).join(', '))
      handleGenerateItems()
      hasAutoGeneratedRef.current = true // è®¾ç½®æ ‡è®°
    } else {
      console.log('âš ï¸ æ¡ä»¶ä¸æ»¡è¶³ï¼Œä¸ç”Ÿæˆæ”¶å…¥é¡¹')
    }
  }, [aiAnalysisResult, context]) // åªç›‘å¬aiAnalysisResultå’Œcontextçš„å˜åŒ–ï¼Œé¿å…å¾ªç¯
  
  /**
   * ç›‘å¬revenueItemsçš„å˜åŒ–ï¼Œå½“æœ‰æ•°æ®æ—¶è®¾ç½®ç”Ÿæˆæ ‡è®°
   */
  useEffect(() => {
    if (revenueItems.length > 0 && !hasAutoGeneratedRef.current) {
      console.log('ğŸ“ æ£€æµ‹åˆ°å·²åŠ è½½çš„æ”¶å…¥é¡¹ï¼Œè®¾ç½®ç”Ÿæˆæ ‡è®°é˜²æ­¢é‡å¤ç”Ÿæˆ')
      console.log('ğŸ“Š å·²åŠ è½½çš„æ”¶å…¥é¡¹æ•°é‡:', revenueItems.length)
      hasAutoGeneratedRef.current = true
    }
  }, [revenueItems]) // ç›‘å¬revenueItemsçš„å˜åŒ–

  /**
   * ç›‘å¬formDataçš„å˜åŒ–ï¼Œç”¨äºè°ƒè¯•
   */
  useEffect(() => {
    console.log('ğŸ“‹ [çŠ¶æ€å˜åŒ–] formDataæ›´æ–°:', {

      unitPrice: formData.unitPrice,
      name: formData.name,
      hasData: !!formData.name
    })
  }, [formData])

  /**
   * æ ¼å¼åŒ–é‡‘é¢æ˜¾ç¤ºï¼ˆ2ä½å°æ•°ï¼‰
   */
  const formatAmount = (amount: number): string => {
    return `${amount.toFixed(2)}`
  }

  /**
   * æ¸²æŸ“å­—æ®µå€¼ï¼ˆç»Ÿä¸€ä»¥ä¸‡å…ƒæ˜¾ç¤ºï¼‰
   */
  const renderFieldValue = (item: RevenueItem): string => {
    // è¾…åŠ©å‡½æ•°ï¼šç»Ÿä¸€æ ¼å¼åŒ–ä»·æ ¼æ˜¾ç¤ºï¼ˆä¸‡å…ƒï¼‰
    const formatPriceInWanYuan = (price: number | undefined): string => {
      if (price === undefined || price === null) return '0ä¸‡å…ƒ';
      // ç»Ÿä¸€ä»¥ä¸‡å…ƒæ˜¾ç¤ºï¼Œä¿ç•™4ä½å°æ•°
      return `${price.toFixed(4)}`;
    };
    
    switch (item.fieldTemplate) {
      case 'quantity-price':
        return `${item.quantity || 0} Ã— ${formatPriceInWanYuan(item.unitPrice)}`
      case 'area-yield-price':
        return `${item.area || 0}äº© Ã— ${item.yieldPerArea || 0} Ã— ${formatPriceInWanYuan(item.unitPrice)}`
      case 'capacity-utilization':
        return `${item.capacity || 0} Ã— ${((item.utilizationRate || 0) * 100).toFixed(0)}% Ã— ${formatPriceInWanYuan(item.unitPrice)}`
      case 'subscription':
        return `${item.subscriptions || 0} Ã— ${formatPriceInWanYuan(item.unitPrice)}`
      case 'direct-amount':
        return `${(item.directAmount || 0).toFixed(4)}ä¸‡å…ƒ`
      default:
        return '-'
    }
  }

  /**
   * æ¸²æŸ“ç¼–è¾‘è¡¨å•å­—æ®µ
   */
  const renderFormFields = () => {
    const template = formData.fieldTemplate || 'quantity-price'
    
    // è®¡ç®—æ€»ä»·é¢„è§ˆï¼ˆç»Ÿä¸€ä»¥ä¸‡å…ƒæ˜¾ç¤ºï¼‰
    const calculatePreviewTotal = () => {
      if (!formData.name || formData.name.trim() === '') return 0;
      
      switch (template) {
        case 'quantity-price':
          const quantity = formData.quantity || 0;
          const unitPrice = formData.unitPrice || 0;
          
          return quantity * unitPrice; // ç»“æœä¸ºä¸‡å…ƒï¼ˆç›´æ¥ä½œä¸ºå«ç¨æ”¶å…¥ï¼‰
          
        case 'area-yield-price':
          const area = formData.area || 0;
          const yieldPerArea = formData.yieldPerArea || 0;
          const areaUnitPrice = formData.unitPrice || 0;
          
          return area * yieldPerArea * areaUnitPrice; // ç»“æœä¸ºä¸‡å…ƒï¼ˆç›´æ¥ä½œä¸ºå«ç¨æ”¶å…¥ï¼‰
          
        case 'capacity-utilization':
          const capacity = formData.capacity || 0;
          const utilizationRate = formData.utilizationRate || 0;
          const capacityUnitPrice = formData.unitPrice || 0;
          
          return capacity * utilizationRate * capacityUnitPrice; // ç»“æœä¸ºä¸‡å…ƒï¼ˆç›´æ¥ä½œä¸ºå«ç¨æ”¶å…¥ï¼‰
          
        case 'subscription':
          const subscriptions = formData.subscriptions || 0;
          const subscriptionUnitPrice = formData.unitPrice || 0;
          
          return subscriptions * subscriptionUnitPrice; // ç»“æœä¸ºä¸‡å…ƒï¼ˆç›´æ¥ä½œä¸ºå«ç¨æ”¶å…¥ï¼‰
          
        case 'direct-amount':
          return formData.directAmount || 0; // å·²ç»æ˜¯ä¸‡å…ƒå•ä½ï¼ˆç›´æ¥ä½œä¸ºå«ç¨æ”¶å…¥ï¼‰
          
        default:
          return 0;
      }
    };

    return (
      <Stack gap="md">
        {/* åŸºç¡€ä¿¡æ¯ - å…¨å®½ */}
        <TextInput
          label="æ”¶å…¥é¡¹åç§°"
          placeholder="è¯·è¾“å…¥æ”¶å…¥é¡¹åç§°"
          value={formData.name || ''}
          onChange={(e) => setFormData({ ...formData, name: e.target.value })}
          required
        />

        {/* 2æ å¸ƒå±€ */}
        <Grid gutter="md">
          <Grid.Col span={6}>
            <Select
              label="æ”¶å…¥ç±»åˆ«"
              data={Object.entries(CATEGORY_LABELS).map(([value, label]) => ({
                value,
                label,
              }))}
              value={formData.category || 'other'}
              onChange={(value) => setFormData({ ...formData, category: value as RevenueCategory })}
            />
          </Grid.Col>

          <Grid.Col span={6}>
            <Select
              label="å­—æ®µæ¨¡æ¿"
              data={Object.entries(TEMPLATE_LABELS).map(([value, label]) => ({
                value,
                label,
              }))}
              value={template}
              onChange={(value) => setFormData({ ...formData, fieldTemplate: value as FieldTemplate })}
            />
          </Grid.Col>
        </Grid>

        {/* æ ¹æ®æ¨¡æ¿æ˜¾ç¤ºä¸åŒå­—æ®µ */}
        {/* ç»Ÿä¸€ä½¿ç”¨4åˆ—å¸ƒå±€ï¼Œä¸å¤Ÿçš„ä½¿ç”¨å ä½ç¬¦å¡«å…… */}
        <Grid gutter="md">
          {template === 'quantity-price' && (
            <>
              <Grid.Col span={3}>
                <NumberInput
                  label={formData.unit ? `æ•°é‡ï¼ˆ${formData.unit}ï¼‰` : 'æ•°é‡'}
                  placeholder="è¯·è¾“å…¥æ•°é‡"
                  value={formData.quantity || 0}
                  onChange={(value) => setFormData({ ...formData, quantity: Number(value) })}
                  min={0}
                  decimalScale={4}
                />
              </Grid.Col>
              <Grid.Col span={3}>
                <TextInput
                  label="å•ä½"
                  placeholder="å¦‚ï¼šå…¬æ–¤ã€å¨"
                  value={formData.unit || ''}
                  onChange={(e) => setFormData({ ...formData, unit: e.target.value })}
                />
              </Grid.Col>
              <Grid.Col span={3}>
                <div style={{ position: 'relative' }}>
                  <NumberInput
                    label="å•ä»·(ä¸‡å…ƒ)"
                    placeholder="è¯·è¾“å…¥å•ä»·"
                    value={formData.unitPrice || 0}
                    onChange={(value) => {
                      const newUnitPrice = value !== null && value !== undefined ? Number(value) : undefined;
                      console.log('ğŸ” [è¡¨å•è¾“å…¥] å•ä»·å˜åŒ–:', { 
                        inputValue: value, 
                        newUnitPrice, 
                        fieldName: 'unitPrice (quantity-price)' 
                      });
                      setFormData({ ...formData, unitPrice: newUnitPrice });
                    }}
                    min={0}
                    decimalScale={7}
                  />
                  {formData.unitPrice !== undefined && formData.unitPrice !== null && formData.unitPrice > 0 && formData.unitPrice < 0.1 && (
                    <Text 
                      size="sm" 
                      c="blue" 
                      style={{ 
                        position: 'absolute', 
                        right: '-80px', 
                        top: '32px',
                        whiteSpace: 'nowrap',
                        zIndex: 1
                      }}
                    >
                      {(formData.unitPrice * 10000).toFixed(2)}å…ƒ
                    </Text>
                  )}
                </div>
              </Grid.Col>

            </>
          )}

          {template === 'area-yield-price' && (
            <>
              <Grid.Col span={3}>
                <NumberInput
                  label="é¢ç§¯ï¼ˆäº©ï¼‰"
                  placeholder="è¯·è¾“å…¥é¢ç§¯"
                  value={formData.area || 0}
                  onChange={(value) => setFormData({ ...formData, area: Number(value) })}
                  min={0}
                  decimalScale={4}
                />
              </Grid.Col>
              <Grid.Col span={3}>
                <NumberInput
                  label="äº©äº§é‡"
                  placeholder="è¯·è¾“å…¥äº©äº§é‡"
                  value={formData.yieldPerArea || 0}
                  onChange={(value) => setFormData({ ...formData, yieldPerArea: Number(value) })}
                  min={0}
                  decimalScale={4}
                />
              </Grid.Col>
              <Grid.Col span={3}>
                <div style={{ position: 'relative' }}>
                  <NumberInput
                    label="å•ä»·(ä¸‡å…ƒ)"
                    placeholder="è¯·è¾“å…¥å•ä»·"
                    value={formData.unitPrice || 0}
                    onChange={(value) => setFormData({ ...formData, unitPrice: value !== null && value !== undefined ? Number(value) : undefined })}
                    min={0}
                    decimalScale={7}
                  />
                  {formData.unitPrice !== undefined && formData.unitPrice !== null && formData.unitPrice > 0 && formData.unitPrice < 0.1 && (
                    <Text 
                      size="sm" 
                      c="blue" 
                      style={{ 
                        position: 'absolute', 
                        right: '-80px', 
                        top: '32px',
                        whiteSpace: 'nowrap',
                        zIndex: 1
                      }}
                    >
                      {(formData.unitPrice * 10000).toFixed(2)}å…ƒ
                    </Text>
                  )}
                </div>
              </Grid.Col>

            </>
          )}

          {template === 'capacity-utilization' && (
            <>
              <Grid.Col span={3}>
                <NumberInput
                  label={formData.capacityUnit ? `äº§èƒ½ï¼ˆ${formData.capacityUnit}ï¼‰` : 'äº§èƒ½'}
                  placeholder="è¯·è¾“å…¥äº§èƒ½"
                  value={formData.capacity || 0}
                  onChange={(value) => setFormData({ ...formData, capacity: Number(value) })}
                  min={0}
                  decimalScale={4}
                />
              </Grid.Col>
              <Grid.Col span={3}>
                <TextInput
                  label="å•ä½"
                  placeholder="å¦‚ï¼šå°ã€ä»¶"
                  value={formData.capacityUnit || ''}
                  onChange={(e) => setFormData({ ...formData, capacityUnit: e.target.value })}
                />
              </Grid.Col>
              <Grid.Col span={3}>
                <div style={{ position: 'relative' }}>
                  <NumberInput
                    label="å•ä»·(ä¸‡å…ƒ)"
                    placeholder="è¯·è¾“å…¥å•ä»·"
                    value={formData.unitPrice || 0}
                    onChange={(value) => setFormData({ ...formData, unitPrice: value !== null && value !== undefined ? Number(value) : undefined })}
                    min={0}
                    decimalScale={7}
                  />
                  {formData.unitPrice !== undefined && formData.unitPrice !== null && formData.unitPrice > 0 && formData.unitPrice < 0.1 && (
                    <Text 
                      size="sm" 
                      c="blue" 
                      style={{ 
                        position: 'absolute', 
                        right: '-80px', 
                        top: '32px',
                        whiteSpace: 'nowrap',
                        zIndex: 1
                      }}
                    >
                      {(formData.unitPrice * 10000).toFixed(2)}å…ƒ
                    </Text>
                  )}
                </div>
              </Grid.Col>

            </>
          )}

          {template === 'subscription' && (
            <>
              <Grid.Col span={3}>
                <NumberInput
                  label="è®¢é˜…æ•°"
                  placeholder="è¯·è¾“å…¥è®¢é˜…æ•°"
                  value={formData.subscriptions || 0}
                  onChange={(value) => setFormData({ ...formData, subscriptions: Number(value) })}
                  min={0}
                  decimalScale={0}
                />
              </Grid.Col>
              <Grid.Col span={3}>
                <div style={{ position: 'relative' }}>
                  <NumberInput
                    label="å•ä»·(ä¸‡å…ƒ)"
                    placeholder="è¯·è¾“å…¥å•ä»·"
                    value={formData.unitPrice || 0}
                    onChange={(value) => setFormData({ ...formData, unitPrice: value !== null && value !== undefined ? Number(value) : undefined })}
                    min={0}
                    decimalScale={7}
                  />
                  {formData.unitPrice !== undefined && formData.unitPrice !== null && formData.unitPrice > 0 && formData.unitPrice < 0.1 && (
                    <Text 
                      size="sm" 
                      c="blue" 
                      style={{ 
                        position: 'absolute', 
                        right: '-80px', 
                        top: '32px',
                        whiteSpace: 'nowrap',
                        zIndex: 1
                      }}
                    >
                      {(formData.unitPrice * 10000).toFixed(2)}å…ƒ
                    </Text>
                  )}
                </div>
              </Grid.Col>

              <Grid.Col span={3}>
                {/* å ä½ç¬¦ */}
                <div style={{ height: '36px' }}></div>
              </Grid.Col>
            </>
          )}

          {template === 'direct-amount' && (
            <>
              <Grid.Col span={3}>
                <NumberInput
                  label="é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰"
                  placeholder="è¯·è¾“å…¥é‡‘é¢"
                  value={formData.directAmount || 0}
                  onChange={(value) => setFormData({ ...formData, directAmount: Number(value) })}
                  min={0}
                  decimalScale={2}
                />
              </Grid.Col>
              <Grid.Col span={9}>
                {/* å ä½ç¬¦ */}
                <div style={{ height: '36px' }}></div>
              </Grid.Col>
            </>
          )}
        </Grid>

        {/* æ¶¨ä»·å‚æ•° - 2æ  */}
        <Grid gutter="md">
          <Grid.Col span={6}>
            <NumberInput
              label="æ¶¨ä»·é—´éš”ï¼ˆå¹´ï¼‰"
              placeholder="0è¡¨ç¤ºä¸æ¶¨ä»·"
              description="æ¯éš”Nå¹´æ¶¨ä»·ä¸€æ¬¡ï¼Œ0è¡¨ç¤ºä¸æ¶¨ä»·"
              value={formData.priceIncreaseInterval || 0}
              onChange={(value) => setFormData({ ...formData, priceIncreaseInterval: Number(value) })}
              min={0}
              max={30}
              decimalScale={0}
            />
          </Grid.Col>
          <Grid.Col span={6}>
            <NumberInput
              label="æ¶¨ä»·å¹…åº¦ï¼ˆ%ï¼‰"
              placeholder="è¯·è¾“å…¥æ¶¨ä»·å¹…åº¦"
              description="æ¯æ¬¡æ¶¨ä»·çš„ç™¾åˆ†æ¯”ï¼Œä¾‹å¦‚ï¼š5 è¡¨ç¤º 5%"
              value={formData.priceIncreaseRate || 0}
              onChange={(value) => setFormData({ ...formData, priceIncreaseRate: Number(value) })}
              min={0}
              max={100}
              decimalScale={2}
              disabled={(formData.priceIncreaseInterval || 0) === 0}
            />
          </Grid.Col>
        </Grid>

        {/* å¢å€¼ç¨ç‡å’Œå¤‡æ³¨ - 2æ  */}
        <Grid gutter="md">
          <Grid.Col span={6}>
            <NumberInput
              label="å¢å€¼ç¨ç‡ï¼ˆ%ï¼‰"
              placeholder="è¯·è¾“å…¥å¢å€¼ç¨ç‡"
              value={(formData.vatRate || 0.13) * 100}
              onChange={(value) => setFormData({ ...formData, vatRate: Number(value) / 100 })}
              min={0}
              max={100}
              decimalScale={2}
            />
          </Grid.Col>

          <Grid.Col span={6}>
            <Tooltip label={formData.remark || 'æ— å¤‡æ³¨'} multiline w={300} withArrow>
              <TextInput
                label="å¤‡æ³¨"
                placeholder="è¯·è¾“å…¥å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰"
                value={formData.remark || ''}
                onChange={(e) => setFormData({ ...formData, remark: e.target.value })}
              />
            </Tooltip>
          </Grid.Col>
        </Grid>

        {/* æ€»ä»·é¢„è§ˆ - å·¦ä¸‹è§’ */}
        <div style={{
          padding: '8px 12px',
          backgroundColor: '#F0F9FF',
          borderRadius: '6px',
          border: '1px solid #BAE6FD',
          marginTop: '8px'
        }}>
          <Text size="sm" c="#0C4A6E" fw={500}>
            ğŸ’¡ æ€»ä»·é¢„è§ˆï¼š{(calculatePreviewTotal()).toFixed(2)} ä¸‡å…ƒ
          </Text>
        </div>

        {/* æ¶¨ä»·æç¤º */}
        {formData.priceIncreaseInterval && formData.priceIncreaseInterval > 0 && formData.priceIncreaseRate && formData.priceIncreaseRate > 0 && (
          <div style={{
            padding: '8px 12px',
            backgroundColor: '#FFF7E6',
            borderRadius: '6px',
            borderLeft: '3px solid #FF7D00'
          }}>
            <Text size="xs" c="#FF7D00" fw={500}>
              ğŸ’¡ æ¶¨ä»·è§„åˆ™ï¼šæ¯{formData.priceIncreaseInterval}å¹´æ¶¨ä»·{formData.priceIncreaseRate}%ï¼Œ
              1-{formData.priceIncreaseInterval}å¹´æ”¶å…¥{calculatePreviewTotal().toFixed(2)}ä¸‡å…ƒï¼Œ
              {formData.priceIncreaseInterval + 1}-{formData.priceIncreaseInterval * 2}å¹´æ”¶å…¥{(calculatePreviewTotal() * (1 + (formData.priceIncreaseRate || 0) / 100)).toFixed(2)}ä¸‡å…ƒ
            </Text>
          </div>
        )}
      </Stack>
    )
  }

  return (
    <>
      <Stack gap="md">
        <Group justify="space-between" align="center">
          <Text size="md" fw={600} c="#1D2129">
            è¥ä¸šæ”¶å…¥é…ç½®
          </Text>
          <Group gap="xs">
            <Tooltip label="é…ç½®è¾¾äº§ç‡">
              <ActionIcon
                variant="light"
                color="orange"
                size="lg"
                onClick={() => setProductionRateModalOpened(true)}
              >
                <IconChartLine size={20} />
              </ActionIcon>
            </Tooltip>
            <Tooltip label="æŸ¥çœ‹æ”¶å…¥è¯¦è¡¨">
              <ActionIcon
                variant="light"
                color="cyan"
                size="lg"
                onClick={() => setShowRevenueDetailModal(true)}
                disabled={revenueItems.length === 0}
              >
                <IconTable size={20} />
              </ActionIcon>
            </Tooltip>
            <Tooltip label="æ–°å¢æ”¶å…¥é¡¹">
              <ActionIcon
                variant="filled"
                color="blue"
                size="lg"
                onClick={handleAdd}
              >
                <IconPlus size={20} />
              </ActionIcon>
            </Tooltip>
          </Group>
        </Group>

        {revenueItems.length === 0 ? (
          <div style={{
            padding: '40px',
            textAlign: 'center',
            backgroundColor: '#F7F8FA',
            borderRadius: '8px',
            border: '1px dashed #E5E6EB'
          }}>
            <Text size="sm" c="#86909C">
              {isGeneratingRef.current ? 'æ­£åœ¨ä½¿ç”¨AIç”Ÿæˆ...' : 'æš‚æ— æ”¶å…¥é¡¹ï¼Œè¯·ç‚¹å‡»"æ–°å¢æ”¶å…¥é¡¹"æ·»åŠ '}
            </Text>
          </div>
        ) : (
          <div style={{ overflowX: 'auto' }}>
            <Table striped highlightOnHover withTableBorder style={{ minWidth: '1000px' }}>
              <Table.Thead>
                <Table.Tr style={{ backgroundColor: '#F7F8FA' }}>
                  <Table.Th style={{ width: '50px', textAlign: 'center' }}>åºå·</Table.Th>
                  <Table.Th style={{ width: '180px' }}>æ”¶å…¥é¡¹åç§°</Table.Th>
                  <Table.Th style={{ width: '100px' }}>ç±»åˆ«</Table.Th>
                  <Table.Th style={{ width: '150px' }}>æ¨¡æ¿</Table.Th>
                  <Table.Th style={{ width: '200px' }}>å‚æ•°å€¼</Table.Th>
                  <Table.Th style={{ width: '100px', textAlign: 'right' }}>å«ç¨æ”¶å…¥</Table.Th>
                  <Table.Th style={{ width: '100px', textAlign: 'right' }}>ä¸å«ç¨æ”¶å…¥</Table.Th>
                  <Table.Th style={{ width: '100px', textAlign: 'right' }}>å¢å€¼ç¨</Table.Th>
                  <Table.Th style={{ width: '80px', textAlign: 'center' }}>ç¨ç‡</Table.Th>
                  <Table.Th style={{ width: '100px', textAlign: 'center' }}>æ“ä½œ</Table.Th>
                </Table.Tr>
              </Table.Thead>
              <Table.Tbody>
                {revenueItems.map((item) => {
                  const taxableIncome = calculateTaxableIncome(item)
                  const nonTaxIncome = calculateNonTaxIncome(item)
                  const vatAmount = calculateVatAmount(item)

                  return (
                    <Table.Tr key={item.id}>
                      <Table.Td style={{ textAlign: 'center' }}>{item.index}</Table.Td>
                      <Table.Td>{item.name}</Table.Td>
                      <Table.Td>
                        <Badge size="sm" color="blue" variant="light">
                          {CATEGORY_LABELS[item.category]}
                        </Badge>
                      </Table.Td>
                      <Table.Td>
                        <Text size="xs" c="#86909C">
                          {TEMPLATE_LABELS[item.fieldTemplate]}
                        </Text>
                      </Table.Td>
                      <Table.Td>
                        <Text size="xs" c="#4E5969">
                          {renderFieldValue(item)}
                        </Text>
                      </Table.Td>
                      <Table.Td style={{ textAlign: 'right' }}>
                        <Text size="sm" fw={500}>
                          {formatAmount(taxableIncome)}
                        </Text>
                      </Table.Td>
                      <Table.Td style={{ textAlign: 'right' }}>
                        <Text size="sm" fw={500} c="#165DFF">
                          {formatAmount(nonTaxIncome)}
                        </Text>
                      </Table.Td>
                      <Table.Td style={{ textAlign: 'right' }}>
                        <Text size="sm" c="#F7BA1E">
                          {formatAmount(vatAmount)}
                        </Text>
                      </Table.Td>
                      <Table.Td style={{ textAlign: 'center' }}>
                        <Text size="xs">
                          {(item.vatRate * 100).toFixed(0)}%
                        </Text>
                      </Table.Td>
                      <Table.Td style={{ textAlign: 'center' }}>
                        <Group gap={4} justify="center">
                          <Tooltip label="ç¼–è¾‘">
                            <ActionIcon
                              variant="light"
                              color="blue"
                              onClick={() => handleEdit(item)}
                              size="sm"
                            >
                              <IconEdit size={16} />
                            </ActionIcon>
                          </Tooltip>
                          <Tooltip label="åˆ é™¤">
                            <ActionIcon
                              variant="light"
                              color="red"
                              onClick={() => handleDelete(item)}
                              size="sm"
                            >
                              <IconTrash size={16} />
                            </ActionIcon>
                          </Tooltip>
                        </Group>
                      </Table.Td>
                    </Table.Tr>
                  )
                })}
                {/* åˆè®¡è¡Œ */}
                <Table.Tr style={{ backgroundColor: '#F7F8FA' }}>
                  <Table.Td style={{ textAlign: 'center' }}></Table.Td>
                  <Table.Td>
                    <Text fw={600}>åˆè®¡</Text>
                  </Table.Td>
                  <Table.Td colSpan={3}></Table.Td>
                  <Table.Td style={{ textAlign: 'right' }}>
                    <Text fw={600} c="#1D2129">
                      {formatAmount(revenueItems.reduce((sum, item) => sum + calculateTaxableIncome(item), 0))}
                    </Text>
                  </Table.Td>
                  <Table.Td style={{ textAlign: 'right' }}>
                    <Text fw={600} c="#165DFF">
                      {formatAmount(revenueItems.reduce((sum, item) => sum + calculateNonTaxIncome(item), 0))}
                    </Text>
                  </Table.Td>
                  <Table.Td style={{ textAlign: 'right' }}>
                    <Text fw={600} c="#F7BA1E">
                      {formatAmount(revenueItems.reduce((sum, item) => sum + calculateVatAmount(item), 0))}
                    </Text>
                  </Table.Td>
                  <Table.Td colSpan={2}></Table.Td>
                </Table.Tr>
              </Table.Tbody>
            </Table>
          </div>
        )}
      </Stack>

      {/* ç¼–è¾‘å¯¹è¯æ¡† */}
      <Modal
        opened={showEditModal}
        onClose={() => setShowEditModal(false)}
        title={
          <Group justify="space-between" style={{ width: '100%', paddingRight: '40px' }}>
            <Text size="lg" fw={600}>{isNewItem ? 'æ–°å¢æ”¶å…¥é¡¹' : 'ç¼–è¾‘æ”¶å…¥é¡¹'}</Text>
            <Button
              size="xs"
              leftSection={<IconSparkles size={14} />}
              onClick={handleAiEstimate}
              loading={aiEstimating}
              variant="light"
              color="violet"
            >
              AIæµ‹ç®—
            </Button>
          </Group>
        }
        size="md"
      >
        {renderFormFields()}
        <Group justify="flex-end" mt="xl">
          <Button variant="default" onClick={() => setShowEditModal(false)}>
            å–æ¶ˆ
          </Button>
          <Button onClick={handleSave} style={{ backgroundColor: '#165DFF', color: '#FFFFFF' }}>
            ä¿å­˜
          </Button>
        </Group>
      </Modal>
      
      {/* è¾¾äº§ç‡é…ç½®å¼¹çª— */}
      <ProductionRateModal
        opened={productionRateModalOpened}
        onClose={() => setProductionRateModalOpened(false)}
      />

      {/* æ”¶å…¥è¯¦è¡¨å¼¹çª— */}
      <Modal
        opened={showRevenueDetailModal}
        onClose={() => setShowRevenueDetailModal(false)}
        title={
          <Text size="md">
            ğŸ“Š è¥ä¸šæ”¶å…¥ã€è¥ä¸šç¨é‡‘åŠé™„åŠ å’Œå¢å€¼ç¨ä¼°ç®—è¡¨
          </Text>
        }
        size="calc(100vw - 100px)"
        styles={{
          body: {
            maxHeight: 'calc(100vh - 200px)',
            overflowY: 'auto',
          },
        }}
      >
        {(() => {
          if (!context) return <Text c="red">é¡¹ç›®ä¸Šä¸‹æ–‡æœªåŠ è½½</Text>

          const operationYears = context.operationYears
          const years = Array.from({ length: operationYears }, (_, i) => i + 1)

          return (
            <>
              {/* åŸå¸‚å»ºè®¾ç»´æŠ¤ç¨ç¨ç‡é€‰æ‹©æ»‘å— */}
              <Group justify="flex-end" mb="md">
                <Text size="xs">åŸå¸‚å»ºè®¾ç»´æŠ¤ç¨ç¨ç‡:</Text>
                <SegmentedControl
                  radius="md"
                  size="sm"
                  data={['å¸‚åŒº7%', 'å¿é•‡5%']}
                  value={urbanTaxRate === 0.07 ? 'å¸‚åŒº7%' : 'å¿é•‡5%'}
                  onChange={(value: string) => {
                    setUrbanTaxRate(value === 'å¸‚åŒº7%' ? 0.07 : 0.05);
                  }}
                  styles={{
                    root: {
                      backgroundColor: '#ffffff', // ç™½è‰²èƒŒæ™¯
                      border: '1px solid #d1d5db', // ç°è‰²è¾¹æ¡†
                    },
                    indicator: {
                      backgroundColor: '#165DFF', // è“è‰²é€‰ä¸­èƒŒæ™¯
                    },
                    label: {
                      color: '#000000', // é»‘è‰²æ–‡å­—
                      '&[data-active]': {
                        color: '#ffffff', // ç™½è‰²é€‰ä¸­æ–‡å­—
                      },
                    },
                  }}
                />
              </Group>
              
              <Table striped withTableBorder style={{ fontSize: '11px' }}>
                <Table.Thead>
                  <Table.Tr style={{ backgroundColor: '#F7F8FA' }}>
                    <Table.Th rowSpan={2} style={{ textAlign: 'center', verticalAlign: 'middle', border: '1px solid #dee2e6' }}>åºå·</Table.Th>
                    <Table.Th rowSpan={2} style={{ textAlign: 'center', verticalAlign: 'middle', border: '1px solid #dee2e6' }}>æ”¶å…¥é¡¹ç›®</Table.Th>
                    <Table.Th rowSpan={2} style={{ textAlign: 'center', verticalAlign: 'middle', border: '1px solid #dee2e6' }}>åˆè®¡</Table.Th>
                    <Table.Th colSpan={operationYears} style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>è¿è¥æœŸ</Table.Th>
                  </Table.Tr>
                  <Table.Tr style={{ backgroundColor: '#F7F8FA' }}>
                    {years.map((year) => (
                      <Table.Th key={year} style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                        {year}
                      </Table.Th>
                    ))}
                  </Table.Tr>
                </Table.Thead>
                <Table.Tbody>
                  {/* 1. è¥ä¸šæ”¶å…¥ */}
                  <Table.Tr>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>1</Table.Td>
                    <Table.Td style={{ border: '1px solid #dee2e6' }}>è¥ä¸šæ”¶å…¥</Table.Td>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                      {revenueItems.reduce((sum, item) => {
                        const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, 1)
                        return sum + calculateYearlyRevenue(item, 1, productionRate)
                      }, 0).toFixed(2)}
                    </Table.Td>
                    {years.map((year) => {
                      const yearTotal = revenueItems.reduce((sum, item) => {
                        const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
                        return sum + calculateYearlyRevenue(item, year, productionRate)
                      }, 0)
                      return (
                        <Table.Td key={year} style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                          {yearTotal.toFixed(2)}
                        </Table.Td>
                      )
                    })}
                  </Table.Tr>
                  
                  {/* 1.1, 1.2, 1.3... æ”¶å…¥é¡¹ */}
                  {revenueItems.map((item, idx) => {
                    const yearlyRevenues = years.map((year) => {
                      const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
                      return calculateYearlyRevenue(item, year, productionRate)
                    })

                    // è®¡ç®—åˆè®¡
                    const totalRevenue = yearlyRevenues.reduce((sum, revenue) => sum + revenue, 0);

                    return (
                      <Table.Tr key={`revenue-${item.id}`}>
                        <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>1.{idx + 1}</Table.Td>
                        <Table.Td style={{ border: '1px solid #dee2e6' }}>{item.name}</Table.Td>
                        <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>{totalRevenue.toFixed(2)}</Table.Td>
                        {yearlyRevenues.map((revenue, i) => (
                          <Table.Td key={i} style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                            {revenue.toFixed(2)}
                          </Table.Td>
                        ))}
                      </Table.Tr>
                    )
                  })}
                  
                  {/* 2. å¢å€¼ç¨ */}
                  <Table.Tr>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>2</Table.Td>
                    <Table.Td style={{ border: '1px solid #dee2e6' }}>å¢å€¼ç¨</Table.Td>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                      {(() => {
                        // è®¡ç®—æ‰€æœ‰å¹´ä»½å¢å€¼ç¨çš„åˆè®¡
                        let totalVat = 0;
                        years.forEach((year) => {
                          const yearVat = revenueItems.reduce((sum, item) => {
                            const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
                            const revenue = calculateYearlyRevenue(item, year, productionRate)
                            return sum + (revenue - revenue / (1 + item.vatRate))
                          }, 0);
                          totalVat += yearVat;
                        });
                        return totalVat.toFixed(2);
                      })()}
                    </Table.Td>
                    {years.map((year) => {
                      const yearTotal = revenueItems.reduce((sum, item) => {
                        const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
                        const revenue = calculateYearlyRevenue(item, year, productionRate)
                        return sum + (revenue - revenue / (1 + item.vatRate))
                      }, 0)
                      return (
                        <Table.Td key={year} style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                          {yearTotal.toFixed(2)}
                        </Table.Td>
                      )
                    })}
                  </Table.Tr>
                  
                  {/* 2.1 é”€é¡¹ç¨é¢ */}
                  <Table.Tr>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>2.1</Table.Td>
                    <Table.Td style={{ border: '1px solid #dee2e6' }}>é”€é¡¹ç¨é¢</Table.Td>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                      {(() => {
                        // è®¡ç®—æ‰€æœ‰å¹´ä»½é”€é¡¹ç¨é¢çš„åˆè®¡
                        let totalVat = 0;
                        years.forEach((year) => {
                          const yearVat = revenueItems.reduce((sum, item) => {
                            const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
                            const revenue = calculateYearlyRevenue(item, year, productionRate)
                            // é”€é¡¹ç¨é¢ = å«ç¨æ”¶å…¥ - ä¸å«ç¨æ”¶å…¥
                            return sum + (revenue - revenue / (1 + item.vatRate))
                          }, 0);
                          totalVat += yearVat;
                        });
                        return totalVat.toFixed(2);
                      })()}
                    </Table.Td>
                    {years.map((year) => {
                      const yearTotal = revenueItems.reduce((sum, item) => {
                        const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
                        const revenue = calculateYearlyRevenue(item, year, productionRate)
                        // é”€é¡¹ç¨é¢ = å«ç¨æ”¶å…¥ - ä¸å«ç¨æ”¶å…¥
                        return sum + (revenue - revenue / (1 + item.vatRate))
                      }, 0)
                      return (
                        <Table.Td key={year} style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                          {yearTotal.toFixed(2)}
                        </Table.Td>
                      )
                    })}
                  </Table.Tr>
                  
                  {/* 2.2 è¿›é¡¹ç¨é¢ */}
                  <Table.Tr>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>2.2</Table.Td>
                    <Table.Td style={{ border: '1px solid #dee2e6' }}>è¿›é¡¹ç¨é¢</Table.Td>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>0.00</Table.Td>
                    {years.map((year) => (
                      <Table.Td key={year} style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                        0.00
                      </Table.Td>
                    ))}
                  </Table.Tr>
                  
                  {/* 2.3 è¿›é¡¹ç¨é¢ï¼ˆå›ºå®šèµ„äº§å¾…æŠµæ‰£ï¼‰ */}
                  <Table.Tr>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>2.3</Table.Td>
                    <Table.Td style={{ border: '1px solid #dee2e6' }}>è¿›é¡¹ç¨é¢ï¼ˆå›ºå®šèµ„äº§å¾…æŠµæ‰£ï¼‰</Table.Td>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>0.00</Table.Td>
                    {years.map((year) => (
                      <Table.Td key={year} style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                        0.00
                      </Table.Td>
                    ))}
                  </Table.Tr>
                  
                  {/* 3. å…¶ä»–ç¨è´¹åŠé™„åŠ  */}
                  <Table.Tr>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>3</Table.Td>
                    <Table.Td style={{ border: '1px solid #dee2e6' }}>å…¶ä»–ç¨è´¹åŠé™„åŠ </Table.Td>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                      {(() => {
                        // è®¡ç®—æ‰€æœ‰å¹´ä»½å…¶ä»–ç¨è´¹åŠé™„åŠ çš„åˆè®¡
                        let totalOtherTaxes = 0;
                        years.forEach((year) => {
                          const vatTotal = revenueItems.reduce((sum, item) => {
                            const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
                            const revenue = calculateYearlyRevenue(item, year, productionRate)
                            return sum + (revenue - revenue / (1 + item.vatRate))
                          }, 0)
                          // ä½¿ç”¨çŠ¶æ€ä¸­çš„ç¨ç‡
                          const urbanTax = vatTotal * urbanTaxRate
                          const educationTax = vatTotal * 0.05 // æ•™è‚²è´¹é™„åŠ (3%+åœ°æ–¹2%)
                          const otherTaxes = urbanTax + educationTax
                          totalOtherTaxes += otherTaxes;
                        });
                        return totalOtherTaxes.toFixed(2);
                      })()}
                    </Table.Td>
                    {years.map((year) => {
                      const vatTotal = revenueItems.reduce((sum, item) => {
                        const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
                        const revenue = calculateYearlyRevenue(item, year, productionRate)
                        return sum + (revenue - revenue / (1 + item.vatRate))
                      }, 0)
                      // ä½¿ç”¨çŠ¶æ€ä¸­çš„ç¨ç‡
                      const urbanTax = vatTotal * urbanTaxRate
                      const educationTax = vatTotal * 0.05 // æ•™è‚²è´¹é™„åŠ (3%+åœ°æ–¹2%)
                      const otherTaxes = urbanTax + educationTax
                      return (
                        <Table.Td key={year} style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                          {otherTaxes.toFixed(2)}
                        </Table.Td>
                      )
                    })}
                  </Table.Tr>
                  
                  {/* 3.1 åŸå¸‚å»ºè®¾ç»´æŠ¤ç¨(n%) */}
                  <Table.Tr>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>3.1</Table.Td>
                    <Table.Td style={{ border: '1px solid #dee2e6' }}>åŸå¸‚å»ºè®¾ç»´æŠ¤ç¨({(urbanTaxRate * 100).toFixed(0)}%)</Table.Td>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                      {(() => {
                        const vatTotal = revenueItems.reduce((sum, item) => {
                          const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, 1)
                          const revenue = calculateYearlyRevenue(item, 1, productionRate)
                          return sum + (revenue - revenue / (1 + item.vatRate))
                        }, 0)
                        const urbanTax = vatTotal * urbanTaxRate
                        return urbanTax.toFixed(2)
                      })()}
                    </Table.Td>
                    {years.map((year) => {
                      const vatTotal = revenueItems.reduce((sum, item) => {
                        const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
                        const revenue = calculateYearlyRevenue(item, year, productionRate)
                        return sum + (revenue - revenue / (1 + item.vatRate))
                      }, 0)
                      const urbanTax = vatTotal * urbanTaxRate
                      return (
                        <Table.Td key={year} style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                          {urbanTax.toFixed(2)}
                        </Table.Td>
                      )
                    })}
                  </Table.Tr>
                  
                  {/* 3.2 æ•™è‚²è´¹é™„åŠ (3%+åœ°æ–¹2%) */}
                  <Table.Tr>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>3.2</Table.Td>
                    <Table.Td style={{ border: '1px solid #dee2e6' }}>æ•™è‚²è´¹é™„åŠ (3%+åœ°æ–¹2%)</Table.Td>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                      {(() => {
                        const vatTotal = revenueItems.reduce((sum, item) => {
                          const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, 1)
                          const revenue = calculateYearlyRevenue(item, 1, productionRate)
                          return sum + (revenue - revenue / (1 + item.vatRate))
                        }, 0)
                        const educationTax = vatTotal * 0.05 // 3%+2%=5%
                        return educationTax.toFixed(2)
                      })()}
                    </Table.Td>
                    {years.map((year) => {
                      const vatTotal = revenueItems.reduce((sum, item) => {
                        const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
                        const revenue = calculateYearlyRevenue(item, year, productionRate)
                        return sum + (revenue - revenue / (1 + item.vatRate))
                      }, 0)
                      const educationTax = vatTotal * 0.05 // 3%+2%=5%
                      return (
                        <Table.Td key={year} style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                          {educationTax.toFixed(2)}
                        </Table.Td>
                      )
                    })}
                  </Table.Tr>
                </Table.Tbody>
              </Table>
            </>
          )
        })()}
      </Modal>
    </>
  )
}

export default DynamicRevenueTable




