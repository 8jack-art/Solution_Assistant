import { modals } from '@mantine/modals'
import React, { useState, useEffect, useRef } from 'react'
import {
  Table,
  Button,
  Modal,
  TextInput,
  NumberInput,
  Select,
  Group,
  Stack,
  Text,
  ActionIcon,
  Tooltip,
  Badge,
  Grid,

SegmentedControl,
} from '@mantine/core'
import { IconEdit, IconTrash, IconPlus, IconChartLine, IconSparkles, IconTable, IconTrashX, IconDownload } from '@tabler/icons-react'
import { notifications } from '@mantine/notifications'
import ProductionRateModal from './ProductionRateModal'
import { revenueCostApi } from '@/lib/api'
import {
  RevenueItem,
  RevenueCategory,
  FieldTemplate,
  useRevenueCostStore,
  calculateTaxableIncome,
  calculateNonTaxIncome,
  calculateVatAmount,
  calculateYearlyRevenue,
  getProductionRateForYear,
} from '../../stores/revenueCostStore'
import * as XLSX from 'xlsx'
import {
  TaxConfig,
  TaxCalculationResult,
  DEFAULT_TAX_CONFIG,
  calculateAllTaxes,
  formatTaxRate
} from '../../utils/taxCalculation'

/**
 * ç±»åˆ«æ ‡ç­¾æ˜ å°„
 */
const CATEGORY_LABELS: Record<RevenueCategory, string> = {
  'digital-platform': 'æ•°å­—å¹³å°',
  'agriculture-crop': 'å†œä¸šç§æ¤',
  'manufacturing': 'åˆ¶é€ ä¸š',
  'service': 'æœåŠ¡ä¸š',
  'real-estate': 'æˆ¿åœ°äº§',
  'other': 'å…¶ä»–',
}

/**
 * å­—æ®µæ¨¡æ¿æ ‡ç­¾æ˜ å°„
 */
const TEMPLATE_LABELS: Record<FieldTemplate, string> = {
  'quantity-price': 'æ•°é‡ Ã— å•ä»·',
  'area-yield-price': 'é¢ç§¯ Ã— äº©äº§é‡ Ã— å•ä»·',
  'capacity-utilization': 'äº§èƒ½ Ã— åˆ©ç”¨ç‡ Ã— å•ä»·',
  'subscription': 'è®¢é˜…æ•° Ã— å•ä»·',
  'direct-amount': 'ç›´æ¥é‡‘é¢',
}

/**
 * åŠ¨æ€æ”¶å…¥è¡¨æ ¼ç»„ä»¶
 */
interface DynamicRevenueTableProps {
  deductibleInputTax?: number; // ä»åŸºç¡€æ•°æ®ç¡®è®¤ä¸­è·å–çš„å¾…æŠµæ‰£è¿›é¡¹ç¨
}

const DynamicRevenueTable: React.FC<DynamicRevenueTableProps> = ({ deductibleInputTax = 0 }) => {
  const {
    context,
    aiAnalysisResult,
    revenueItems,
    addRevenueItem,
    updateRevenueItem,
    deleteRevenueItem,
    clearAllRevenueItems
  } = useRevenueCostStore()
  
  const [showEditModal, setShowEditModal] = useState(false)
  const [editingItem, setEditingItem] = useState<RevenueItem | null>(null)
  const [isNewItem, setIsNewItem] = useState(false)
  const [productionRateModalOpened, setProductionRateModalOpened] = useState(false) // è¾¾äº§ç‡é…ç½®å¼¹çª—
  const [aiEstimating, setAiEstimating] = useState(false) // AIæµ‹ç®—ä¸­
  const [showRevenueDetailModal, setShowRevenueDetailModal] = useState(false) // æ”¶å…¥è¯¦è¡¨å¼¹çª—
  const [taxConfig, setTaxConfig] = useState<TaxConfig>(DEFAULT_TAX_CONFIG); // å®Œæ•´çš„ç¨è´¹é…ç½®
  const hasAutoGeneratedRef = useRef(false) // ä½¿ç”¨refé˜²æ­¢ç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶ä¸¢å¤±æ ‡è®°
  const isGeneratingRef = useRef(false) // é˜²æ­¢å¹¶å‘è°ƒç”¨

  // ç¼–è¾‘è¡¨å•çŠ¶æ€
  const [formData, setFormData] = useState<Partial<RevenueItem>>({})

  /**
   * æ‰“å¼€æ–°å¢å¯¹è¯æ¡†
   */
  const handleAdd = () => {
    setFormData({
      name: '',
      category: 'other',
      fieldTemplate: 'quantity-price',
      vatRate: 0.13,

      priceIncreaseInterval: 0, // é»˜è®¤ä¸æ¶¨ä»·
      priceIncreaseRate: 0,
      quantity: 0,
      unitPrice: 0,
      area: 0,
      yieldPerArea: 0,
      capacity: 0,
      utilizationRate: 0,
      subscriptions: 0,
      directAmount: 0,
    })
    setEditingItem(null)
    setIsNewItem(true)
    setShowEditModal(true)
  }

  /**
   * æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†
   */
  const handleEdit = (item: RevenueItem) => {
    const formDataToSet = { ...item }
    
    console.log('ğŸ” [ç¼–è¾‘] åŸå§‹æ•°æ®:', { 
 
      unitPrice: item.unitPrice,
      name: item.name 
    })
    
    // ç®€åŒ–é€»è¾‘ï¼šæ•°æ®åº“ç»Ÿä¸€ä¿å­˜ä¸‡å…ƒå•ä½ï¼Œç¼–è¾‘æ—¶é»˜è®¤ä»¥ä¸‡å…ƒå•ä½æ˜¾ç¤º

    
    // æ•°æ®åº“ä¸­çš„å•ä»·å·²ç»æ˜¯ä¸‡å…ƒå•ä½ï¼Œç›´æ¥ä½¿ç”¨
    if (formDataToSet.unitPrice !== undefined) {
      console.log('ğŸ”„ [ç¼–è¾‘] ç›´æ¥æ˜¾ç¤ºä¸‡å…ƒå•ä½:', {
        æ•°æ®åº“å€¼: formDataToSet.unitPrice, // ä¸‡å…ƒ
        æ˜¾ç¤ºå€¼: formDataToSet.unitPrice, // ä¸‡å…ƒ
        é»˜è®¤å•ä½: 'wan-yuan'
      })
    }    
    setFormData(formDataToSet)
    setEditingItem(item)
    setIsNewItem(false)
    setShowEditModal(true)
    
    console.log('âœ… [ç¼–è¾‘] è¡¨å•è®¾ç½®å®Œæˆ:', formDataToSet)
  }
  /**
   * åˆ é™¤æ”¶å…¥é¡¹
   */
  const handleDelete = (item: RevenueItem) => {
    modals.openConfirmModal({
      title: 'ç¡®è®¤åˆ é™¤',
      centered: true,
      children: (
        <Text size="sm">
          ç¡®å®šè¦åˆ é™¤æ”¶å…¥é¡¹â€œ<Text component="span" fw={600} c="red">{item.name}</Text>â€å—ï¼Ÿ
        </Text>
      ),
      labels: { confirm: 'ç¡®å®šåˆ é™¤', cancel: 'å–æ¶ˆ' },
      confirmProps: { color: 'red' },
      onConfirm: () => {
        deleteRevenueItem(item.id)
        notifications.show({
          title: 'æˆåŠŸ',
          message: 'æ”¶å…¥é¡¹å·²åˆ é™¤',
          color: 'green',
        })
      },
    })
  }

  /**
   * åˆ é™¤å…¨éƒ¨æ”¶å…¥é¡¹
   */
  const handleDeleteAll = () => {
    modals.openConfirmModal({
      title: 'ç¡®è®¤åˆ é™¤å…¨éƒ¨',
      centered: true,
      children: (
        <Text size="sm">
          ç¡®å®šè¦åˆ é™¤æ‰€æœ‰æ”¶å…¥é¡¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤
        </Text>
      ),
      labels: { confirm: 'ç¡®å®šåˆ é™¤', cancel: 'å–æ¶ˆ' },
      confirmProps: { color: 'red' },
      onConfirm: () => {
        clearAllRevenueItems()
        notifications.show({
          title: 'æˆåŠŸ',
          message: 'æ‰€æœ‰æ”¶å…¥é¡¹å·²åˆ é™¤',
          color: 'green',
        })
      },
    })
  }

  /**
   * AIæµ‹ç®—æ”¶å…¥é¡¹
   */
  const handleAiEstimate = async () => {
    if (!formData.name || formData.name.trim() === '') {
      notifications.show({
        title: 'é”™è¯¯',
        message: 'è¯·å…ˆè¾“å…¥æ”¶å…¥é¡¹åç§°',
        color: 'red',
      })
      return
    }

    if (!context?.projectId) {
      notifications.show({
        title: 'é”™è¯¯',
        message: 'æœªæ‰¾åˆ°é¡¹ç›®ID',
        color: 'red',
      })
      return
    }

    setAiEstimating(true)
    try {
      const response = await revenueCostApi.estimateItem(context.projectId, formData.name)

      if (response.success && response.data) {
        // åº”ç”¨AIä¼°ç®—ç»“æœï¼ŒåŒ…å«remarkå¤‡æ³¨
        const aiData: any = response.data
        setFormData({
          ...formData,
          category: aiData.category as RevenueCategory,
          fieldTemplate: aiData.fieldTemplate as FieldTemplate,
          quantity: aiData.quantity,
          unit: aiData.unit,
          unitPrice: aiData.unitPrice,

          vatRate: aiData.vatRate,
          area: aiData.area,
          yieldPerArea: aiData.yieldPerArea,
          capacity: aiData.capacity,
          utilizationRate: aiData.utilizationRate,
          subscriptions: aiData.subscriptions,
          directAmount: aiData.directAmount,
          remark: aiData.remark || '',
        } as any)

        notifications.show({
          title: 'AIæµ‹ç®—æˆåŠŸ',
          message: 'å·²è‡ªåŠ¨å¡«å……å…³é”®ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥å¹¶è°ƒæ•´',
          color: 'green',
        })
      } else {
        throw new Error(response.error || 'AIæµ‹ç®—å¤±è´¥')
      }
    } catch (error: any) {
      console.error('AIæµ‹ç®—å¤±è´¥:', error)
      notifications.show({
        title: 'æµ‹ç®—å¤±è´¥',
        message: error.message || 'è¯·ç¨åé‡è¯•',
        color: 'red',
      })
    } finally {
      setAiEstimating(false)
    }
  }

  /**
   * ä¿å­˜æ”¶å…¥é¡¹
   */
  const handleSave = async () => {
    if (!formData.name || formData.name.trim() === '') {
      notifications.show({
        title: 'é”™è¯¯',
        message: 'è¯·è¾“å…¥æ”¶å…¥é¡¹åç§°',
        color: 'red',
      })
      return
    }

    // ç›´æ¥ä¿å­˜ï¼Œå•ä½ç»Ÿä¸€ä¸ºä¸‡å…ƒ
    const dataToSave = { ...formData }
    console.log('ğŸ” [ä¿å­˜] ä¿å­˜å‰çš„formData:', formData)
    console.log('ğŸ” æœ€ç»ˆä¿å­˜åˆ°æ•°æ®åº“çš„æ•°æ®(ä¸‡å…ƒå•ä½):', dataToSave)

    // å…ˆæ›´æ–°æœ¬åœ°çŠ¶æ€
    try {
      if (isNewItem) {
        addRevenueItem(dataToSave)
        notifications.show({
          title: 'æˆåŠŸ',
          message: 'æ”¶å…¥é¡¹å·²æ·»åŠ ',
          color: 'green',
        })
      } else if (editingItem) {
        updateRevenueItem(editingItem.id, dataToSave)
        notifications.show({
          title: 'æˆåŠŸ',
          message: 'æ”¶å…¥é¡¹å·²æ›´æ–°',
          color: 'green',
        })
      }
    } catch (error: any) {
      notifications.show({
        title: 'é”™è¯¯',
        message: error.message || 'ä¿å­˜å¤±è´¥',
        color: 'red',
      })
      return
    }

    // è‡ªåŠ¨ä¿å­˜å·²ç”± Store å¤„ç†
    
    setShowEditModal(false)
    setFormData({})
  }

  /**
   * AIè‡ªåŠ¨ç”Ÿæˆæ”¶å…¥é¡¹ç›®è¡¨
   */
  const handleGenerateItems = async () => {
    // é˜²æ­¢å¹¶å‘è°ƒç”¨
    if (isGeneratingRef.current) {
      console.log('âš ï¸ æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè·³è¿‡é‡å¤è°ƒç”¨')
      return
    }
    
    if (!context?.projectId) {
      console.warn('AIç”Ÿæˆè·³è¿‡ï¼šæœªæ‰¾åˆ°é¡¹ç›®ID')
      return
    }

    if (!aiAnalysisResult || !aiAnalysisResult.selected_categories || aiAnalysisResult.selected_categories.length === 0) {
      console.warn('AIç”Ÿæˆè·³è¿‡ï¼šæœªå®ŒæˆAIè¥æ”¶ç»“æ„åˆ†æ')
      return
    }

    // è®¾ç½®ç”Ÿæˆä¸­æ ‡è®°
    isGeneratingRef.current = true

    // ä» context ä¸­æ„å»ºæŠ•èµ„æ•°æ®ï¼ˆä½¿ç”¨åŸºç¡€ä¿¡æ¯ï¼‰
    const investmentData = {
      total_investment: context.totalInvestment,
      construction_years: context.constructionYears,
      operation_years: context.operationYears,
      construction_cost: 0, // é»˜è®¤å€¼
      equipment_cost: 0, // é»˜è®¤å€¼
    }

    console.log('ğŸ¤– å¼€å§‹è‡ªåŠ¨ç”Ÿæˆæ”¶å…¥é¡¹...')
    console.log('ğŸ“Š è¥æ”¶ç±»åˆ«æ•°é‡:', aiAnalysisResult.selected_categories.length)
    console.log('ğŸ“„ è¥æ”¶ç±»åˆ«è¯¦æƒ…:', aiAnalysisResult.selected_categories.map(c => c.category_name).join(', '))
    
    try {
      const response = await revenueCostApi.generateItems(context.projectId, {
        revenueStructure: aiAnalysisResult,
        investmentData,
      })

      if (response.success && response.data?.revenue_items) {
        console.log(`âœ… åç«¯LLMç”ŸæˆæˆåŠŸï¼š${response.data.revenue_items.length} ä¸ªæ”¶å…¥é¡¹`)
        console.log('ğŸ“ æ”¶å…¥é¡¹åˆ—è¡¨:', response.data.revenue_items.map((item: any) => item.name).join(', '))
        
        const generatedItems = response.data.revenue_items
        const itemCount = generatedItems.length
        
        // å…ˆè®°å½•å½“å‰æ”¶å…¥é¡¹æ•°é‡
        console.log(`ğŸ—‘ï¸ å‡†å¤‡æ¸…ç©ºç°æœ‰ ${revenueItems.length} ä¸ªæ”¶å…¥é¡¹`)
        
        // ä½¿ç”¨ä¸€é”®æ¸…ç©ºæ‰€æœ‰æ”¶å…¥é¡¹çš„æ–¹æ³•
        console.log(`ğŸ—‘ï¸ å¼€å§‹ä¸€é”®æ¸…ç©ºæ‰€æœ‰æ”¶å…¥é¡¹`)
        clearAllRevenueItems()

        // ç­‰å¾…ä¸€ä¸ªå¾®ä»»åŠ¡å‘¨æœŸï¼Œç¡®ä¿åˆ é™¤æ“ä½œå®Œæˆ
        await new Promise(resolve => setTimeout(resolve, 0))
        
        // è·å–æœ€æ–°çš„çŠ¶æ€
        const currentState = useRevenueCostStore.getState()
        console.log(`âœ… æ¸…ç©ºå®Œæˆï¼Œå½“å‰å‰©ä½™æ”¶å…¥é¡¹: ${currentState.revenueItems.length} ä¸ª`)
        console.log(`â• å¼€å§‹æ·»åŠ  ${itemCount} ä¸ªæ–°æ”¶å…¥é¡¹`)

        // æ·»åŠ AIç”Ÿæˆçš„æ”¶å…¥é¡¹ï¼Œå¹¶è¿›è¡Œä¸¥æ ¼çš„é‡å¤é¡¹æ£€æµ‹
        let addedCount = 0
        let skippedCount = 0
        
        generatedItems.forEach((item: any, index: number) => {
          console.log(`  â• [${index + 1}/${itemCount}] å¤„ç†: ${item.name}`)
          
          try {
            addRevenueItem({
              name: item.name,
              category: item.category || 'other',
              fieldTemplate: item.field_template || 'quantity-price',
              quantity: item.quantity || 0,
              unitPrice: item.unit_price || 0,
              area: item.area || 0,
              yieldPerArea: item.yield_per_area || 0,
              capacity: item.capacity || 0,
              utilizationRate: item.utilization_rate || 0,
              subscriptions: item.subscriptions || 0,
              directAmount: item.direct_amount || 0,
            })
            addedCount++
            console.log(`    âœ… æˆåŠŸæ·»åŠ : ${item.name}`)
          } catch (error: any) {
            skippedCount++
            console.log(`    âš ï¸ è·³è¿‡é‡å¤é¡¹: ${item.name} - ${error.message}`)
          }
        })
        
        console.log(`ğŸ“Š ç”Ÿæˆç»Ÿè®¡: æˆåŠŸæ·»åŠ  ${addedCount} é¡¹ï¼Œè·³è¿‡é‡å¤ ${skippedCount} é¡¹`)

        console.log(`âœ… AIç”Ÿæˆå®Œæˆï¼šæ·»åŠ äº† ${itemCount} ä¸ªæ”¶å…¥é¡¹`)
        notifications.show({
          title: 'è‡ªåŠ¨ç”ŸæˆæˆåŠŸ',
          message: `å·²è‡ªåŠ¨ç”Ÿæˆ ${itemCount} ä¸ªæ”¶å…¥é¡¹ï¼Œå¯ç»§ç»­ç¼–è¾‘è°ƒæ•´`,
          color: 'green',
        })
      } else {
        throw new Error(response.error || 'AIç”Ÿæˆå¤±è´¥')
      }
    } catch (error: any) {
      console.error('âŒ AIç”Ÿæˆæ”¶å…¥é¡¹å¤±è´¥:', error)
      // ä¸æ˜¾ç¤ºé”™è¯¯é€šçŸ¥ï¼Œåªè®°å½•æ—¥å¿—
    } finally {
      // æ¸…é™¤ç”Ÿæˆä¸­æ ‡è®°
      isGeneratingRef.current = false
    }
  }

  /**
   * ç»„ä»¶æŒ‚è½½æ—¶è‡ªåŠ¨ç”Ÿæˆï¼ˆå¦‚æœæ”¶å…¥é¡¹ä¸ºç©ºä¸”æœ‰AIåˆ†æç»“æœï¼‰
   * ä½¿ç”¨ useRef é˜²æ­¢é‡å¤ç”Ÿæˆ
   */
  useEffect(() => {
    console.log('=== useEffect è¢«è§¦å‘ ===')
    console.log('ğŸ”¹ hasAutoGeneratedRef.current:', hasAutoGeneratedRef.current)
    console.log('ğŸ”¹ revenueItems.length:', revenueItems.length)
    console.log('ğŸ”¹ aiAnalysisResult:', aiAnalysisResult ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨')
    console.log('ğŸ”¹ context:', context ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨')
    
    // å¦‚æœå·²ç»ç”Ÿæˆè¿‡ï¼Œä¸å†ç”Ÿæˆ
    if (hasAutoGeneratedRef.current) {
      console.log('â­ï¸ å·²ç»ç”Ÿæˆè¿‡æ”¶å…¥é¡¹ï¼Œè·³è¿‡è‡ªåŠ¨ç”Ÿæˆ')
      return
    }
    
    // å¦‚æœæœ‰æ”¶å…¥é¡¹ï¼Œä¹Ÿä¸ç”Ÿæˆ
    if (revenueItems.length > 0) {
      console.log('âš ï¸ å·²æœ‰æ”¶å…¥é¡¹ï¼Œè·³è¿‡è‡ªåŠ¨ç”Ÿæˆ')
      console.log('ğŸ“ å½“å‰æ”¶å…¥é¡¹:', revenueItems.map(i => i.name).join(', '))
      hasAutoGeneratedRef.current = true
      return
    }
    
    if (aiAnalysisResult && aiAnalysisResult.selected_categories && aiAnalysisResult.selected_categories.length > 0 && context) {
      console.log('ğŸ”µ æ£€æµ‹åˆ°AIåˆ†æç»“æœï¼Œå¼€å§‹è‡ªåŠ¨ç”Ÿæˆæ”¶å…¥é¡¹...')
      console.log('ğŸ“¦ AIæ¨èçš„æ”¶å…¥ç±»åˆ«æ•°:', aiAnalysisResult.selected_categories.length)
      console.log('ğŸ“ AIæ¨èçš„ç±»åˆ«:', aiAnalysisResult.selected_categories.map(c => c.category_name).join(', '))
      handleGenerateItems()
      hasAutoGeneratedRef.current = true // è®¾ç½®æ ‡è®°
    } else {
      console.log('âš ï¸ æ¡ä»¶ä¸æ»¡è¶³ï¼Œä¸ç”Ÿæˆæ”¶å…¥é¡¹')
    }
  }, [aiAnalysisResult, context]) // åªç›‘å¬aiAnalysisResultå’Œcontextçš„å˜åŒ–ï¼Œé¿å…å¾ªç¯
  
  /**
   * ç›‘å¬revenueItemsçš„å˜åŒ–ï¼Œå½“æœ‰æ•°æ®æ—¶è®¾ç½®ç”Ÿæˆæ ‡è®°
   */
  useEffect(() => {
    if (revenueItems.length > 0 && !hasAutoGeneratedRef.current) {
      console.log('ğŸ“ æ£€æµ‹åˆ°å·²åŠ è½½çš„æ”¶å…¥é¡¹ï¼Œè®¾ç½®ç”Ÿæˆæ ‡è®°é˜²æ­¢é‡å¤ç”Ÿæˆ')
      console.log('ğŸ“Š å·²åŠ è½½çš„æ”¶å…¥é¡¹æ•°é‡:', revenueItems.length)
      hasAutoGeneratedRef.current = true
    }
  }, [revenueItems]) // ç›‘å¬revenueItemsçš„å˜åŒ–

  /**
   * ç›‘å¬formDataçš„å˜åŒ–ï¼Œç”¨äºè°ƒè¯•
   */
  useEffect(() => {
    console.log('ğŸ“‹ [çŠ¶æ€å˜åŒ–] formDataæ›´æ–°:', {

      unitPrice: formData.unitPrice,
      name: formData.name,
      hasData: !!formData.name
    })
  }, [formData])

  /**
   * æ ¼å¼åŒ–é‡‘é¢æ˜¾ç¤ºï¼ˆ2ä½å°æ•°ï¼‰
   */
  const formatAmount = (amount: number): string => {
    return `${amount.toFixed(2)}`
  }

  /**
   * æ ¼å¼åŒ–æ•°å­—æ˜¾ç¤ºä¸º2ä½å°æ•°ï¼Œä¸å››èˆäº”å…¥ï¼Œæ— åƒåˆ†å·ï¼ˆä¸ä¿®æ”¹å®é™…å€¼ï¼Œåªç”¨äºæ˜¾ç¤ºï¼‰
   */
  const formatNumberNoRounding = (value: number): string => {
    // å¤„ç†è´Ÿæ•°
    const isNegative = value < 0;
    const absValue = Math.abs(value);
    
    // å°†æ•°å­—ä¹˜ä»¥100ï¼Œæˆªæ–­æ•´æ•°éƒ¨åˆ†ï¼Œå†é™¤ä»¥100ï¼Œå®ç°ä¸å››èˆäº”å…¥ä¿ç•™2ä½å°æ•°
    const truncated = Math.trunc(absValue * 100) / 100;
    
    // è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œç¡®ä¿æœ‰2ä½å°æ•°
    let result = truncated.toString();
    
    // å¦‚æœæ²¡æœ‰å°æ•°ç‚¹æˆ–åªæœ‰1ä½å°æ•°ï¼Œè¡¥é½åˆ°2ä½
    if (!result.includes('.')) {
      result += '.00';
    } else {
      const decimalPart = result.split('.')[1];
      if (decimalPart.length === 1) {
        result += '0';
      } else if (decimalPart.length > 2) {
        result = result.split('.')[0] + '.' + decimalPart.substring(0, 2);
      }
    }
    
    // æ·»åŠ è´Ÿå·
    if (isNegative) {
      result = '-' + result;
    }
    
    return result;
  }

  /**
   * è®¡ç®—å¤–è´­åŸææ–™è´¹ä¼°ç®—è¡¨ä¸­è¿›é¡¹ç¨é¢çš„è¿è¥æœŸåˆ—å€¼
   */
  const calculateRawMaterialsInputTaxForYear = (year: number): number => {
    const { costConfig, productionRates } = useRevenueCostStore.getState();
    if (!costConfig.rawMaterials.items || costConfig.rawMaterials.items.length === 0) {
      return 0;
    }

    const productionRate = costConfig.rawMaterials.applyProductionRate
      ? (productionRates?.find(p => p.yearIndex === year)?.rate || 1)
      : 1;

    let yearInputTax = 0;
    costConfig.rawMaterials.items.forEach((item: any) => {
      const baseAmount = (() => {
        if (item.sourceType === 'percentage') {
          let revenueBase = 0;
          if (item.linkedRevenueId === 'total' || !item.linkedRevenueId) {
            revenueBase = (useRevenueCostStore.getState().revenueItems || []).reduce((sum, revItem) => sum + calculateTaxableIncome(revItem), 0);
          } else {
            const revItem = (useRevenueCostStore.getState().revenueItems || []).find(r => r.id === item.linkedRevenueId);
            if (revItem) {
              revenueBase = calculateTaxableIncome(revItem);
            }
          }
          return revenueBase * (item.percentage || 0) / 100;
        } else if (item.sourceType === 'quantityPrice') {
          return (item.quantity || 0) * (item.unitPrice || 0);
        } else if (item.sourceType === 'directAmount') {
          return item.directAmount || 0;
        }
        return 0;
      })();

      const taxRate = Number(item.taxRate) || 0;
      const taxRateDecimal = taxRate / 100;
      // æ­£ç¡®çš„è¿›é¡¹ç¨è®¡ç®—å…¬å¼ï¼šå«ç¨é‡‘é¢ / (1 + ç¨ç‡) Ã— ç¨ç‡
      yearInputTax += baseAmount * productionRate * taxRateDecimal / (1 + taxRateDecimal);
    });

    return yearInputTax;
  };

  /**
   * è®¡ç®—å¤–è´­ç‡ƒæ–™åŠåŠ¨åŠ›è´¹ä¼°ç®—è¡¨ä¸­è¿›é¡¹ç¨é¢çš„è¿è¥æœŸåˆ—å€¼
   */
  const calculateFuelPowerInputTaxForYear = (year: number): number => {
    const { costConfig, productionRates } = useRevenueCostStore.getState();
    if (!costConfig.fuelPower.items || costConfig.fuelPower.items.length === 0) {
      return 0;
    }

    const productionRate = costConfig.fuelPower.applyProductionRate
      ? (productionRates?.find(p => p.yearIndex === year)?.rate || 1)
      : 1;

    let yearInputTax = 0;
    costConfig.fuelPower.items.forEach((item: any) => {
      let consumption = item.consumption || 0;
      let amount = 0;
      // å¯¹æ±½æ²¹å’ŒæŸ´æ²¹è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼šå•ä»·Ã—æ•°é‡/10000
      if (['æ±½æ²¹', 'æŸ´æ²¹'].includes(item.name)) {
        amount = (item.price || 0) * consumption / 10000 * productionRate;
      } else {
        amount = consumption * (item.price || 0) * productionRate;
      }
      
      const taxRate = (item.taxRate || 13) / 100;
      // æ ¹æ®ç”¨æˆ·åé¦ˆï¼šç‡ƒæ–™åŠ¨åŠ›è´¹é‡‘é¢å‡ä¸ºå«ç¨æ”¶å…¥ï¼Œä½¿ç”¨æ­£ç¡®å…¬å¼ï¼šå«ç¨é‡‘é¢ / (1 + ç¨ç‡) Ã— ç¨ç‡
      yearInputTax += amount * taxRate / (1 + taxRate);
    });

    return yearInputTax;
  };

  /**
   * è®¡ç®—æ€»è¿›é¡¹ç¨é¢ï¼ˆå¤–è´­åŸææ–™è´¹ + å¤–è´­ç‡ƒæ–™åŠåŠ¨åŠ›è´¹ï¼‰
   */
  const calculateTotalInputTaxForYear = (year: number): number => {
    return calculateRawMaterialsInputTaxForYear(year) + calculateFuelPowerInputTaxForYear(year);
  };

  /**
   * è®¡ç®—è¿›é¡¹ç¨é¢ï¼ˆå›ºå®šèµ„äº§å¾…æŠµæ‰£ï¼‰çš„è¿è¥æœŸåˆ—å€¼
   * æ¯å¹´ä»å¾…æŠµæ‰£è¿›é¡¹ç¨æ€»é¢ä¸­å–ä¸€ä¸ªå€¼ï¼Œä½¿å¾—å½“å¹´çš„å¢å€¼ç¨ç­‰äº0
   */
  const calculateFixedAssetInputTaxForYear = (year: number): number => {
    if (!context || deductibleInputTax <= 0) return 0;
    
    const operationYears = context.operationYears;
    const years = Array.from({ length: operationYears }, (_, i) => i + 1);
    
    // è®¡ç®—æ¯å¹´çš„é”€é¡¹ç¨é¢å’Œè¿›é¡¹ç¨é¢
    const yearlyData = years.map((y) => {
      // è®¡ç®—é”€é¡¹ç¨é¢
      const yearOutputTax = revenueItems.reduce((sum, item) => {
        const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, y)
        const revenue = calculateYearlyRevenue(item, y, productionRate)
        // é”€é¡¹ç¨é¢ = å«ç¨æ”¶å…¥ - ä¸å«ç¨æ”¶å…¥
        return sum + (revenue - revenue / (1 + item.vatRate))
      }, 0);
      
      // è®¡ç®—è¿›é¡¹ç¨é¢
      const yearInputTax = calculateTotalInputTaxForYear(y);
      
      return {
        year: y,
        outputTax: yearOutputTax,
        inputTax: yearInputTax
      };
    });
    
    // è®¡ç®—æ¯å¹´çš„è¿›é¡¹ç¨é¢ï¼ˆå›ºå®šèµ„äº§å¾…æŠµæ‰£ï¼‰
    let remainingDeductibleTax = deductibleInputTax;
    const fixedAssetInputTaxes: number[] = [];
    
    for (const data of yearlyData) {
      // è®¡ç®—ä½¿å¢å€¼ç¨ç­‰äº0æ‰€éœ€çš„è¿›é¡¹ç¨é¢ï¼ˆå›ºå®šèµ„äº§å¾…æŠµæ‰£ï¼‰
      const neededFixedAssetInputTax = data.outputTax - data.inputTax;
      
      // å¦‚æœè¿˜æœ‰å‰©ä½™çš„å¾…æŠµæ‰£è¿›é¡¹ç¨ï¼Œåˆ™ä½¿ç”¨éœ€è¦çš„å€¼ï¼Œå¦åˆ™ä½¿ç”¨å‰©ä½™å€¼
      const actualFixedAssetInputTax = Math.min(neededFixedAssetInputTax, remainingDeductibleTax);
      
      fixedAssetInputTaxes.push(actualFixedAssetInputTax);
      remainingDeductibleTax -= actualFixedAssetInputTax;
    }
    
    // è¿”å›æŒ‡å®šå¹´ä»½çš„è¿›é¡¹ç¨é¢ï¼ˆå›ºå®šèµ„äº§å¾…æŠµæ‰£ï¼‰
    return fixedAssetInputTaxes[year - 1] || 0;
  };

  /**
   * å¯¼å‡ºè¥ä¸šæ”¶å…¥ã€è¥ä¸šç¨é‡‘åŠé™„åŠ å’Œå¢å€¼ç¨ä¼°ç®—è¡¨ä¸ºExcel
   */
  const handleExportRevenueTable = () => {
    if (!context) {
      notifications.show({
        title: 'å¯¼å‡ºå¤±è´¥',
        message: 'é¡¹ç›®ä¸Šä¸‹æ–‡æœªåŠ è½½',
        color: 'red',
      });
      return;
    }

    const operationYears = context.operationYears;
    const years = Array.from({ length: operationYears }, (_, i) => i + 1);

    // å‡†å¤‡Excelæ•°æ®
    const excelData: any[] = [];
    
    // æ·»åŠ è¡¨å¤´
    const headerRow: any = { 'åºå·': '', 'æ”¶å…¥é¡¹ç›®': '', 'åˆè®¡': '' };
    years.forEach((year) => {
      headerRow[year.toString()] = year;
    });
    excelData.push(headerRow);

    // 1. è¥ä¸šæ”¶å…¥
    const row1: any = { 'åºå·': '1', 'æ”¶å…¥é¡¹ç›®': 'è¥ä¸šæ”¶å…¥' };
    let totalRow1 = 0;
    years.forEach((year) => {
      const yearTotal = revenueItems.reduce((sum, item) => {
        const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
        return sum + calculateYearlyRevenue(item, year, productionRate)
      }, 0);
      row1[year.toString()] = yearTotal;
      totalRow1 += yearTotal;
    });
    row1['åˆè®¡'] = totalRow1;
    excelData.push(row1);

    // 1.1, 1.2, 1.3... æ”¶å…¥é¡¹
    revenueItems.forEach((item, idx) => {
      const row: any = { 'åºå·': `1.${idx + 1}`, 'æ”¶å…¥é¡¹ç›®': `${item.name}ï¼ˆ${(item.vatRate * 100).toFixed(0)}%ï¼‰` };
      let total = 0;
      years.forEach((year) => {
        const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
        const revenue = calculateYearlyRevenue(item, year, productionRate);
        row[year.toString()] = revenue;
        total += revenue;
      });
      row['åˆè®¡'] = total;
      excelData.push(row);
    });

    // 2. å¢å€¼ç¨
    const row2: any = { 'åºå·': '2', 'æ”¶å…¥é¡¹ç›®': 'å¢å€¼ç¨' };
    let totalRow2 = 0;
    years.forEach((year) => {
      // è®¡ç®—é”€é¡¹ç¨é¢
      const yearOutputTax = revenueItems.reduce((sum, item) => {
        const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
        const revenue = calculateYearlyRevenue(item, year, productionRate)
        // é”€é¡¹ç¨é¢ = å«ç¨æ”¶å…¥ - ä¸å«ç¨æ”¶å…¥
        return sum + (revenue - revenue / (1 + item.vatRate))
      }, 0);
      
      // è®¡ç®—è¿›é¡¹ç¨é¢
      const yearInputTax = calculateTotalInputTaxForYear(year);
      
      // è®¡ç®—è¿›é¡¹ç¨é¢ï¼ˆå›ºå®šèµ„äº§å¾…æŠµæ‰£ï¼‰
      const yearFixedAssetInputTax = calculateFixedAssetInputTaxForYear(year);
      
      // å¢å€¼ç¨ = é”€é¡¹ç¨é¢ - è¿›é¡¹ç¨é¢ - è¿›é¡¹ç¨é¢ï¼ˆå›ºå®šèµ„äº§å¾…æŠµæ‰£ï¼‰
      const yearVat = yearOutputTax - yearInputTax - yearFixedAssetInputTax;
      
      row2[year.toString()] = yearVat;
      totalRow2 += yearVat;
    });
    row2['åˆè®¡'] = totalRow2;
    excelData.push(row2);

    // 2.1 é”€é¡¹ç¨é¢
    const row2_1: any = { 'åºå·': '2.1', 'æ”¶å…¥é¡¹ç›®': 'é”€é¡¹ç¨é¢' };
    let totalRow2_1 = 0;
    years.forEach((year) => {
      const yearTotal = revenueItems.reduce((sum, item) => {
        const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
        const revenue = calculateYearlyRevenue(item, year, productionRate)
        // é”€é¡¹ç¨é¢ = å«ç¨æ”¶å…¥ - ä¸å«ç¨æ”¶å…¥
        return sum + (revenue - revenue / (1 + item.vatRate))
      }, 0);
      row2_1[year.toString()] = yearTotal;
      totalRow2_1 += yearTotal;
    });
    row2_1['åˆè®¡'] = totalRow2_1;
    excelData.push(row2_1);

    // 2.2 è¿›é¡¹ç¨é¢
    const row2_2: any = { 'åºå·': '2.2', 'æ”¶å…¥é¡¹ç›®': 'è¿›é¡¹ç¨é¢' };
    let totalRow2_2 = 0;
    years.forEach((year) => {
      const yearTotal = calculateTotalInputTaxForYear(year);
      row2_2[year.toString()] = yearTotal;
      totalRow2_2 += yearTotal;
    });
    row2_2['åˆè®¡'] = totalRow2_2;
    excelData.push(row2_2);

    // 2.3 è¿›é¡¹ç¨é¢ï¼ˆå›ºå®šèµ„äº§å¾…æŠµæ‰£ï¼‰
    const row2_3: any = { 'åºå·': '2.3', 'æ”¶å…¥é¡¹ç›®': 'è¿›é¡¹ç¨é¢ï¼ˆå›ºå®šèµ„äº§å¾…æŠµæ‰£ï¼‰' };
    let totalRow2_3 = 0;
    years.forEach((year) => {
      const yearTotal = calculateFixedAssetInputTaxForYear(year);
      row2_3[year.toString()] = yearTotal;
      totalRow2_3 += yearTotal;
    });
    row2_3['åˆè®¡'] = totalRow2_3;
    excelData.push(row2_3);

    // 3. å…¶ä»–ç¨è´¹åŠé™„åŠ 
    const row3: any = { 'åºå·': '3', 'æ”¶å…¥é¡¹ç›®': 'å…¶ä»–ç¨è´¹åŠé™„åŠ ' };
    let totalRow3 = 0;
    years.forEach((year) => {
      const vatTotal = revenueItems.reduce((sum, item) => {
        const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
        const revenue = calculateYearlyRevenue(item, year, productionRate)
        return sum + (revenue - revenue / (1 + item.vatRate))
      }, 0)
      // ä½¿ç”¨æ–°çš„ç¨è´¹è®¡ç®—é€»è¾‘
      const taxResult = calculateAllTaxes(vatTotal, taxConfig);
      row3[year.toString()] = taxResult.totalAdditionalTaxes;
      totalRow3 += taxResult.totalAdditionalTaxes;
    });
    row3['åˆè®¡'] = totalRow3;
    excelData.push(row3);

    // 3.1 åŸå¸‚å»ºè®¾ç»´æŠ¤ç¨
    const row3_1: any = { 'åºå·': '3.1', 'æ”¶å…¥é¡¹ç›®': `åŸå¸‚å»ºè®¾ç»´æŠ¤ç¨(${formatTaxRate(taxConfig.urbanConstructionTaxRate)})` };
    let totalRow3_1 = 0;
    years.forEach((year) => {
      const vatTotal = revenueItems.reduce((sum, item) => {
        const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
        const revenue = calculateYearlyRevenue(item, year, productionRate)
        return sum + (revenue - revenue / (1 + item.vatRate))
      }, 0)
      const taxResult = calculateAllTaxes(vatTotal, taxConfig);
      row3_1[year.toString()] = taxResult.urbanConstructionTax;
      totalRow3_1 += taxResult.urbanConstructionTax;
    });
    row3_1['åˆè®¡'] = totalRow3_1;
    excelData.push(row3_1);

    // 3.2 æ•™è‚²è´¹é™„åŠ 
    const row3_2: any = { 'åºå·': '3.2', 'æ”¶å…¥é¡¹ç›®': `æ•™è‚²è´¹é™„åŠ (${formatTaxRate(taxConfig.educationSurtaxRate)})` };
    let totalRow3_2 = 0;
    years.forEach((year) => {
      const vatTotal = revenueItems.reduce((sum, item) => {
        const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
        const revenue = calculateYearlyRevenue(item, year, productionRate)
        return sum + (revenue - revenue / (1 + item.vatRate))
      }, 0)
      const taxResult = calculateAllTaxes(vatTotal, taxConfig);
      row3_2[year.toString()] = taxResult.educationSurtax;
      totalRow3_2 += taxResult.educationSurtax;
    });
    row3_2['åˆè®¡'] = totalRow3_2;
    excelData.push(row3_2);

    // 3.3 åœ°æ–¹æ•™è‚²è´¹é™„åŠ 
    const row3_3: any = { 'åºå·': '3.3', 'æ”¶å…¥é¡¹ç›®': `åœ°æ–¹æ•™è‚²è´¹é™„åŠ (${formatTaxRate(taxConfig.localEducationSurtaxRate)})` };
    let totalRow3_3 = 0;
    years.forEach((year) => {
      const vatTotal = revenueItems.reduce((sum, item) => {
        const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
        const revenue = calculateYearlyRevenue(item, year, productionRate)
        return sum + (revenue - revenue / (1 + item.vatRate))
      }, 0)
      const taxResult = calculateAllTaxes(vatTotal, taxConfig);
      row3_3[year.toString()] = taxResult.localEducationSurtax;
      totalRow3_3 += taxResult.localEducationSurtax;
    });
    row3_3['åˆè®¡'] = totalRow3_3;
    excelData.push(row3_3);

    // åˆ›å»ºå·¥ä½œç°¿å’Œå·¥ä½œè¡¨
    const ws = XLSX.utils.json_to_sheet(excelData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'è¥ä¸šæ”¶å…¥ã€è¥ä¸šç¨é‡‘åŠé™„åŠ å’Œå¢å€¼ç¨ä¼°ç®—è¡¨');

    // å¯¼å‡ºæ–‡ä»¶
    XLSX.writeFile(wb, `è¥ä¸šæ”¶å…¥ã€è¥ä¸šç¨é‡‘åŠé™„åŠ å’Œå¢å€¼ç¨ä¼°ç®—è¡¨_${context.projectName || 'é¡¹ç›®'}.xlsx`);

    notifications.show({
      title: 'å¯¼å‡ºæˆåŠŸ',
      message: 'è¥ä¸šæ”¶å…¥ã€è¥ä¸šç¨é‡‘åŠé™„åŠ å’Œå¢å€¼ç¨ä¼°ç®—è¡¨å·²å¯¼å‡ºä¸ºExcelæ–‡ä»¶',
      color: 'green',
    });
  };

  /**
   * æ¸²æŸ“å­—æ®µå€¼ï¼ˆç»Ÿä¸€ä»¥ä¸‡å…ƒæ˜¾ç¤ºï¼‰
   */
  const renderFieldValue = (item: RevenueItem): string => {
    // è¾…åŠ©å‡½æ•°ï¼šç»Ÿä¸€æ ¼å¼åŒ–ä»·æ ¼æ˜¾ç¤ºï¼ˆä¸‡å…ƒï¼‰
    const formatPriceInWanYuan = (price: number | undefined): string => {
      if (price === undefined || price === null) return '0ä¸‡å…ƒ';
      // ç»Ÿä¸€ä»¥ä¸‡å…ƒæ˜¾ç¤ºï¼Œä¿ç•™4ä½å°æ•°
      return `${price.toFixed(4)}`;
    };
    
    switch (item.fieldTemplate) {
      case 'quantity-price':
        return `${item.quantity || 0} Ã— ${formatPriceInWanYuan(item.unitPrice)}`
      case 'area-yield-price':
        return `${item.area || 0}äº© Ã— ${item.yieldPerArea || 0} Ã— ${formatPriceInWanYuan(item.unitPrice)}`
      case 'capacity-utilization':
        return `${item.capacity || 0} Ã— ${((item.utilizationRate || 0) * 100).toFixed(0)}% Ã— ${formatPriceInWanYuan(item.unitPrice)}`
      case 'subscription':
        return `${item.subscriptions || 0} Ã— ${formatPriceInWanYuan(item.unitPrice)}`
      case 'direct-amount':
        return `${(item.directAmount || 0).toFixed(4)}ä¸‡å…ƒ`
      default:
        return '-'
    }
  }

  /**
   * æ¸²æŸ“ç¼–è¾‘è¡¨å•å­—æ®µ
   */
  const renderFormFields = () => {
    const template = formData.fieldTemplate || 'quantity-price'
    
    // è®¡ç®—æ€»ä»·é¢„è§ˆï¼ˆç»Ÿä¸€ä»¥ä¸‡å…ƒæ˜¾ç¤ºï¼‰
    const calculatePreviewTotal = () => {
      if (!formData.name || formData.name.trim() === '') return 0;
      
      switch (template) {
        case 'quantity-price':
          const quantity = formData.quantity || 0;
          const unitPrice = formData.unitPrice || 0;
          
          return quantity * unitPrice; // ç»“æœä¸ºä¸‡å…ƒï¼ˆç›´æ¥ä½œä¸ºå«ç¨æ”¶å…¥ï¼‰
          
        case 'area-yield-price':
          const area = formData.area || 0;
          const yieldPerArea = formData.yieldPerArea || 0;
          const areaUnitPrice = formData.unitPrice || 0;
          
          return area * yieldPerArea * areaUnitPrice; // ç»“æœä¸ºä¸‡å…ƒï¼ˆç›´æ¥ä½œä¸ºå«ç¨æ”¶å…¥ï¼‰
          
        case 'capacity-utilization':
          const capacity = formData.capacity || 0;
          const utilizationRate = formData.utilizationRate || 0;
          const capacityUnitPrice = formData.unitPrice || 0;
          
          return capacity * utilizationRate * capacityUnitPrice; // ç»“æœä¸ºä¸‡å…ƒï¼ˆç›´æ¥ä½œä¸ºå«ç¨æ”¶å…¥ï¼‰
          
        case 'subscription':
          const subscriptions = formData.subscriptions || 0;
          const subscriptionUnitPrice = formData.unitPrice || 0;
          
          return subscriptions * subscriptionUnitPrice; // ç»“æœä¸ºä¸‡å…ƒï¼ˆç›´æ¥ä½œä¸ºå«ç¨æ”¶å…¥ï¼‰
          
        case 'direct-amount':
          return formData.directAmount || 0; // å·²ç»æ˜¯ä¸‡å…ƒå•ä½ï¼ˆç›´æ¥ä½œä¸ºå«ç¨æ”¶å…¥ï¼‰
          
        default:
          return 0;
      }
    };

    return (
      <Stack gap="md">
        {/* åŸºç¡€ä¿¡æ¯ - å…¨å®½ */}
        <TextInput
          label="æ”¶å…¥é¡¹åç§°"
          placeholder="è¯·è¾“å…¥æ”¶å…¥é¡¹åç§°"
          value={formData.name || ''}
          onChange={(e) => setFormData({ ...formData, name: e.target.value })}
          required
        />

        {/* 2æ å¸ƒå±€ */}
        <Grid gutter="md">
          <Grid.Col span={6}>
            <Select
              label="æ”¶å…¥ç±»åˆ«"
              data={Object.entries(CATEGORY_LABELS).map(([value, label]) => ({
                value,
                label,
              }))}
              value={formData.category || 'other'}
              onChange={(value) => setFormData({ ...formData, category: value as RevenueCategory })}
            />
          </Grid.Col>

          <Grid.Col span={6}>
            <Select
              label="å­—æ®µæ¨¡æ¿"
              data={Object.entries(TEMPLATE_LABELS).map(([value, label]) => ({
                value,
                label,
              }))}
              value={template}
              onChange={(value) => setFormData({ ...formData, fieldTemplate: value as FieldTemplate })}
            />
          </Grid.Col>
        </Grid>

        {/* æ ¹æ®æ¨¡æ¿æ˜¾ç¤ºä¸åŒå­—æ®µ */}
        {/* ç»Ÿä¸€ä½¿ç”¨4åˆ—å¸ƒå±€ï¼Œä¸å¤Ÿçš„ä½¿ç”¨å ä½ç¬¦å¡«å…… */}
        <Grid gutter="md">
          {template === 'quantity-price' && (
            <>
              <Grid.Col span={3}>
                <NumberInput
                  label={formData.unit ? `æ•°é‡ï¼ˆ${formData.unit}ï¼‰` : 'æ•°é‡'}
                  placeholder="è¯·è¾“å…¥æ•°é‡"
                  value={formData.quantity || 0}
                  onChange={(value) => setFormData({ ...formData, quantity: Number(value) })}
                  min={0}
                  decimalScale={4}
                />
              </Grid.Col>
              <Grid.Col span={3}>
                <TextInput
                  label="å•ä½"
                  placeholder="å¦‚ï¼šå…¬æ–¤ã€å¨"
                  value={formData.unit || ''}
                  onChange={(e) => setFormData({ ...formData, unit: e.target.value })}
                />
              </Grid.Col>
              <Grid.Col span={3}>
                <div style={{ position: 'relative' }}>
                  <NumberInput
                    label="å•ä»·(ä¸‡å…ƒ)"
                    placeholder="è¯·è¾“å…¥å•ä»·"
                    value={formData.unitPrice || 0}
                    onChange={(value) => {
                      const newUnitPrice = value !== null && value !== undefined ? Number(value) : undefined;
                      console.log('ğŸ” [è¡¨å•è¾“å…¥] å•ä»·å˜åŒ–:', { 
                        inputValue: value, 
                        newUnitPrice, 
                        fieldName: 'unitPrice (quantity-price)' 
                      });
                      setFormData({ ...formData, unitPrice: newUnitPrice });
                    }}
                    min={0}
                    decimalScale={7}
                  />
                  {formData.unitPrice !== undefined && formData.unitPrice !== null && formData.unitPrice > 0 && formData.unitPrice < 0.1 && (
                    <Text 
                      size="sm" 
                      c="blue" 
                      style={{ 
                        position: 'absolute', 
                        right: '-80px', 
                        top: '32px',
                        whiteSpace: 'nowrap',
                        zIndex: 1
                      }}
                    >
                      {(formData.unitPrice * 10000).toFixed(2)}å…ƒ
                    </Text>
                  )}
                </div>
              </Grid.Col>

            </>
          )}

          {template === 'area-yield-price' && (
            <>
              <Grid.Col span={3}>
                <NumberInput
                  label="é¢ç§¯ï¼ˆäº©ï¼‰"
                  placeholder="è¯·è¾“å…¥é¢ç§¯"
                  value={formData.area || 0}
                  onChange={(value) => setFormData({ ...formData, area: Number(value) })}
                  min={0}
                  decimalScale={4}
                />
              </Grid.Col>
              <Grid.Col span={3}>
                <NumberInput
                  label="äº©äº§é‡"
                  placeholder="è¯·è¾“å…¥äº©äº§é‡"
                  value={formData.yieldPerArea || 0}
                  onChange={(value) => setFormData({ ...formData, yieldPerArea: Number(value) })}
                  min={0}
                  decimalScale={4}
                />
              </Grid.Col>
              <Grid.Col span={3}>
                <div style={{ position: 'relative' }}>
                  <NumberInput
                    label="å•ä»·(ä¸‡å…ƒ)"
                    placeholder="è¯·è¾“å…¥å•ä»·"
                    value={formData.unitPrice || 0}
                    onChange={(value) => setFormData({ ...formData, unitPrice: value !== null && value !== undefined ? Number(value) : undefined })}
                    min={0}
                    decimalScale={7}
                  />
                  {formData.unitPrice !== undefined && formData.unitPrice !== null && formData.unitPrice > 0 && formData.unitPrice < 0.1 && (
                    <Text 
                      size="sm" 
                      c="blue" 
                      style={{ 
                        position: 'absolute', 
                        right: '-80px', 
                        top: '32px',
                        whiteSpace: 'nowrap',
                        zIndex: 1
                      }}
                    >
                      {(formData.unitPrice * 10000).toFixed(2)}å…ƒ
                    </Text>
                  )}
                </div>
              </Grid.Col>

            </>
          )}

          {template === 'capacity-utilization' && (
            <>
              <Grid.Col span={3}>
                <NumberInput
                  label={formData.capacityUnit ? `äº§èƒ½ï¼ˆ${formData.capacityUnit}ï¼‰` : 'äº§èƒ½'}
                  placeholder="è¯·è¾“å…¥äº§èƒ½"
                  value={formData.capacity || 0}
                  onChange={(value) => setFormData({ ...formData, capacity: Number(value) })}
                  min={0}
                  decimalScale={4}
                />
              </Grid.Col>
              <Grid.Col span={3}>
                <TextInput
                  label="å•ä½"
                  placeholder="å¦‚ï¼šå°ã€ä»¶"
                  value={formData.capacityUnit || ''}
                  onChange={(e) => setFormData({ ...formData, capacityUnit: e.target.value })}
                />
              </Grid.Col>
              <Grid.Col span={3}>
                <div style={{ position: 'relative' }}>
                  <NumberInput
                    label="å•ä»·(ä¸‡å…ƒ)"
                    placeholder="è¯·è¾“å…¥å•ä»·"
                    value={formData.unitPrice || 0}
                    onChange={(value) => setFormData({ ...formData, unitPrice: value !== null && value !== undefined ? Number(value) : undefined })}
                    min={0}
                    decimalScale={7}
                  />
                  {formData.unitPrice !== undefined && formData.unitPrice !== null && formData.unitPrice > 0 && formData.unitPrice < 0.1 && (
                    <Text 
                      size="sm" 
                      c="blue" 
                      style={{ 
                        position: 'absolute', 
                        right: '-80px', 
                        top: '32px',
                        whiteSpace: 'nowrap',
                        zIndex: 1
                      }}
                    >
                      {(formData.unitPrice * 10000).toFixed(2)}å…ƒ
                    </Text>
                  )}
                </div>
              </Grid.Col>

            </>
          )}

          {template === 'subscription' && (
            <>
              <Grid.Col span={3}>
                <NumberInput
                  label="è®¢é˜…æ•°"
                  placeholder="è¯·è¾“å…¥è®¢é˜…æ•°"
                  value={formData.subscriptions || 0}
                  onChange={(value) => setFormData({ ...formData, subscriptions: Number(value) })}
                  min={0}
                  decimalScale={0}
                />
              </Grid.Col>
              <Grid.Col span={3}>
                <div style={{ position: 'relative' }}>
                  <NumberInput
                    label="å•ä»·(ä¸‡å…ƒ)"
                    placeholder="è¯·è¾“å…¥å•ä»·"
                    value={formData.unitPrice || 0}
                    onChange={(value) => setFormData({ ...formData, unitPrice: value !== null && value !== undefined ? Number(value) : undefined })}
                    min={0}
                    decimalScale={7}
                  />
                  {formData.unitPrice !== undefined && formData.unitPrice !== null && formData.unitPrice > 0 && formData.unitPrice < 0.1 && (
                    <Text 
                      size="sm" 
                      c="blue" 
                      style={{ 
                        position: 'absolute', 
                        right: '-80px', 
                        top: '32px',
                        whiteSpace: 'nowrap',
                        zIndex: 1
                      }}
                    >
                      {(formData.unitPrice * 10000).toFixed(2)}å…ƒ
                    </Text>
                  )}
                </div>
              </Grid.Col>

              <Grid.Col span={3}>
                {/* å ä½ç¬¦ */}
                <div style={{ height: '36px' }}></div>
              </Grid.Col>
            </>
          )}

          {template === 'direct-amount' && (
            <>
              <Grid.Col span={3}>
                <NumberInput
                  label="é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰"
                  placeholder="è¯·è¾“å…¥é‡‘é¢"
                  value={formData.directAmount || 0}
                  onChange={(value) => setFormData({ ...formData, directAmount: Number(value) })}
                  min={0}
                  decimalScale={2}
                />
              </Grid.Col>
              <Grid.Col span={9}>
                {/* å ä½ç¬¦ */}
                <div style={{ height: '36px' }}></div>
              </Grid.Col>
            </>
          )}
        </Grid>

        {/* æ¶¨ä»·å‚æ•° - 2æ  */}
        <Grid gutter="md">
          <Grid.Col span={6}>
            <NumberInput
              label="æ¶¨ä»·é—´éš”ï¼ˆå¹´ï¼‰"
              placeholder="0è¡¨ç¤ºä¸æ¶¨ä»·"
              description="æ¯éš”Nå¹´æ¶¨ä»·ä¸€æ¬¡ï¼Œ0è¡¨ç¤ºä¸æ¶¨ä»·"
              value={formData.priceIncreaseInterval || 0}
              onChange={(value) => setFormData({ ...formData, priceIncreaseInterval: Number(value) })}
              min={0}
              max={30}
              decimalScale={0}
            />
          </Grid.Col>
          <Grid.Col span={6}>
            <NumberInput
              label="æ¶¨ä»·å¹…åº¦ï¼ˆ%ï¼‰"
              placeholder="è¯·è¾“å…¥æ¶¨ä»·å¹…åº¦"
              description="æ¯æ¬¡æ¶¨ä»·çš„ç™¾åˆ†æ¯”ï¼Œä¾‹å¦‚ï¼š5 è¡¨ç¤º 5%"
              value={formData.priceIncreaseRate || 0}
              onChange={(value) => setFormData({ ...formData, priceIncreaseRate: Number(value) })}
              min={0}
              max={100}
              decimalScale={2}
              disabled={(formData.priceIncreaseInterval || 0) === 0}
            />
          </Grid.Col>
        </Grid>

        {/* å¢å€¼ç¨ç‡å’Œå¤‡æ³¨ - 2æ  */}
        <Grid gutter="md">
          <Grid.Col span={6}>
            <NumberInput
              label="å¢å€¼ç¨ç‡ï¼ˆ%ï¼‰"
              placeholder="è¯·è¾“å…¥å¢å€¼ç¨ç‡"
              value={(formData.vatRate || 0.13) * 100}
              onChange={(value) => setFormData({ ...formData, vatRate: Number(value) / 100 })}
              min={0}
              max={100}
              decimalScale={2}
            />
          </Grid.Col>

          <Grid.Col span={6}>
            <Tooltip label={formData.remark || 'æ— å¤‡æ³¨'} multiline w={300} withArrow>
              <TextInput
                label="å¤‡æ³¨"
                placeholder="è¯·è¾“å…¥å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰"
                value={formData.remark || ''}
                onChange={(e) => setFormData({ ...formData, remark: e.target.value })}
              />
            </Tooltip>
          </Grid.Col>
        </Grid>

        {/* æ€»ä»·é¢„è§ˆ - å·¦ä¸‹è§’ */}
        <div style={{
          padding: '8px 12px',
          backgroundColor: '#F0F9FF',
          borderRadius: '6px',
          border: '1px solid #BAE6FD',
          marginTop: '8px'
        }}>
          <Text size="sm" c="#0C4A6E" fw={500}>
            ğŸ’¡ æ€»ä»·é¢„è§ˆï¼š{(calculatePreviewTotal()).toFixed(2)} ä¸‡å…ƒ
          </Text>
        </div>

        {/* æ¶¨ä»·æç¤º */}
        {formData.priceIncreaseInterval && formData.priceIncreaseInterval > 0 && formData.priceIncreaseRate && formData.priceIncreaseRate > 0 && (
          <div style={{
            padding: '8px 12px',
            backgroundColor: '#FFF7E6',
            borderRadius: '6px',
            borderLeft: '3px solid #FF7D00'
          }}>
            <Text size="xs" c="#FF7D00" fw={500}>
              ğŸ’¡ æ¶¨ä»·è§„åˆ™ï¼šæ¯{formData.priceIncreaseInterval}å¹´æ¶¨ä»·{formData.priceIncreaseRate}%ï¼Œ
              1-{formData.priceIncreaseInterval}å¹´æ”¶å…¥{calculatePreviewTotal().toFixed(2)}ä¸‡å…ƒï¼Œ
              {formData.priceIncreaseInterval + 1}-{formData.priceIncreaseInterval * 2}å¹´æ”¶å…¥{(calculatePreviewTotal() * (1 + (formData.priceIncreaseRate || 0) / 100)).toFixed(2)}ä¸‡å…ƒ
            </Text>
          </div>
        )}
      </Stack>
    )
  }

  return (
    <>
      <Stack gap="md">
        <Group justify="space-between" align="center">
          <Text size="md" fw={600} c="#1D2129">
            è¥ä¸šæ”¶å…¥é…ç½®
          </Text>
          <Group gap="xs">
            <Tooltip label="åˆ é™¤å…¨éƒ¨">
              <ActionIcon
                variant="filled"
                color="red"
                size="lg"
                onClick={handleDeleteAll}
                disabled={revenueItems.length === 0}
              >
                <IconTrashX size={16} />
              </ActionIcon>
            </Tooltip>
            <Tooltip label="é…ç½®è¾¾äº§ç‡">
              <ActionIcon
                variant="light"
                color="orange"
                size="lg"
                onClick={() => setProductionRateModalOpened(true)}
              >
                <IconChartLine size={16} />
              </ActionIcon>
            </Tooltip>
            <Tooltip label="æŸ¥çœ‹æ”¶å…¥è¯¦è¡¨">
              <ActionIcon
                variant="light"
                color="cyan"
                size="lg"
                onClick={() => setShowRevenueDetailModal(true)}
                disabled={revenueItems.length === 0}
              >
                <IconTable size={16} />
              </ActionIcon>
            </Tooltip>
            <Tooltip label="æ–°å¢æ”¶å…¥é¡¹">
              <ActionIcon
                variant="filled"
                color="blue"
                size="lg"
                onClick={handleAdd}
              >
                <IconPlus size={16} />
              </ActionIcon>
            </Tooltip>
          </Group>
        </Group>

        {revenueItems.length === 0 ? (
          <div style={{
            padding: '40px',
            textAlign: 'center',
            backgroundColor: '#F7F8FA',
            borderRadius: '8px',
            border: '1px dashed #E5E6EB'
          }}>
            <Text size="sm" c="#86909C">
              {isGeneratingRef.current ? 'æ­£åœ¨ä½¿ç”¨AIç”Ÿæˆ...' : 'æš‚æ— æ”¶å…¥é¡¹ï¼Œè¯·ç‚¹å‡»"æ–°å¢æ”¶å…¥é¡¹"æ·»åŠ '}
            </Text>
          </div>
        ) : (
          <div style={{ overflowX: 'auto' }}>
            <Table striped highlightOnHover withTableBorder style={{ minWidth: '1000px' }}>
              <Table.Thead>
                <Table.Tr style={{ backgroundColor: '#F7F8FA' }}>
                  <Table.Th style={{ width: '50px', textAlign: 'center' }}>åºå·</Table.Th>
                  <Table.Th style={{ width: '180px' }}>æ”¶å…¥é¡¹åç§°</Table.Th>
                  <Table.Th style={{ width: '100px' }}>ç±»åˆ«</Table.Th>
                  <Table.Th style={{ width: '150px' }}>æ¨¡æ¿</Table.Th>
                  <Table.Th style={{ width: '200px' }}>å‚æ•°å€¼</Table.Th>
                  <Table.Th style={{ width: '100px', textAlign: 'right' }}>å«ç¨æ”¶å…¥</Table.Th>
                  <Table.Th style={{ width: '100px', textAlign: 'right' }}>ä¸å«ç¨æ”¶å…¥</Table.Th>
                  <Table.Th style={{ width: '100px', textAlign: 'right' }}>å¢å€¼ç¨</Table.Th>
                  <Table.Th style={{ width: '80px', textAlign: 'center' }}>ç¨ç‡</Table.Th>
                  <Table.Th style={{ width: '100px', textAlign: 'center' }}>æ“ä½œ</Table.Th>
                </Table.Tr>
              </Table.Thead>
              <Table.Tbody>
                {revenueItems.map((item) => {
                  const taxableIncome = calculateTaxableIncome(item)
                  const nonTaxIncome = calculateNonTaxIncome(item)
                  const vatAmount = calculateVatAmount(item)

                  return (
                    <Table.Tr key={item.id}>
                      <Table.Td style={{ textAlign: 'center' }}>{item.index}</Table.Td>
                      <Table.Td>{item.name}</Table.Td>
                      <Table.Td>
                        <Badge size="sm" color="blue" variant="light">
                          {CATEGORY_LABELS[item.category]}
                        </Badge>
                      </Table.Td>
                      <Table.Td>
                        <Text size="xs" c="#86909C">
                          {TEMPLATE_LABELS[item.fieldTemplate]}
                        </Text>
                      </Table.Td>
                      <Table.Td>
                        <Text size="xs" c="#4E5969">
                          {renderFieldValue(item)}
                        </Text>
                      </Table.Td>
                      <Table.Td style={{ textAlign: 'right' }}>
                        <Text size="sm" fw={500}>
                          {formatAmount(taxableIncome)}
                        </Text>
                      </Table.Td>
                      <Table.Td style={{ textAlign: 'right' }}>
                        <Text size="sm" fw={500} c="#165DFF">
                          {formatAmount(nonTaxIncome)}
                        </Text>
                      </Table.Td>
                      <Table.Td style={{ textAlign: 'right' }}>
                        <Text size="sm" c="#F7BA1E">
                          {formatAmount(vatAmount)}
                        </Text>
                      </Table.Td>
                      <Table.Td style={{ textAlign: 'center' }}>
                        <Text size="xs">
                          {(item.vatRate * 100).toFixed(0)}%
                        </Text>
                      </Table.Td>
                      <Table.Td style={{ textAlign: 'center' }}>
                        <Group gap={4} justify="center">
                          <Tooltip label="ç¼–è¾‘">
                            <ActionIcon
                              variant="light"
                              color="blue"
                              onClick={() => handleEdit(item)}
                              size="sm"
                            >
                              <IconEdit size={16} />
                            </ActionIcon>
                          </Tooltip>
                          <Tooltip label="åˆ é™¤">
                            <ActionIcon
                              variant="light"
                              color="red"
                              onClick={() => handleDelete(item)}
                              size="sm"
                            >
                              <IconTrash size={16} />
                            </ActionIcon>
                          </Tooltip>
                        </Group>
                      </Table.Td>
                    </Table.Tr>
                  )
                })}
                {/* åˆè®¡è¡Œ */}
                <Table.Tr style={{ backgroundColor: '#F7F8FA' }}>
                  <Table.Td style={{ textAlign: 'center' }}></Table.Td>
                  <Table.Td>
                    <Text fw={600}>åˆè®¡</Text>
                  </Table.Td>
                  <Table.Td colSpan={3}></Table.Td>
                  <Table.Td style={{ textAlign: 'right' }}>
                    <Text fw={600} c="#1D2129">
                      {formatAmount(revenueItems.reduce((sum, item) => sum + calculateTaxableIncome(item), 0))}
                    </Text>
                  </Table.Td>
                  <Table.Td style={{ textAlign: 'right' }}>
                    <Text fw={600} c="#165DFF">
                      {formatAmount(revenueItems.reduce((sum, item) => sum + calculateNonTaxIncome(item), 0))}
                    </Text>
                  </Table.Td>
                  <Table.Td style={{ textAlign: 'right' }}>
                    <Text fw={600} c="#F7BA1E">
                      {formatAmount(revenueItems.reduce((sum, item) => sum + calculateVatAmount(item), 0))}
                    </Text>
                  </Table.Td>
                  <Table.Td colSpan={2}></Table.Td>
                </Table.Tr>
              </Table.Tbody>
            </Table>
          </div>
        )}
      </Stack>

      {/* ç¼–è¾‘å¯¹è¯æ¡† */}
      <Modal
        opened={showEditModal}
        onClose={() => setShowEditModal(false)}
        title={
          <Group justify="space-between" style={{ width: '100%', paddingRight: '40px' }}>
            <Text size="lg" fw={600}>{isNewItem ? 'æ–°å¢æ”¶å…¥é¡¹' : 'ç¼–è¾‘æ”¶å…¥é¡¹'}</Text>
            <Button
              size="xs"
              leftSection={<IconSparkles size={14} />}
              onClick={handleAiEstimate}
              loading={aiEstimating}
              variant="light"
              color="violet"
            >
              AIæµ‹ç®—
            </Button>
          </Group>
        }
        size="md"
      >
        {renderFormFields()}
        <Group justify="flex-end" mt="xl">
          <Button variant="default" onClick={() => setShowEditModal(false)}>
            å–æ¶ˆ
          </Button>
          <Button onClick={handleSave} style={{ backgroundColor: '#165DFF', color: '#FFFFFF' }}>
            ä¿å­˜
          </Button>
        </Group>
      </Modal>
      
      {/* è¾¾äº§ç‡é…ç½®å¼¹çª— */}
      <ProductionRateModal
        opened={productionRateModalOpened}
        onClose={() => setProductionRateModalOpened(false)}
      />

      {/* æ”¶å…¥è¯¦è¡¨å¼¹çª— */}
      <Modal
        opened={showRevenueDetailModal}
        onClose={() => setShowRevenueDetailModal(false)}
        title={
          <Group justify="space-between" w="100%">
            <Text size="md">
              ğŸ“Š è¥ä¸šæ”¶å…¥ã€è¥ä¸šç¨é‡‘åŠé™„åŠ å’Œå¢å€¼ç¨ä¼°ç®—è¡¨
            </Text>
            <Tooltip label="å¯¼å‡ºExcel">
              <ActionIcon
                variant="light"
                color="green"
                size={16}
                onClick={handleExportRevenueTable}
              >
                <IconDownload size={16} />
              </ActionIcon>
            </Tooltip>
          </Group>
        }
        size="calc(100vw - 100px)"
        styles={{
          body: {
            maxHeight: 'calc(100vh - 200px)',
            overflowY: 'auto',
          },
        }}
      >
        {(() => {
          if (!context) return <Text c="red">é¡¹ç›®ä¸Šä¸‹æ–‡æœªåŠ è½½</Text>

          const operationYears = context.operationYears
          const years = Array.from({ length: operationYears }, (_, i) => i + 1)

          return (
            <>
              {/* åŸå¸‚å»ºè®¾ç»´æŠ¤ç¨ç¨ç‡é€‰æ‹©æ»‘å— */}
              <Group justify="flex-end" mb="md">
                <Text size="xs">åŸå¸‚å»ºè®¾ç»´æŠ¤ç¨ç¨ç‡:</Text>
                <SegmentedControl
                  radius="md"
                  size="sm"
                  data={['å¸‚åŒº7%', 'å¿é•‡5%']}
                  value={taxConfig.urbanConstructionTaxRate === 0.07 ? 'å¸‚åŒº7%' : 'å¿é•‡5%'}
                  onChange={(value: string) => {
                    setTaxConfig({
                      ...taxConfig,
                      urbanConstructionTaxRate: value === 'å¸‚åŒº7%' ? 0.07 : 0.05
                    });
                  }}
                  styles={{
                    root: {
                      backgroundColor: '#ffffff', // ç™½è‰²èƒŒæ™¯
                      border: '1px solid #d1d5db', // ç°è‰²è¾¹æ¡†
                    },
                    indicator: {
                      backgroundColor: '#165DFF', // è“è‰²é€‰ä¸­èƒŒæ™¯
                    },
                    label: {
                      color: '#000000', // é»‘è‰²æ–‡å­—
                      '&[data-active]': {
                        color: '#ffffff', // ç™½è‰²é€‰ä¸­æ–‡å­—
                      },
                    },
                  }}
                />
              </Group>
              
              <Table striped withTableBorder style={{ fontSize: '11px' }}>
                <Table.Thead>
                  <Table.Tr style={{ backgroundColor: '#F7F8FA' }}>
                    <Table.Th rowSpan={2} style={{ textAlign: 'center', verticalAlign: 'middle', border: '1px solid #dee2e6' }}>åºå·</Table.Th>
                    <Table.Th rowSpan={2} style={{ textAlign: 'center', verticalAlign: 'middle', border: '1px solid #dee2e6' }}>æ”¶å…¥é¡¹ç›®</Table.Th>
                    <Table.Th rowSpan={2} style={{ textAlign: 'center', verticalAlign: 'middle', border: '1px solid #dee2e6' }}>åˆè®¡</Table.Th>
                    <Table.Th colSpan={operationYears} style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>è¿è¥æœŸ</Table.Th>
                  </Table.Tr>
                  <Table.Tr style={{ backgroundColor: '#F7F8FA' }}>
                    {years.map((year) => (
                      <Table.Th key={year} style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                        {year}
                      </Table.Th>
                    ))}
                  </Table.Tr>
                </Table.Thead>
                <Table.Tbody>
                  {/* 1. è¥ä¸šæ”¶å…¥ */}
                  <Table.Tr>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>1</Table.Td>
                    <Table.Td style={{ border: '1px solid #dee2e6' }}>è¥ä¸šæ”¶å…¥</Table.Td>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                      {revenueItems.reduce((sum, item) => {
                        const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, 1)
                        return sum + calculateYearlyRevenue(item, 1, productionRate)
                      }, 0).toFixed(2)}
                    </Table.Td>
                    {years.map((year) => {
                      const yearTotal = revenueItems.reduce((sum, item) => {
                        const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
                        return sum + calculateYearlyRevenue(item, year, productionRate)
                      }, 0)
                      return (
                        <Table.Td key={year} style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                          {yearTotal.toFixed(2)}
                        </Table.Td>
                      )
                    })}
                  </Table.Tr>
                  
                  {/* 1.1, 1.2, 1.3... æ”¶å…¥é¡¹ */}
                  {revenueItems.map((item, idx) => {
                    const yearlyRevenues = years.map((year) => {
                      const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
                      return calculateYearlyRevenue(item, year, productionRate)
                    })

                    // è®¡ç®—åˆè®¡
                    const totalRevenue = yearlyRevenues.reduce((sum, revenue) => sum + revenue, 0);

                    return (
                      <Table.Tr key={`revenue-${item.id}`}>
                        <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>1.{idx + 1}</Table.Td>
                        <Table.Td style={{ border: '1px solid #dee2e6' }}>{`${item.name}ï¼ˆ${(item.vatRate * 100).toFixed(0)}%ï¼‰`}</Table.Td>
                        <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>{totalRevenue.toFixed(2)}</Table.Td>
                        {yearlyRevenues.map((revenue, i) => (
                          <Table.Td key={i} style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                            {revenue.toFixed(2)}
                          </Table.Td>
                        ))}
                      </Table.Tr>
                    )
                  })}
                  
                  {/* 2. å¢å€¼ç¨ */}
                  <Table.Tr>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>2</Table.Td>
                    <Table.Td style={{ border: '1px solid #dee2e6' }}>å¢å€¼ç¨</Table.Td>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                      {(() => {
                        // è®¡ç®—æ‰€æœ‰å¹´ä»½å¢å€¼ç¨çš„åˆè®¡ = é”€é¡¹ç¨é¢ - è¿›é¡¹ç¨é¢ - è¿›é¡¹ç¨é¢ï¼ˆå›ºå®šèµ„äº§å¾…æŠµæ‰£ï¼‰
                        let totalVat = 0;
                        years.forEach((year) => {
                          // è®¡ç®—é”€é¡¹ç¨é¢
                          const yearOutputTax = revenueItems.reduce((sum, item) => {
                            const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
                            const revenue = calculateYearlyRevenue(item, year, productionRate)
                            // é”€é¡¹ç¨é¢ = å«ç¨æ”¶å…¥ - ä¸å«ç¨æ”¶å…¥
                            return sum + (revenue - revenue / (1 + item.vatRate))
                          }, 0);
                          
                          // è®¡ç®—è¿›é¡¹ç¨é¢
                          const yearInputTax = calculateTotalInputTaxForYear(year);
                          
                          // è®¡ç®—è¿›é¡¹ç¨é¢ï¼ˆå›ºå®šèµ„äº§å¾…æŠµæ‰£ï¼‰
                          const yearFixedAssetInputTax = calculateFixedAssetInputTaxForYear(year);
                          
                          // å¢å€¼ç¨ = é”€é¡¹ç¨é¢ - è¿›é¡¹ç¨é¢ - è¿›é¡¹ç¨é¢ï¼ˆå›ºå®šèµ„äº§å¾…æŠµæ‰£ï¼‰
                          const yearVat = yearOutputTax - yearInputTax - yearFixedAssetInputTax;
                          totalVat += yearVat;
                        });
                        return formatNumberNoRounding(totalVat);
                      })()}
                    </Table.Td>
                    {years.map((year) => {
                      // è®¡ç®—é”€é¡¹ç¨é¢
                      const yearOutputTax = revenueItems.reduce((sum, item) => {
                        const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
                        const revenue = calculateYearlyRevenue(item, year, productionRate)
                        // é”€é¡¹ç¨é¢ = å«ç¨æ”¶å…¥ - ä¸å«ç¨æ”¶å…¥
                        return sum + (revenue - revenue / (1 + item.vatRate))
                      }, 0);
                      
                      // è®¡ç®—è¿›é¡¹ç¨é¢
                      const yearInputTax = calculateTotalInputTaxForYear(year);
                      
                      // è®¡ç®—è¿›é¡¹ç¨é¢ï¼ˆå›ºå®šèµ„äº§å¾…æŠµæ‰£ï¼‰
                      const yearFixedAssetInputTax = calculateFixedAssetInputTaxForYear(year);
                      
                      // å¢å€¼ç¨ = é”€é¡¹ç¨é¢ - è¿›é¡¹ç¨é¢ - è¿›é¡¹ç¨é¢ï¼ˆå›ºå®šèµ„äº§å¾…æŠµæ‰£ï¼‰
                      const yearVat = yearOutputTax - yearInputTax - yearFixedAssetInputTax;
                      
                      return (
                        <Table.Td key={year} style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                          {formatNumberNoRounding(yearVat)}
                        </Table.Td>
                      )
                    })}
                  </Table.Tr>
                  
                  {/* 2.1 é”€é¡¹ç¨é¢ */}
                  <Table.Tr>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>2.1</Table.Td>
                    <Table.Td style={{ border: '1px solid #dee2e6' }}>é”€é¡¹ç¨é¢</Table.Td>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                      {(() => {
                        // è®¡ç®—æ‰€æœ‰å¹´ä»½é”€é¡¹ç¨é¢çš„åˆè®¡
                        let totalVat = 0;
                        years.forEach((year) => {
                          const yearVat = revenueItems.reduce((sum, item) => {
                            const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
                            const revenue = calculateYearlyRevenue(item, year, productionRate)
                            // é”€é¡¹ç¨é¢ = å«ç¨æ”¶å…¥ - ä¸å«ç¨æ”¶å…¥
                            return sum + (revenue - revenue / (1 + item.vatRate))
                          }, 0);
                          totalVat += yearVat;
                        });
                        return totalVat.toFixed(2);
                      })()}
                    </Table.Td>
                    {years.map((year) => {
                      const yearTotal = revenueItems.reduce((sum, item) => {
                        const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
                        const revenue = calculateYearlyRevenue(item, year, productionRate)
                        // é”€é¡¹ç¨é¢ = å«ç¨æ”¶å…¥ - ä¸å«ç¨æ”¶å…¥
                        return sum + (revenue - revenue / (1 + item.vatRate))
                      }, 0)
                      return (
                        <Table.Td key={year} style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                          {yearTotal.toFixed(2)}
                        </Table.Td>
                      )
                    })}
                  </Table.Tr>
                  
                  {/* 2.2 è¿›é¡¹ç¨é¢ */}
                  <Table.Tr>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>2.2</Table.Td>
                    <Table.Td style={{ border: '1px solid #dee2e6' }}>è¿›é¡¹ç¨é¢</Table.Td>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                      {(() => {
                        // è®¡ç®—æ‰€æœ‰å¹´ä»½è¿›é¡¹ç¨é¢çš„åˆè®¡
                        let totalInputTax = 0;
                        years.forEach((year) => {
                          totalInputTax += calculateTotalInputTaxForYear(year);
                        });
                        return formatNumberNoRounding(totalInputTax);
                      })()}
                    </Table.Td>
                    {years.map((year) => {
                      const totalInputTax = calculateTotalInputTaxForYear(year);
                      return (
                        <Table.Td key={year} style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                          {formatNumberNoRounding(totalInputTax)}
                        </Table.Td>
                      );
                    })}
                  </Table.Tr>
                  
                  {/* 2.3 è¿›é¡¹ç¨é¢ï¼ˆå›ºå®šèµ„äº§å¾…æŠµæ‰£ï¼‰ */}
                  <Table.Tr>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>2.3</Table.Td>
                    <Table.Td style={{ border: '1px solid #dee2e6' }}>è¿›é¡¹ç¨é¢ï¼ˆå›ºå®šèµ„äº§å¾…æŠµæ‰£ï¼‰</Table.Td>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                      {(() => {
                        // è®¡ç®—æ‰€æœ‰å¹´ä»½è¿›é¡¹ç¨é¢ï¼ˆå›ºå®šèµ„äº§å¾…æŠµæ‰£ï¼‰çš„åˆè®¡
                        let totalFixedAssetInputTax = 0;
                        years.forEach((year) => {
                          totalFixedAssetInputTax += calculateFixedAssetInputTaxForYear(year);
                        });
                        return formatNumberNoRounding(totalFixedAssetInputTax);
                      })()}
                    </Table.Td>
                    {years.map((year) => {
                      const fixedAssetInputTax = calculateFixedAssetInputTaxForYear(year);
                      return (
                        <Table.Td key={year} style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                          {formatNumberNoRounding(fixedAssetInputTax)}
                        </Table.Td>
                      );
                    })}
                  </Table.Tr>
                  
                  {/* 3. å…¶ä»–ç¨è´¹åŠé™„åŠ  */}
                  <Table.Tr>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>3</Table.Td>
                    <Table.Td style={{ border: '1px solid #dee2e6' }}>å…¶ä»–ç¨è´¹åŠé™„åŠ </Table.Td>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                      {(() => {
                        // è®¡ç®—æ‰€æœ‰å¹´ä»½å…¶ä»–ç¨è´¹åŠé™„åŠ çš„åˆè®¡
                        let totalOtherTaxes = 0;
                        years.forEach((year) => {
                          const vatTotal = revenueItems.reduce((sum, item) => {
                            const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
                            const revenue = calculateYearlyRevenue(item, year, productionRate)
                            return sum + (revenue - revenue / (1 + item.vatRate))
                          }, 0)
                          // ä½¿ç”¨çŠ¶æ€ä¸­çš„ç¨ç‡
                          const taxResult = calculateAllTaxes(vatTotal, taxConfig);
                          const otherTaxes = taxResult.totalAdditionalTaxes
                          totalOtherTaxes += otherTaxes;
                        });
                        return totalOtherTaxes.toFixed(2);
                      })()}
                    </Table.Td>
                    {years.map((year) => {
                      const vatTotal = revenueItems.reduce((sum, item) => {
                        const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
                        const revenue = calculateYearlyRevenue(item, year, productionRate)
                        return sum + (revenue - revenue / (1 + item.vatRate))
                      }, 0)
                      // ä½¿ç”¨çŠ¶æ€ä¸­çš„ç¨ç‡
                      const urbanTax = vatTotal * urbanTaxRate
                      const educationTax = vatTotal * 0.05 // æ•™è‚²è´¹é™„åŠ (3%+åœ°æ–¹2%)
                      const otherTaxes = urbanTax + educationTax
                      return (
                        <Table.Td key={year} style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                          {otherTaxes.toFixed(2)}
                        </Table.Td>
                      )
                    })}
                  </Table.Tr>
                  
                  {/* 3.1 åŸå¸‚å»ºè®¾ç»´æŠ¤ç¨(n%) */}
                  <Table.Tr>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>3.1</Table.Td>
                    <Table.Td style={{ border: '1px solid #dee2e6' }}>åŸå¸‚å»ºè®¾ç»´æŠ¤ç¨({(urbanTaxRate * 100).toFixed(0)}%)</Table.Td>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                      {(() => {
                        const vatTotal = revenueItems.reduce((sum, item) => {
                          const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, 1)
                          const revenue = calculateYearlyRevenue(item, 1, productionRate)
                          return sum + (revenue - revenue / (1 + item.vatRate))
                        }, 0)
                        const taxResult = calculateAllTaxes(vatTotal, taxConfig);
                        const urbanTax = taxResult.urbanConstructionTax
                        return urbanTax.toFixed(2)
                      })()}
                    </Table.Td>
                    {years.map((year) => {
                      const vatTotal = revenueItems.reduce((sum, item) => {
                        const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
                        const revenue = calculateYearlyRevenue(item, year, productionRate)
                        return sum + (revenue - revenue / (1 + item.vatRate))
                      }, 0)
                      const urbanTax = vatTotal * urbanTaxRate
                      return (
                        <Table.Td key={year} style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                          {urbanTax.toFixed(2)}
                        </Table.Td>
                      )
                    })}
                  </Table.Tr>
                  
                  {/* 3.2 æ•™è‚²è´¹é™„åŠ (3%+åœ°æ–¹2%) */}
                  <Table.Tr>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>3.2</Table.Td>
                    <Table.Td style={{ border: '1px solid #dee2e6' }}>æ•™è‚²è´¹é™„åŠ (3%+åœ°æ–¹2%)</Table.Td>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                      {(() => {
                        const vatTotal = revenueItems.reduce((sum, item) => {
                          const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, 1)
                          const revenue = calculateYearlyRevenue(item, 1, productionRate)
                          return sum + (revenue - revenue / (1 + item.vatRate))
                        }, 0)
                        const taxResult = calculateAllTaxes(vatTotal, taxConfig);
                        const educationTax = taxResult.educationSurtax
                        return educationTax.toFixed(2)
                      })()}
                    </Table.Td>
                    {years.map((year) => {
                      const vatTotal = revenueItems.reduce((sum, item) => {
                        const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
                        const revenue = calculateYearlyRevenue(item, year, productionRate)
                        return sum + (revenue - revenue / (1 + item.vatRate))
                      }, 0)
                      const educationTax = vatTotal * 0.05 // 3%+2%=5%
                      return (
                        <Table.Td key={year} style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                          {educationTax.toFixed(2)}
                        </Table.Td>
                      )
                    })}
                  </Table.Tr>
                  
                  {/* 3.3 åœ°æ–¹æ•™è‚²è´¹é™„åŠ  */}
                  <Table.Tr>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>3.3</Table.Td>
                    <Table.Td style={{ border: '1px solid #dee2e6' }}>åœ°æ–¹æ•™è‚²è´¹é™„åŠ ({formatTaxRate(taxConfig.localEducationSurtaxRate)})</Table.Td>
                    <Table.Td style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                      {(() => {
                        const vatTotal = revenueItems.reduce((sum, item) => {
                          const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, 1)
                          const revenue = calculateYearlyRevenue(item, 1, productionRate)
                          return sum + (revenue - revenue / (1 + item.vatRate))
                        }, 0)
                        const taxResult = calculateAllTaxes(vatTotal, taxConfig);
                        return taxResult.localEducationSurtax.toFixed(2)
                      })()}
                    </Table.Td>
                    {years.map((year) => {
                      const vatTotal = revenueItems.reduce((sum, item) => {
                        const productionRate = getProductionRateForYear(useRevenueCostStore.getState().productionRates, year)
                        const revenue = calculateYearlyRevenue(item, year, productionRate)
                        return sum + (revenue - revenue / (1 + item.vatRate))
                      }, 0)
                      const taxResult = calculateAllTaxes(vatTotal, taxConfig);
                      return (
                        <Table.Td key={year} style={{ textAlign: 'center', border: '1px solid #dee2e6' }}>
                          {taxResult.localEducationSurtax.toFixed(2)}
                        </Table.Td>
                      )
                    })}
                  </Table.Tr>
                </Table.Tbody>
              </Table>
            </>
          )
        })()}
      </Modal>
    </>
  )
 }

export default DynamicRevenueTable




