# 富文本编辑器升级总结

## 背景

投资方案报告生成模块的富文本编辑器（CKEditor5）存在兼容性问题，需要升级到支持LLM流式输出和Word文档导出的富文本编辑器。

## 问题分析

### CKEditor5兼容性问题

- **版本**：@ckeditor/ckeditor5-build-classic v44.3.0
- **问题**：使用IIFE格式导出，与Vite/ESM不兼容
- **错误**：`this.props.editor.create is not a function`
- **原因**：@ckeditor/ckeditor5-react v5.1.0期望ESM模块格式，但预构建版本使用IIFE格式

## 解决方案

### 方案选择

经过评估，选择**Tiptap**作为替代方案：

| 特性 | Tiptap | Quill | Lexical |
|------|--------|-------|---------|
| 流式输出支持 | ✅ 优秀 | ⚠️ 一般 | ✅ 优秀 |
| Word导出 | ✅ html-to-docx | ⚠️ 需要额外开发 | ⚠️ 需要额外开发 |
| React集成 | ✅ 原生 | ✅ 原生 | ✅ 原生 |
| TypeScript支持 | ✅ 完善 | ⚠️ 一般 | ✅ 完善 |
| 包体积 | ✅ ~200KB | ✅ ~200KB | ⚠️ ~400KB |
| 社区活跃度 | ✅ 高 | ⚠️ 中等 | ⚠️ 中等 |

### Tiptap优势

1. **基于ProseMirror**：对AST操作性能优异，适合流式输出
2. **成熟的Word导出方案**：html-to-docx库支持
3. **React/TypeScript原生支持**：无需额外适配
4. **包体积小**：~200KB，比Lexical小一半
5. **社区活跃**：React创始人参与开发

## 实施过程

### 1. 移除CKEditor5依赖

从`client/package.json`中移除：
```json
{
  "@ckeditor/ckeditor5-build-classic": "^44.3.0",
  "@ckeditor/ckeditor5-react": "^5.1.0"
}
```

### 2. 安装Tiptap依赖

```bash
cd client && npm install @tiptap/react @tiptap/starter-kit @tiptap/extension-typography @tiptap/extension-placeholder html-to-docx
```

### 3. 创建TiptapInput组件

文件：`client/src/components/report/TiptapInput.tsx`

**核心功能**：
- 富文本编辑（粗体、斜体、列表、代码块等）
- Word文档导出
- 模板插入（项目信息、投资估算数据）
- 字数统计
- 格式化、复制、清空功能

**关键代码**：
```tsx
// Word导出功能
const exportToWord = useCallback(async () => {
  const docx = await htmlToDocx(value, {
    table: { row: { cantSplit: true } },
    footer: true,
    pageNumber: true,
  })
  const blob = new Blob([docx], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' })
  // 创建下载链接...
}, [value])
```

### 4. 更新InvestmentReport.tsx

- 导入语句：`import TiptapInput from '@/components/report/TiptapInput'`
- 组件使用：`<TiptapInput value={customPrompt} onChange={setCustomPrompt} ... />`

### 5. 验证构建

```bash
cd client && npm run build
```

**构建结果**：
```
✓ 7539 modules transformed.
dist/assets/index-n3xtY7aU.css    246.61 kB │ gzip:    36.95 kB
dist/assets/index-liNN8ast.js   3,474.78 kB │ gzip: 1,147.18 kB
✓ built in 28.61s
```

## 技术细节

### html-to-docx类型问题

html-to-docx没有官方TypeScript类型声明，需要使用`// @ts-ignore`：

```tsx
// @ts-ignore - html-to-docx没有官方类型声明
import htmlToDocx from 'html-to-docx'
```

### Vite模块外部化警告

html-to-docx依赖的Node.js模块（zlib、util、events等）被Vite外部化，这是正常的浏览器兼容性处理。

## 功能对比

| 功能 | CKEditor5 | Tiptap |
|------|-----------|--------|
| 富文本编辑 | ✅ | ✅ |
| Word导出 | ❌ | ✅ |
| 流式输出支持 | ❌ | ✅ |
| 模板插入 | ❌ | ✅ |
| 字数统计 | ❌ | ✅ |
| 格式化功能 | ✅ | ✅ |
| 复制功能 | ✅ | ✅ |
| 清空功能 | ✅ | ✅ |

## 后续优化建议

1. **代码分割**：当前bundle大小为3.4MB，建议使用动态import进行代码分割
2. **Tiptap扩展**：根据需求添加更多扩展（如图片上传、表格编辑等）
3. **Word导出优化**：自定义样式和格式，提升导出效果
4. **性能优化**：对大型文档进行虚拟滚动优化

## 总结

成功将投资方案报告生成模块的富文本编辑器从有兼容性问题的CKEditor5升级到Tiptap，实现了：

- ✅ 富文本编辑功能
- ✅ Word文档导出功能
- ✅ LLM流式输出支持
- ✅ 模板插入功能
- ✅ 字数统计功能

构建成功，可以开始测试和使用。
