<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>现金流入含税营业收入验证</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .highlight {
            background-color: #e7f3ff;
        }
        .calculation {
            margin: 10px 0;
            padding: 10px;
            background-color: #f9f9f9;
            border-left: 4px solid #007acc;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>现金流入含税营业收入验证</h1>
        
        <div class="section">
            <h2>修改说明</h2>
            <p>根据用户反馈，项目投资现金流量表中现金流入的营业收入部分应该使用含税收入，而不是不含税收入。之前的计算方式是营业收入 = 含税收入 - 销项税额（即不含税收入），现在修改为营业收入 = 含税收入（即含税收入）。</p>
            
            <div class="calculation">
                <strong>修改前：</strong><br>
                现金流入中的营业收入 = 营业收入（含税）- 销项税额 = 不含税收入<br><br>
                
                <strong>修改后：</strong><br>
                现金流入中的营业收入 = 营业收入（含税） = 含税收入
            </div>
            
            <p>修改位置：</p>
            <ul>
                <li>表格显示中的现金流入计算（使用新函数 calculateTaxableOperatingRevenue）</li>
                <li>Excel导出功能中的现金流入计算（使用新函数 calculateTaxableOperatingRevenue）</li>
                <li>所得税前净现金流量（1-2）计算（现在正确使用含税收入）</li>
                <li>所有相关财务指标计算</li>
                <li>debug弹窗中的说明文字更新</li>
            </ul>
        </div>
        
        <div class="section highlight">
            <h2>计算逻辑验证</h2>
            <table>
                <thead>
                    <tr>
                        <th>项目</th>
                        <th>修改前（不含税）</th>
                        <th>修改后（含税）</th>
                        <th>影响</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>营业收入</td>
                        <td>含税收入 - 销项税额</td>
                        <td>含税收入</td>
                        <td>现金流入增加（增加销项税额部分）</td>
                    </tr>
                    <tr>
                        <td>现金流入小计</td>
                        <td>不含税收入 + 其他流入</td>
                        <td>含税收入 + 其他流入</td>
                        <td>现金流入总额增加</td>
                    </tr>
                    <tr>
                        <td>所得税前净现金流量</td>
                        <td>（不含税收入 + 其他流入）- 现金流出</td>
                        <td>（含税收入 + 其他流入）- 现金流出</td>
                        <td>净现金流量增加（增加销项税额部分）</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <h2>代码实现</h2>
            <p>1. 新增 calculateTaxableOperatingRevenue 函数：</p>
            <pre>
// 计算含税营业收入的函数
const calculateTaxableOperatingRevenue = (year?: number): number => {
  if (year !== undefined) {
    // 从 revenueTableData 中获取"营业收入"（序号1）的运营期列数据（含税收入）
    if (revenueTableData && revenueTableData.rows) {
      const revenueRow = revenueTableData.rows.find(r => r.序号 === '1');
      
      if (revenueRow && revenueRow.运营期 && revenueRow.运营期[year - 1] !== undefined) {
        return revenueRow.运营期[year - 1];
      }
    }
    // 如果没有表格数据，使用原有计算逻辑作为后备
    const productionRate = productionRates?.find(p => p.yearIndex === year)?.rate || 1;
    return revenueItems.reduce((sum, item) => {
      // 计算含税收入
      const taxableRevenue = calculateYearlyRevenue(item, year, productionRate);
      return sum + taxableRevenue;
    }, 0);
  } else {
    // 从 revenueTableData 中获取"营业收入"（序号1）的合计数据（含税收入）
    if (revenueTableData && revenueTableData.rows) {
      const revenueRow = revenueTableData.rows.find(r => r.序号 === '1');
      
      if (revenueRow && revenueRow.合计 !== undefined) {
        return revenueRow.合计;
      }
    }
    // 如果没有表格数据，使用原有计算逻辑作为后备
    if (!context) return 0;
    const years = Array.from({ length: context.operationYears }, (_, i) => i + 1);
    let totalSum = 0;
    years.forEach((year) => {
      totalSum += calculateTaxableOperatingRevenue(year);
    });
    return totalSum;
  }
};
            </pre>
            
            <p>2. 修改表格显示中的现金流入计算：</p>
            <pre>
// 修改前
yearTotal = calculateOperatingRevenue(operationYear) +
           calculateSubsidyIncome(operationYear) +
           calculateFixedAssetResidual(operationYear) +
           calculateWorkingCapitalRecovery(operationYear);

// 修改后
yearTotal = calculateTaxableOperatingRevenue(operationYear) +
           calculateSubsidyIncome(operationYear) +
           calculateFixedAssetResidual(operationYear) +
           calculateWorkingCapitalRecovery(operationYear);
            </pre>
            
            <p>3. 修改Excel导出中的现金流入计算：</p>
            <pre>
// 修改前
const yearInflow = calculateOperatingRevenue(operationYear) +
                  calculateSubsidyIncome(operationYear) +
                  calculateFixedAssetResidual(operationYear) +
                  calculateWorkingCapitalRecovery(operationYear);

// 修改后
const yearInflow = calculateTaxableOperatingRevenue(operationYear) +
                  calculateSubsidyIncome(operationYear) +
                  calculateFixedAssetResidual(operationYear) +
                  calculateWorkingCapitalRecovery(operationYear);
            </pre>
        </div>
        
        <div class="section">
            <h2>验证结果</h2>
            <p>通过以上修改，现金流入中的营业收入现在使用含税收入，这将导致：</p>
            <ul>
                <li>现金流入总额增加</li>
                <li>所得税前净现金流量增加</li>
                <li>财务指标（如NPV、IRR）可能改善</li>
            </ul>
            <p>这种修改确保了项目投资现金流量表中的营业收入与营业收入估算表中的数据保持一致，解决了数据不一致的问题。</p>
        </div>
    </div>
</body>
</html>