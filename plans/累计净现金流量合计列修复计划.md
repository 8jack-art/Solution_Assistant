# 累计净现金流量合计列修复计划

## 问题概述

在项目投资现金流量表中，以下四个项目的合计列计算存在问题：
- "4 累计所得税前净现金流量"
- "7 累计所得税后净现金流量"
- "2 累计所得税前净现金流量（动态）"
- "4 累计所得税后净现金流量（动态）"

这些项目的合计列目前只是简单地使用最后一年的累计值，而没有正确合计各自的建设期列及运营期列。

## 问题分析

### 当前实现
在`FinancialIndicatorsTable.tsx`文件中，四个累计净现金流量项目的合计列计算方式为：

1. **累计所得税前净现金流量**（行1331-1361）：
   ```typescript
   row4['合计'] = cumulativeCashFlow;
   ```

2. **累计所得税后净现金流量**（行1414-1445）：
   ```typescript
   row7['合计'] = cumulativeCashFlow;
   ```

3. **累计所得税前净现金流量（动态）**（行1484-1518）：
   ```typescript
   row9['合计'] = cumulativeDynamicPreTaxCashFlow;
   ```

4. **累计所得税后净现金流量（动态）**（行1568-1612）：
   ```typescript
   row11['合计'] = cumulativeDynamicPostTaxCashFlow;
   ```

### 问题所在
当前实现中，合计列只是使用了最后一年的累计值，而不是正确合计建设期和运营期的所有列值。根据用户需求，合计列应合计各自的建设期列及运营期列。

## 解决方案

### 修改思路
对于每个累计净现金流量项目，需要：
1. 分别计算建设期和运营期的现金流总和
2. 将建设期和运营期的总和相加，得到正确的合计值
3. 保持累计值的计算逻辑不变

### 具体修改

#### 1. 累计所得税前净现金流量（项目4）
**文件位置**：`client/src/components/revenue-cost/FinancialIndicatorsTable.tsx`，行1331-1361

**修改前**：
```typescript
// 4. 累计所得税前净现金流量
const row4: any = { '序号': '4', '项目': '累计所得税前净现金流量' };
let cumulativeCashFlow = 0;
years.forEach((year) => {
  if (year <= constructionYears) {
    // 建设期
    const preTaxCashFlow = calculatePreTaxCashFlow(year);
    cumulativeCashFlow += preTaxCashFlow;
    row4[`${year}`] = cumulativeCashFlow;
  } else {
    // 运营期
    const operationYear = year - constructionYears;
    const preTaxCashFlow = calculatePreTaxCashFlow(year);
    cumulativeCashFlow += preTaxCashFlow;
    row4[`${year}`] = cumulativeCashFlow;
  }
});
row4['合计'] = cumulativeCashFlow;
```

**修改后**：
```typescript
// 4. 累计所得税前净现金流量
const row4: any = { '序号': '4', '项目': '累计所得税前净现金流量' };
let cumulativeCashFlow = 0;
let constructionPeriodTotal = 0;
let operationPeriodTotal = 0;

years.forEach((year) => {
  if (year <= constructionYears) {
    // 建设期
    const preTaxCashFlow = calculatePreTaxCashFlow(year);
    cumulativeCashFlow += preTaxCashFlow;
    row4[`${year}`] = cumulativeCashFlow;
    constructionPeriodTotal += preTaxCashFlow;
  } else {
    // 运营期
    const operationYear = year - constructionYears;
    const preTaxCashFlow = calculatePreTaxCashFlow(year);
    cumulativeCashFlow += preTaxCashFlow;
    row4[`${year}`] = cumulativeCashFlow;
    operationPeriodTotal += preTaxCashFlow;
  }
});

// 合计列应合计建设期和运营期列
row4['合计'] = constructionPeriodTotal + operationPeriodTotal;
```

#### 2. 累计所得税后净现金流量（项目7）
**文件位置**：`client/src/components/revenue-cost/FinancialIndicatorsTable.tsx`，行1414-1445

**修改前**：
```typescript
// 7. 累计所得税后净现金流量
const row7: any = { '序号': '7', '项目': '累计所得税后净现金流量' };
cumulativeCashFlow = 0;
years.forEach((year) => {
  if (year <= constructionYears) {
    // 建设期
    const postTaxCashFlow = calculatePostTaxCashFlow(year);
    cumulativeCashFlow += postTaxCashFlow;
    row7[`${year}`] = cumulativeCashFlow;
  } else {
    // 运营期
    const operationYear = year - constructionYears;
    const postTaxCashFlow = calculatePostTaxCashFlow(year);
    cumulativeCashFlow += postTaxCashFlow;
    row7[`${year}`] = cumulativeCashFlow;
  }
});
row7['合计'] = cumulativeCashFlow;
```

**修改后**：
```typescript
// 7. 累计所得税后净现金流量
const row7: any = { '序号': '7', '项目': '累计所得税后净现金流量' };
cumulativeCashFlow = 0;
let constructionPeriodTotal = 0;
let operationPeriodTotal = 0;

years.forEach((year) => {
  if (year <= constructionYears) {
    // 建设期
    const postTaxCashFlow = calculatePostTaxCashFlow(year);
    cumulativeCashFlow += postTaxCashFlow;
    row7[`${year}`] = cumulativeCashFlow;
    constructionPeriodTotal += postTaxCashFlow;
  } else {
    // 运营期
    const operationYear = year - constructionYears;
    const postTaxCashFlow = calculatePostTaxCashFlow(year);
    cumulativeCashFlow += postTaxCashFlow;
    row7[`${year}`] = cumulativeCashFlow;
    operationPeriodTotal += postTaxCashFlow;
  }
});

// 合计列应合计建设期和运营期列
row7['合计'] = constructionPeriodTotal + operationPeriodTotal;
```

#### 3. 累计所得税前净现金流量（动态）（项目2）
**文件位置**：`client/src/components/revenue-cost/FinancialIndicatorsTable.tsx`，行1484-1518

**修改前**：
```typescript
// 9. 累计所得税前净现金流量（动态）
const row9: any = { '序号': '2', '项目': '累计所得税前净现金流量（动态）' };
let cumulativeDynamicPreTaxCashFlow = 0;
years.forEach((year) => {
  if (year <= constructionYears) {
    // 建设期
    const preTaxCashFlow = calculatePreTaxCashFlow(year);
    const discountFactor = Math.pow(1 + preTaxRate / 100, year - 1);
    const dynamicPreTaxCashFlow = preTaxCashFlow / discountFactor;
    cumulativeDynamicPreTaxCashFlow += dynamicPreTaxCashFlow;
    row9[`${year}`] = cumulativeDynamicPreTaxCashFlow;
  } else {
    // 运营期
    const operationYear = year - constructionYears;
    const preTaxCashFlow = calculatePreTaxCashFlow(year);
    const discountFactor = Math.pow(1 + preTaxRate / 100, year - 1);
    const dynamicPreTaxCashFlow = preTaxCashFlow / discountFactor;
    cumulativeDynamicPreTaxCashFlow += dynamicPreTaxCashFlow;
    row9[`${year}`] = cumulativeDynamicPreTaxCashFlow;
  }
});
row9['合计'] = cumulativeDynamicPreTaxCashFlow;
```

**修改后**：
```typescript
// 9. 累计所得税前净现金流量（动态）
const row9: any = { '序号': '2', '项目': '累计所得税前净现金流量（动态）' };
let cumulativeDynamicPreTaxCashFlow = 0;
let constructionPeriodTotal = 0;
let operationPeriodTotal = 0;

years.forEach((year) => {
  if (year <= constructionYears) {
    // 建设期
    const preTaxCashFlow = calculatePreTaxCashFlow(year);
    const discountFactor = Math.pow(1 + preTaxRate / 100, year - 1);
    const dynamicPreTaxCashFlow = preTaxCashFlow / discountFactor;
    cumulativeDynamicPreTaxCashFlow += dynamicPreTaxCashFlow;
    row9[`${year}`] = cumulativeDynamicPreTaxCashFlow;
    constructionPeriodTotal += dynamicPreTaxCashFlow;
  } else {
    // 运营期
    const operationYear = year - constructionYears;
    const preTaxCashFlow = calculatePreTaxCashFlow(year);
    const discountFactor = Math.pow(1 + preTaxRate / 100, year - 1);
    const dynamicPreTaxCashFlow = preTaxCashFlow / discountFactor;
    cumulativeDynamicPreTaxCashFlow += dynamicPreTaxCashFlow;
    row9[`${year}`] = cumulativeDynamicPreTaxCashFlow;
    operationPeriodTotal += dynamicPreTaxCashFlow;
  }
});

// 合计列应合计建设期和运营期列
row9['合计'] = constructionPeriodTotal + operationPeriodTotal;
```

#### 4. 累计所得税后净现金流量（动态）（项目4）
**文件位置**：`client/src/components/revenue-cost/FinancialIndicatorsTable.tsx`，行1568-1612

**修改前**：
```typescript
// 11. 累计所得税后净现金流量（动态）
const row11: any = { '序号': '4', '项目': '累计所得税后净现金流量（动态）' };
let cumulativeDynamicPostTaxCashFlow = 0;
years.forEach((year) => {
  if (year <= constructionYears) {
    // 建设期
    const postTaxCashFlow = calculatePostTaxCashFlow(year);
    const discountFactor = Math.pow(1 + postTaxRate / 100, year - 1);
    const dynamicPostTaxCashFlow = postTaxCashFlow / discountFactor;
    cumulativeDynamicPostTaxCashFlow += dynamicPostTaxCashFlow;
    row11[`${year}`] = cumulativeDynamicPostTaxCashFlow;
  } else {
    // 运营期
    const operationYear = year - constructionYears;
    const postTaxCashFlow = calculatePostTaxCashFlow(year);
    const discountFactor = Math.pow(1 + postTaxRate / 100, year - 1);
    const dynamicPostTaxCashFlow = postTaxCashFlow / discountFactor;
    cumulativeDynamicPostTaxCashFlow += dynamicPostTaxCashFlow;
    row11[`${year}`] = cumulativeDynamicPostTaxCashFlow;
  }
});
row11['合计'] = cumulativeDynamicPostTaxCashFlow;
```

**修改后**：
```typescript
// 11. 累计所得税后净现金流量（动态）
const row11: any = { '序号': '4', '项目': '累计所得税后净现金流量（动态）' };
let cumulativeDynamicPostTaxCashFlow = 0;
let constructionPeriodTotal = 0;
let operationPeriodTotal = 0;

years.forEach((year) => {
  if (year <= constructionYears) {
    // 建设期
    const postTaxCashFlow = calculatePostTaxCashFlow(year);
    const discountFactor = Math.pow(1 + postTaxRate / 100, year - 1);
    const dynamicPostTaxCashFlow = postTaxCashFlow / discountFactor;
    cumulativeDynamicPostTaxCashFlow += dynamicPostTaxCashFlow;
    row11[`${year}`] = cumulativeDynamicPostTaxCashFlow;
    constructionPeriodTotal += dynamicPostTaxCashFlow;
  } else {
    // 运营期
    const operationYear = year - constructionYears;
    const postTaxCashFlow = calculatePostTaxCashFlow(year);
    const discountFactor = Math.pow(1 + postTaxRate / 100, year - 1);
    const dynamicPostTaxCashFlow = postTaxCashFlow / discountFactor;
    cumulativeDynamicPostTaxCashFlow += dynamicPostTaxCashFlow;
    row11[`${year}`] = cumulativeDynamicPostTaxCashFlow;
    operationPeriodTotal += dynamicPostTaxCashFlow;
  }
});

// 合计列应合计建设期和运营期列
row11['合计'] = constructionPeriodTotal + operationPeriodTotal;
```

## 实施步骤

1. 修改累计所得税前净现金流量（项目4）的合计列计算
2. 修改累计所得税后净现金流量（项目7）的合计列计算
3. 修改累计所得税前净现金流量（动态）（项目2）的合计列计算
4. 修改累计所得税后净现金流量（动态）（项目4）的合计列计算
5. 测试修改后的计算逻辑，确保合计列正确显示建设期和运营期的总和

## 预期效果

修改后，四个累计净现金流量项目的合计列将正确合计各自的建设期列及运营期列，而不是简单地使用最后一年的累计值。这将确保项目投资现金流量表的计算更加准确和符合用户需求。