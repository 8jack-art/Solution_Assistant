# 自定义变量持久化和项目隔离实施计划

## 需求概述

### 当前问题
1. **变量不持久化**：新建的变量只存在于前端状态，刷新页面后丢失
2. **变量不按项目隔离**：所有项目共享同一个 `customVariables` 状态
3. **变量传递给了LLM**：自定义变量被传递到LLM生成报告，但不应该传递

### 目标
1. 自定义变量需要持久化到数据库
2. 按项目ID隔离，不同项目的变量互不影响
3. 自定义变量仅用于参考/模板插入，不传递给LLM

## 技术方案

### 1. 数据库设计

在现有的 `report_project_overview` 表中添加 `custom_variables` JSON 字段：

```sql
-- 添加自定义变量字段到 report_project_overview 表
ALTER TABLE report_project_overview
ADD COLUMN IF NOT EXISTS custom_variables JSON COMMENT '自定义变量，结构: {"变量名": "变量值"}';
```

表结构（已有）：
| 字段 | 类型 | 说明 |
|------|------|------|
| id | VARCHAR(36) | 主键 |
| project_id | VARCHAR(36) | 项目ID，用于隔离 |
| content | TEXT | 项目概况内容 |
| custom_variables | JSON | **新增**：自定义变量，键值对格式 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

### 2. 数据结构设计

自定义变量使用 JSON 格式存储：
```json
{
  "my_variable": "变量值1",
  "another_var": "变量值2"
}
```

### 3. 后端API设计

复用现有的项目概况API，通过 `custom_variables` 字段来保存和读取自定义变量：

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/reports/project-overview/:projectId` | 获取项目概况时同时返回自定义变量 |
| POST | `/api/reports/project-overview` | 创建/更新项目概况，同时保存自定义变量 |
| PUT | `/api/reports/project-overview/:id` | 更新项目概况，同时更新自定义变量 |

或者新增专用的自定义变量API：
| 方法 | 路径 | 说明 |
|------|------|------|
| PUT | `/api/reports/custom-variables/:projectId` | 保存项目的自定义变量 |
| GET | `/api/reports/custom-variables/:projectId` | 获取项目的自定义变量 |

### 3. 前端修改

#### 3.1 Store修改 (`reportStore.ts`)

```typescript
// 修改 customVariables 结构为按项目ID隔离
customVariables: Record<string, Record<string, string>>  // projectId -> { variableKey: value }

// 修改函数签名
addCustomVariable: (projectId: string, key: string, value: string) => void
removeCustomVariable: (projectId: string, key: string) => void
loadCustomVariables: (projectId: string) => Promise<void>
saveCustomVariables: (projectId: string) => Promise<void>
```

#### 3.2 获取当前项目的变量

```typescript
// 获取当前项目的自定义变量
const getCurrentProjectVariables = () => {
  const { projectId, customVariables } = get()
  if (!projectId) return {}
  return customVariables[projectId] || {}
}
```

#### 3.3 LLM报告生成时不传递自定义变量

修改 `startGeneration` 函数，确保 `tableDataJSON` 不包含自定义变量：

```typescript
// 只传递系统变量，不传递自定义变量
const tableDataJSON = (cachedTableDataJSON || {})[projectId] || {}
// 自定义变量不在 tableDataJSON 中，所以不会被传递给LLM
```

### 4. VariablePicker修改

修改 `VariablePicker.tsx` 以使用项目隔离的变量：

```typescript
const { projectId, customVariables, addCustomVariable, removeCustomVariable } = useReportStore()

// 获取当前项目的变量
const currentProjectVariables = projectId ? (customVariables[projectId] || {}) : {}

// 创建变量时指定项目ID
const handleCreateVariable = () => {
  if (projectId && newVariableKey.trim()) {
    const key = `{{${newVariableKey.trim()}}}`
    addCustomVariable(projectId, key, newVariableValue)
  }
}
```

## 实施步骤

### 步骤1: 创建数据库迁移

- [ ] 创建 `server/src/db/migrations/007_add_custom_variables_field.sql`
- [ ] 在 `report_project_overview` 表添加 `custom_variables` JSON 字段

### 步骤2: 修改后端API

- [ ] 修改 `reportController.ts` 的 `getProjectOverview` API 返回 `custom_variables`
- [ ] 修改 `reportController.ts` 的 `saveProjectOverview` API 保存 `custom_variables`
- [ ] 新增专用 API：`GET /custom-variables/:projectId` 和 `PUT /custom-variables/:projectId`

### 步骤3: 修改前端Store

- [ ] 修改 `customVariables` 数据结构为按项目隔离
- [ ] 修改 `addCustomVariable`, `removeCustomVariable` 函数
- [ ] 添加 `loadCustomVariables` 函数从API获取
- [ ] 添加 `saveCustomVariables` 函数保存到API
- [ ] 在 `loadProjectData` 中调用 `loadCustomVariables`

### 步骤4: 修改VariablePicker组件

- [ ] 修改变量创建/删除使用项目隔离的变量
- [ ] 修改变量时自动调用API保存
- [ ] 更新UI显示当前项目的变量

### 步骤5: 确保LLM不使用自定义变量

- [ ] 确认 `startGeneration` 不传递自定义变量
- [ ] 添加注释说明

## 注意事项

1. **向后兼容**：如果数据库中没有历史数据，需要处理空数据情况
2. **变量名格式**：自定义变量名需要验证，避免与系统变量冲突
3. **性能考虑**：变量数据量小，不需要特殊优化
4. **权限控制**：确保只能操作自己项目的变量

## 测试用例

1. [ ] 创建变量后刷新页面，变量仍然存在
2. [ ] 在项目A创建变量，切换到项目B，变量不显示
3. [ ] 在项目B创建变量，切换回项目A，变量仍然存在
4. [ ] 生成LLM报告时，控制台不输出自定义变量的值
5. [ ] 删除变量后，变量不再显示
