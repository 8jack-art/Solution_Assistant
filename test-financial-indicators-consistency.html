<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>财务指标计算一致性测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            min-width: 800px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .diff {
            background-color: #ffcccc;
        }
        .match {
            background-color: #ccffcc;
        }
    </style>
</head>
<body class="bg-gray-50 p-6">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8">财务指标计算一致性测试</h1>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">测试说明</h2>
            <p class="mb-4">此测试用于验证财务指标计算与Excel导出功能的数据一致性。主要检查以下内容：</p>
            <ul class="list-disc pl-6 space-y-2">
                <li>财务指标计算是否使用与Excel导出相同的数据源</li>
                <li>动态现金流量的计算公式是否与Excel导出一致</li>
                <li>财务指标（IRR、NPV、投资回收期）的计算结果是否一致</li>
            </ul>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">修复内容</h2>
            <div class="space-y-4">
                <div>
                    <h3 class="font-semibold text-lg">1. 修复动态现金流量计算公式</h3>
                    <p>确保<code>generateCashFlowTableData</code>函数中的动态现金流量计算与Excel导出使用相同的公式：</p>
                    <pre class="bg-gray-100 p-3 rounded mt-2 overflow-x-auto">
<code>所得税后净现金流量（动态）= C-D/(1+E)^B
其中：
C = 所得税前净现金流量（动态）
D = 调整所得税
E = 折现率（所得税后）
B = 年份（从建设期第1年开始计算）</code>
                    </pre>
                </div>
                
                <div>
                    <h3 class="font-semibold text-lg">2. 统一数据源依赖</h3>
                    <p>在<code>useCachedFinancialIndicators</code>函数中添加了更多的数据源依赖，确保当表格数据变化时，财务指标会重新计算：</p>
                    <pre class="bg-gray-100 p-3 rounded mt-2 overflow-x-auto">
<code>const calculationKey = JSON.stringify({
  preTaxRate,
  postTaxRate,
  constructionYears: context?.constructionYears,
  operationYears: context?.operationYears,
  revenueTableData,        // 新增
  costTableData,           // 新增
  profitDistributionTableData, // 新增
});</code>
                    </pre>
                </div>
                
                <div>
                    <h3 class="font-semibold text-lg">3. 优化财务指标计算函数</h3>
                    <p>改进<code>calculateFinancialIndicators</code>函数，确保使用与Excel导出相同的计算逻辑。</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">测试步骤</h2>
            <ol class="list-decimal pl-6 space-y-2">
                <li>在应用中打开财务指标表</li>
                <li>导出项目投资现金流量表为Excel</li>
                <li>比较财务指标表中显示的数值与Excel中的数值</li>
                <li>特别关注动态现金流量和财务指标（IRR、NPV、投资回收期）</li>
                <li>验证修改后两者数值是否一致</li>
            </ol>
        </div>
        
        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
            <p class="text-blue-700">
                <strong>注意：</strong> 修改后的财务指标计算应该与Excel导出使用完全相同的数据源和计算逻辑，确保两者结果一致。
            </p>
        </div>
        
        <div class="bg-green-50 border-l-4 border-green-400 p-4">
            <p class="text-green-700">
                <strong>预期结果：</strong> 修改后，财务指标表中显示的所有数值应该与导出的Excel文件中的对应数值完全一致。
            </p>
        </div>
    </div>
</body>
</html>